<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å®¶åº­è´¹ç”¨æ¸…å• - Big Banana House</title>

  <!-- 1. å¼•å…¥ LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>

  <!-- 2. å¼•å…¥ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- 3. å¼•å…¥ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <!-- å¼•å…¥ Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* --- è«å…°è¿ªé…è‰²å®šä¹‰ --- */
      --bg-body: #f2f4f6;
      --bg-card: #ffffff;

      --primary: #607d8b;
      /* è“ç° */
      --primary-hover: #455a64;
      --accent: #81a18b;
      /* é¼ å°¾è‰ç»¿ */
      --danger: #d4a5a5;
      /* å¹²æ¯ç«ç‘° */
      --danger-hover: #c08b8b;

      --text-main: #374151;
      --text-sub: #6b7280;
      --border-color: #e5e7eb;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05);

      --radius-md: 8px;
      --radius-lg: 16px;
    }
/* === å¤´éƒ¨å¸ƒå±€ä¿®æ­£æ ·å¼ (ä¿®å¤æ ‡é¢˜åç§») === */
    .app-header {
      position: relative;
      display: flex;
      justify-content: center; /* è®© h1 ç»å¯¹å±…ä¸­ */
      align-items: center;
      margin-bottom: 30px;
      min-height: 40px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .user-info-box {
      position: absolute; /* ç»å¯¹å®šä½åˆ°å³ä¾§ï¼Œä¸å æµå¼ç©ºé—´ */
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-sub);
      background: rgba(255, 255, 255, 0.8); /* é˜²æ­¢èƒŒæ™¯é®æŒ¡ */
    }

    /* æ‰‹æœºç«¯é€‚é…ï¼šå±å¹•çª„æ—¶å–æ¶ˆç»å¯¹å®šä½ï¼Œæ”¹ä¸ºå‚ç›´æ’åˆ— */
    @media (max-width: 600px) {
      .app-header {
        flex-direction: column;
        gap: 15px;
        margin-bottom: 25px;
      }
      .user-info-box {
        position: static;
        transform: none;
        width: 100%;
        justify-content: center;
      }
    }
    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', 'Noto Sans SC', sans-serif;
      background-color: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* ç™»å½•/é…ç½®å®¹å™¨æ ·å¼ */
    #authContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 90vh;
    }

    .auth-card {
      background: var(--bg-card);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 450px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 25px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-sub);
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      margin-bottom: -2px;
    }

    .auth-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
      font-weight: 700;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 15px;
      background: #f0f4f8;
      padding: 10px;
      border-radius: var(--radius-md);
    }

    /* ä¸»åº”ç”¨å®¹å™¨ï¼Œé»˜è®¤éšè— */
    #appContainer {
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-card);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }

    h1 {
      text-align: center;
      font-size: 1.75rem;
      margin: 10px 0 30px;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* é€šç”¨è¡¨å•ä¸æŒ‰é’® */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ä¸é«˜åº¦ */
    input,
    select,
    .custom-select-trigger {
      width: 100%;
      height: 42px;
      padding: 0 12px;
      line-height: 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      background-color: #f9fafb;
      color: var(--text-main);
      transition: all 0.3s ease;
      box-sizing: border-box;
      display: flex;
      align-items: center;
    }

    /* Date Input Styling */
    input[type="date"] {
      font-family: inherit;
      color: var(--text-main);
      cursor: pointer;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
      transition: 0.2s;
    }

    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    select {
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23374151%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 12px top 50%;
      background-size: 10px auto;
    }

    input:focus,
    select:focus,
    .custom-select-wrapper.open .custom-select-trigger {
      border-color: var(--primary);
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.15);
    }

    /* æŒ‰é’®ä½“ç³» */
    button {
      font-family: inherit;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .action-btn,
    .action-btn-large {
      border-radius: 6px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn {
      padding: 5px 10px;
      font-size: 0.8rem;
      margin: 0;
      white-space: nowrap;
    }

    .action-btn-large {
      padding: 12px 24px;
      font-size: 1rem;
      min-width: 100px;
      border-radius: var(--radius-md);
      width: 100%; /* Make default width full for mobile/auth */
    }

    @media(min-width: 768px) {
        .action-btn-large { width: auto; }
        .auth-card .action-btn-large { width: 100%; }
    }

    .btn-brown {
      background: var(--primary);
      color: white;
    }

    .btn-brown:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-dark {
      background: var(--danger);
      color: white;
    }

    .btn-dark:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }

    .btn-light {
      background: #fff;
      border: 1px solid var(--border-color);
      color: var(--text-main);
    }

    .btn-light:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #6b8c76;
      transform: translateY(-1px);
    }

    /* ç»Ÿè®¡æ¦‚è§ˆæ¡ */
    .summary {
      background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      margin: 20px 0;
      font-weight: 500;
      color: var(--text-main);
      border-left: 5px solid var(--primary);
      /* Flex å¸ƒå±€ */
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-left {
      flex: 1;
    }

    .summary-right {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.4);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      color: var(--text-main);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .refresh-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.1em;
      margin-left: 8px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .refresh-btn:hover {
      transform: rotate(180deg);
      color: var(--primary-hover);
    }

    @media (max-width: 768px) {
      .summary {
        flex-direction: column;
        align-items: flex-start;
      }

      .summary-right {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
      font-size: 0.95rem;
    }

    th {
      padding: 15px;
      text-align: left;
      background-color: #f8fafc;
      color: var(--text-sub);
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    .action-cell-content {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .month-group-title {
      background: #e2e8f0;
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      padding-left: 15px;
    }

    /* æ–°å¢ï¼šè®°è´¦äºº Badge æ ·å¼ */
    .user-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px; /* åœ†è§’çŸ©å½¢ï¼Œç±»ä¼¼è¯ä¸¸çš„ä¸€åŠ */
        font-size: 0.8em;
        font-weight: 500;
        letter-spacing: 0.3px;
        white-space: nowrap;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* å¸ƒå±€ä¸å›¾è¡¨ */
    .charts-section {
      margin: 30px 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .chart-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      font-size: 1.1rem;
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 20px;
      margin: 25px 0;
      align-items: flex-end;
      flex-wrap: wrap;
      background: #f8fafc;
      padding: 20px;
      border-radius: var(--radius-md);
    }

    .filter-bar>div {
      flex: 1;
      min-width: 130px;
      width: auto;
    }

    /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡† */
    .custom-select-wrapper {
      position: relative;
      user-select: none;
    }

    .custom-select-trigger {
      position: relative;
      cursor: pointer;
    }

    .custom-select-trigger::after {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-25%);
      border: 5px solid transparent;
      border-top-color: var(--text-sub);
    }

    .custom-options {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
    }

    .custom-select-wrapper.open .custom-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-options-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 5px 0;
    }

    .custom-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .custom-option:hover {
      background-color: #f1f5f9;
    }

    .custom-option input {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: var(--primary);
    }

    .custom-footer {
      display: flex;
      border-top: 1px solid var(--border-color);
      padding: 10px;
      gap: 10px;
      background: #f8fafc;
    }

    .custom-footer button {
      padding: 8px;
      flex: 1;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .btn-cancel {
      background: #e5e7eb;
    }

    .btn-confirm {
      background: var(--primary);
      color: white;
    }

    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: #fff;
      padding: 30px;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    /* åˆ†é¡µæ ·å¼ */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px 0;
      padding: 15px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 15px;
    }

    .pagination-jumper {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f8fafc;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .pagination-input {
      width: 50px !important;
      height: 28px !important;
      padding: 4px !important;
      text-align: center;
      margin: 0 5px;
      line-height: normal !important;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #fff;
    }

    .btn-page-nav {
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.1rem;
      padding: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 28px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-page-nav:hover {
      color: var(--primary);
      background: #e2e8f0;
    }

    .btn-jump {
      margin-left: 10px;
      padding: 4px 12px;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    .btn-jump:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* é¢„ç®—æ¡ */
    #budgetProgressBar {
      margin-top: 15px;
      padding: 4px;
      background: #eceff1;
      border-radius: 20px;
      position: relative;
      height: 36px;
      overflow: hidden;
    }

    #budgetBase {
      border-radius: 18px !important;
    }

    /* å®¶åº­å…±äº«æç¤º */
    .family-badge {
        background: #fff3e0;
        color: #e65100;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        border: 1px solid #ffe0b2;
        margin-left: 10px;
    }
  </style>
</head>

<body>

  <!-- ================= 0. ç™»å½•/é…ç½® ç•Œé¢ ================= -->
  <div id="authContainer">
    <div class="auth-card">
      <h2 class="auth-title">å®¶åº­è´¹ç”¨æ¸…å•</h2>
      <p style="text-align: center; color: var(--text-sub); margin-bottom: 20px;">
          Family: Big Banana House
      </p>

      <!-- é…ç½®è¡¨å• (å¦‚æœæ²¡æœ‰ appId/key) -->
      <div id="configSection" style="display: none;">
        <div class="helper-text">
            è¯·å‰å¾€ LeanCloud æ§åˆ¶å°è·å–åº”ç”¨çš„ App ID å’Œ App Keyã€‚<br>
            æ§åˆ¶å° > è®¾ç½® > åº”ç”¨å‡­è¯
        </div>
        <div class="form-group">
            <label>App ID</label>
            <input type="text" id="configAppId" placeholder="è¾“å…¥ App ID">
        </div>
        <div class="form-group">
            <label>App Key</label>
            <input type="password" id="configAppKey" placeholder="è¾“å…¥ App Key">
        </div>
        <div class="form-group">
            <label>REST API Server URL</label>
            <input type="text" id="configServerUrl" placeholder="https://..." value="https://api.leancloud.cn">
        </div>
        <button class="action-btn-large btn-brown" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
      </div>

      <!-- ç™»å½•/æ³¨å†Œè¡¨å• (å¦‚æœå·²æœ‰é…ç½®) -->
      <div id="authSection" style="display: none;">
        <div class="auth-tabs">
            <div class="auth-tab active" id="tabLogin" onclick="switchAuthMode('login')">ç™»å½•</div>
            <div class="auth-tab" id="tabSignup" onclick="switchAuthMode('signup')">æ³¨å†Œ</div>
        </div>

        <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="authUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="authPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>

        <button class="action-btn-large btn-brown" id="authActionBtn" onclick="handleAuthAction()">ç™»å½•</button>

        <div style="text-align: center; margin-top: 20px;">
            <button class="action-btn" style="color: var(--text-sub); text-decoration: underline;" onclick="clearConfig()">é‡ç½® App é…ç½®</button>
        </div>
      </div>

      <!-- åŠ è½½ä¸­ -->
      <div id="loadingSection" style="display: none; text-align: center; color: var(--text-sub);">
        æ­£åœ¨åˆå§‹åŒ–...
      </div>

    </div>
  </div>


  <!-- ================= ä¸»åº”ç”¨ç•Œé¢ ================= -->
  <div class="container" id="appContainer">

    <!-- 1. å¤´éƒ¨åŒºåŸŸï¼šå·²ä¿®å¤ UI åç§» -->
    <div class="app-header">
        <h1>å®¶åº­è´¹ç”¨æ¸…å• <span class="family-badge">Big Banana House</span></h1>
        <div class="user-info-box">
            <span id="currentUserDisplay" style="font-weight: 500; color: var(--primary);"></span>
            <button class="action-btn btn-light" onclick="logout()" style="padding: 4px 12px; font-size: 0.85rem;">é€€å‡º</button>
        </div>
    </div>

    <!-- 2. æ–°å¢æŒ‰é’® -->
    <div style="text-align: center; margin-bottom: 25px;">
      <button class="action-btn-large btn-brown" onclick="openAddModal()">
        <span style="margin-right:5px; font-size:1.2em; line-height:1;">+</span> æ–°å¢æ”¯å‡º
      </button>
    </div>

    <!-- 3. ç»Ÿè®¡æ åŒºåŸŸ (JSåŠ¨æ€æ¸²æŸ“) -->
    <div class="summary" id="summaryBox">
      <!-- åŠ¨æ€å†…å®¹å°†é€šè¿‡ JS æ¸²æŸ“ -->
    </div>

    <!-- 4. å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-section">
      <!-- æŸ±çŠ¶å›¾ & é¢„ç®—æ¡ -->
      <div class="chart-container">
        <div class="chart-title">
          <span id="budgetTitle">å„æœˆæ€»æ”¯å‡º</span>
          <button id="editBudgetBtn" class="action-btn btn-light"
            style="margin-left:8px; font-size:0.75em;">ä¿®æ”¹é¢„ç®—</button>
        </div>
        <canvas id="monthlyBarChart" height="180"></canvas>
        <div id="budgetProgressBar">
          <div id="budgetBase"
            style="height:100%; width:100%; background:#cfd8dc; position:relative; overflow:hidden;">
            <div id="progressGreen"
              style="height:100%; width:0%; background:linear-gradient(to right, #a5d6a7, #81c784); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressRed"
              style="height:100%; width:0%; background:linear-gradient(to right, #ef9a9a, #e57373); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressText"
              style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:0.85em; z-index:2;">
            </div>
          </div>
        </div>
      </div>

      <!-- é¥¼å›¾ -->
      <div class="chart-container">
        <div class="chart-title">ç±»å‹å æ¯” <span
            style="font-size:0.8em; color:var(--text-sub); font-weight:400;">(ç‚¹å‡»æ‰‡åŒºç­›é€‰)</span></div>
        <div id="echartsPie" style="width: 100%; height: 350px;"></div>
      </div>
    </div>

    <!-- 5. ç­›é€‰æ  -->
    <div class="filter-bar">
      <div>
        <label>ç±»å‹ç­›é€‰ (å¤šé€‰)</label>
        <div class="custom-select-wrapper" id="typeSelectWrapper">
          <div class="custom-select-trigger" id="typeSelectTrigger">å…¨éƒ¨ç±»å‹</div>
          <div class="custom-options">
            <div class="custom-options-list" id="typeOptionsList"></div>
            <div class="custom-footer">
              <button class="btn-cancel" onclick="cancelTypeFilter()">å–æ¶ˆ</button>
              <button class="btn-confirm" onclick="confirmTypeFilter()">ç¡®è®¤</button>
            </div>
          </div>
        </div>
      </div>
      <div style="flex: 2; display: flex; gap: 10px;">
        <div style="flex: 1;">
          <label for="startDate">æ˜ç»†å¼€å§‹æ—¥æœŸ</label>
          <input type="date" id="startDate" onchange="applyDateRangeFilter()" />
        </div>
        <div style="flex: 1;">
          <label for="endDate">æ˜ç»†ç»“æŸæ—¥æœŸ</label>
          <input type="date" id="endDate" onchange="applyDateRangeFilter()" />
        </div>
      </div>
      <div>
        <label for="monthFilter">ç»Ÿè®¡æœˆä»½ç­›é€‰</label>
        <select id="monthFilter" onchange="applyMonthOrSearchFilter()">
          <option value="">å…¨éƒ¨æœˆä»½</option>
        </select>
      </div>
      <div>
        <label for="searchInput">æœç´¢ï¼ˆäºŒçº§ç±»å‹ï¼‰</label>
        <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯..." oninput="applyMonthOrSearchFilter()" />
      </div>
      <div style="flex: 0 0 auto;">
        <button class="action-btn btn-accent" onclick="resetFilters()" style="height: 42px;">æ¢å¤é»˜è®¤</button>
      </div>
    </div>

    <!-- 6. è¡¨æ ¼åŒºåŸŸ -->
    <div style="overflow-x: auto;">
      <table id="expenseTable">
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                style="height:auto;"></th>
            <th>ç»Ÿè®¡æœˆä»½</th>
            <th>æ¶ˆè´¹æ—¥æœŸ</th>
            <th>ä¸€çº§ç±»å‹</th>
            <th>è®°è´¦äºº</th> <!-- æ–°å¢ï¼šè®°è´¦äººåˆ— -->
            <th>äºŒçº§ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th style="width: 160px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="expenseList"></tbody>
      </table>
    </div>

    <!-- 7. åˆ†é¡µåŒºåŸŸ -->
    <div class="pagination-container">
      <div style="display:flex; align-items:center;">
        <span style="color:var(--text-sub); font-size:0.9rem; margin-right:5px;">æ¯é¡µ:</span>
        <select id="pageSizeSelect" onchange="changePageSize()"
          style="width:auto; height:30px; line-height:30px; padding:0 25px 0 10px; font-size:0.9rem;">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>

      <div class="pagination-jumper">
        <button class="btn-page-nav" onclick="changePageRelative(-1)" title="ä¸Šä¸€é¡µ">â®</button>
        <span style="margin: 0 6px;">ç¬¬</span>
        <input type="number" id="pageJumpInput" class="pagination-input" value="1" min="1"
          onkeypress="if(event.keyCode==13) jumpToPage()">
        <span style="margin: 0 6px;">é¡µ / å…± <span id="totalPagesDisplay" style="font-weight:bold;">1</span> é¡µ</span>
        <button class="btn-page-nav" onclick="changePageRelative(1)" title="ä¸‹ä¸€é¡µ">â¯</button>
        <button class="btn-jump" onclick="jumpToPage()">è·³è½¬</button>
      </div>
    </div>

    <!-- 8. æ‰¹é‡æ“ä½œæŒ‰é’® -->
    <div style="text-align: right;">
      <button id="batchDeleteBtn" class="action-btn btn-dark" style="opacity:0.8; font-size:0.9rem; padding:8px 16px;"
        onclick="batchDeleteSelected()" disabled>æ‰¹é‡åˆ é™¤</button>
    </div>

    <!-- 9. åº•éƒ¨åŠŸèƒ½æ  (å«æ•°æ®è¿ç§») -->
    <div class="action-bar">
      <button class="action-btn-large btn-light" onclick="exportToCSV()">å¯¼å‡º CSV</button>
      <button class="action-btn-large btn-light" onclick="printCurrentPage()">æ‰“å°</button>

      <!-- å…±äº«æ•°æ®æŒ‰é’® -->
      <button class="action-btn-large btn-accent" onclick="syncToFamily()" style="margin-left: 10px;" title="å°†æˆ‘çš„ç§æœ‰æ•°æ®å…¬å¼€ç»™å®¶åº­æˆå‘˜">
        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ åŒæ­¥åˆ°å®¶åº­
      </button>
        <!-- è§£ç»‘æŒ‰é’® -->
      <button class="action-btn-large btn-dark" onclick="releaseData()" style="margin-left: 10px; display:none;">
        ğŸ”“ é‡Šæ”¾æ•°æ®(åˆå¹¶ç”¨)
      </button>
    </div>

  </div>

  <!-- æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">æ–°å¢æ”¯å‡º</div>
        <button class="action-btn" style="background:none; color:#999; font-size:1.5em; padding:0;"
          onclick="closeAddModal()">&times;</button>
      </div>
      <form id="modalExpenseForm">
        <input type="hidden" id="modalEditId" />
        <div class="form-group">
          <label>æ¶ˆè´¹æ—¥æœŸ</label>
          <input type="date" id="modalDate" required />
        </div>
        <div class="form-group">
          <label>ä¸€çº§ç±»å‹</label>
          <select id="modalType1" required>
            <option value="">-- è¯·é€‰æ‹© --</option>
          </select>
        </div>
        <div class="form-group">
          <label>äºŒçº§ç±»å‹</label>
          <input type="text" id="modalType2" placeholder="å¦‚ï¼šå¥¶èŒ¶" />
        </div>
        <div class="form-group">
          <label>é‡‘é¢</label>
          <div style="position:relative;">
            <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#999;">Â¥</span>
            <input type="number" step="0.01" id="modalAmount" required min="0.01" style="padding-left:25px;" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:15px; margin-top:30px;">
          <button type="button" class="action-btn-large btn-cancel" style="width:auto;"
            onclick="closeAddModal()">å–æ¶ˆ</button>
          <button type="submit" class="action-btn-large btn-confirm" style="width:auto;">ç¡®è®¤ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== é…ç½®ä¸å…¨å±€å˜é‡ ==========
    const MY_FAMILY_ID = "big banana house";

    let BUDGET_STORAGE_KEY = 'expense_budget_' + MY_FAMILY_ID;

    const EXPENSE_CLASS_NAME = 'rourou_YellowChamberPot';

    const EXPENSE_TYPES = ['åƒ', 'å–', 'äº¤é€š', 'è¯è´¹', 'è´­ç‰©', 'æ¸¸æˆ', 'å……å€¼', 'ç”µæ°´è´¹', 'æˆ¿ç§Ÿ', 'å® ç‰©', 'å…¶ä»–'];

    const MORANDI_PALETTE = [
      '#90a4ae', '#a1887f', '#e57373', '#81c784', '#64b5f6',
      '#ffb74d', '#ba68c8', '#4db6ac', '#ffd54f', '#a1887f', '#7986cb'
    ];

    // --- æ–°å¢ï¼šç”¨æˆ·æ ‡ç­¾é¢œè‰²ç›˜ï¼ˆåŒºåˆ«äºå›¾è¡¨é¢œè‰²ï¼‰---
    // ç±»ä¼¼äºå¾®ä¿¡/é’‰é’‰å¤´åƒçš„éšæœºåº•è‰²ï¼Œçœ‹èµ·æ¥æ¯”è¾ƒæŸ”å’Œ
    const USER_PALETTE = [
        { bg: '#e3f2fd', text: '#1565c0' }, // è“
        { bg: '#fce4ec', text: '#c2185b' }, // ç²‰
        { bg: '#f3e5f5', text: '#7b1fa2' }, // ç´«
        { bg: '#e8f5e9', text: '#2e7d32' }, // ç»¿
        { bg: '#fff3e0', text: '#ef6c00' }, // æ©™
        { bg: '#e0f7fa', text: '#006064' }  // é’
    ];

    let ExpenseClass = null;
    let currentUser = null;

    let allExpenses = [];
    let filteredExpenses = [];
    let monthlyBarChart = null;
    let echartsPieInstance = null;
    let activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let tempSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let currentPage = 1;
    let pageSize = 10;
    let currentBudget = 9000;

    let analysisModeIndex = 0;
    const ANALYSIS_MODE_COUNT = 17;

    let authMode = 'login';

    // ========== è®¤è¯ä¸åˆå§‹åŒ–é€»è¾‘ ==========

    window.onload = () => {
        checkAppConfig();
    };

    // --- è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®ç”¨æˆ·åç”Ÿæˆå›ºå®šçš„é¢œè‰² ---
    function getUserColor(username) {
        if (!username) return { bg: '#eeeeee', text: '#9e9e9e' };
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % USER_PALETTE.length;
        return USER_PALETTE[index];
    }

    async function syncToFamily() {
        if (!currentUser) return alert("è¯·å…ˆç™»å½•ï¼");

        if (!confirm(`ç¡®å®šè¦å°†å½“å‰è´¦å·çš„æ‰€æœ‰ç§æœ‰æ•°æ®åŒæ­¥åˆ°å®¶åº­ã€${MY_FAMILY_ID}ã€‘å—ï¼Ÿ\n\nåŒæ­¥åï¼Œå…¶ä»–ç™»å½•æ­¤Appçš„å®¶åº­æˆå‘˜å°†å¯ä»¥æŸ¥çœ‹å¹¶ç¼–è¾‘è¿™äº›æ•°æ®ã€‚`)) {
            return;
        }

        const loadingText = document.createElement('div');
        loadingText.style.position = 'fixed';
        loadingText.style.top = '10px';
        loadingText.style.left = '50%';
        loadingText.style.transform = 'translateX(-50%)';
        loadingText.style.background = 'rgba(0,0,0,0.8)';
        loadingText.style.color = 'white';
        loadingText.style.padding = '10px 20px';
        loadingText.style.borderRadius = '5px';
        loadingText.style.zIndex = '9999';
        loadingText.innerText = 'æ­£åœ¨åŒæ­¥æ•°æ®æƒé™ï¼Œè¯·å‹¿å…³é—­é¡µé¢...';
        document.body.appendChild(loadingText);

        try {
            const query = new AV.Query(EXPENSE_CLASS_NAME);
            query.equalTo('owner', currentUser);
            query.limit(1000);

            const results = await query.find();

            if (results.length === 0) {
                alert("å½“å‰è´¦å·ä¸‹æ²¡æœ‰æ‰¾åˆ°éœ€è¦åŒæ­¥çš„æ•°æ®ã€‚");
                loadingText.remove();
                return;
            }

            const updates = results.map(item => {
                item.set('familyId', MY_FAMILY_ID);
                const acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                item.setACL(acl);

                return item;
            });

            await AV.Object.saveAll(updates);

            loadingText.remove();
            alert(`æˆåŠŸåŒæ­¥äº† ${results.length} æ¡æ•°æ®åˆ°å®¶åº­ï¼\nç°åœ¨è´¦å·Bä¹Ÿå¯ä»¥çœ‹åˆ°è¿™äº›æ•°æ®äº†ã€‚é¡µé¢å°†åˆ·æ–°ã€‚`);

            allExpenses = [];
            renderExpenses();

        } catch (error) {
            console.error(error);
            loadingText.remove();
            alert("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚");
        }
    }

    function checkAppConfig() {
        const id = localStorage.getItem('lc_app_id');
        const key = localStorage.getItem('lc_app_key');
        const url = localStorage.getItem('lc_server_url');

        if (id && key && url) {
            initLeanCloud(id, key, url);
        } else {
            showConfigForm();
        }
    }

    function initLeanCloud(id, key, url) {
        document.getElementById('configSection').style.display = 'none';
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('loadingSection').style.display = 'block';

        try {
            if (typeof AV === 'undefined') {
                alert('LeanCloud SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                return;
            }
            AV.init({ appId: id, appKey: key, serverURLs: url });
            ExpenseClass = AV.Object.extend(EXPENSE_CLASS_NAME);

            checkLoginStatus();
        } catch (e) {
            console.error(e);
            alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
            clearConfig();
        }
    }

    function checkLoginStatus() {
        currentUser = AV.User.current();
        document.getElementById('loadingSection').style.display = 'none';

        if (currentUser) {
            enterApp();
        } else {
            showAuthForm();
        }
    }

    function enterApp() {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('currentUserDisplay').textContent = `ç”¨æˆ·: ${currentUser.getUsername()}`;

        initCustomDropdown();
        renderExpenses();
        window.onresize = () => { if (echartsPieInstance) echartsPieInstance.resize(); };
    }

    function logout() {
        AV.User.logOut();
        location.reload();
    }

    // --- é…ç½®è¡¨å•é€»è¾‘ ---
    function showConfigForm() {
        document.getElementById('configSection').style.display = 'block';
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('loadingSection').style.display = 'none';
    }

    function saveConfig() {
        const id = document.getElementById('configAppId').value.trim();
        const key = document.getElementById('configAppKey').value.trim();
        const url = document.getElementById('configServerUrl').value.trim();

        if (!id || !key || !url) {
            alert('è¯·å¡«å†™å®Œæ•´é…ç½®');
            return;
        }

        localStorage.setItem('lc_app_id', id);
        localStorage.setItem('lc_app_key', key);
        localStorage.setItem('lc_server_url', url);

        initLeanCloud(id, key, url);
    }

    function clearConfig() {
        localStorage.removeItem('lc_app_id');
        localStorage.removeItem('lc_app_key');
        localStorage.removeItem('lc_server_url');
        location.reload();
    }

    // --- ç™»å½•/æ³¨å†Œé€»è¾‘ ---
    function showAuthForm() {
        document.getElementById('authSection').style.display = 'block';
        switchAuthMode('login');
    }

    function switchAuthMode(mode) {
        authMode = mode;
        const btn = document.getElementById('authActionBtn');
        const tabLogin = document.getElementById('tabLogin');
        const tabSignup = document.getElementById('tabSignup');

        if (mode === 'login') {
            tabLogin.classList.add('active');
            tabSignup.classList.remove('active');
            btn.textContent = 'ç«‹å³ç™»å½•';
            btn.className = 'action-btn-large btn-brown';
        } else {
            tabLogin.classList.remove('active');
            tabSignup.classList.add('active');
            btn.textContent = 'æ³¨å†Œå¹¶ç™»å½•';
            btn.className = 'action-btn-large btn-accent';
        }
    }

    async function handleAuthAction() {
        const u = document.getElementById('authUsername').value.trim();
        const p = document.getElementById('authPassword').value.trim();

        if (!u || !p) return alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');

        try {
            if (authMode === 'login') {
                await AV.User.logIn(u, p);
            } else {
                const user = new AV.User();
                user.setUsername(u);
                user.setPassword(p);
                await user.signUp();
            }
            checkLoginStatus();
        } catch (error) {
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        }
    }


    // ========== ä¸šåŠ¡é€»è¾‘ (ä¸‹æ‹‰æ¡†/è¡¨æ ¼/å›¾è¡¨) ==========

    function initCustomDropdown() {
      const list = document.getElementById('typeOptionsList');
      list.innerHTML = '';
      const allDiv = document.createElement('div');
      allDiv.className = 'custom-option';
      allDiv.innerHTML = `<input type="checkbox" value="å…¨éƒ¨ç±»å‹" id="cb_all"><span>å…¨éƒ¨ç±»å‹</span>`;
      allDiv.onclick = (e) => toggleDropdownItem(e, 'å…¨éƒ¨ç±»å‹');
      list.appendChild(allDiv);

      EXPENSE_TYPES.forEach(type => {
        const div = document.createElement('div');
        div.className = 'custom-option';
        div.innerHTML = `<input type="checkbox" value="${type}" id="cb_${type}"><span>${type}</span>`;
        div.onclick = (e) => toggleDropdownItem(e, type);
        list.appendChild(div);
      });

      const modalSelect = document.getElementById('modalType1');
      modalSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
      EXPENSE_TYPES.forEach(t => { modalSelect.add(new Option(t, t)); });

      const wrapper = document.getElementById('typeSelectWrapper');
      const trigger = document.getElementById('typeSelectTrigger');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        wrapper.classList.toggle('open');
        if (wrapper.classList.contains('open')) {
          tempSelectedTypes = [...activeSelectedTypes];
          renderDropdownCheckboxes();
        }
      });

      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) wrapper.classList.remove('open');
      });
    }

    function renderDropdownCheckboxes() {
      const isAll = tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹');
      document.getElementById('cb_all').checked = isAll;
      EXPENSE_TYPES.forEach(type => {
        const cb = document.getElementById(`cb_${type}`);
        if (isAll) { cb.checked = true; } else { cb.checked = tempSelectedTypes.includes(type); }
      });
    }

    function toggleDropdownItem(e, value) {
      if (e.target.tagName !== 'INPUT') {
        const cb = e.currentTarget.querySelector('input');
        cb.checked = !cb.checked;
      }
      if (value === 'å…¨éƒ¨ç±»å‹') {
        const isChecked = document.getElementById('cb_all').checked;
        tempSelectedTypes = isChecked ? ['å…¨éƒ¨ç±»å‹'] : [];
      } else {
        const isChecked = document.getElementById(`cb_${value}`).checked;
        if (tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) {
          tempSelectedTypes = [...EXPENSE_TYPES];
          if (!isChecked) tempSelectedTypes = tempSelectedTypes.filter(t => t !== value);
        } else {
          if (isChecked) tempSelectedTypes.push(value);
          else tempSelectedTypes = tempSelectedTypes.filter(t => t !== value);
        }
        const allSelected = EXPENSE_TYPES.every(t => tempSelectedTypes.includes(t));
        if (allSelected) tempSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
      }
      renderDropdownCheckboxes();
    }

    function confirmTypeFilter() {
      activeSelectedTypes = [...tempSelectedTypes];
      if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
      updateTriggerText();
      document.getElementById('typeSelectWrapper').classList.remove('open');
      renderExpenses();
    }

    function cancelTypeFilter() {
      document.getElementById('typeSelectWrapper').classList.remove('open');
    }

    function updateTriggerText() {
      const trigger = document.getElementById('typeSelectTrigger');
      if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) {
        trigger.textContent = 'å…¨éƒ¨ç±»å‹';
      } else if (activeSelectedTypes.length === 1) {
        trigger.textContent = activeSelectedTypes[0];
      } else {
        trigger.textContent = `${activeSelectedTypes[0]} ç­‰ ${activeSelectedTypes.length} é¡¹`;
      }
    }

    // ========== æ•°æ®æ“ä½œ (å·²ä¿®æ”¹ï¼šæŸ¥è¯¢å®¶åº­ID) ==========
    function computeStatMonth(dateStr) {
      const d = new Date(dateStr);
      let y = d.getFullYear(), m = d.getMonth() + 1;
      if (d.getDate() <= 4) {
        if (m === 1) { m = 12; y--; } else { m--; }
      }
      return `${y}-${String(m).padStart(2, '0')}`;
    }

    async function getExpenses() {
      if (!ExpenseClass || !currentUser) return [];
      const query = new AV.Query(ExpenseClass);

      query.equalTo('familyId', MY_FAMILY_ID);
      // --- å…³é”®ä¿®æ”¹ï¼šåŒ…å« owner å­—æ®µï¼Œä»¥ä¾¿è·å–ç”¨æˆ·å ---
      query.include('owner');

      query.addDescending('date');
      query.addDescending('createdAt');
      query.limit(1000);
      try {
        const results = await query.find();
        return results.map(obj => {
          // è·å–å…³è”çš„ç”¨æˆ·å¯¹è±¡
          const ownerObj = obj.get('owner');
          // å¦‚æœæœ‰ owner å¯¹è±¡åˆ™å– usernameï¼Œå¦åˆ™æ˜¾ç¤ºæœªçŸ¥
          const username = ownerObj ? ownerObj.getUsername() : 'æœªçŸ¥';

          return {
            id: obj.id,
            date: obj.get('date'),
            type1: obj.get('type1'),
            type2: obj.get('type2') || '',
            amount: parseFloat(obj.get('amount')) || 0,
            statMonth: computeStatMonth(obj.get('date')),
            username: username // å¢åŠ  username å­—æ®µ
          };
        });
      } catch (err) { console.error(err); return []; }
    }

    // ========== å›¾è¡¨é€»è¾‘ ==========
    function renderCharts() {
      const groups = {};
      allExpenses.forEach(e => {
        if (!groups[e.statMonth]) groups[e.statMonth] = 0;
        groups[e.statMonth] += e.amount;
      });

      const now = new Date();
      const currentStatMonth = computeStatMonth(now.toISOString());

      const months = [];
      for (let i = 5; i >= 0; i--) {
        let [y, m] = currentStatMonth.split('-').map(Number);
        m = m - i;
        while (m <= 0) { m += 12; y--; }
        while (m > 12) { m -= 12; y++; }
        months.push(`${y}-${String(m).padStart(2, '0')}`);
      }

      const totals = months.map(m => groups[m] || 0);

      // è¯»å–é¢„ç®—ï¼Œä½¿ç”¨å®¶åº­å…¬ç”¨ Key
      currentBudget = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}')[currentStatMonth] || 9000;

      document.getElementById('budgetTitle').textContent = `å„æœˆæ€»æ”¯å‡º (é¢„ç®— Â¥${currentBudget})`;

      const ctxBar = document.getElementById('monthlyBarChart').getContext('2d');
      if (monthlyBarChart) monthlyBarChart.destroy();
      monthlyBarChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'æ”¯å‡º',
            data: totals,
            backgroundColor: months.map(m => (m === currentStatMonth && (groups[m] || 0) > currentBudget) ? '#e57373' : '#90a4ae'),
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: { annotations: { line1: { type: 'line', yMin: currentBudget, yMax: currentBudget, borderColor: '#b0bec5', borderDash: [5, 5], borderWidth: 2 } } }
          },
          scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
        }
      });

      const curTotal = groups[currentStatMonth] || 0;
      const percent = Math.min(100, (curTotal / currentBudget) * 100);
      const remain = currentBudget - curTotal;
      if (remain >= 0) {
        document.getElementById('progressGreen').style.width = (remain / currentBudget * 100) + '%';
        document.getElementById('progressRed').style.width = '0%';
        document.getElementById('progressText').textContent = `å‰©ä½™ Â¥${remain.toFixed(0)} (${(100 - percent).toFixed(0)}%)`;
        document.getElementById('progressText').style.color = "#2c3e50";
      } else {
        document.getElementById('progressGreen').style.width = '0%';
        document.getElementById('progressRed').style.width = Math.min(100, (Math.abs(remain) / currentBudget * 100)) + '%';
        document.getElementById('progressText').textContent = `è¶…æ”¯ Â¥${Math.abs(remain).toFixed(0)}`;
        document.getElementById('progressText').style.color = "#b71c1c";
      }

      renderEChartsPie();
    }

    function renderEChartsPie() {
      const dom = document.getElementById('echartsPie');
      if (!echartsPieInstance) {
        echartsPieInstance = echarts.init(dom);
        echartsPieInstance.on('click', function (params) { handleChartClick(params.name); });
        echartsPieInstance.on('legendselectchanged', function (params) { handleChartClick(params.name); });
      }

      let pieSourceData = getTimeFilteredExpenses();

      const typeMap = {};
      pieSourceData.forEach(e => { typeMap[e.type1] = (typeMap[e.type1] || 0) + e.amount; });

      const isAllSelected = activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹');
      const dataForChart = Object.keys(typeMap).map(k => {
        const isSelected = isAllSelected || activeSelectedTypes.includes(k);
        return {
          value: typeMap[k],
          name: k,
          itemStyle: { opacity: isSelected ? 1 : 0.1, color: isSelected ? undefined : '#cfd8dc' },
          label: { show: isSelected, color: '#546e7a' },
          labelLine: { show: isSelected, lineStyle: { color: '#cfd8dc' } }
        };
      });

      const legendSelectedState = {};
      EXPENSE_TYPES.forEach(t => legendSelectedState[t] = true);

      const option = {
        color: MORANDI_PALETTE,
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(255,255,255,0.9)',
          formatter: function (params) { return `${params.name}<br/>Â¥${params.value.toFixed(2)} (${params.percent}%)`; }
        },
        legend: {
          bottom: 0,
          left: 'center',
          padding: [5, 5],
          itemWidth: 15,
          itemHeight: 10,
          textStyle: { color: '#607d8b' },
          width: '95%',
          selected: legendSelectedState
        },
        series: [
          {
            name: 'æ”¯å‡ºç±»å‹',
            type: 'pie',
            radius: ['35%', '55%'],
            center: ['50%', '40%'],
            avoidLabelOverlap: true,
            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
            data: dataForChart,
            selectedMode: 'multiple', selectedOffset: 10
          }
        ]
      };

      echartsPieInstance.setOption(option, true);
    }

    function handleChartClick(typeName) {
      if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) {
        activeSelectedTypes = [typeName];
      } else {
        if (activeSelectedTypes.includes(typeName)) {
          activeSelectedTypes = activeSelectedTypes.filter(t => t !== typeName);
          if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
        } else {
          activeSelectedTypes.push(typeName);
        }
      }
      tempSelectedTypes = [...activeSelectedTypes];
      updateTriggerText();
      renderDropdownCheckboxes();
      renderExpenses();
    }

    // ========== æ¸²æŸ“é€»è¾‘ ==========

    function getTimeFilteredExpenses() {
      let temp = allExpenses;
      const mFilter = document.getElementById('monthFilter').value;
      if (mFilter) temp = temp.filter(e => e.statMonth === mFilter);

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate) temp = temp.filter(e => e.date >= startDate);
      if (endDate) temp = temp.filter(e => e.date <= endDate);

      return temp;
    }

    async function renderExpenses() {
      if (!currentUser) return; // æœªç™»å½•ä¸æ¸²æŸ“

      // å¦‚æœæ˜¯åˆšç™»å½•è¿›æ¥ï¼ŒallExpenses ä¸ºç©ºï¼Œå…ˆè·å–æ•°æ®
      if (allExpenses.length === 0) {
        allExpenses = await getExpenses();
        const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
        const sel = document.getElementById('monthFilter');

        let targetVal = sel.value;
        sel.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>';
        months.forEach(m => sel.add(new Option(m, m)));

        const currentMonth = computeStatMonth(new Date().toISOString());
        if (!targetVal && months.includes(currentMonth)) {
          targetVal = currentMonth;
        }

        if (targetVal) sel.value = targetVal;
      }

      let temp = getTimeFilteredExpenses();

      if (!activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) {
        temp = temp.filter(e => activeSelectedTypes.includes(e.type1));
      }

      const kw = document.getElementById('searchInput').value.trim();
      if (kw) temp = temp.filter(e => e.type2.includes(kw));

      filteredExpenses = temp;

      const totalPages = Math.ceil(filteredExpenses.length / pageSize) || 1;
      if (currentPage > totalPages) currentPage = 1;
      document.getElementById('totalPagesDisplay').innerText = totalPages;
      document.getElementById('pageJumpInput').max = totalPages;
      document.getElementById('pageJumpInput').value = currentPage;

      renderTable();
      renderCharts();
      updateAnalysis();
    }

    function applyMonthOrSearchFilter() {
      currentPage = 1;
      renderExpenses();
    }

    function applyDateRangeFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (start && end && start > end) {
        alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´');
        document.getElementById('startDate').value = '';
        return;
      }
      currentPage = 1;
      renderExpenses();
    }

    function resetFilters() {
      activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
      tempSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
      updateTriggerText();
      renderDropdownCheckboxes();
      document.getElementById('typeSelectWrapper').classList.remove('open');

      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      const sel = document.getElementById('monthFilter');
      const currentMonth = computeStatMonth(new Date().toISOString());
      let found = false;
      for (let i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === currentMonth) {
          sel.value = currentMonth;
          found = true;
          break;
        }
      }
      if (!found) sel.value = "";

      document.getElementById('searchInput').value = '';

      currentPage = 1;
      renderExpenses();
    }

    function renderTable() {
      const tbody = document.getElementById('expenseList');
      tbody.innerHTML = '';

      const start = (currentPage - 1) * pageSize;
      const pageData = filteredExpenses.slice(start, start + pageSize);

      const summaryBox = document.getElementById('summaryBox');

      const targetData = filteredExpenses;
      const targetTotal = targetData.reduce((a, b) => a + b.amount, 0);
      const targetCount = targetData.length;

      const leftContent = `
        <div class="summary-left">
          <span style="color:var(--primary); font-weight:bold;">ç­›é€‰ç»“æœï¼šå…± ${targetCount} ç¬”ï¼Œæ€»é¢ Â¥${formatMoney(targetTotal)}</span>
        </div>`;

      const rightContent = `
        <div class="summary-right">
            <span id="analysisText" style="margin-right:5px;">æ­£åœ¨ç”Ÿæˆåˆ†æ...</span>
            <button class="refresh-btn" onclick="switchAnalysisMode()" title="éšæœºåˆ·æ–°åˆ†æ">â†»</button>
        </div>`;

      summaryBox.innerHTML = leftContent + rightContent;

      const groups = {};
      pageData.forEach(e => {
        if (!groups[e.statMonth]) groups[e.statMonth] = [];
        groups[e.statMonth].push(e);
      });

      Object.keys(groups).sort().reverse().forEach(mon => {
        const list = groups[mon];
        const subTotal = list.reduce((s, i) => s + i.amount, 0);
        const trTitle = document.createElement('tr');
        trTitle.innerHTML = `<td colspan="8" class="month-group-title">${mon} å½“å‰é¡µå°è®¡: Â¥${formatMoney(subTotal)}</td>`; // æ³¨æ„ colspan=8
        tbody.appendChild(trTitle);

        list.forEach(item => {
          // --- å…³é”®ä¿®æ”¹ï¼šè·å–å½“å‰ç”¨æˆ·çš„é¢œè‰²é…ç½® ---
          const userColor = getUserColor(item.username);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="item-cb" value="${item.id}" onchange="checkBatchBtn()" style="height:auto;"></td>
            <td>${item.statMonth}</td>
            <td>${item.date.slice(0, 10)}</td>
            <td><span style="background:#eceff1; padding:2px 8px; border-radius:10px; font-size:0.85em; color:#455a64;">${item.type1}</span></td>

            <!-- æ–°å¢ï¼šè®°è´¦äººåˆ— -->
            <td>
                <span class="user-badge" style="background:${userColor.bg}; color:${userColor.text};">
                    ${item.username}
                </span>
            </td>

            <td>${item.type2}</td>
            <td style="font-weight:500;">Â¥${formatMoney(item.amount)}</td>
            <td>
              <div class="action-cell-content">
                <button class="action-btn btn-brown" onclick="editExp('${item.id}')">ç¼–è¾‘</button>
                <button class="action-btn btn-dark" onclick="delExp('${item.id}')">åˆ é™¤</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

      checkBatchBtn();
    }

    // ========== åˆ†ææŠ¥å‘Šé€»è¾‘ ==========

    function switchAnalysisMode() {
      let newIndex;
      do {
          newIndex = Math.floor(Math.random() * ANALYSIS_MODE_COUNT);
      } while (newIndex === analysisModeIndex && ANALYSIS_MODE_COUNT > 1);
      analysisModeIndex = newIndex;
      updateAnalysis();
    }

    function updateAnalysis() {
      const textEl = document.getElementById('analysisText');
      if (!textEl) return;

      const data = filteredExpenses;

      if (data.length === 0) {
        textEl.textContent = "æš‚æ— æ•°æ®å¯åˆ†æ";
        return;
      }

      const dates = data.map(e => new Date(e.date).getTime());
      const minDate = Math.min(...dates);
      const maxDate = Math.max(...dates);
      const daySpan = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + (minDate === maxDate ? 0 : 1));
      const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);

      let resultText = "";

      const sortedByAmount = data.filter(item => item.type1 !== 'æˆ¿ç§Ÿ').sort((a, b) => b.amount - a.amount);
      const typeGroups = {};
      const typeCounts = {};
      data.forEach(item => {
        typeGroups[item.type1] = (typeGroups[item.type1] || 0) + item.amount;
        typeCounts[item.type1] = (typeCounts[item.type1] || 0) + 1;
      });

      const sortedTypes = Object.entries(typeGroups)
        .filter(([t]) => t !== 'æˆ¿ç§Ÿ')
        .sort((a, b) => b[1] - a[1]);

      switch (analysisModeIndex) {
        case 0:
          const dailyAvg = totalAmount / daySpan;
          resultText = `æ—¥å‡æ”¯å‡º${dailyAvg.toFixed(2)}å…ƒ`;
          break;
        case 1:
          if (sortedByAmount.length > 0) {
            const item = sortedByAmount[0];
            resultText = `å•ç¬”æœ€é«˜ï¼šã€${item.type1}ã€‘${item.type2} æ¶ˆè´¹${item.amount}å…ƒ`;
          } else { resultText = "é™¤æˆ¿ç§Ÿå¤–æš‚æ— æ¶ˆè´¹"; }
          break;
        case 2:
          if (sortedByAmount.length > 1) {
            const item = sortedByAmount[1];
            resultText = `å•ç¬”ç¬¬äºŒï¼šã€${item.type1}ã€‘${item.type2} æ¶ˆè´¹${item.amount}å…ƒ`;
          } else { resultText = "æš‚æ— å•ç¬”æ¶ˆè´¹ç¬¬äºŒå"; }
          break;
        case 3:
          if (sortedByAmount.length > 2) {
            const item = sortedByAmount[2];
            resultText = `å•ç¬”ç¬¬ä¸‰ï¼šã€${item.type1}ã€‘${item.type2} æ¶ˆè´¹${item.amount}å…ƒ`;
          } else { resultText = "æš‚æ— å•ç¬”æ¶ˆè´¹ç¬¬ä¸‰å"; }
          break;
        case 4:
          if (sortedByAmount.length > 0) {
            const item = sortedByAmount[sortedByAmount.length - 1];
            resultText = `å•ç¬”æœ€å°ï¼šã€${item.type1}ã€‘${item.type2} æ¶ˆè´¹${item.amount}å…ƒ`;
          } else { resultText = "æš‚æ— æ•°æ®"; }
          break;
        case 5:
          if (sortedTypes.length > 0) {
            const [name, amt] = sortedTypes[0];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `ç¬¬ä¸€å¤§ç±»ï¼š${name}å ${percent}%`;
          } else { resultText = "é™¤æˆ¿ç§Ÿå¤–æš‚æ— ä¸»è¦åˆ†ç±»"; }
          break;
        case 6:
          if (sortedTypes.length > 1) {
            const [name, amt] = sortedTypes[1];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `ç¬¬äºŒå¤§ç±»ï¼š${name}å ${percent}%`;
          } else { resultText = "æš‚æ— ç¬¬äºŒå¤§åˆ†ç±»"; }
          break;
        case 7:
          if (sortedTypes.length > 2) {
            const [name, amt] = sortedTypes[2];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `ç¬¬ä¸‰å¤§ç±»ï¼š${name}å ${percent}%`;
          } else { resultText = "æš‚æ— ç¬¬ä¸‰å¤§åˆ†ç±»"; }
          break;
        case 8:
           if (sortedTypes.length > 0) {
            const [name, amt] = sortedTypes[sortedTypes.length - 1];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `æœ€å°åˆ†ç±»ï¼š${name}å ${percent}%`;
          } else { resultText = "æš‚æ— æ•°æ®"; }
          break;
        case 9:
          let weekDayTotal = 0, weekDayCount = 0;
          let weekendTotal = 0, weekendCount = 0;
          let wdItems = 0, weItems = 0;
          const targetTypes = ['åƒ', 'å–', 'äº¤é€š'];

          data.forEach(item => {
             if (!targetTypes.includes(item.type1)) return;
             const day = new Date(item.date).getDay();
             const isWeekend = (day === 0 || day === 6);
             if (isWeekend) { weekendTotal += item.amount; weItems++; }
             else { weekDayTotal += item.amount; wdItems++; }
          });

          const wdAvg = wdItems ? (weekDayTotal / wdItems) : 0;
          const weAvg = weItems ? (weekendTotal / weItems) : 0;
          const diff = Math.abs(wdAvg - weAvg).toFixed(0);

          if (wdAvg > weAvg) resultText = `å·¥ä½œæ—¥(åƒå–äº¤é€š)ç¬”å‡æ¯”å‘¨æœ«é«˜${diff}å…ƒ`;
          else if (weAvg > wdAvg) resultText = `å‘¨æœ«(åƒå–äº¤é€š)ç¬”å‡æ¯”å·¥ä½œæ—¥é«˜${diff}å…ƒ`;
          else resultText = "å‘¨æœ«ä¸å·¥ä½œæ—¥(åƒå–äº¤é€š)æ¶ˆè´¹æŒå¹³";
          break;
        case 10:
          const sortedCounts = Object.entries(typeCounts).sort((a,b) => b[1] - a[1]);
          if (sortedCounts.length > 0) {
             const [name, count] = sortedCounts[0];
             resultText = `é¢‘æ¬¡ä¹‹ç‹ï¼š${name}ç±»å…±æ¶ˆè´¹${count}æ¬¡`;
          } else { resultText = "æš‚æ— é¢‘æ¬¡æ•°æ®"; }
          break;
        case 11:
          const density = data.length / daySpan;
          resultText = `æ¶ˆè´¹å¯†åº¦ä¸º${density.toFixed(1)}æ¬¡/å¤©`;
          break;
        case 12:
          const dailyExpense = totalAmount / daySpan;
          const balance = currentBudget - totalAmount;
          if (balance < 0) {
            resultText = `å·²è¶…é¢${Math.abs(balance).toFixed(2)}å…ƒ`;
          } else {
            if (dailyExpense <= 0) resultText = "ä½™é¢å……è¶³ï¼ˆæš‚æ— æ—¥å‡æ”¯å‡ºï¼‰";
            else {
              const daysLeft = balance / dailyExpense;
              resultText = `ä½™é¢ä»…å¤ŸèŠ±${daysLeft.toFixed(0)}å¤©`;
            }
          }
          break;
        case 13:
            const dayMap = {};
            data.forEach(item => {
                if (item.type1 === 'æˆ¿ç§Ÿ') return;
                const d = item.date.slice(0, 10);
                dayMap[d] = (dayMap[d] || 0) + item.amount;
            });
            let maxDay = "", maxDayAmt = 0;
            for (let d in dayMap) {
                if (dayMap[d] > maxDayAmt) { maxDayAmt = dayMap[d]; maxDay = d; }
            }
            if (maxDay) resultText = `å•æ—¥ä¹‹ç‹(é™¤æˆ¿ç§Ÿ)ï¼š${maxDay} èŠ±è´¹${maxDayAmt.toFixed(0)}å…ƒ`;
            else resultText = "é™¤æˆ¿ç§Ÿå¤–æš‚æ— æ¶ˆè´¹æ•°æ®";
            break;
        case 14:
             const avgPrice = data.length ? (totalAmount / data.length) : 0;
             resultText = `å¹³å‡å•ä»·ï¼šæ¯ç¬”æ¶ˆè´¹çº¦${avgPrice.toFixed(1)}å…ƒ`;
             break;
        case 15:
             const smallCount = data.filter(i => i.amount < 30).length;
             const smallPercent = data.length ? ((smallCount / data.length) * 100).toFixed(0) : 0;
             resultText = `çç¢æ¶ˆè´¹ï¼š30å…ƒä»¥ä¸‹å æ¯”${smallPercent}% (${smallCount}ç¬”)`;
             break;
        case 16:
            const highValueItems = data.filter(i => i.amount > 500);
            const hvCount = highValueItems.length;
            if (hvCount > 0) {
                const hvTotal = highValueItems.reduce((sum, i) => sum + i.amount, 0);
                resultText = `é«˜é¢æ¶ˆè´¹(>500)ï¼šå…±${hvCount}ç¬”ï¼Œåˆè®¡${hvTotal.toFixed(0)}å…ƒ`;
            } else {
                resultText = "æš‚æ— å•ç¬”è¶…500å…ƒçš„å¤§é¢æ¶ˆè´¹";
            }
            break;
      }

      textEl.textContent = resultText;
    }

    // ========== åˆ†é¡µä¸æ“ä½œé€»è¾‘ ==========
    function formatMoney(n) { return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }

    function checkBatchBtn() {
      const n = document.querySelectorAll('.item-cb:checked').length;
      const btn = document.getElementById('batchDeleteBtn');
      btn.disabled = (n === 0);
      btn.style.opacity = n === 0 ? '0.5' : '1';
    }
    function toggleAllCheckboxes() {
      const v = document.getElementById('selectAll').checked;
      document.querySelectorAll('.item-cb').forEach(c => c.checked = v);
      checkBatchBtn();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      renderExpenses();
    }

    function jumpToPage() {
      const inputVal = parseInt(document.getElementById('pageJumpInput').value);
      const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1;

      if (isNaN(inputVal) || inputVal < 1) {
        currentPage = 1;
      } else if (inputVal > maxPage) {
        currentPage = maxPage;
      } else {
        currentPage = inputVal;
      }
      renderTable();
      document.getElementById('pageJumpInput').value = currentPage;
    }

    function changePageRelative(offset) {
      const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1;
      let newPage = currentPage + offset;
      if (newPage < 1) newPage = 1;
      if (newPage > maxPage) newPage = maxPage;

      if (newPage !== currentPage) {
        currentPage = newPage;
        renderTable();
        document.getElementById('pageJumpInput').value = currentPage;
      }
    }

    // å¢åˆ æ”¹
    function openAddModal() {
      document.getElementById('modalExpenseForm').reset();
      document.getElementById('modalEditId').value = '';
      document.getElementById('modalTitle').innerText = 'æ–°å¢æ”¯å‡º';
      document.getElementById('modalDate').valueAsDate = new Date();
      document.getElementById('addModal').classList.add('active');
    }
    function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

    document.getElementById('modalExpenseForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('æœªç™»å½•');

      const id = document.getElementById('modalEditId').value;
      const cleanAmount = Math.round(parseFloat(document.getElementById('modalAmount').value) * 100) / 100;
      const data = {
        date: document.getElementById('modalDate').value,
        type1: document.getElementById('modalType1').value,
        type2: document.getElementById('modalType2').value,
        amount: cleanAmount,
        familyId: MY_FAMILY_ID
      };

      try {
        if (id) {
            const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id);
            obj.set(data);
            await obj.save();
        } else {
            const obj = new ExpenseClass();
            obj.set(data);
            obj.set('owner', currentUser);

            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            obj.setACL(acl);

            await obj.save();
        }
        closeAddModal();
        allExpenses = [];
        renderExpenses();
      } catch (err) {
        alert('ä¿å­˜å¤±è´¥: ' + err.message);
      }
    };

    async function delExp(id) {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id);
      await obj.destroy();
      allExpenses = allExpenses.filter(e => e.id !== id);
      renderExpenses();
    }

    async function batchDeleteSelected() {
      const ids = Array.from(document.querySelectorAll('.item-cb:checked')).map(c => c.value);
      if (!confirm(`ç¡®å®šåˆ é™¤ ${ids.length} æ¡?`)) return;
      const objs = ids.map(id => AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id));
      await AV.Object.destroyAll(objs);
      allExpenses = allExpenses.filter(e => !ids.includes(e.id));
      renderExpenses();
      document.getElementById('selectAll').checked = false;
    }

    function editExp(id) {
      const item = allExpenses.find(e => e.id === id);
      document.getElementById('modalEditId').value = id;
      document.getElementById('modalDate').value = item.date.slice(0, 10);
      document.getElementById('modalType1').value = item.type1;
      document.getElementById('modalType2').value = item.type2;
      document.getElementById('modalAmount').value = item.amount;
      document.getElementById('modalTitle').innerText = 'ç¼–è¾‘æ”¯å‡º';
      document.getElementById('addModal').classList.add('active');
    }

    document.getElementById('editBudgetBtn').onclick = () => {
      const v = prompt('è¾“å…¥æœ¬æœˆé¢„ç®—', currentBudget);
      if (v && !isNaN(v)) {
        const nowStr = computeStatMonth(new Date().toISOString().slice(0, 10));
        const budgets = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}');
        budgets[nowStr] = parseFloat(v);
        localStorage.setItem(BUDGET_STORAGE_KEY, JSON.stringify(budgets));
        renderCharts();
        updateAnalysis();
      }
    };

    function exportToCSV() {
      let csv = 'ç»Ÿè®¡æœˆä»½,æ—¥æœŸ,ä¸€çº§ç±»å‹,è®°è´¦äºº,äºŒçº§ç±»å‹,é‡‘é¢\n';
      filteredExpenses.forEach(e => {
        csv += `${e.statMonth},${e.date.slice(0, 10)},${e.type1},${e.username},${e.type2},${e.amount}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'æ”¯å‡ºæ˜ç»†.csv'; a.click();
    }
    function printCurrentPage() { window.print(); }

  </script>
</body>

</html>