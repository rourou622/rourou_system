<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å•†å“ä¿è´¨æœŸç®¡ç†ç³»ç»Ÿ</title>
  <!-- å¼•å…¥ LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>
  <style>
    /* ================= ä½é¥±å’Œåº¦ / è«å…°è¿ªé£æ ¼ CSS ================= */
    :root {
      --bg-body: #f2f4f6;
      --bg-container: #ffffff;
      --text-primary: #505050;
      --text-secondary: #888888;

      --color-blue: #7d9cb3;
      --color-blue-hover: #6a869b;
      --color-red: #d48785;
      --color-red-hover: #bf7371;
      --color-green: #8cb39d;
      --color-green-hover: #769c87;
      --color-orange: #dcb37b;
      --color-orange-hover: #c9a068;
      --color-purple: #9b8ea9;
      --color-purple-hover: #867995;
      --color-grey: #aab0b6;
      --color-grey-hover: #949aa0;

      --border-color: #e6e8eb;
      --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background-color: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1100px; /*ç¨å¾®åŠ å®½ä»¥å®¹çº³å•è¡Œæ˜¾ç¤º */
      margin: 0 auto;
      background: var(--bg-container);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid #fff;
    }

    h1 {
      text-align: center;
      font-size: 1.6em;
      margin: 10px 0 25px;
      color: #4a5a6a;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    h2 {
      font-size: 1.1em;
      color: var(--color-blue);
      border-left: 4px solid var(--color-blue);
      padding-left: 10px;
      margin-bottom: 20px;
    }

    .form-group { margin-bottom: 15px; }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 0.9em;
      color: #666;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      color: #555;
      background-color: #fcfcfc;
      transition: all 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--color-blue);
      background-color: #fff;
    }

    button {
      padding: 9px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s, transform 0.1s;
      font-weight: 500;
      color: white;
    }
    button:active { transform: scale(0.98); }

    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– - å¼ºåˆ¶ä¸æ¢è¡Œ */
    .table-responsive {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.95em;
      min-width: 1000px; /* ä¿è¯æœ€å°å®½åº¦ï¼Œé˜²æ­¢è¿‡åº¦æŒ¤å‹ */
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap; /* æ ¸å¿ƒï¼šç¦æ­¢æ–‡å­—æ¢è¡Œ */
    }

    th {
      background-color: #f7f9fa;
      color: #666;
      font-weight: 600;
      position: sticky; /* è¡¨å¤´å›ºå®š */
      top: 0;
      z-index: 10;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background-color: #fbfbfc; }

    /* æ“ä½œæŒ‰é’®åˆ—å®¹å™¨ */
    .action-cell {
      display: flex;
      gap: 5px;
    }

    /* çŠ¶æ€æ–‡å­—é¢œè‰² */
    .status-normal { color: #5a9476; font-weight: 600; }
    .status-near-expired { color: #d19953; font-weight: 600; }
    .status-expired { color: #c46464; font-weight: 600; }

    /* ========== åˆ†é¡µæ æ–°æ ·å¼ (ä»¿å›¾äºŒ) ========== */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 12px 15px;
      background: #ffffff; /* çº¯ç™½èƒŒæ™¯ */
      border: 1px solid #3498db; /* è¿™é‡Œçš„è“æ¡† */
      border-radius: 6px; /* åœ†è§’ */
      font-size: 14px;
      color: #666;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pagination-left {
      font-weight: 500;
    }

    .pagination-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* æ¯é¡µå¤šå°‘æ¡çš„é€‰æ‹©æ¡† */
    .page-size-select {
      width: auto;
      padding: 5px 25px 5px 10px;
      margin: 0 5px;
      border-radius: 4px;
      background-color: #f2f4f6;
      border: 1px solid #ddd;
      cursor: pointer;
    }

    /* ç¿»é¡µæŒ‰é’® < > */
    .btn-icon {
      background: #fff;
      color: #666;
      border: 1px solid #ddd;
      padding: 5px 10px;
      font-size: 14px;
      border-radius: 4px;
    }
    .btn-icon:hover:not(:disabled) {
      border-color: var(--color-blue);
      color: var(--color-blue);
    }
    .btn-icon:disabled {
      color: #ccc;
      cursor: not-allowed;
      background: #f9f9f9;
    }

    /* é¡µç æ˜¾ç¤º */
    .page-number-display {
      margin: 0 5px;
      font-weight: 500;
    }

    /* è·³è½¬éƒ¨åˆ† */
    .jump-wrapper {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
    }
    .jump-input {
      width: 50px;
      padding: 5px;
      text-align: center;
      border-radius: 4px;
    }
    .jump-btn {
      background: #fff;
      color: #666;
      border: 1px solid #ddd;
      padding: 5px 10px;
      font-size: 13px;
    }
    .jump-btn:hover {
      border-color: var(--color-blue);
      color: var(--color-blue);
    }


    /* æŒ‰é’®é¢œè‰²å®šä¹‰ */
    .edit-btn { background: var(--color-orange); padding: 5px 10px; font-size: 12px; }
    .edit-btn:hover { background: var(--color-orange-hover); }

    .delete-btn { background: var(--color-red); padding: 5px 10px; font-size: 12px;}
    .delete-btn:hover { background: var(--color-red-hover); }

    .add-product-btn { background: var(--color-green); padding: 9px 20px; }
    .add-product-btn:hover { background: var(--color-green-hover); }

    #searchBtn { background-color: var(--color-blue); }
    #searchBtn:hover { background-color: var(--color-blue-hover); }

    .batch-delete-btn { background: var(--color-purple); }
    .batch-delete-btn:hover { background: var(--color-purple-hover); }
    .batch-delete-btn:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }

    /* ç­›é€‰æ  */
    .filter-bar {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      align-items: center;
      flex-wrap: wrap;
      background: #fafbfc;
      padding: 15px;
      border-radius: 10px;
    }
    .filter-bar > div { flex: 1; min-width: 150px; }

    /* æ¨¡æ€çª— & å…¶ä»–é€šç”¨æ ·å¼ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(45, 50, 60, 0.4); backdrop-filter: blur(2px);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: white; padding: 25px; border-radius: 12px;
      width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
    .modal-title { font-size: 1.3em; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; }
    .modal-footer { display: flex; gap: 12px; margin-top: 25px; justify-content: flex-end; }
    .modal-submit { background-color: var(--color-blue); }
    .modal-cancel { background-color: var(--color-grey); color:white;}

    .action-bar { display: flex; gap: 12px; margin: 25px 0 15px; flex-wrap: wrap; }
    .action-btn-large { padding: 12px 18px; font-size: 15px; flex: 1; min-width: 120px; }
    .export-btn { background: var(--color-green); }
    .print-btn { background: #7ba3a8; }
    .clear-btn { background: var(--color-red); }
    .import-btn { background: var(--color-grey); }

    .shelf-life-group { display: flex; gap: 10px; }
    .import-area { display: flex; align-items: center; gap: 12px; margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
    .import-area button { background: #909399; font-size: 13px; padding: 6px 15px; }
    .notice { text-align: center; color: #999; font-size: 0.85em; margin-top: 15px; background: #fcfcfc; padding: 10px; border-radius: 6px; border: 1px dashed #e0e0e0; }
    input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--color-blue); }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ å•†å“ä¿è´¨æœŸç®¡ç†ç³»ç»Ÿ <span style="font-size:0.6em; color:#999; font-weight:normal;"></span></h1>

    <h2>å•†å“åˆ—è¡¨</h2>

    <div class="filter-bar">
      <div>
        <label>ğŸ” æœç´¢</label>
        <input type="text" id="searchInput" placeholder="ç¼–å· / åç§° / ç±»å‹..." />
      </div>
      <div>
        <label>ğŸ“Œ ç±»å‹</label>
        <select id="typeFilter">
          <option value="">å…¨éƒ¨ç±»å‹</option>
          <option value="é£Ÿå“">é£Ÿå“</option>
          <option value="é¥®æ–™">é¥®æ–™</option>
          <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
          <option value="è¯å“">è¯å“</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
      <div>
        <label>ğŸš¦ çŠ¶æ€</label>
        <select id="statusFilter">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="normal">æ­£å¸¸</option>
          <option value="near-expired">ä¸´æœŸ</option>
          <option value="expired">è¿‡æœŸ</option>
        </select>
      </div>
      <div style="align-self:flex-end;">
        <button id="searchBtn" onclick="applyFilters()">æœç´¢</button>
        <button class="add-product-btn" onclick="openAddModal()">â• æ–°å¢</button>
      </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤æŒ‰é’®æ”¾åœ¨è¡¨æ ¼å³ä¸Šè§’æˆ–å·¦ä¸Šè§’éƒ½å¯ä»¥ï¼Œè¿™é‡Œç»´æŒåŸä½æˆ–æ”¾è¡¨æ ¼ä¸Šæ–¹ -->
    <div style="text-align: right; margin-bottom: 10px;">
      <button id="batchDeleteBtn" class="batch-delete-btn" onclick="batchDeleteSelected()" disabled>æ‰¹é‡åˆ é™¤</button>
    </div>

    <div class="table-responsive">
      <table id="productTable">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"></th>
            <th>ç¼–å·</th>
            <th>åç§°</th>
            <th>ä¸€çº§ç±»å‹</th>
            <th>äºŒçº§ç±»å‹</th>
            <th>ç”Ÿäº§æ—¥æœŸ</th>
            <th>ä¿è´¨æœŸ(å¤©)</th>
            <th>è¿‡æœŸæ—¥æœŸ</th>
            <th>å‰©ä½™å¤©æ•°</th>
            <th>çŠ¶æ€</th>
            <th width="120">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </div>

    <!-- æ–°çš„åˆ†é¡µå¸ƒå±€ -->
    <div class="pagination-container">
      <div class="pagination-left" id="totalItemsInfo">å…± 0 æ¡æ•°æ®</div>

      <div class="pagination-right">
        <div>
          æ¯é¡µ:
          <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize()">
            <option value="10">10</option>
            <option value="15">15</option>
            <option value="30">30</option>
          </select>
        </div>

        <button class="btn-icon" onclick="prevPage()" id="prevBtn" title="ä¸Šä¸€é¡µ">&lt;</button>
        <span class="page-number-display" id="pageNumberDisplay">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
        <button class="btn-icon" onclick="nextPage()" id="nextBtn" title="ä¸‹ä¸€é¡µ">&gt;</button>

        <div class="jump-wrapper">
          è·³è‡³ <input type="number" id="jumpInput" class="jump-input" min="1"> é¡µ
          <button class="jump-btn" onclick="jumpToPage()">è·³è½¬</button>
        </div>
      </div>
    </div>

    <p class="notice">ğŸ’¡ ä¸´æœŸè§„åˆ™ï¼šâ‰¤30å¤©(å‰©1/2)ï½œ30~540å¤©(å‰©1/3)ï½œ>540å¤©(å‰©1/5)</p>

    <!-- æ¨¡æ€çª— -->
    <div class="modal-overlay" id="addModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">å•†å“ä¿¡æ¯</div>
          <button class="modal-close" onclick="closeAddModal()">&times;</button>
        </div>
        <form id="modalProductForm">
          <input type="hidden" id="modalEditId" />
          <input type="hidden" id="modalEditCode" />
          <div class="form-group">
            <label>å•†å“ç¼–å· (å”¯ä¸€)</label>
            <input type="text" id="modalCode" placeholder="å¦‚ï¼šMILK001" required />
          </div>
          <div class="form-group">
            <label>å•†å“åç§°</label>
            <input type="text" id="modalName" placeholder="å¦‚ï¼šçº¯ç‰›å¥¶" required />
          </div>
          <div class="form-group">
            <label>ä¸€çº§ç±»å‹</label>
            <select id="modalType1" required>
              <option value="">-- è¯·é€‰æ‹© --</option>
              <option value="é£Ÿå“">é£Ÿå“</option>
              <option value="é¥®æ–™">é¥®æ–™</option>
              <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
              <option value="è¯å“">è¯å“</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="form-group">
            <label>äºŒçº§ç±»å‹ (å¯é€‰)</label>
            <input type="text" id="modalType2" placeholder="å¦‚ï¼šä¹³åˆ¶å“ã€æ´—å‘æ°´" />
          </div>
          <div class="form-group">
            <label>ç”Ÿäº§æ—¥æœŸ</label>
            <input type="date" id="modalProduceDate" required />
          </div>
          <div class="form-group">
            <label>ä¿è´¨æœŸ (å¤©)</label>
            <div class="shelf-life-group">
              <select id="modalShelfLifeSelect" required>
                <option value="">-- é€‰æ‹© --</option>
                <option value="7">7 å¤©</option>
                <option value="21">21 å¤©</option>
                <option value="180">180 å¤© (åŠå¹´)</option>
                <option value="365">365 å¤© (ä¸€å¹´)</option>
                <option value="540">540 å¤© (18ä¸ªæœˆ)</option>
                <option value="730">730 å¤© (ä¸¤å¹´)</option>
                <option value="1095">1095 å¤© (ä¸‰å¹´)</option>
                <option value="custom">è‡ªå®šä¹‰</option>
              </select>
              <input type="number" id="modalShelfLifeCustom" placeholder="è¾“å…¥å¤©æ•°" min="1" style="display:none;" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="modal-btn modal-cancel" onclick="closeAddModal()">å–æ¶ˆ</button>
            <button type="submit" class="modal-btn modal-submit">ç¡®è®¤æäº¤</button>
          </div>
        </form>
      </div>
    </div>

    <div class="action-bar">
      <button class="action-btn-large export-btn" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º Excel</button>
      <button class="action-btn-large print-btn" onclick="printCurrentPage()">ğŸ–¨ï¸ æ‰“å°é¡µé¢</button>
      <button class="action-btn-large clear-btn" onclick="confirmClearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
      <button class="action-btn-large import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
    </div>

    <div class="import-area">
      <input type="file" id="importFile" accept=".csv" onchange="handleImportFile(this)" style="display:none;" />
      <span id="fileNameDisplay" style="color:#666; font-size:0.9em;">æœªé€‰æ‹©æ–‡ä»¶</span>
      <button onclick="importFromCSV()" id="importBtn" disabled>æ‰§è¡Œå¯¼å…¥</button>
    </div>
    <div class="csv-format">
      æ ¼å¼ï¼šç¼–å·, åç§°, ä¸€çº§ç±»å‹, äºŒçº§ç±»å‹, ç”Ÿäº§æ—¥æœŸ(YYYY-MM-DD), ä¿è´¨æœŸ(å¤©)
    </div>
  </div>

  <script>
    // ========== LeanCloud åˆå§‹åŒ– ==========
    const APP_ID = 'dwracmq52kDlwQkRaO2jPCFJ-gzGzoHsz';     // â† æ›¿æ¢
    const APP_KEY = 'DngFcXZMsMup5W3Z4QSYPMdw';   // â† æ›¿æ¢
    const SERVER_URL = 'https://api.leancloud.cn';

    try {
      AV.init({
        appId: APP_ID,
        appKey: APP_KEY,
        serverURL: SERVER_URL
      });
      console.log('âœ… LeanCloud åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
      console.error('âŒ LeanCloud åˆå§‹åŒ–å¤±è´¥:', error);
      alert('LeanCloud åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ App ID / Key æˆ–ç½‘ç»œè¿æ¥');
    }

    const ProductClass = AV.Object.extend('rourou_BananaNest');

    // ========== äº‘ç«¯æ•°æ®æ“ä½œ ==========
    async function getProducts() {
      const query = new AV.Query(ProductClass);
      query.limit(1000);
      try {
        const results = await query.find();
        return results.map(obj => ({
          id: obj.id,
          code: obj.get('code'),
          name: obj.get('name'),
          type1: obj.get('type1'),
          type2: obj.get('type2') || '',
          produceDate: obj.get('produceDate'),
          shelfLife: obj.get('shelfLife')
        }));
      } catch (error) {
        console.error('âŒ LeanCloud è¯·æ±‚å¤±è´¥:', error);
        alert('âŒ è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
        return [];
      }
    }

    async function addProduct(product) {
      const obj = new ProductClass();
      obj.set('code', product.code);
      obj.set('name', product.name);
      obj.set('type1', product.type1);
      obj.set('type2', product.type2);
      obj.set('produceDate', product.produceDate);
      obj.set('shelfLife', product.shelfLife);

      const acl = new AV.ACL();
      acl.setPublicReadAccess(true);
      acl.setPublicWriteAccess(true);
      obj.setACL(acl);

      try {
        await obj.save();
      } catch (error) {
        if (error.code === 125) {
          throw new Error('å•†å“ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å”¯ä¸€ç¼–å·');
        }
        throw new Error('æ·»åŠ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    async function updateProduct(id, product) {
      const obj = AV.Object.createWithoutData('rourou_BananaNest', id);
      obj.set('name', product.name);
      obj.set('type1', product.type1);
      obj.set('type2', product.type2);
      obj.set('produceDate', product.produceDate);
      obj.set('shelfLife', product.shelfLife);

      try {
        await obj.save();
      } catch (error) {
        throw new Error('æ›´æ–°å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    async function deleteProductById(id) {
      const obj = AV.Object.createWithoutData('rourou_BananaNest', id);
      try {
        await obj.destroy();
      } catch (error) {
        throw new Error('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    async function deleteProductsByIds(ids) {
      const objects = ids.map(id => AV.Object.createWithoutData('rourou_BananaNest', id));
      try {
        await AV.Object.destroyAll(objects);
      } catch (error) {
        throw new Error('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getProductStatus(product) {
      const now = new Date();
      const produceDate = new Date(product.produceDate);
      const expireDate = new Date(produceDate);
      expireDate.setDate(expireDate.getDate() + product.shelfLife);

      const diffTime = expireDate.getTime() - now.getTime();
      const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (now > expireDate) {
        return { status: 'expired', cls: 'status-expired', text: 'å·²è¿‡æœŸ', daysLeft };
      }

      let ratio;
      if (product.shelfLife <= 30) ratio = 0.5;
      else if (product.shelfLife <= 540) ratio = 1/3;
      else ratio = 0.2;

      const criticalDate = new Date(expireDate.getTime() - product.shelfLife * ratio * 24 * 60 * 60 * 1000);
      if (now >= criticalDate) {
        return { status: 'near-expired', cls: 'status-near-expired', text: 'ä¸´æœŸ', daysLeft };
      }
      return { status: 'normal', cls: 'status-normal', text: 'æ­£å¸¸', daysLeft };
    }

    // ========== æ¸²æŸ“ & é€»è¾‘ ==========
    let currentPage = 1;
    let itemsPerPage = 10; // é»˜è®¤æ¯é¡µ10æ¡
    let currentProducts = []; // å­˜å‚¨å½“å‰è¿‡æ»¤åçš„æ‰€æœ‰æ•°æ®

    async function renderProducts() {
      // è·å–æ•°æ®å¹¶ç­›é€‰ï¼ˆè¿™é‡Œç®€åŒ–é€»è¾‘ï¼Œæ¯æ¬¡éƒ½å…¨é‡è·å–å¹¶å‰ç«¯åˆ†é¡µï¼‰
      // å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ä¸ºåç«¯åˆ†é¡µ
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      let products = await getProducts();

      if (keyword) {
        products = products.filter(p =>
          p.code.toLowerCase().includes(keyword) ||
          p.name.toLowerCase().includes(keyword) ||
          p.type1.toLowerCase().includes(keyword) ||
          (p.type2 && p.type2.toLowerCase().includes(keyword))
        );
      }
      if (typeFilter) products = products.filter(p => p.type1 === typeFilter);
      if (statusFilter) products = products.filter(p => {
        const { status } = getProductStatus(p);
        return status === statusFilter;
      });

      // æ’åºï¼šæŒ‰è¿‡æœŸæ—¶é—´
      products.sort((a, b) => {
          const expireA = new Date(a.produceDate).getTime() + a.shelfLife * 24 * 60 * 60 * 1000;
          const expireB = new Date(b.produceDate).getTime() + b.shelfLife * 24 * 60 * 60 * 1000;
          return expireA - expireB;
      });

      currentProducts = products; // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›åˆ†é¡µä½¿ç”¨
      updatePagination(); // æ›´æ–°åˆ†é¡µè§†å›¾
    }

    function updatePagination() {
      const totalItems = currentProducts.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);

      // ä¿®æ­£å½“å‰é¡µç 
      if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * itemsPerPage;
      const pageItems = currentProducts.slice(start, start + itemsPerPage);

      const tbody = document.getElementById('productList');
      tbody.innerHTML = '';

      if (pageItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:#999;padding:30px;">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å•†å“</td></tr>`;
      } else {
        pageItems.forEach(p => {
          const { status, cls, text, daysLeft } = getProductStatus(p);
          const expireDate = new Date(p.produceDate);
          expireDate.setDate(expireDate.getDate() + p.shelfLife);
          const expireDateStr = formatDate(expireDate);

          // åç§°æˆªæ–­å¤„ç†ï¼šè¶…è¿‡5ä¸ªå­—åˆ™æˆªå–+...
          let displayName = p.name;
          if (displayName.length > 5) {
            displayName = displayName.substring(0, 5) + '...';
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="checkbox" class="item-checkbox" data-id="${p.id}" onchange="updateBatchDeleteButton()"></td>
            <td>${p.code}</td>
            <td title="${p.name}">${displayName}</td> <!-- titleå±æ€§æ˜¾ç¤ºå…¨å -->
            <td>${p.type1}</td>
            <td>${p.type2 || 'â€”'}</td>
            <td>${p.produceDate}</td>
            <td>${p.shelfLife}</td>
            <td>${expireDateStr}</td>
            <td>${daysLeft}</td>
            <td class="${cls}">${text}</td>
            <td>
              <div class="action-cell">
                <button class="action-btn edit-btn" onclick="startEdit('${p.id}', '${p.code}')">ç¼–è¾‘</button>
                <button class="action-btn delete-btn" onclick="deleteProduct('${p.id}')">åˆ é™¤</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
      document.getElementById('totalItemsInfo').innerText = `å…± ${totalItems} æ¡æ•°æ®`;
      document.getElementById('pageNumberDisplay').innerText = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages || 1} é¡µ`;

      document.getElementById('prevBtn').disabled = currentPage <= 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages || totalPages === 0;

      updateBatchDeleteButton();
    }

    // ========== åˆ†é¡µäº¤äº’å‡½æ•° ==========

    // æ”¹å˜æ¯é¡µæ¡æ•°
    function changePageSize() {
      const select = document.getElementById('pageSizeSelect');
      itemsPerPage = parseInt(select.value);
      currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      updatePagination();
    }

    // ä¸Šä¸€é¡µ
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
      }
    }

    // ä¸‹ä¸€é¡µ
    function nextPage() {
      const totalPages = Math.ceil(currentProducts.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
      }
    }

    // è·³è½¬åˆ°æŒ‡å®šé¡µ
    function jumpToPage() {
      const input = document.getElementById('jumpInput');
      const page = parseInt(input.value);
      const totalPages = Math.ceil(currentProducts.length / itemsPerPage);

      if (isNaN(page) || page < 1 || page > totalPages) {
        alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç  (1-${totalPages})`);
        return;
      }
      currentPage = page;
      updatePagination();
      input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    }

    // ========== è¡¨å•æäº¤ ==========
    function getShelfLifeValue() {
      const select = document.getElementById('modalShelfLifeSelect').value;
      const custom = document.getElementById('modalShelfLifeCustom').value.trim();
      if (select === 'custom') {
        const num = parseInt(custom);
        return isNaN(num) || num <= 0 ? null : num;
      } else if (select) {
        return parseInt(select);
      }
      return null;
    }

    async function handleModalFormSubmit(e) {
      e.preventDefault();
      const isEditing = !!document.getElementById('modalEditId').value;
      const code = document.getElementById('modalCode').value.trim();
      const name = document.getElementById('modalName').value.trim();
      const type1 = document.getElementById('modalType1').value;
      const type2 = document.getElementById('modalType2').value.trim();
      const produceDateStr = document.getElementById('modalProduceDate').value;
      let shelfLife = getShelfLifeValue();

      if (!code || !name || !type1 || !produceDateStr || shelfLife === null) {
        alert('è¯·å¡«å†™å®Œæ•´æœ‰æ•ˆä¿¡æ¯ï¼');
        return;
      }

      shelfLife = parseInt(shelfLife);

      const product = {
        code, name, type1, type2,
        produceDate: produceDateStr,
        shelfLife
      };

      try {
        if (isEditing) {
          await updateProduct(document.getElementById('modalEditId').value, product);
        } else {
          await addProduct(product);
        }
        await renderProducts();
        closeAddModal();
      } catch (err) {
        alert(err.message);
      }
    }

    // ========== å…¶ä»–æ“ä½œ ==========
    async function deleteProduct(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥å•†å“ï¼Ÿ')) return;
      try {
        await deleteProductById(id);
        await renderProducts();
      } catch (err) {
        alert(err.message);
      }
    }

    async function batchDeleteSelected() {
      const checkboxes = document.querySelectorAll('.item-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('è¯·å…ˆå‹¾é€‰å•†å“ï¼');
        return;
      }
      if (!confirm(`ç¡®å®šåˆ é™¤ ${checkboxes.length} ä¸ªå•†å“ï¼Ÿ`)) return;

      const ids = Array.from(checkboxes).map(cb => cb.dataset.id);
      try {
        await deleteProductsByIds(ids);
        await renderProducts();
      } catch (err) {
        alert(err.message);
      }
    }

    async function confirmClearAll() {
      if (!confirm('âš ï¸ ç¬¬ä¸€æ¬¡ç¡®è®¤ï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) return;
      if (!confirm('âš ï¸ ç¬¬äºŒæ¬¡ç¡®è®¤ï¼šçœŸçš„æ¸…ç©ºï¼Ÿ')) return;
      try {
        const products = await getProducts();
        const ids = products.map(p => p.id);
        if (ids.length > 0) await deleteProductsByIds(ids);
        await renderProducts();
        alert('âœ… æ‰€æœ‰å•†å“å·²æ¸…ç©ºï¼');
      } catch (err) {
        alert('æ¸…ç©ºå¤±è´¥ï¼š' + err.message);
      }
    }

    async function exportToCSV() {
      const products = await getProducts();
      if (products.length === 0) {
        alert('æ— æ•°æ®å¯å¯¼å‡º');
        return;
      }
      const headers = ['ç¼–å·', 'åç§°', 'ä¸€çº§ç±»å‹', 'äºŒçº§ç±»å‹', 'ç”Ÿäº§æ—¥æœŸ', 'ä¿è´¨æœŸ(å¤©)', 'è¿‡æœŸæ—¥æœŸ', 'å‰©ä½™å¤©æ•°', 'çŠ¶æ€'];
      const rows = products.map(p => {
        const { text, daysLeft } = getProductStatus(p);
        const expireDate = new Date(p.produceDate);
        expireDate.setDate(expireDate.getDate() + p.shelfLife);
        const expireDateStr = formatDate(expireDate);
        return [
          p.code, p.name, p.type1, p.type2 || '', p.produceDate,
          p.shelfLife, expireDateStr, daysLeft, text
        ].map(f => `"${f}"`).join(',');
      });
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ä¿è´¨æœŸç®¡ç†_${new Date().toLocaleDateString()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    let importedData = [];
    function handleImportFile(input) {
      const file = input.files[0];
      if (!file) {
        document.getElementById('fileNameDisplay').innerText = 'æœªé€‰æ‹©æ–‡ä»¶';
        document.getElementById('importBtn').disabled = true;
        return;
      }
      document.getElementById('fileNameDisplay').innerText = file.name;
      document.getElementById('importBtn').disabled = false;

      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        try {
          importedData = parseCSV(content);
        } catch (err) {
          alert('CSVæ ¼å¼é”™è¯¯ï¼š' + err.message);
          importedData = [];
          document.getElementById('importBtn').disabled = true;
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(csvText) {
      const lines = csvText.split(/\r?\n/);
      if (lines.length < 2) throw new Error('è‡³å°‘éœ€è¦ä¸€è¡Œæ•°æ®');
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const fields = splitCSVLine(line);
        if (fields.length < 6) continue;
        const [code, name, type1, type2, produceDate, shelfLifeStr] = fields;
        const shelfLife = parseInt(shelfLifeStr);
        if (isNaN(shelfLife) || shelfLife <= 0) throw new Error(`ç¬¬${i+1}è¡Œä¿è´¨æœŸå¿…é¡»æ˜¯æ­£æ•´æ•°`);
        const pd = new Date(produceDate);
        if (isNaN(pd.getTime())) throw new Error(`ç¬¬${i+1}è¡Œç”Ÿäº§æ—¥æœŸæ ¼å¼é”™è¯¯`);
        data.push({
          code: code.trim(),
          name: name.trim(),
          type1: type1.trim(),
          type2: type2.trim(),
          produceDate: produceDate,
          shelfLife
        });
      }
      return data;
    }

    function splitCSVLine(line) {
      const result = [];
      let current = '', inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else current += char;
      }
      result.push(current);
      return result;
    }

    async function importFromCSV() {
      if (importedData.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®');
        return;
      }
      try {
        const existing = await getProducts();
        const existingCodes = new Set(existing.map(p => p.code));
        const newProducts = [];
        for (const item of importedData) {
          if (existingCodes.has(item.code)) {
            continue;
          }
          newProducts.push(item);
        }
        if (newProducts.length === 0) {
          alert('æ²¡æœ‰æ–°å•†å“å¯å¯¼å…¥');
          return;
        }
        for (const p of newProducts) await addProduct(p);
        await renderProducts();
        alert(`âœ… æˆåŠŸå¯¼å…¥ ${newProducts.length} æ¡æ•°æ®`);
        document.getElementById('importFile').value = '';
        document.getElementById('fileNameDisplay').innerText = 'æœªé€‰æ‹©æ–‡ä»¶';
        document.getElementById('importBtn').disabled = true;
        importedData = [];
      } catch (err) {
        alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
      }
    }

    // ========== UI äº¤äº’ ==========
    function setShelfLifeUI(value) {
      const select = document.getElementById('modalShelfLifeSelect');
      const custom = document.getElementById('modalShelfLifeCustom');
      const options = ['7', '21', '180', '365', '540', '730', '1095'];
      if (options.includes(String(value))) {
        select.value = String(value);
        custom.style.display = 'none';
        custom.value = '';
      } else {
        select.value = 'custom';
        custom.style.display = 'block';
        custom.value = value;
      }
    }

    function updateBatchDeleteButton() {
      const selected = document.querySelectorAll('.item-checkbox:checked').length;
      document.getElementById('batchDeleteBtn').disabled = selected === 0;
    }

    function toggleAllCheckboxes() {
      const main = document.getElementById('selectAll');
      document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = main.checked);
      updateBatchDeleteButton();
    }

    function applyFilters() {
      currentPage = 1;
      renderProducts();
    }

    function printCurrentPage() {
      window.print();
    }

    function openAddModal() {
      document.getElementById('modalProductForm').reset();
      document.getElementById('modalShelfLifeCustom').style.display = 'none';
      document.getElementById('modalEditId').value = '';
      document.getElementById('modalEditCode').value = '';
      document.querySelector('#modalProductForm .modal-submit').innerText = 'ç¡®è®¤æ·»åŠ ';
      document.getElementById('addModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeAddModal() {
      document.getElementById('addModal').classList.remove('active');
      document.body.style.overflow = '';
    }

    async function startEdit(id, code) {
      const products = await getProducts();
      const product = products.find(p => p.code === code);
      if (!product) return;
      document.getElementById('modalEditId').value = id;
      document.getElementById('modalCode').value = code;
      document.getElementById('modalName').value = product.name;
      document.getElementById('modalType1').value = product.type1;
      document.getElementById('modalType2').value = product.type2;
      document.getElementById('modalProduceDate').value = product.produceDate;
      setShelfLifeUI(product.shelfLife);
      document.querySelector('#modalProductForm .modal-submit').innerText = 'æ›´æ–°å•†å“';
      openAddModal();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const shelfLifeSelect = document.getElementById('modalShelfLifeSelect');
      const shelfLifeCustom = document.getElementById('modalShelfLifeCustom');

      shelfLifeSelect.addEventListener('change', () => {
        if (shelfLifeSelect.value === 'custom') {
          shelfLifeCustom.style.display = 'block';
          shelfLifeCustom.required = true;
          shelfLifeSelect.required = false;
        } else {
          shelfLifeCustom.style.display = 'none';
          shelfLifeCustom.required = false;
          shelfLifeSelect.required = true;
          shelfLifeCustom.value = '';
        }
      });

      document.getElementById('modalProductForm').addEventListener('submit', handleModalFormSubmit);
      renderProducts();
    });
  </script>
</body>
</html>