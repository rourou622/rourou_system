<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>家庭费用清单</title>

  <!-- 1. 引入 LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>

  <!-- 2. 引入 Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- 3. 引入 ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <!-- 引入 Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* --- 莫兰迪配色定义 --- */
      --bg-body: #f2f4f6;
      --bg-card: #ffffff;

      --primary: #607d8b;
      /* 蓝灰 */
      --primary-hover: #455a64;
      --accent: #81a18b;
      /* 鼠尾草绿 */
      --danger: #d4a5a5;
      /* 干枯玫瑰 */
      --danger-hover: #c08b8b;

      --text-main: #374151;
      --text-sub: #6b7280;
      --border-color: #e5e7eb;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05);

      --radius-md: 8px;
      --radius-lg: 16px;
    }

    /* === 头部布局修正样式 (修复标题偏移) === */
    .app-header {
      position: relative;
      display: flex;
      justify-content: center;
      /* 让 h1 绝对居中 */
      align-items: center;
      margin-bottom: 30px;
      min-height: 40px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .user-info-box {
      position: absolute;
      /* 绝对定位到右侧，不占流式空间 */
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-sub);
      background: rgba(255, 255, 255, 0.8);
      /* 防止背景遮挡 */
    }

    /* 手机端适配：屏幕窄时取消绝对定位，改为垂直排列 */
    @media (max-width: 600px) {
      .app-header {
        flex-direction: column;
        gap: 15px;
        margin-bottom: 25px;
      }

      .user-info-box {
        position: static;
        transform: none;
        width: 100%;
        justify-content: center;
      }
    }

    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', 'Noto Sans SC', sans-serif;
      background-color: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    /* 登录/配置容器样式 */
    #authContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 90vh;
    }

    .auth-card {
      background: var(--bg-card);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 450px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 25px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-sub);
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      margin-bottom: -2px;
    }

    .auth-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
      font-weight: 700;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 15px;
      background: #f0f4f8;
      padding: 10px;
      border-radius: var(--radius-md);
    }

    /* 主应用容器，默认隐藏 */
    #appContainer {
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-card);
      padding: 30px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }

    h1 {
      text-align: center;
      font-size: 1.75rem;
      margin: 10px 0 30px;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* 通用表单与按钮 */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    /* 统一输入框样式与高度 */
    input,
    select,
    .custom-select-trigger {
      width: 100%;
      height: 42px;
      padding: 0 12px;
      line-height: 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 0.95rem;
      background-color: #f9fafb;
      color: var(--text-main);
      transition: all 0.3s ease;
      box-sizing: border-box;
      display: flex;
      align-items: center;
    }

    /* Date Input Styling */
    input[type="date"] {
      font-family: inherit;
      color: var(--text-main);
      cursor: pointer;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0.6;
      transition: 0.2s;
    }

    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    select {
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23374151%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 12px top 50%;
      background-size: 10px auto;
    }

    input:focus,
    select:focus,
    .custom-select-wrapper.open .custom-select-trigger {
      border-color: var(--primary);
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.15);
    }

    /* 按钮体系 */
    button {
      font-family: inherit;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .action-btn,
    .action-btn-large {
      border-radius: 6px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn {
      padding: 5px 10px;
      font-size: 0.8rem;
      margin: 0;
      white-space: nowrap;
    }

    .action-btn-large {
      padding: 12px 24px;
      font-size: 1rem;
      min-width: 100px;
      border-radius: var(--radius-md);
      width: 100%;
      /* Make default width full for mobile/auth */
    }

    @media(min-width: 768px) {
      .action-btn-large {
        width: auto;
      }

      .auth-card .action-btn-large {
        width: 100%;
      }
    }

    .btn-brown {
      background: var(--primary);
      color: white;
    }

    .btn-brown:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-dark {
      background: var(--danger);
      color: white;
    }

    .btn-dark:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }

    .btn-light {
      background: #fff;
      border: 1px solid var(--border-color);
      color: var(--text-main);
    }

    .btn-light:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #6b8c76;
      transform: translateY(-1px);
    }

    /* 统计概览条 */
    .summary {
      background: linear-gradient(135deg, #eceff1 0%, #cfd8dc 100%);
      padding: 16px 20px;
      border-radius: var(--radius-md);
      margin: 20px 0;
      font-weight: 500;
      color: var(--text-main);
      border-left: 5px solid var(--primary);
      /* Flex 布局 */
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-left {
      flex: 1;
    }

    .summary-right {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.4);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      color: var(--text-main);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .refresh-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 1.1em;
      margin-left: 8px;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .refresh-btn:hover {
      transform: rotate(180deg);
      color: var(--primary-hover);
    }

    @media (max-width: 768px) {
      .summary {
        flex-direction: column;
        align-items: flex-start;
      }

      .summary-right {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* 表格样式 */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 20px;
      font-size: 0.95rem;
    }

    th {
      padding: 15px;
      text-align: left;
      background-color: #f8fafc;
      color: var(--text-sub);
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    .action-cell-content {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .month-group-title {
      background: #e2e8f0;
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      padding-left: 15px;
    }

    /* 新增：记账人 Badge 样式 */
    .user-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      /* 圆角矩形，类似药丸的一半 */
      font-size: 0.8em;
      font-weight: 500;
      letter-spacing: 0.3px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* 布局与图表 */
    .charts-section {
      margin: 30px 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .chart-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      font-size: 1.1rem;
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 20px;
      margin: 25px 0;
      align-items: flex-end;
      flex-wrap: wrap;
      background: #f8fafc;
      padding: 20px;
      border-radius: var(--radius-md);
    }

    .filter-bar>div {
      flex: 1;
      min-width: 130px;
      width: auto;
    }

    /* 自定义下拉框 */
    .custom-select-wrapper {
      position: relative;
      user-select: none;
    }

    .custom-select-trigger {
      position: relative;
      cursor: pointer;
    }

    .custom-select-trigger::after {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-25%);
      border: 5px solid transparent;
      border-top-color: var(--text-sub);
    }

    .custom-options {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
    }

    .custom-select-wrapper.open .custom-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-options-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 5px 0;
    }

    .custom-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .custom-option:hover {
      background-color: #f1f5f9;
    }

    .custom-option input {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: var(--primary);
    }

    .custom-footer {
      display: flex;
      border-top: 1px solid var(--border-color);
      padding: 10px;
      gap: 10px;
      background: #f8fafc;
    }

    .custom-footer button {
      padding: 8px;
      flex: 1;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .btn-cancel {
      background: #e5e7eb;
    }

    .btn-confirm {
      background: var(--primary);
      color: white;
    }

    /* 模态框 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: #fff;
      padding: 30px;
      border-radius: var(--radius-lg);
      width: 90%;
      max-width: 480px;
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }

    /* 分页样式 */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px 0;
      padding: 15px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 15px;
    }

    .pagination-jumper {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f8fafc;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .pagination-input {
      width: 50px !important;
      height: 28px !important;
      padding: 4px !important;
      text-align: center;
      margin: 0 5px;
      line-height: normal !important;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #fff;
    }

    .btn-page-nav {
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.1rem;
      padding: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 28px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-page-nav:hover {
      color: var(--primary);
      background: #e2e8f0;
    }

    .btn-jump {
      margin-left: 10px;
      padding: 4px 12px;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    .btn-jump:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* 预算条 */
    #budgetProgressBar {
      margin-top: 15px;
      padding: 4px;
      background: #eceff1;
      border-radius: 20px;
      position: relative;
      height: 36px;
      overflow: hidden;
    }

    #budgetBase {
      border-radius: 18px !important;
    }

    /* 家庭共享提示 */
    .family-badge {
      background: #fff3e0;
      color: #e65100;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      border: 1px solid #ffe0b2;
      margin-left: 10px;
    }
  </style>
</head>

<body>

  <!-- ================= 0. 登录/配置 界面 ================= -->
  <div id="authContainer">
    <div class="auth-card">
      <h2 class="auth-title">家庭费用清单</h2>
      <p style="text-align: center; color: var(--text-sub); margin-bottom: 20px;">
        Family: Big Banana House
      </p>

      <!-- 配置表单 (如果没有 appId/key) -->
      <div id="configSection" style="display: none;">
        <div class="helper-text">
          请前往 LeanCloud 控制台获取应用的 App ID 和 App Key。<br>
          控制台 > 设置 > 应用凭证
        </div>
        <div class="form-group">
          <label>App ID</label>
          <input type="text" id="configAppId" placeholder="输入 App ID">
        </div>
        <div class="form-group">
          <label>App Key</label>
          <input type="password" id="configAppKey" placeholder="输入 App Key">
        </div>
        <div class="form-group">
          <label>REST API Server URL</label>
          <input type="text" id="configServerUrl" placeholder="https://..." value="https://api.leancloud.cn">
        </div>
        <button class="action-btn-large btn-brown" onclick="saveConfig()">保存配置</button>
      </div>

      <!-- 登录/注册表单 (如果已有配置) -->
      <div id="authSection" style="display: none;">
        <div class="auth-tabs">
          <div class="auth-tab active" id="tabLogin" onclick="switchAuthMode('login')">登录</div>
          <div class="auth-tab" id="tabSignup" onclick="switchAuthMode('signup')">注册</div>
        </div>

        <div class="form-group">
          <label>用户名</label>
          <input type="text" id="authUsername" placeholder="请输入用户名">
        </div>
        <div class="form-group">
          <label>密码</label>
          <input type="password" id="authPassword" placeholder="请输入密码">
        </div>

        <button class="action-btn-large btn-brown" id="authActionBtn" onclick="handleAuthAction()">登录</button>

        <div style="text-align: center; margin-top: 20px;">
          <button class="action-btn" style="color: var(--text-sub); text-decoration: underline;"
            onclick="clearConfig()">重置 App 配置</button>
        </div>
      </div>

      <!-- 加载中 -->
      <div id="loadingSection" style="display: none; text-align: center; color: var(--text-sub);">
        正在初始化...
      </div>

    </div>
  </div>


  <!-- ================= 主应用界面 ================= -->
  <div class="container" id="appContainer">

    <!-- 1. 头部区域：已修复 UI 偏移 -->
    <div class="app-header">
      <h1>家庭费用清单</h1>
      <div class="user-info-box">
        <span id="currentUserDisplay" style="font-weight: 500; color: var(--primary);"></span>
        <button class="action-btn btn-light" onclick="logout()"
          style="padding: 4px 12px; font-size: 0.85rem;">退出</button>
      </div>
    </div>

    <!-- 2. 新增按钮 -->
    <div style="text-align: center; margin-bottom: 25px;">
      <button class="action-btn-large btn-brown" onclick="openAddModal()">
        <span style="margin-right:5px; font-size:1.2em; line-height:1;">+</span> 新增支出
      </button>
    </div>

    <!-- 3. 统计栏区域 (JS动态渲染) -->
    <div class="summary" id="summaryBox">
      <!-- 动态内容将通过 JS 渲染 -->
    </div>

    <!-- 4. 图表区域 -->
    <div class="charts-section">
      <!-- 柱状图 & 预算条 -->
      <div class="chart-container">
        <div class="chart-title">
          <span id="budgetTitle">各月总支出</span>
          <button id="editBudgetBtn" class="action-btn btn-light"
            style="margin-left:8px; font-size:0.75em;">修改预算</button>
        </div>
        <canvas id="monthlyBarChart" height="180"></canvas>
        <div id="budgetProgressBar">
          <div id="budgetBase" style="height:100%; width:100%; background:#cfd8dc; position:relative; overflow:hidden;">
            <div id="progressGreen"
              style="height:100%; width:0%; background:linear-gradient(to right, #a5d6a7, #81c784); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressRed"
              style="height:100%; width:0%; background:linear-gradient(to right, #ef9a9a, #e57373); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressText"
              style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:0.85em; z-index:2;">
            </div>
          </div>
        </div>
      </div>

      <!-- 饼图 -->
      <div class="chart-container">
        <div class="chart-title">类型占比 <span
            style="font-size:0.8em; color:var(--text-sub); font-weight:400;">(点击扇区筛选)</span></div>
        <div id="echartsPie" style="width: 100%; height: 350px;"></div>
      </div>
    </div>

    <!-- 5. 筛选栏 -->
    <div class="filter-bar">
      <div>
        <label>类型筛选 (多选)</label>
        <div class="custom-select-wrapper" id="typeSelectWrapper">
          <div class="custom-select-trigger" id="typeSelectTrigger">全部类型</div>
          <div class="custom-options">
            <div class="custom-options-list" id="typeOptionsList"></div>
            <div class="custom-footer">
              <button class="btn-cancel" onclick="cancelTypeFilter()">取消</button>
              <button class="btn-confirm" onclick="confirmTypeFilter()">确认</button>
            </div>
          </div>
        </div>
      </div>
      <div style="flex: 2; display: flex; gap: 10px;">
        <div style="flex: 1;">
          <label for="startDate">明细开始日期</label>
          <input type="date" id="startDate" onchange="applyDateRangeFilter()" />
        </div>
        <div style="flex: 1;">
          <label for="endDate">明细结束日期</label>
          <input type="date" id="endDate" onchange="applyDateRangeFilter()" />
        </div>
      </div>
      <div>
        <label for="monthFilter">统计月份筛选</label>
        <select id="monthFilter" onchange="applyMonthOrSearchFilter()">
          <option value="">全部月份</option>
        </select>
      </div>
      <div>
        <label for="memberFilter">家庭成员筛选</label>
        <select id="memberFilter" onchange="applyMonthOrSearchFilter()">
          <option value="">全部成员</option>
        </select>
      </div>
      <div>
        <label for="searchInput">搜索（二级类型）</label>
        <input type="text" id="searchInput" placeholder="输入关键词..." oninput="applyMonthOrSearchFilter()" />
      </div>
      <div style="flex: 0 0 auto;">
        <button class="action-btn btn-accent" onclick="resetFilters()" style="height: 42px;">恢复默认</button>
      </div>
    </div>

    <!-- 6. 表格区域 -->
    <div style="overflow-x: auto;">
      <table id="expenseTable">
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                style="height:auto;"></th>
            <th>统计月份</th>
            <th>消费日期</th>
            <th>一级类型</th>
            <th>记账人</th> <!-- 新增：记账人列 -->
            <th>二级类型</th>
            <th>金额</th>
            <th style="width: 160px;">操作</th>
          </tr>
        </thead>
        <tbody id="expenseList"></tbody>
      </table>
    </div>

    <!-- 7. 分页区域 -->
    <div class="pagination-container">
      <div style="display:flex; align-items:center;">
        <span style="color:var(--text-sub); font-size:0.9rem; margin-right:5px;">每页:</span>
        <select id="pageSizeSelect" onchange="changePageSize()"
          style="width:auto; height:30px; line-height:30px; padding:0 25px 0 10px; font-size:0.9rem;">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>

      <div class="pagination-jumper">
        <button class="btn-page-nav" onclick="changePageRelative(-1)" title="上一页">❮</button>
        <span style="margin: 0 6px;">第</span>
        <input type="number" id="pageJumpInput" class="pagination-input" value="1" min="1"
          onkeypress="if(event.keyCode==13) jumpToPage()">
        <span style="margin: 0 6px;">页 / 共 <span id="totalPagesDisplay" style="font-weight:bold;">1</span> 页</span>
        <button class="btn-page-nav" onclick="changePageRelative(1)" title="下一页">❯</button>
        <button class="btn-jump" onclick="jumpToPage()">跳转</button>
      </div>
    </div>

    <!-- 8. 批量操作按钮 -->
    <div style="text-align: right;">
      <button id="batchDeleteBtn" class="action-btn btn-dark" style="opacity:0.8; font-size:0.9rem; padding:8px 16px;"
        onclick="batchDeleteSelected()" disabled>批量删除</button>
    </div>

    <!-- 9. 底部功能栏 (删除同步功能，仅保留导出和打印) -->
    <div class="action-bar">
      <button class="action-btn-large btn-light" onclick="exportToCSV()">导出 CSV</button>
      <button class="action-btn-large btn-light" onclick="printCurrentPage()">打印</button>

      <!-- 之前的同步按钮已移除 -->
    </div>

  </div>

  <!-- 模态框 -->
  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">新增支出</div>
        <button class="action-btn" style="background:none; color:#999; font-size:1.5em; padding:0;"
          onclick="closeAddModal()">&times;</button>
      </div>
      <form id="modalExpenseForm">
        <input type="hidden" id="modalEditId" />
        <div class="form-group">
          <label>消费日期</label>
          <input type="date" id="modalDate" required />
        </div>
        <div class="form-group">
          <label>一级类型</label>
          <select id="modalType1" required>
            <option value="">-- 请选择 --</option>
          </select>
        </div>
        <div class="form-group">
          <label>二级类型</label>
          <input type="text" id="modalType2" placeholder="如：奶茶" />
        </div>
        <div class="form-group">
          <label>金额</label>
          <div style="position:relative;">
            <span style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#999;">¥</span>
            <input type="number" step="0.01" id="modalAmount" required min="0.01" style="padding-left:25px;" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:15px; margin-top:30px;">
          <button type="button" class="action-btn-large btn-cancel" style="width:auto;"
            onclick="closeAddModal()">取消</button>
          <button type="submit" class="action-btn-large btn-confirm" style="width:auto;">确认保存</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== 配置与全局变量 ==========
    const MY_FAMILY_ID = "big banana house";

    let BUDGET_STORAGE_KEY = 'expense_budget_' + MY_FAMILY_ID;

    const EXPENSE_CLASS_NAME = 'rourou_YellowChamberPot';

    const EXPENSE_TYPES = ['吃', '喝', '交通', '话费', '购物', '游戏', '充值', '电水费', '房租', '宠物', '其他'];

    const MORANDI_PALETTE = [
      '#90a4ae', '#a1887f', '#e57373', '#81c784', '#64b5f6',
      '#ffb74d', '#ba68c8', '#4db6ac', '#ffd54f', '#a1887f', '#7986cb'
    ];

    // --- 新增：用户标签颜色盘（区别于图表颜色）---
    // 类似于微信/钉钉头像的随机底色，看起来比较柔和
    const USER_PALETTE = [
      { bg: '#e3f2fd', text: '#1565c0' }, // 蓝
      { bg: '#fce4ec', text: '#c2185b' }, // 粉
      { bg: '#f3e5f5', text: '#7b1fa2' }, // 紫
      { bg: '#e8f5e9', text: '#2e7d32' }, // 绿
      { bg: '#fff3e0', text: '#ef6c00' }, // 橙
      { bg: '#e0f7fa', text: '#006064' }, // 青
      { bg: '#ffebee', text: '#b71c1c' }, // 鲜红
      { bg: '#e3f2fd', text: '#0d47a1' }, // 深蓝
      { bg: '#f3e5f5', text: '#4a148c' }, // 深紫
      { bg: '#fffde7', text: '#f57f17' }, // 深黄
      { bg: '#e0f2f1', text: '#004d40' }  // 深青
    ];
    const USER_COLOR_MAP = {
      "hundun": { bg: '#fce4ec', text: '#c2185b' },
      "rourou622": { bg: '#e8f5e9', text: '#2e7d32' },
      "其他": { bg: '#f5f5f5', text: '#616161' }  // 默认灰色
    };
    let ExpenseClass = null;
    let currentUser = null;

    let allExpenses = [];
    let filteredExpenses = [];
    let monthlyBarChart = null;
    let echartsPieInstance = null;
    let activeSelectedTypes = ['全部类型'];
    let tempSelectedTypes = ['全部类型'];
    let currentPage = 1;
    let pageSize = 10;
    let currentBudget = 9000;

    let analysisModeIndex = 0;
    const ANALYSIS_MODE_COUNT = 17;

    let authMode = 'login';

    // ========== 认证与初始化逻辑 ==========

    window.onload = () => {
      checkAppConfig();
    };

    // --- 辅助函数：根据用户名生成固定的颜色 ---
    // 【修改建议】根据名字直接查表
    function getUserColor(username) {
      // 如果名字在表里，就用表里的颜色；找不到就用默认的“其他”
      return USER_COLOR_MAP[username] || USER_COLOR_MAP["其他"];
    }

    // --- 同步函数已移除 ---

    function checkAppConfig() {
      const id = localStorage.getItem('lc_app_id');
      const key = localStorage.getItem('lc_app_key');
      const url = localStorage.getItem('lc_server_url');

      if (id && key && url) {
        initLeanCloud(id, key, url);
      } else {
        showConfigForm();
      }
    }

    function initLeanCloud(id, key, url) {
      document.getElementById('configSection').style.display = 'none';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';

      try {
        if (typeof AV === 'undefined') {
          alert('LeanCloud SDK 加载失败，请检查网络');
          return;
        }
        AV.init({ appId: id, appKey: key, serverURLs: url });
        ExpenseClass = AV.Object.extend(EXPENSE_CLASS_NAME);

        checkLoginStatus();
      } catch (e) {
        console.error(e);
        alert('初始化失败，请检查配置');
        clearConfig();
      }
    }

    function checkLoginStatus() {
      currentUser = AV.User.current();
      document.getElementById('loadingSection').style.display = 'none';

      if (currentUser) {
        enterApp();
      } else {
        showAuthForm();
      }
    }

    function enterApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('currentUserDisplay').textContent = `用户: ${currentUser.getUsername()}`;

      initCustomDropdown();
      renderExpenses();
      window.onresize = () => { if (echartsPieInstance) echartsPieInstance.resize(); };
    }

    function logout() {
      AV.User.logOut();
      location.reload();
    }

    // --- 配置表单逻辑 ---
    function showConfigForm() {
      document.getElementById('configSection').style.display = 'block';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'none';
    }

    function saveConfig() {
      const id = document.getElementById('configAppId').value.trim();
      const key = document.getElementById('configAppKey').value.trim();
      const url = document.getElementById('configServerUrl').value.trim();

      if (!id || !key || !url) {
        alert('请填写完整配置');
        return;
      }

      localStorage.setItem('lc_app_id', id);
      localStorage.setItem('lc_app_key', key);
      localStorage.setItem('lc_server_url', url);

      initLeanCloud(id, key, url);
    }

    function clearConfig() {
      localStorage.removeItem('lc_app_id');
      localStorage.removeItem('lc_app_key');
      localStorage.removeItem('lc_server_url');
      location.reload();
    }

    // --- 登录/注册逻辑 ---
    function showAuthForm() {
      document.getElementById('authSection').style.display = 'block';
      switchAuthMode('login');
    }

    function switchAuthMode(mode) {
      authMode = mode;
      const btn = document.getElementById('authActionBtn');
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');

      if (mode === 'login') {
        tabLogin.classList.add('active');
        tabSignup.classList.remove('active');
        btn.textContent = '立即登录';
        btn.className = 'action-btn-large btn-brown';
      } else {
        tabLogin.classList.remove('active');
        tabSignup.classList.add('active');
        btn.textContent = '注册并登录';
        btn.className = 'action-btn-large btn-accent';
      }
    }

    async function handleAuthAction() {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value.trim();

      if (!u || !p) return alert('请输入用户名和密码');

      try {
        if (authMode === 'login') {
          await AV.User.logIn(u, p);
        } else {
          const user = new AV.User();
          user.setUsername(u);
          user.setPassword(p);
          await user.signUp();
        }
        checkLoginStatus();
      } catch (error) {
        alert('操作失败: ' + error.message);
      }
    }


    // ========== 业务逻辑 (下拉框/表格/图表) ==========

    function initCustomDropdown() {
      const list = document.getElementById('typeOptionsList');
      list.innerHTML = '';
      const allDiv = document.createElement('div');
      allDiv.className = 'custom-option';
      allDiv.innerHTML = `<input type="checkbox" value="全部类型" id="cb_all"><span>全部类型</span>`;
      allDiv.onclick = (e) => toggleDropdownItem(e, '全部类型');
      list.appendChild(allDiv);

      EXPENSE_TYPES.forEach(type => {
        const div = document.createElement('div');
        div.className = 'custom-option';
        div.innerHTML = `<input type="checkbox" value="${type}" id="cb_${type}"><span>${type}</span>`;
        div.onclick = (e) => toggleDropdownItem(e, type);
        list.appendChild(div);
      });

      const modalSelect = document.getElementById('modalType1');
      modalSelect.innerHTML = '<option value="">-- 请选择 --</option>';
      EXPENSE_TYPES.forEach(t => { modalSelect.add(new Option(t, t)); });

      const wrapper = document.getElementById('typeSelectWrapper');
      const trigger = document.getElementById('typeSelectTrigger');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        wrapper.classList.toggle('open');
        if (wrapper.classList.contains('open')) {
          tempSelectedTypes = [...activeSelectedTypes];
          renderDropdownCheckboxes();
        }
      });

      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) wrapper.classList.remove('open');
      });
    }

    function renderDropdownCheckboxes() {
      const isAll = tempSelectedTypes.includes('全部类型');
      document.getElementById('cb_all').checked = isAll;
      EXPENSE_TYPES.forEach(type => {
        const cb = document.getElementById(`cb_${type}`);
        if (isAll) { cb.checked = true; } else { cb.checked = tempSelectedTypes.includes(type); }
      });
    }

    function toggleDropdownItem(e, value) {
      if (e.target.tagName !== 'INPUT') {
        const cb = e.currentTarget.querySelector('input');
        cb.checked = !cb.checked;
      }
      if (value === '全部类型') {
        const isChecked = document.getElementById('cb_all').checked;
        tempSelectedTypes = isChecked ? ['全部类型'] : [];
      } else {
        const isChecked = document.getElementById(`cb_${value}`).checked;
        if (tempSelectedTypes.includes('全部类型')) {
          tempSelectedTypes = [...EXPENSE_TYPES];
          if (!isChecked) tempSelectedTypes = tempSelectedTypes.filter(t => t !== value);
        } else {
          if (isChecked) tempSelectedTypes.push(value);
          else tempSelectedTypes = tempSelectedTypes.filter(t => t !== value);
        }
        const allSelected = EXPENSE_TYPES.every(t => tempSelectedTypes.includes(t));
        if (allSelected) tempSelectedTypes = ['全部类型'];
      }
      renderDropdownCheckboxes();
    }

    function confirmTypeFilter() {
      activeSelectedTypes = [...tempSelectedTypes];
      if (activeSelectedTypes.length === 0) activeSelectedTypes = ['全部类型'];
      updateTriggerText();
      document.getElementById('typeSelectWrapper').classList.remove('open');
      renderExpenses();
    }

    function cancelTypeFilter() {
      document.getElementById('typeSelectWrapper').classList.remove('open');
    }

    function updateTriggerText() {
      const trigger = document.getElementById('typeSelectTrigger');
      if (activeSelectedTypes.includes('全部类型')) {
        trigger.textContent = '全部类型';
      } else if (activeSelectedTypes.length === 1) {
        trigger.textContent = activeSelectedTypes[0];
      } else {
        trigger.textContent = `${activeSelectedTypes[0]} 等 ${activeSelectedTypes.length} 项`;
      }
    }

    // ========== 数据操作 (已修改：查询家庭ID) ==========
    function computeStatMonth(dateStr) {
      const d = new Date(dateStr);
      let y = d.getFullYear(), m = d.getMonth() + 1;
      if (d.getDate() <= 4) {
        if (m === 1) { m = 12; y--; } else { m--; }
      }
      return `${y}-${String(m).padStart(2, '0')}`;
    }

    async function getExpenses() {
      if (!ExpenseClass || !currentUser) return [];
      const query = new AV.Query(ExpenseClass);

      query.equalTo('familyId', MY_FAMILY_ID);
      // --- 关键修改：包含 owner 字段，以便获取用户名 ---
      query.include('owner');

      query.addDescending('date');
      query.addDescending('createdAt');
      query.limit(1000);
      try {
        const results = await query.find();
        return results.map(obj => {
          // 获取关联的用户对象
          const ownerObj = obj.get('owner');
          // 如果有 owner 对象则取 username，否则显示未知
          const username = ownerObj ? ownerObj.getUsername() : '未知';

          return {
            id: obj.id,
            date: obj.get('date'),
            type1: obj.get('type1'),
            type2: obj.get('type2') || '',
            amount: parseFloat(obj.get('amount')) || 0,
            statMonth: computeStatMonth(obj.get('date')),
            username: username // 增加 username 字段
          };
        });
      } catch (err) { console.error(err); return []; }
    }

    // ========== 图表逻辑 ==========
    function renderCharts() {
      const groups = {};
      allExpenses.forEach(e => {
        if (!groups[e.statMonth]) groups[e.statMonth] = 0;
        groups[e.statMonth] += e.amount;
      });

      const now = new Date();
      const currentStatMonth = computeStatMonth(now.toISOString());

      const months = [];
      for (let i = 5; i >= 0; i--) {
        let [y, m] = currentStatMonth.split('-').map(Number);
        m = m - i;
        while (m <= 0) { m += 12; y--; }
        while (m > 12) { m -= 12; y++; }
        months.push(`${y}-${String(m).padStart(2, '0')}`);
      }

      const totals = months.map(m => groups[m] || 0);

      // 读取预算，使用家庭公用 Key
      currentBudget = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}')[currentStatMonth] || 9000;

      document.getElementById('budgetTitle').textContent = `各月总支出 (预算 ¥${currentBudget})`;

      const ctxBar = document.getElementById('monthlyBarChart').getContext('2d');
      if (monthlyBarChart) monthlyBarChart.destroy();
      monthlyBarChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: '支出',
            data: totals,
            backgroundColor: months.map(m => (m === currentStatMonth && (groups[m] || 0) > currentBudget) ? '#e57373' : '#90a4ae'),
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: { annotations: { line1: { type: 'line', yMin: currentBudget, yMax: currentBudget, borderColor: '#b0bec5', borderDash: [5, 5], borderWidth: 2 } } }
          },
          scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
        }
      });

      const curTotal = groups[currentStatMonth] || 0;
      const percent = Math.min(100, (curTotal / currentBudget) * 100);
      const remain = currentBudget - curTotal;
      if (remain >= 0) {
        document.getElementById('progressGreen').style.width = (remain / currentBudget * 100) + '%';
        document.getElementById('progressRed').style.width = '0%';
        document.getElementById('progressText').textContent = `剩余 ¥${remain.toFixed(0)} (${(100 - percent).toFixed(0)}%)`;
        document.getElementById('progressText').style.color = "#2c3e50";
      } else {
        document.getElementById('progressGreen').style.width = '0%';
        document.getElementById('progressRed').style.width = Math.min(100, (Math.abs(remain) / currentBudget * 100)) + '%';
        document.getElementById('progressText').textContent = `超支 ¥${Math.abs(remain).toFixed(0)}`;
        document.getElementById('progressText').style.color = "#b71c1c";
      }

      renderEChartsPie();
    }

    function renderEChartsPie() {
      const dom = document.getElementById('echartsPie');
      if (!echartsPieInstance) {
        echartsPieInstance = echarts.init(dom);
        echartsPieInstance.on('click', function (params) { handleChartClick(params.name); });
        echartsPieInstance.on('legendselectchanged', function (params) { handleChartClick(params.name); });
      }

      let pieSourceData = getTimeFilteredExpenses();

      const typeMap = {};
      pieSourceData.forEach(e => { typeMap[e.type1] = (typeMap[e.type1] || 0) + e.amount; });

      const isAllSelected = activeSelectedTypes.includes('全部类型');
      const dataForChart = Object.keys(typeMap).map(k => {
        const isSelected = isAllSelected || activeSelectedTypes.includes(k);
        return {
          value: typeMap[k],
          name: k,
          itemStyle: { opacity: isSelected ? 1 : 0.1, color: isSelected ? undefined : '#cfd8dc' },
          label: { show: isSelected, color: '#546e7a' },
          labelLine: { show: isSelected, lineStyle: { color: '#cfd8dc' } }
        };
      });

      const legendSelectedState = {};
      EXPENSE_TYPES.forEach(t => legendSelectedState[t] = true);

      const option = {
        color: MORANDI_PALETTE,
        tooltip: {
          trigger: 'item',
          backgroundColor: 'rgba(255,255,255,0.9)',
          formatter: function (params) { return `${params.name}<br/>¥${params.value.toFixed(2)} (${params.percent}%)`; }
        },
        legend: {
          bottom: 0,
          left: 'center',
          padding: [5, 5],
          itemWidth: 15,
          itemHeight: 10,
          textStyle: { color: '#607d8b' },
          width: '95%',
          selected: legendSelectedState
        },
        series: [
          {
            name: '支出类型',
            type: 'pie',
            radius: ['35%', '55%'],
            center: ['50%', '40%'],
            avoidLabelOverlap: true,
            itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
            data: dataForChart,
            selectedMode: 'multiple', selectedOffset: 10
          }
        ]
      };

      echartsPieInstance.setOption(option, true);
    }

    function handleChartClick(typeName) {
      if (activeSelectedTypes.includes('全部类型')) {
        activeSelectedTypes = [typeName];
      } else {
        if (activeSelectedTypes.includes(typeName)) {
          activeSelectedTypes = activeSelectedTypes.filter(t => t !== typeName);
          if (activeSelectedTypes.length === 0) activeSelectedTypes = ['全部类型'];
        } else {
          activeSelectedTypes.push(typeName);
        }
      }
      tempSelectedTypes = [...activeSelectedTypes];
      updateTriggerText();
      renderDropdownCheckboxes();
      renderExpenses();
    }

    // ========== 渲染逻辑 ==========

    function getTimeFilteredExpenses() {
      let temp = allExpenses;

      const memberFilter = document.getElementById('memberFilter').value;
      if (memberFilter) temp = temp.filter(e => e.username === memberFilter);

      const mFilter = document.getElementById('monthFilter').value;
      if (mFilter) temp = temp.filter(e => e.statMonth === mFilter);

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate) temp = temp.filter(e => e.date >= startDate);
      if (endDate) temp = temp.filter(e => e.date <= endDate);

      return temp;
    }

    async function renderExpenses() {
      if (!currentUser) return; // 未登录不渲染

      // 如果是刚登录进来，allExpenses 为空，先获取数据
      if (allExpenses.length === 0) {
        allExpenses = await getExpenses();
        const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
        const sel = document.getElementById('monthFilter');

        let targetVal = sel.value;
        sel.innerHTML = '<option value="">全部月份</option>';
        months.forEach(m => sel.add(new Option(m, m)));

        const currentMonth = computeStatMonth(new Date().toISOString());
        if (!targetVal && months.includes(currentMonth)) {
          targetVal = currentMonth;
        }

        if (targetVal) sel.value = targetVal;
      }

      // --- 动态渲染成员下拉框 ---
      // 每次都检查是否有新成员，但保持选中状态
      const memberSel = document.getElementById('memberFilter');
      const currentMember = memberSel.value;
      const members = [...new Set(allExpenses.map(e => e.username))].filter(u => u && u !== '未知');

      // 保存旧的选中值，重新渲染
      memberSel.innerHTML = '<option value="">全部成员</option>';
      members.forEach(u => memberSel.add(new Option(u, u)));
      if (currentMember && members.includes(currentMember)) {
        memberSel.value = currentMember;
      }

      let temp = getTimeFilteredExpenses();

      if (!activeSelectedTypes.includes('全部类型')) {
        temp = temp.filter(e => activeSelectedTypes.includes(e.type1));
      }

      const kw = document.getElementById('searchInput').value.trim();
      if (kw) temp = temp.filter(e => e.type2.includes(kw));

      filteredExpenses = temp;

      const totalPages = Math.ceil(filteredExpenses.length / pageSize) || 1;
      if (currentPage > totalPages) currentPage = 1;
      document.getElementById('totalPagesDisplay').innerText = totalPages;
      document.getElementById('pageJumpInput').max = totalPages;
      document.getElementById('pageJumpInput').value = currentPage;

      renderTable();
      renderCharts();
      updateAnalysis();
    }

    function applyMonthOrSearchFilter() {
      currentPage = 1;
      renderExpenses();
    }

    function applyDateRangeFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if (start && end && start > end) {
        alert('开始时间不能晚于结束时间');
        document.getElementById('startDate').value = '';
        return;
      }
      currentPage = 1;
      renderExpenses();
    }

    function resetFilters() {
      activeSelectedTypes = ['全部类型'];
      tempSelectedTypes = ['全部类型'];
      updateTriggerText();
      renderDropdownCheckboxes();
      document.getElementById('typeSelectWrapper').classList.remove('open');

      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      const sel = document.getElementById('monthFilter');
      const memSel = document.getElementById('memberFilter');
      memSel.value = ""; // 重置成员筛选

      const currentMonth = computeStatMonth(new Date().toISOString());
      let found = false;
      for (let i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === currentMonth) {
          sel.value = currentMonth;
          found = true;
          break;
        }
      }
      if (!found) sel.value = "";

      document.getElementById('searchInput').value = '';

      currentPage = 1;
      renderExpenses();
    }

    function renderTable() {
      const tbody = document.getElementById('expenseList');
      tbody.innerHTML = '';

      const start = (currentPage - 1) * pageSize;
      const pageData = filteredExpenses.slice(start, start + pageSize);

      const summaryBox = document.getElementById('summaryBox');

      const targetData = filteredExpenses;
      const targetTotal = targetData.reduce((a, b) => a + b.amount, 0);
      const targetCount = targetData.length;

      const leftContent = `
        <div class="summary-left">
          <span style="color:var(--primary); font-weight:bold;">筛选结果：共 ${targetCount} 笔，总额 ¥${formatMoney(targetTotal)}</span>
        </div>`;

      const rightContent = `
        <div class="summary-right">
            <span id="analysisText" style="margin-right:5px;">正在生成分析...</span>
            <button class="refresh-btn" onclick="switchAnalysisMode()" title="随机刷新分析">↻</button>
        </div>`;

      summaryBox.innerHTML = leftContent + rightContent;

      const groups = {};
      pageData.forEach(e => {
        if (!groups[e.statMonth]) groups[e.statMonth] = [];
        groups[e.statMonth].push(e);
      });

      Object.keys(groups).sort().reverse().forEach(mon => {
        const list = groups[mon];
        const subTotal = list.reduce((s, i) => s + i.amount, 0);
        const trTitle = document.createElement('tr');
        trTitle.innerHTML = `<td colspan="8" class="month-group-title">${mon} 当前页小计: ¥${formatMoney(subTotal)}</td>`; // 注意 colspan=8
        tbody.appendChild(trTitle);

        list.forEach(item => {
          // --- 关键修改：获取当前用户的颜色配置 ---
          const userColor = getUserColor(item.username);

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="item-cb" value="${item.id}" onchange="checkBatchBtn()" style="height:auto;"></td>
            <td>${item.statMonth}</td>
            <td>${item.date.slice(0, 10)}</td>
            <td><span style="background:#eceff1; padding:2px 8px; border-radius:10px; font-size:0.85em; color:#455a64;">${item.type1}</span></td>

            <!-- 新增：记账人列 -->
            <td>
                <span class="user-badge" style="background:${userColor.bg}; color:${userColor.text};">
                    ${item.username}
                </span>
            </td>

            <td>${item.type2}</td>
            <td style="font-weight:500;">¥${formatMoney(item.amount)}</td>
            <td>
              <div class="action-cell-content">
                <button class="action-btn btn-brown" onclick="editExp('${item.id}')">编辑</button>
                <button class="action-btn btn-dark" onclick="delExp('${item.id}')">删除</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });

      checkBatchBtn();
    }

    // ========== 分析报告逻辑 ==========

    function switchAnalysisMode() {
      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * ANALYSIS_MODE_COUNT);
      } while (newIndex === analysisModeIndex && ANALYSIS_MODE_COUNT > 1);
      analysisModeIndex = newIndex;
      updateAnalysis();
    }

    function updateAnalysis() {
      const textEl = document.getElementById('analysisText');
      if (!textEl) return;

      const data = filteredExpenses;

      if (data.length === 0) {
        textEl.textContent = "暂无数据可分析";
        return;
      }

      const dates = data.map(e => new Date(e.date).getTime());
      const minDate = Math.min(...dates);
      const maxDate = Math.max(...dates);
      const daySpan = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + (minDate === maxDate ? 0 : 1));
      const totalAmount = data.reduce((sum, item) => sum + item.amount, 0);

      let resultText = "";

      const sortedByAmount = data.filter(item => item.type1 !== '房租').sort((a, b) => b.amount - a.amount);
      const typeGroups = {};
      const typeCounts = {};
      data.forEach(item => {
        typeGroups[item.type1] = (typeGroups[item.type1] || 0) + item.amount;
        typeCounts[item.type1] = (typeCounts[item.type1] || 0) + 1;
      });

      const sortedTypes = Object.entries(typeGroups)
        .filter(([t]) => t !== '房租')
        .sort((a, b) => b[1] - a[1]);

      switch (analysisModeIndex) {
        case 0:
          const dailyAvg = totalAmount / daySpan;
          resultText = `日均支出${dailyAvg.toFixed(2)}元`;
          break;
        case 1:
          if (sortedByAmount.length > 0) {
            const item = sortedByAmount[0];
            resultText = `单笔最高：【${item.type1}】${item.type2} 消费${item.amount}元`;
          } else { resultText = "除房租外暂无消费"; }
          break;
        case 2:
          if (sortedByAmount.length > 1) {
            const item = sortedByAmount[1];
            resultText = `单笔第二：【${item.type1}】${item.type2} 消费${item.amount}元`;
          } else { resultText = "暂无单笔消费第二名"; }
          break;
        case 3:
          if (sortedByAmount.length > 2) {
            const item = sortedByAmount[2];
            resultText = `单笔第三：【${item.type1}】${item.type2} 消费${item.amount}元`;
          } else { resultText = "暂无单笔消费第三名"; }
          break;
        case 4:
          if (sortedByAmount.length > 0) {
            const item = sortedByAmount[sortedByAmount.length - 1];
            resultText = `单笔最小：【${item.type1}】${item.type2} 消费${item.amount}元`;
          } else { resultText = "暂无数据"; }
          break;
        case 5:
          if (sortedTypes.length > 0) {
            const [name, amt] = sortedTypes[0];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `第一大类：${name}占${percent}%`;
          } else { resultText = "除房租外暂无主要分类"; }
          break;
        case 6:
          if (sortedTypes.length > 1) {
            const [name, amt] = sortedTypes[1];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `第二大类：${name}占${percent}%`;
          } else { resultText = "暂无第二大分类"; }
          break;
        case 7:
          if (sortedTypes.length > 2) {
            const [name, amt] = sortedTypes[2];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `第三大类：${name}占${percent}%`;
          } else { resultText = "暂无第三大分类"; }
          break;
        case 8:
          if (sortedTypes.length > 0) {
            const [name, amt] = sortedTypes[sortedTypes.length - 1];
            const percent = ((amt / totalAmount) * 100).toFixed(1);
            resultText = `最小分类：${name}占${percent}%`;
          } else { resultText = "暂无数据"; }
          break;
        case 9:
          let weekDayTotal = 0, weekDayCount = 0;
          let weekendTotal = 0, weekendCount = 0;
          let wdItems = 0, weItems = 0;
          const targetTypes = ['吃', '喝', '交通'];

          data.forEach(item => {
            if (!targetTypes.includes(item.type1)) return;
            const day = new Date(item.date).getDay();
            const isWeekend = (day === 0 || day === 6);
            if (isWeekend) { weekendTotal += item.amount; weItems++; }
            else { weekDayTotal += item.amount; wdItems++; }
          });

          const wdAvg = wdItems ? (weekDayTotal / wdItems) : 0;
          const weAvg = weItems ? (weekendTotal / weItems) : 0;
          const diff = Math.abs(wdAvg - weAvg).toFixed(0);

          if (wdAvg > weAvg) resultText = `工作日(吃喝交通)笔均比周末高${diff}元`;
          else if (weAvg > wdAvg) resultText = `周末(吃喝交通)笔均比工作日高${diff}元`;
          else resultText = "周末与工作日(吃喝交通)消费持平";
          break;
        case 10:
          const sortedCounts = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
          if (sortedCounts.length > 0) {
            const [name, count] = sortedCounts[0];
            resultText = `频次之王：${name}类共消费${count}次`;
          } else { resultText = "暂无频次数据"; }
          break;
        case 11:
          const density = data.length / daySpan;
          resultText = `消费密度为${density.toFixed(1)}次/天`;
          break;
        case 12:
          const dailyExpense = totalAmount / daySpan;
          const balance = currentBudget - totalAmount;
          if (balance < 0) {
            resultText = `已超额${Math.abs(balance).toFixed(2)}元`;
          } else {
            if (dailyExpense <= 0) resultText = "余额充足（暂无日均支出）";
            else {
              const daysLeft = balance / dailyExpense;
              resultText = `余额仅够花${daysLeft.toFixed(0)}天`;
            }
          }
          break;
        case 13:
          const dayMap = {};
          data.forEach(item => {
            if (item.type1 === '房租') return;
            const d = item.date.slice(0, 10);
            dayMap[d] = (dayMap[d] || 0) + item.amount;
          });
          let maxDay = "", maxDayAmt = 0;
          for (let d in dayMap) {
            if (dayMap[d] > maxDayAmt) { maxDayAmt = dayMap[d]; maxDay = d; }
          }
          if (maxDay) resultText = `单日之王(除房租)：${maxDay} 花费${maxDayAmt.toFixed(0)}元`;
          else resultText = "除房租外暂无消费数据";
          break;
        case 14:
          const avgPrice = data.length ? (totalAmount / data.length) : 0;
          resultText = `平均单价：每笔消费约${avgPrice.toFixed(1)}元`;
          break;
        case 15:
          const smallCount = data.filter(i => i.amount < 30).length;
          const smallPercent = data.length ? ((smallCount / data.length) * 100).toFixed(0) : 0;
          resultText = `琐碎消费：30元以下占比${smallPercent}% (${smallCount}笔)`;
          break;
        case 16:
          const highValueItems = data.filter(i => i.amount > 500);
          const hvCount = highValueItems.length;
          if (hvCount > 0) {
            const hvTotal = highValueItems.reduce((sum, i) => sum + i.amount, 0);
            resultText = `高额消费(>500)：共${hvCount}笔，合计${hvTotal.toFixed(0)}元`;
          } else {
            resultText = "暂无单笔超500元的大额消费";
          }
          break;
      }

      textEl.textContent = resultText;
    }

    // ========== 分页与操作逻辑 ==========
    function formatMoney(n) { return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }

    function checkBatchBtn() {
      const n = document.querySelectorAll('.item-cb:checked').length;
      const btn = document.getElementById('batchDeleteBtn');
      btn.disabled = (n === 0);
      btn.style.opacity = n === 0 ? '0.5' : '1';
    }
    function toggleAllCheckboxes() {
      const v = document.getElementById('selectAll').checked;
      document.querySelectorAll('.item-cb').forEach(c => c.checked = v);
      checkBatchBtn();
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      renderExpenses();
    }

    function jumpToPage() {
      const inputVal = parseInt(document.getElementById('pageJumpInput').value);
      const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1;

      if (isNaN(inputVal) || inputVal < 1) {
        currentPage = 1;
      } else if (inputVal > maxPage) {
        currentPage = maxPage;
      } else {
        currentPage = inputVal;
      }
      renderTable();
      document.getElementById('pageJumpInput').value = currentPage;
    }

    function changePageRelative(offset) {
      const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1;
      let newPage = currentPage + offset;
      if (newPage < 1) newPage = 1;
      if (newPage > maxPage) newPage = maxPage;

      if (newPage !== currentPage) {
        currentPage = newPage;
        renderTable();
        document.getElementById('pageJumpInput').value = currentPage;
      }
    }

    // 增删改
    function openAddModal() {
      document.getElementById('modalExpenseForm').reset();
      document.getElementById('modalEditId').value = '';
      document.getElementById('modalTitle').innerText = '新增支出';
      document.getElementById('modalDate').valueAsDate = new Date();
      document.getElementById('addModal').classList.add('active');
    }
    function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

    document.getElementById('modalExpenseForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('未登录');

      const id = document.getElementById('modalEditId').value;
      const cleanAmount = Math.round(parseFloat(document.getElementById('modalAmount').value) * 100) / 100;
      const data = {
        date: document.getElementById('modalDate').value,
        type1: document.getElementById('modalType1').value,
        type2: document.getElementById('modalType2').value,
        amount: cleanAmount,
        familyId: MY_FAMILY_ID
      };

      try {
        if (id) {
          const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id);
          obj.set(data);
          await obj.save();
        } else {
          const obj = new ExpenseClass();
          obj.set(data);
          obj.set('owner', currentUser);

          const acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          obj.setACL(acl);

          await obj.save();
        }
        closeAddModal();
        allExpenses = [];
        renderExpenses();
      } catch (err) {
        alert('保存失败: ' + err.message);
      }
    };

    async function delExp(id) {
      if (!confirm('确定删除?')) return;
      const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id);
      await obj.destroy();
      allExpenses = allExpenses.filter(e => e.id !== id);
      renderExpenses();
    }

    async function batchDeleteSelected() {
      const ids = Array.from(document.querySelectorAll('.item-cb:checked')).map(c => c.value);
      if (!confirm(`确定删除 ${ids.length} 条?`)) return;
      const objs = ids.map(id => AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id));
      await AV.Object.destroyAll(objs);
      allExpenses = allExpenses.filter(e => !ids.includes(e.id));
      renderExpenses();
      document.getElementById('selectAll').checked = false;
    }

    function editExp(id) {
      const item = allExpenses.find(e => e.id === id);
      document.getElementById('modalEditId').value = id;
      document.getElementById('modalDate').value = item.date.slice(0, 10);
      document.getElementById('modalType1').value = item.type1;
      document.getElementById('modalType2').value = item.type2;
      document.getElementById('modalAmount').value = item.amount;
      document.getElementById('modalTitle').innerText = '编辑支出';
      document.getElementById('addModal').classList.add('active');
    }

    document.getElementById('editBudgetBtn').onclick = () => {
      const v = prompt('输入本月预算', currentBudget);
      if (v && !isNaN(v)) {
        const nowStr = computeStatMonth(new Date().toISOString().slice(0, 10));
        const budgets = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}');
        budgets[nowStr] = parseFloat(v);
        localStorage.setItem(BUDGET_STORAGE_KEY, JSON.stringify(budgets));
        renderCharts();
        updateAnalysis();
      }
    };

    function exportToCSV() {
      let csv = '统计月份,日期,一级类型,记账人,二级类型,金额\n';
      filteredExpenses.forEach(e => {
        csv += `${e.statMonth},${e.date.slice(0, 10)},${e.type1},${e.username},${e.type2},${e.amount}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = '支出明细.csv'; a.click();
    }
    function printCurrentPage() { window.print(); }

  </script>
</body>

</html>