<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å®¶åº­è´¹ç”¨æ¸…å•</title>

  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* --- è«å…°è¿ªé…è‰²å®šä¹‰ --- */
      --bg-body: #f2f4f6;
      --bg-card: #ffffff;

      --primary: #607d8b;
      --primary-hover: #455a64;
      --accent: #81a18b;
      --danger: #d4a5a5;
      --danger-hover: #c08b8b;

      --text-main: #374151;
      --text-sub: #6b7280;
      --border-color: #e5e7eb;

      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.06);

      --radius-md: 12px;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', 'Noto Sans SC', sans-serif;
      background-color: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* === å¤´éƒ¨å¸ƒå±€ === */
    .app-header {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
      min-height: 40px;
      padding: 0 10px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.6rem;
      color: var(--text-main);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .user-info-box {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
    }

    /* === Dashboard å¡ç‰‡æ ·å¼ === */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 20px;
      position: relative;
      display: flex;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.03);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      min-height: 100px;
    }

    /* æ–°å¢ Chart Header æ ·å¼ */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chart-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8fafc;
      padding: 4px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .clean-date-input {
      border: none;
      background: transparent;
      font-family: inherit;
      color: var(--text-main);
      font-size: 0.9rem;
      outline: none;
      padding: 0 4px;
      cursor: pointer;
    }

    .btn-icon-small {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid transparent;
      background: white;
      color: var(--text-sub);
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-icon-small:hover {
      color: var(--primary);
      border-color: #cbd5e1;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 2;
      flex: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #90a4ae;
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      font-family: 'Roboto', sans-serif;
      line-height: 1.2;
      letter-spacing: -0.5px;
      word-break: break-all;
    }

    .stat-icon-box {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .stat-icon-box svg {
      width: 24px;
      height: 24px;
    }

    /* é…è‰²æ–¹æ¡ˆ */
    .theme-blue .stat-icon-box {
      background: #e3f2fd;
      color: #1976d2;
    }

    .theme-blue .stat-value {
      color: #37474f;
    }

    .theme-red .stat-icon-box {
      background: #ffebee;
      color: #e53935;
    }

    .theme-red .stat-value {
      color: #c62828;
    }

    .theme-green .stat-icon-box {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .theme-green .stat-value {
      color: #2e7d32;
    }

    /* ç´«è‰²æ™®é€š (ç”¨äºç¯æ¯”) */
    .theme-purple .stat-icon-box {
      background: #f3e5f5;
      color: #8e24aa;
    }

    .theme-purple .stat-value {
      color: #4a148c;
    }

    /* ç´«è‰²é«˜äº® (ä»…ç”¨äºç­›é€‰ç»“æœ) */
    .theme-purple-highlight {
      background: #f3e5f5;
      border: 1px solid #e1bee7;
    }

    .theme-purple-highlight .stat-icon-box {
      background: #fff;
      color: #8e24aa;
    }

    .theme-purple-highlight .stat-value {
      color: #6a1b9a;
      font-size: 1.1rem;
    }

    .theme-purple-highlight .stat-label {
      color: #8e24aa;
    }

    /* === ç»Ÿä¸€çš„å¤§å¡ç‰‡æ ·å¼ === */
    .details-card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 25px;
      box-shadow: var(--shadow-md);
      margin-bottom: 30px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .details-header {
      margin-bottom: 25px;
      display: flex;
      align-items: center;
    }

    .details-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-main);
      padding-left: 12px;
      border-left: 4px solid var(--primary);
      line-height: 1.2;
    }

    /* === ä¼˜åŒ–åçš„æ¨¡æ€æ¡† & è¡¨å•æ ·å¼ === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: #fff;
      padding: 35px;
      border-radius: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
    }

    /* AI åŒºåŸŸä¼˜åŒ– */
    .ai-section {
      background: linear-gradient(145deg, #f0fdf4 0%, #e8f5e9 100%);
      padding: 18px;
      border-radius: 16px;
      border: 1px dashed #a5d6a7;
      margin-bottom: 25px;
    }

    .ai-textarea {
      width: 100%;
      height: 70px;
      padding: 12px;
      border: 1px solid #c8e6c9;
      border-radius: 12px;
      resize: none;
      font-family: inherit;
      font-size: 0.95rem;
      margin-bottom: 12px;
      background: #fff;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: all 0.3s ease;
    }

    .ai-textarea:focus {
      border-color: #66bb6a;
      box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.15);
    }

    .btn-ai {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      color: white;
      width: 100%;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      font-weight: 500;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.2);
    }

    .btn-ai:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
    }

    /* é€šç”¨è¾“å…¥æ¡†ç¾åŒ– */
    input,
    select {
      width: 100%;
      height: 46px;
      padding: 0 16px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.1);
    }

    /* === ä¿®å¤è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ (æ–‡å­—å‚ç›´å±…ä¸­) === */
    .custom-select-trigger {
      width: 100%;
      height: 46px;
      padding: 0 16px;
      /* ä¿æŒä¸ input ä¸€è‡´ */
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      /* å‚ç›´å±…ä¸­ */
      justify-content: space-between;
      /* ç¡®ä¿æ–‡å­—åœ¨å·¦ï¼Œç®­å¤´åœ¨å³ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰ */
      line-height: normal;
      /* é‡ç½®è¡Œé«˜ï¼Œäº¤ç»™ flex æ§åˆ¶ */
    }

    .custom-select-wrapper.open .custom-select-trigger {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.1);
    }

    /* Radio æŒ‰é’®ç¾åŒ– */
    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 5px;
    }

    .radio-label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .radio-label:hover {
      background: #f5f5f5;
    }

    .radio-label input {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
    .modal-footer {
      margin-top: 35px;
      gap: 15px;
    }

    .modal-footer button {
      border-radius: 12px;
      height: 46px;
      font-size: 1rem;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* === FAB æ‚¬æµ®æŒ‰é’® === */
    .fab-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
    }

    .fab-btn {
      width: 60px;
      height: 60px;
      border-radius: 24px;
      background-color: #263238;
      color: white;
      border: none;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .fab-btn:hover {
      transform: scale(1.1) rotate(90deg);
      background-color: #37474f;
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    /* === å…¶ä»–é€šç”¨æ ·å¼ (ä¿æŒä¸å˜) === */
    .auth-card {
      background: var(--bg-card);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 450px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #authContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 90vh;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 25px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-sub);
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      margin-bottom: -2px;
    }

    .auth-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
      font-weight: 700;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 15px;
      background: #f0f4f8;
      padding: 10px;
      border-radius: var(--radius-md);
    }

    #appContainer {
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    button {
      font-family: inherit;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .action-btn,
    .action-btn-large {
      border-radius: 8px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      margin: 0;
      white-space: nowrap;
    }

    .action-btn-large {
      padding: 12px 24px;
      font-size: 1rem;
      min-width: 100px;
      width: 100%;
    }

    @media(min-width: 768px) {
      .action-btn-large {
        width: auto;
      }

      .auth-card .action-btn-large {
        width: 100%;
      }
    }

    .btn-brown {
      background: var(--primary);
      color: white;
    }

    .btn-brown:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-dark {
      background: var(--danger);
      color: white;
    }

    .btn-dark:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }

    .btn-light {
      background: #fff;
      border: 1px solid var(--border-color);
      color: var(--text-main);
    }

    .btn-light:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #6b8c76;
      transform: translateY(-1px);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.95rem;
    }

    th {
      padding: 15px;
      text-align: left;
      background-color: #f8fafc;
      color: var(--text-sub);
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    .action-cell-content {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .month-group-title {
      background: #e2e8f0;
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      padding-left: 15px;
    }

    .user-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 500;
      letter-spacing: 0.3px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .charts-section {
      margin: 30px 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .chart-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      font-size: 1.1rem;
    }

    #budgetProgressBar {
      margin-top: 15px;
      padding: 4px;
      background: #eceff1;
      border-radius: 20px;
      position: relative;
      height: 36px;
      overflow: hidden;
    }

    #budgetBase {
      border-radius: 18px !important;
    }

    .filter-bar {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filter-bar>div {
      flex: 1;
      min-width: 130px;
      width: auto;
    }

    .custom-select-wrapper {
      position: relative;
      user-select: none;
    }

    .custom-select-trigger {
      position: relative;
      cursor: pointer;
    }

    .custom-select-trigger::after {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-25%);
      border: 5px solid transparent;
      border-top-color: var(--text-sub);
    }

    .custom-options {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
    }

    .custom-select-wrapper.open .custom-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-options-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 5px 0;
    }

    .custom-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .custom-option:hover {
      background-color: #f1f5f9;
    }

    .custom-option input {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: var(--primary);
    }

    .custom-footer {
      display: flex;
      border-top: 1px solid var(--border-color);
      padding: 10px;
      gap: 10px;
      background: #f8fafc;
    }

    .custom-footer button {
      padding: 8px;
      flex: 1;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .btn-cancel {
      background: #e5e7eb;
    }

    .btn-confirm {
      background: var(--primary);
      color: white;
    }

    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px 0;
      padding: 15px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 15px;
    }

    .pagination-jumper {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f8fafc;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .pagination-input {
      width: 50px !important;
      height: 28px !important;
      padding: 4px !important;
      text-align: center;
      margin: 0 5px;
      line-height: normal !important;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #fff;
    }

    .btn-page-nav {
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.1rem;
      padding: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 28px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-page-nav:hover {
      color: var(--primary);
      background: #e2e8f0;
    }

    .btn-jump {
      margin-left: 10px;
      padding: 4px 12px;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    .btn-jump:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .action-bar {
      text-align: center;
      margin-top: 30px;
    }

    /* === å¤ç›˜ä¸»è¦ Overlay æ ·å¼ === */
    .retro-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
      backdrop-filter: blur(8px);
      /* æ¨¡ç³Šæ•ˆæœ */
      z-index: 2000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .retro-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* é¡¶éƒ¨å¯¼èˆªå·¥å…·æ  */
    .retro-top-bar {
      position: absolute;
      top: 20px;
      left: 0;
      width: 100%;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      z-index: 10;
    }

    .btn-retro-nav {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-retro-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .retro-progress {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
    }

    .retro-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff9800, #f44336);
      width: 0%;
      transition: width 0.3s;
    }

    .retro-card-container {
      width: 90%;
      max-width: 400px;
      height: 520px;
      /* å¢åŠ ä¸€ç‚¹é«˜åº¦å®¹çº³å¯¼èˆª */
      position: relative;
      perspective: 1000px;
      display: flex;
      flex-direction: column;
    }

    .retro-card {
      width: 100%;
      flex: 1;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      padding: 30px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.4s ease, opacity 0.4s ease;
      transform-origin: 50% 100%;
      position: relative;
      /* ç›¸å¯¹å®šä½ï¼Œä¸å† absolute */
    }

    /* å†…éƒ¨å¯¼èˆªæŒ‰é’®æ ·å¼ */
    .btn-icon-nav {
      background: transparent;
      border: 1px solid #cfd8dc;
      color: #90a4ae;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .btn-icon-nav:hover {
      background: #eceff1;
      color: #607d8b;
      border-color: #b0bec5;
    }

    .btn-icon-nav:active {
      transform: scale(0.9);
    }

    /* å¤´éƒ¨æ–‡æœ¬æŒ‰é’® */
    .btn-text-icon {
      background: transparent;
      border: none;
      color: #90a4ae;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .btn-text-icon:hover {
      background: #eceff1;
      color: #607d8b;
    }

    .retro-card.swiped-left {
      transform: translateX(-120%) rotate(-15deg);
      opacity: 0;
      position: absolute;
      /* åŠ¨ç”»æ—¶è„±ç¦»æµ? ä¸ºäº†ç®€å•ç›´æ¥æ”¹ transform å³å¯ï¼Œä¸ç”¨ flex */
    }

    .retro-card.swiped-right {
      transform: translateX(120%) rotate(15deg);
      opacity: 0;
      position: absolute;
    }

    /* ä¿®æ­£åŠ¨ç”»æ—¶çš„å¸ƒå±€é—®é¢˜ï¼š
       ä¸ºäº†ä¿æŒåŠ¨ç”»é¡ºç•…ï¼Œæˆ‘ä»¬å°† retro-card è®¾ä¸º absolute filledï¼Œ
       container è®¾ä¸º fixed height
    */
    .retro-card-container {
      display: block;
      /* å›å½’ block */
    }

    .retro-card {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
    }

    .retro-header {
      display: flex;
      justify-content: space-between;
      color: #90a4ae;
      font-size: 0.9rem;
    }

    .retro-type {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #37474f;
    }

    .retro-amount {
      font-size: 3rem;
      font-weight: 800;
      color: #263238;
      font-family: 'Roboto', sans-serif;
    }

    .retro-desc {
      color: #78909c;
      margin-top: 10px;
      font-size: 1.1rem;
    }

    .retro-actions {
      display: flex;
      gap: 15px;
    }

    .btn-retro {
      flex: 1;
      height: 60px;
      border-radius: 30px;
      border: none;
      font-size: 1.1rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-retro:active {
      transform: scale(0.95);
    }

    .btn-waste {
      background: #ffebee;
      color: #c62828;
    }

    .btn-pass {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* è¾“å…¥å±‚ */
    .retro-input-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      border-radius: 20px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s;
    }

    .retro-input-overlay.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .retro-note-input {
      width: 100%;
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 12px;
      font-family: inherit;
      resize: none;
      height: 80px;
      font-size: 0.95rem;
    }

    .retro-note-input:focus {
      border-color: var(--primary);
    }

    .retro-summary {
      text-align: center;
      display: none;
      animation: fadeIn 0.5s;
    }
  </style>
</head>

<body>

  <div id="authContainer">
    <div class="auth-card">
      <h2 class="auth-title">å®¶åº­è´¹ç”¨æ¸…å•</h2>
      <p style="text-align: center; color: var(--text-sub); margin-bottom: 20px;">
        Family: Big Banana House
      </p>

      <div id="configSection" style="display: none;">
        <div class="helper-text">
          è¯·å‰å¾€ LeanCloud æ§åˆ¶å°è·å–åº”ç”¨çš„ App ID å’Œ App Keyã€‚<br>
          æ§åˆ¶å° > è®¾ç½® > åº”ç”¨å‡­è¯
        </div>
        <div class="form-group">
          <label>App ID</label>
          <input type="text" id="configAppId" placeholder="è¾“å…¥ App ID">
        </div>
        <div class="form-group">
          <label>App Key</label>
          <input type="password" id="configAppKey" placeholder="è¾“å…¥ App Key">
        </div>
        <div class="form-group">
          <label>REST API Server URL</label>
          <input type="text" id="configServerUrl" placeholder="https://..." value="https://api.leancloud.cn">
        </div>
        <div class="form-group">
          <label>OpenRouter API Key</label>
          <input type="password" id="configAiKey" placeholder="è¾“å…¥ sk-or-v1-...">
        </div>
        <button class="action-btn-large btn-brown" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
      </div>

      <div id="authSection" style="display: none;">
        <div class="auth-tabs">
          <div class="auth-tab active" id="tabLogin" onclick="switchAuthMode('login')">ç™»å½•</div>
          <div class="auth-tab" id="tabSignup" onclick="switchAuthMode('signup')">æ³¨å†Œ</div>
        </div>

        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="authUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="authPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>

        <button class="action-btn-large btn-brown" id="authActionBtn" onclick="handleAuthAction()">ç™»å½•</button>

        <div style="text-align: center; margin-top: 20px;">
          <button class="action-btn" style="color: var(--text-sub); text-decoration: underline;"
            onclick="clearConfig()">é‡ç½® App é…ç½®</button>
        </div>
      </div>

      <div id="loadingSection" style="display: none; text-align: center; color: var(--text-sub);">
        æ­£åœ¨åˆå§‹åŒ–...
      </div>

    </div>
  </div>


  <div class="container" id="appContainer">

    <div class="app-header">
      <h1>å®¶åº­è´¹ç”¨æ¸…å•</h1>
      <div class="user-info-box">
        <span id="currentUserDisplay" style="font-weight: 500; color: var(--primary);"></span>
        <button class="action-btn btn-light" onclick="logout()"
          style="padding: 4px 12px; font-size: 0.85rem; margin-left: 10px;">é€€å‡º</button>
      </div>
    </div>

    <div class="dashboard-grid">

      <div class="stat-card theme-red">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆæ¶ˆè´¹</div>
          <div class="stat-value" id="dashMonthExpense">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />
            <polyline points="17 18 23 18 23 12" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-green">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆç»“ä½™</div>
          <div class="stat-value" id="dashMonthBalance">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆå¤§é¢æ¶ˆè´¹ç¬”æ•°(>500)</div>
          <div class="stat-value" id="dashLargeCount">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M16 12l-4-4-4 4"></path>
            <line x1="12" y1="16" x2="12" y2="8"></line>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆæ—¥å‡æ¶ˆè´¹</div>
          <div class="stat-value" id="dashMonthDailyAvg">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2v-1a2 2 0 0 1 2-2h2"></path>
            <path d="M2 6h20v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z"></path>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-red">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆå¨±ä¹/è´­ç‰©</div>
          <div class="stat-value" id="dashEntertainment">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">è¿‘7å¤©æ—¥å‡æ¶ˆè´¹</div>
          <div class="stat-value" id="dashWeeklyAvg">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-purple">
        <div class="stat-content">
          <div class="stat-label">æ”¯å‡ºç¯æ¯”å¢é•¿</div>
          <div class="stat-value" id="dashMomGrowth">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <polyline points="18 20 18 4 6 4 6 20"></polyline>
            <line x1="6" y1="16" x2="18" y2="16"></line>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-purple-highlight">
        <div class="stat-content">
          <div class="stat-label">å½“å‰ç­›é€‰ç»“æœ</div>
          <div class="stat-value" id="filterResultText">åŠ è½½ä¸­...</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
          </svg>
        </div>
      </div>
    </div>

    <!-- å¤ç›˜åŠŸèƒ½å…¥å£åŒºåŸŸ (4ä¸ªå¡ç‰‡) -->
    <div class="dashboard-grid" style="margin-bottom: 25px;">
      <!-- å¡ç‰‡ 1: ä¸Šæœˆæµªè´¹ -->
      <div class="stat-card theme-red">
        <div class="stat-content">
          <div class="stat-label" id="dashWasteLabel">ä¸Šæœˆæµªè´¹</div>
          <div class="stat-value" id="dashWasteValue">--</div>
        </div>
        <div class="stat-icon-box">
          <span style="font-size: 1.5rem;">ğŸ—‘ï¸</span>
        </div>
      </div>
      <!-- å¡ç‰‡ 2: æµªè´¹ç¯æ¯” -->
      <div class="stat-card" style="border: 1px solid #e0e0e0;">
        <div class="stat-content">
          <div class="stat-label">æµªè´¹ç¯æ¯”å˜åŠ¨</div>
          <div class="stat-value" id="dashWasteTrendValue" style="font-size:1.1rem;">--</div>
        </div>
        <div class="stat-icon-box">
          <span style="font-size: 1.5rem;">ğŸ“‰</span>
        </div>
      </div>
      <!-- åçœæ¸…å•å…¥å£ -->
      <div class="stat-card" style="cursor: pointer; border: 1px solid #ffebee; background: #fffaf0;"
        onclick="openWasteListModal()">
        <div class="stat-content">
          <div class="stat-label" style="color:#d32f2f;">åçœæ¸…å•</div>
          <div class="stat-value" style="font-size: 1.1rem; color:#c62828;">ğŸ“œ æŸ¥çœ‹æµªè´¹è¯¦æƒ…</div>
        </div>
        <div class="stat-icon-box">
          <span style="font-size: 1.5rem;">ğŸ§</span>
        </div>
      </div>
      <!-- å¤ç›˜å…¥å£å¡ç‰‡ -->
      <div class="stat-card theme-red" style="cursor: pointer;" onclick="openRetroSetup()">
        <div class="stat-content">
          <div class="stat-label">æœˆåº¦è´¦å•å¤ç›˜</div>
          <div class="stat-value" style="font-size: 1.25rem;">âœ¨ å¼€å§‹å¤ç›˜</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            <path d="M9 14l2 2 4-4"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- å¤ç›˜ç›¸å…³æ ·å¼ -->
    <style>
      .row-waste {
        background-color: rgba(239, 68, 68, 0.08) !important;
      }

      .row-waste td {
        color: #b91c1c !important;
      }

      .retro-setup-card {
        background: white;
        padding: 30px;
        border-radius: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: none;
      }

      .retro-setup-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--text-main);
      }

      .setup-group {
        text-align: left;
        margin-bottom: 20px;
      }

      .setup-group label {
        display: block;
        color: var(--text-sub);
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .toggle-options {
        display: flex;
        background: #f1f5f9;
        padding: 4px;
        border-radius: 12px;
      }

      .toggle-option {
        flex: 1;
        text-align: center;
        padding: 8px;
        font-size: 0.9rem;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-sub);
        font-weight: 500;
        transition: all 0.2s;
      }

      .toggle-option.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      /* æ–°å¢ Chart Header æ ·å¼ (ç®€çº¦ç‰ˆ) */
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 5px;
      }

      .chart-title-text {
        font-size: 1.1rem;
        /* ç¨å¾®è°ƒå° */
        font-weight: 700;
        color: #37474f;
        display: flex;
        align-items: baseline;
        gap: 6px;
      }

      .chart-controls {
        display: flex;
        align-items: center;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        /* ç¨å¾®åœ†æ¶¦ */
        padding: 2px;
        gap: 2px;
      }

      /* è‡ªå®šä¹‰æ—¥æœŸæ˜¾ç¤ºå®¹å™¨ */
      .date-display-wrapper {
        position: relative;
        width: 80px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .custom-date-text {
        font-size: 0.9rem;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        color: #455a64;
        pointer-events: none;
        /* è®©ç‚¹å‡»ç©¿é€åˆ° input */
      }

      /* è‡ªå®šä¹‰æœˆä»½é€‰æ‹©å™¨å¼¹çª— */
      .custom-month-popover {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 240px;
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        padding: 10px;
        z-index: 100;
        margin-top: 8px;
      }

      .custom-month-popover.active {
        display: block;
        animation: fadeIn 0.15s ease-out;
      }

      .popover-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #f1f5f9;
      }

      .picker-year-btn {
        background: transparent;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .picker-year-btn:hover {
        background: #f1f5f9;
        color: #334155;
      }

      .picker-year-text {
        font-weight: 700;
        color: #334155;
        pointer-events: none;
      }

      .month-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .month-cell {
        padding: 6px 0;
        text-align: center;
        font-size: 0.85rem;
        border-radius: 6px;
        cursor: pointer;
        color: #64748b;
        transition: all 0.2s;
      }

      .month-cell:hover {
        background: #f8fafc;
        color: #334155;
      }

      /* æœ‰æ•°æ®çš„æœˆä»½ï¼šç²‰çº¢èƒŒæ™¯ */
      .month-cell.has-data {
        background: #ffebee;
        color: #d32f2f;
        font-weight: 600;
      }

      .month-cell.has-data:hover {
        background: #ffcdd2;
      }

      /* å½“å‰é€‰ä¸­æœˆä»½ */
      .month-cell.selected {
        background: #37474f !important;
        color: white !important;
        box-shadow: 0 2px 4px rgba(55, 71, 79, 0.3);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -10px);
        }

        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }

      .hidden-date-input {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .btn-icon-small {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: #90a4ae;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-icon-small:hover {
        background: #fff;
        color: var(--primary);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      #editBudgetBtn {
        background: transparent;
        border: 1px solid #cfd8dc;
        color: #78909c;
        font-size: 0.8rem;
        /* æ–‡å­—æ›´å° */
        height: 30px;
        padding: 0 10px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      #editBudgetBtn:hover {
        border-color: #b0bec5;
        color: #546e7a;
        background: #fcfcfc;
      }
    </style>

    <!-- é‡æ–°æ·»åŠ ä¸¢å¤±çš„ charts-section åŒ…è£…å™¨ -->
    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title-text" id="budgetTitle">
            <!-- åŠ¨æ€ç”Ÿæˆ: 2026.01 æ€»æ”¯å‡º (é¢„ç®— Â¥5000) -->
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <div class="chart-controls">
              <button class="btn-icon-small" onclick="shiftChartMonth(-1)" title="ä¸Šä¸€æœˆ">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M15 18l-6-6 6-6" />
                </svg>
              </button>

              <!-- ç‚¹å‡»è§¦å‘è‡ªå®šä¹‰ Popover -->
              <div class="date-display-wrapper" onclick="toggleMonthPicker(event)">
                <span id="chartDateDisplay" class="custom-date-text">--.--</span>
                <!-- Custom Popover -->
                <div id="customMonthPopover" class="custom-month-popover" onclick="event.stopPropagation()">
                  <div class="popover-header">
                    <button class="picker-year-btn" onclick="changePickerYear(-1)">â®</button>
                    <span id="pickerYearDisplay" class="picker-year-text">2026</span>
                    <button class="picker-year-btn" onclick="changePickerYear(1)">â¯</button>
                  </div>
                  <div class="month-grid" id="pickerMonthGrid">
                    <!-- JS Generated -->
                  </div>
                </div>
              </div>

              <button class="btn-icon-small" onclick="shiftChartMonth(1)" title="ä¸‹ä¸€æœˆ">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 18l6-6-6-6" />
                </svg>
              </button>
            </div>
            <button id="editBudgetBtn">ä¿®æ”¹é¢„ç®—</button>
          </div>
        </div>
        <div style="position: relative; height: 280px; width: 100%;">
          <canvas id="monthlyBarChart"></canvas>
        </div>
        <div id="budgetProgressBar">
          <div id="budgetBase" style="height:100%; width:100%; background:#cfd8dc; position:relative; overflow:hidden;">
            <div id="progressGreen"
              style="height:100%; width:0%; background:linear-gradient(to right, #a5d6a7, #81c784); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressRed"
              style="height:100%; width:0%; background:linear-gradient(to right, #ef9a9a, #e57373); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressText"
              style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:0.85em; z-index:2;">
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">ç±»å‹å æ¯” <span
            style="font-size:0.8em; color:var(--text-sub); font-weight:400;">(ç‚¹å‡»æ‰‡åŒºç­›é€‰)</span></div>
        <div id="echartsPie" style="width: 100%; height: 350px;"></div>
      </div>
    </div>

    <div class="details-card">
      <div class="details-header">
        <div class="details-title">æ”¯å‡ºæ˜ç»†</div>
      </div>

      <div class="filter-bar">
        <div>
          <label>ç±»å‹ç­›é€‰ (å¤šé€‰)</label>
          <div class="custom-select-wrapper" id="typeSelectWrapper">
            <div class="custom-select-trigger" id="typeSelectTrigger">å…¨éƒ¨ç±»å‹</div>
            <div class="custom-options">
              <div class="custom-options-list" id="typeOptionsList"></div>
              <div class="custom-footer">
                <button class="btn-cancel" onclick="cancelTypeFilter()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmTypeFilter()">ç¡®è®¤</button>
              </div>
            </div>
          </div>
        </div>
        <div style="flex: 2; display: flex; gap: 10px;">
          <div style="flex: 1;">
            <label for="startDate">æ˜ç»†å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate" onchange="applyDateRangeFilter()" />
          </div>
          <div style="flex: 1;">
            <label for="endDate">æ˜ç»†ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="endDate" onchange="applyDateRangeFilter()" />
          </div>
        </div>
        <div>
          <label for="monthFilter">ç»Ÿè®¡æœˆä»½ç­›é€‰</label>
          <select id="monthFilter" onchange="applyMonthOrSearchFilter()">
            <option value="">å…¨éƒ¨æœˆä»½</option>
          </select>
        </div>
        <div>
          <label for="memberFilter">å®¶åº­æˆå‘˜ç­›é€‰</label>
          <select id="memberFilter" onchange="applyMonthOrSearchFilter()">
            <option value="">å…¨éƒ¨æˆå‘˜</option>
          </select>
        </div>
        <div>
          <label for="searchInput">æœç´¢ï¼ˆäºŒçº§ç±»å‹ï¼‰</label>
          <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯..." oninput="applyMonthOrSearchFilter()" />
        </div>
        <div style="flex: 0 0 auto;">
          <button class="action-btn btn-accent" onclick="resetFilters()" style="height: 46px;">æ¢å¤é»˜è®¤</button>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table id="expenseTable">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                  style="height:auto;"></th>
              <th>ç»Ÿè®¡æœˆä»½</th>
              <th>æ¶ˆè´¹æ—¥æœŸ</th>
              <th>ä¸€çº§ç±»å‹</th>
              <th>è®°è´¦äºº</th>
              <th>äºŒçº§ç±»å‹</th>
              <th>é‡‘é¢</th>
              <th style="width: 160px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="expenseList"></tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div style="display:flex; align-items:center;">
          <span style="color:var(--text-sub); font-size:0.9rem; margin-right:5px;">æ¯é¡µ:</span>
          <select id="pageSizeSelect" onchange="changePageSize()"
            style="width:auto; height:30px; line-height:30px; padding:0 25px 0 10px; font-size:0.9rem;">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>

        <div class="pagination-jumper">
          <button class="btn-page-nav" onclick="changePageRelative(-1)" title="ä¸Šä¸€é¡µ">â®</button>
          <span style="margin: 0 6px;">ç¬¬</span>
          <input type="number" id="pageJumpInput" class="pagination-input" value="1" min="1"
            onkeypress="if(event.keyCode==13) jumpToPage()">
          <span style="margin: 0 6px;">é¡µ / å…± <span id="totalPagesDisplay" style="font-weight:bold;">1</span> é¡µ</span>
          <button class="btn-page-nav" onclick="changePageRelative(1)" title="ä¸‹ä¸€é¡µ">â¯</button>
          <button class="btn-jump" onclick="jumpToPage()">è·³è½¬</button>
        </div>
      </div>

      <div style="text-align: right;">
        <button id="batchDeleteBtn" class="action-btn btn-dark" style="opacity:0.8; font-size:0.9rem; padding:8px 16px;"
          onclick="batchDeleteSelected()" disabled>æ‰¹é‡åˆ é™¤</button>
      </div>
    </div>

    <div class="action-bar">
      <button class="action-btn-large btn-light" onclick="exportToCSV()">å¯¼å‡º CSV</button>
      <button class="action-btn-large btn-light" onclick="printCurrentPage()">æ‰“å°</button>
    </div>

  </div>

  <div class="fab-container">
    <button class="fab-btn" onclick="openAddModal()" title="æ–°å¢æ•°æ®">+</button>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">æ–°å¢è®°å½•</div>
        <button class="action-btn" style="background:none; color:#999; font-size:1.5em; padding:0;"
          onclick="closeAddModal()">&times;</button>
      </div>

      <form id="modalExpenseForm">
        <input type="hidden" id="modalEditId" />

        <div class="ai-section">
          <label
            style="color: #388e3c; display:flex; align-items:center; gap:6px; font-weight:600; font-size:0.95rem; margin-bottom:8px;">
            <span>ğŸ¤– AI æ™ºèƒ½è¯†åˆ«</span>
          </label>
          <textarea id="aiInput" class="ai-textarea" placeholder="è¾“å…¥å¦‚ï¼šæ˜¨å¤©ä¹°å¥¶èŒ¶èŠ±äº†18å…ƒ..."></textarea>
          <button type="button" class="btn-ai" onclick="handleSmartIdentify()" id="btnSmartIdentify">
            âœ¨ æ™ºèƒ½å¡«å……
          </button>
        </div>

        <div class="form-group" style="display:none;">
          <label>æ”¶æ”¯ç±»å‹</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="modalCategory" value="expense" checked onchange="updateModalTypeOptions()"> æ”¯å‡º
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>æ¶ˆè´¹æ—¥æœŸ</label>
          <input type="date" id="modalDate" required />
        </div>
        <div class="form-group">
          <label>ä¸€çº§ç±»å‹</label>
          <select id="modalType1" required>
            <option value="">-- è¯·é€‰æ‹© --</option>
          </select>
        </div>
        <div class="form-group">
          <label>äºŒçº§ç±»å‹</label>
          <input type="text" id="modalType2" placeholder="å¦‚ï¼šå¥¶èŒ¶ã€å·¥èµ„æ˜ç»†" />
        </div>
        <div class="form-group">
          <label>é‡‘é¢</label>
          <div style="position:relative;">
            <span
              style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#999; font-weight:bold;">Â¥</span>
            <input type="number" step="0.01" id="modalAmount" required min="0.01"
              style="padding-left:30px; font-weight:600; color:#374151;" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end;">
          <button type="button" class="btn-light" style="width:100px;" onclick="closeAddModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn-brown"
            style="width:120px; box-shadow: 0 4px 10px rgba(96, 125, 139, 0.3);">ç¡®è®¤ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- å¤ç›˜æ¨¡å¼é®ç½©å±‚ -->
  <div class="retro-overlay" id="retroOverlay">
    <!-- 1. å¤ç›˜å‰ç½®è®¾ç½®é¢æ¿ -->
    <div class="retro-setup-card" id="retroSetupPanel">
      <div class="retro-setup-title">ğŸ“ å¼€å¯æœˆåº¦å¤ç›˜</div>

      <div class="setup-group">
        <label>é€‰æ‹©å¤ç›˜æœˆä»½</label>
        <select id="retroMonthSelect"
          style="width:100%; height:46px; border-radius:12px; border:1px solid #e0e0e0; padding:0 12px; font-size:1rem; outline:none;">
          <!-- JS Populate -->
        </select>
      </div>

      <div class="setup-group">
        <label>å¤ç›˜èŒƒå›´</label>
        <div class="toggle-options">
          <div class="toggle-option active" onclick="setRetroScope('unreviewed')" id="scopeUnreviewed">ä»…æœªå¤ç›˜</div>
          <div class="toggle-option" onclick="setRetroScope('all')" id="scopeAll">å…¨éƒ¨æ•°æ®</div>
        </div>
      </div>

      <div style="margin-top:30px;">
        <button class="action-btn-large btn-brown" style="width:100%; box-shadow: 0 4px 12px rgba(96,125,139,0.3);"
          onclick="startRetroSession()">
          ğŸš€ å¼€å§‹å¤ç›˜
        </button>
        <p style="text-align:center; margin-top:15px; cursor:pointer; color:#90a4ae;" onclick="closeRetroMode()">
          æš‚ä¸å¤ç›˜ï¼Œå…³é—­çª—å£
        </p>
      </div>
    </div>

    <!-- 2. å¤ç›˜è¿›è¡Œä¸­åŒºåŸŸ (é»˜è®¤éšè—) -->
    <div id="retroRunningArea"
      style="display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center;">

      <!-- é¡¶éƒ¨å¯¼èˆªæ å·²ç§»é™¤ï¼ŒæŒ‰é’®ç§»å…¥å¡ç‰‡å†…éƒ¨ -->

      <div class="retro-progress">
        <div class="retro-progress-bar" id="retroProgressBar"></div>
      </div>

      <div class="retro-card-container" id="retroCardContainer">
        <div class="retro-card" id="retroCard">
          <!-- å¤´éƒ¨åŒ…å«å¯¼èˆªæŒ‰é’® -->
          <div class="retro-header"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button class="btn-text-icon" onclick="backToSetup()">â¬… é‡é€‰</button>
            <div style="text-align:right;">
              <div id="retroDate" style="font-weight:bold; color:#546e7a;"></div>
              <div id="retroCount" style="font-size:0.85rem; color:#b0bec5;"></div>
            </div>
            <button class="btn-text-icon" onclick="closeRetroMode()">é€€å‡º âœ•</button>
          </div>

          <!-- ä¸­é—´å†…å®¹åŒºåŸŸï¼šåŒ…å« ä¸Šä¸€ä¸ª | å†…å®¹ | ä¸‹ä¸€ä¸ª -->
          <div style="flex:1; display:flex; align-items:center; width:100%; justify-content:space-between;">
            <button class="btn-icon-nav" onclick="prevRetroCard()" id="btnPrevCard" title="ä¸Šä¸€æ¡"
              style="margin-right:10px;">â®</button>

            <div
              style="flex:1; text-align:center; display:flex; flex-direction:column; justify-content:center; overflow:hidden;">
              <div class="retro-type" id="retroType" style="margin-bottom:5px;"></div>
              <div class="retro-amount" id="retroAmount"></div>
              <div class="retro-desc" id="retroDesc"
                style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding:0 5px;"></div>
            </div>

            <button class="btn-icon-nav" onclick="nextRetroCard()" id="btnNextCard" title="ä¸‹ä¸€æ¡"
              style="margin-left:10px;">â¯</button>
          </div>

          <div class="retro-actions">
            <!-- çº¢è‰²æŒ‰é’®ï¼šæµªè´¹ -->
            <button class="btn-retro btn-waste" onclick="triggerWasteAction()">
              <span>ğŸ’¸</span> æµªè´¹äº†
            </button>
            <!-- ç»¿è‰²æŒ‰é’®ï¼šå¿…éœ€ -->
            <button class="btn-retro btn-pass" onclick="handleRetroSwipe('pass')">
              <span>âœ…</span> å¿…éœ€å“
            </button>
          </div>
        </div>

        <!-- é‡‘é¢è¾“å…¥å±‚ -->
        <div class="retro-input-overlay" id="retroInputLayer">
          <h3 style="margin-top:0;">è¿™å°±çœäº†å¤šå°‘?</h3>
          <p style="color:var(--text-sub); font-size:0.9rem; margin-bottom:10px;">é»˜è®¤å…¨é¢ï¼Œå¯ä¿®æ”¹</p>

          <div style="position:relative; width:100%; margin-bottom:15px;">
            <span
              style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#999; font-weight:bold; font-size:1.2rem;">Â¥</span>
            <input type="number" id="retroWasteInput"
              style="padding-left:35px; height:50px; width:100%; font-size:1.5rem; font-weight:bold; text-align:center; border:1px solid #e0e0e0; border-radius:12px;" />
          </div>

          <textarea id="retroWasteNote" class="retro-note-input" placeholder="å¤‡æ³¨ï¼šä¸ºä»€ä¹ˆè§‰å¾—è¿™ç¬”æ˜¯æµªè´¹ï¼Ÿï¼ˆå¯é€‰ï¼‰"></textarea>

          <div style="display:flex; gap:10px; width:100%;">
            <button class="action-btn-large btn-light" style="flex:1;" onclick="closeRetroInput()">å–æ¶ˆ</button>
            <button class="action-btn-large btn-brown" style="flex:1;" onclick="confirmWasteAction()">ç¡®è®¤</button>
          </div>
        </div>
      </div>

    </div>

    <!-- 3. ç»“ç®—æŠ¥å‘Š -->
    <div class="retro-summary" id="retroSummary">
      <div style="font-size:4rem; margin-bottom:20px;">ğŸ‰</div>
      <h2 style="margin:0 0 10px; color:var(--text-main);">å¤ç›˜å®Œæˆ !</h2>
      <p style="color:var(--text-sub); margin-bottom:30px;">æœ¬æœˆçœé’±æ½œåŠ›æ¢³ç†</p>
      <div class="stat-card theme-red" style="margin:0 auto 30px; max-width:300px;">
        <div class="stat-content">
          <div class="stat-label">è¯†åˆ«ä¸å¿…è¦æ”¯å‡º</div>
          <div class="stat-value" id="retroTotalWaste" style="color:#c62828;">Â¥ 0.00</div>
        </div>
      </div>
      <button class="action-btn-large btn-brown" onclick="closeRetroMode()">å®Œæˆå¹¶åˆ·æ–°</button>
    </div>
  </div>

  <!-- åçœæ¸…å•å¼¹çª— -->
  <div class="modal-overlay" id="wasteListModal">
    <div class="modal"
      style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; padding: 25px;">
      <div class="modal-header" style="align-items: center; margin-bottom: 10px; padding-bottom: 15px;">
        <div class="modal-title" style="flex:1;">ğŸ§ æµªè´¹åçœæ¸…å•</div>
        <select id="wasteMonthSelect" onchange="renderWasteList()"
          style="width: 120px; height: 36px; padding: 0 10px; margin-right: 15px; border-radius: 8px; border: 1px solid #ddd;">
          <!-- JS Populate -->
        </select>
        <button
          style="background:none; border:none; font-size:1.8rem; color:#999; cursor:pointer; padding:0; line-height:1;"
          onclick="closeWasteListModal()">Ã—</button>
      </div>

      <div style="flex: 1; overflow-y: auto; padding-right: 5px; margin-top: 5px;" id="wasteListContainer">
        <!-- åŠ¨æ€ç”Ÿæˆåˆ—è¡¨ -->
        <div style="text-align:center; color:#999; margin-top:50px;">æš‚æ— æµªè´¹è®°å½•</div>
      </div>

      <!-- åˆ†é¡µæ§ä»¶ -->
      <div class="pagination-container"
        style="margin-top: 15px; margin-bottom: 0; padding-top: 15px; border-bottom: none;">
        <div style="color: var(--text-sub); font-size: 0.9rem;" id="wasteListSummaryText">å…± 0 æ¡</div>
        <div class="pagination-jumper">
          <button class="btn-page-nav" onclick="changeWastePageRelative(-1)" title="ä¸Šä¸€é¡µ">â®</button>
          <input type="number" id="wastePageInput" class="pagination-input" value="1" onchange="jumpToWastePage()"
            min="1">
          <span style="margin: 0 5px; color: var(--text-sub);">/ <span id="wasteTotalPages">1</span> é¡µ</span>
          <button class="btn-page-nav" onclick="changeWastePageRelative(1)" title="ä¸‹ä¸€é¡µ">â¯</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ç¼–è¾‘å¤‡æ³¨å’Œé‡‘é¢çš„ç‹¬ç«‹å¼¹çª— (ä»çˆ¶çº§ç§»å‡ºä»¥æ”¯æŒå…¨å±€è°ƒç”¨) -->
  <div id="editNoteOverlay" class="modal-overlay" style="z-index: 2000;">
    <div class="modal" style="display: flex; flex-direction: column; padding: 25px; max-width: 400px;">
      <h4 style="margin-bottom: 20px; text-align: center;">ä¿®æ”¹åçœè¯¦æƒ…</h4>

      <div style="width:100%; margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; color:#607d8b; font-size:0.9rem;">æµªè´¹é‡‘é¢</label>
        <div style="position:relative; width:100%;">
          <span
            style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#999; font-weight:bold;">Â¥</span>
          <input type="number" id="editWasteAmountInput"
            style="padding-left:30px; width:100%; height: 42px; border-radius: 8px; border: 1px solid #ddd;" />
        </div>
      </div>

      <div style="width:100%; margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; color:#607d8b; font-size:0.9rem;">åçœå¤‡æ³¨</label>
        <textarea id="editWasteNoteInput" class="retro-note-input"
          style="height:100px; margin-bottom:0; width: 100%;"></textarea>
      </div>

      <div style="display:flex; gap:10px; width:100%;">
        <button class="action-btn btn-light" style="flex:1" onclick="closeEditNote()">å–æ¶ˆ</button>

        <!-- ä¸­é—´æ“ä½œæŒ‰é’®ç»„ -->
        <button class="action-btn btn-dark" style="flex:1; display:none;" id="btnRevokeWaste"
          onclick="revokeWaste()">æ’¤é”€æµªè´¹</button>
        <button class="action-btn"
          style="flex:1; display:none; background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;" id="btnMarkSafe"
          onclick="markAsSafe()">âœ… ç¡®è®¤æ— è¯¯</button>

        <button class="action-btn btn-brown" style="flex:1" onclick="saveEditNote()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // ========== 0. å…¨å±€é…ç½®ä¸å˜é‡ ==========
    const OPENROUTER_API_KEY = ""; // æ­¤å¤„ç•™ç©ºï¼Œå·²ä¿®æ”¹é€»è¾‘è¯»å– localStorage
    let openRouterKey = ""; // å…¨å±€å˜é‡å­˜å‚¨ Key

    const MY_FAMILY_ID = "big banana house";
    const EXPENSE_CLASS_NAME = 'rourou_YellowChamberPot';
    const BUDGET_CLASS_NAME = 'rourou_FamilyBudget'; // äº‘ç«¯é¢„ç®—è¡¨
    let BudgetClass = null;  // LeanCloud é¢„ç®—ç±»
    let cloudBudget = 9000;  // äº‘ç«¯åŒæ­¥çš„é¢„ç®—å€¼

    // æ”¯å‡ºç±»å‹å®šä¹‰ (å·²ç§»é™¤æˆ¿ç§Ÿ)
    const EXPENSE_TYPES = ['åƒ', 'å–', 'äº¤é€š', 'è¯è´¹', 'è´­ç‰©', 'æ¸¸æˆ', 'å……å€¼', 'ç”µæ°´è´¹', 'å® ç‰©', 'å…¶ä»–'];

    // æ”¶å…¥ç±»å‹ (è™½ç„¶UIä¸æ˜¾ç¤ºï¼Œä¿ç•™å®šä¹‰ä»¥é˜²æŠ¥é”™)
    const INCOME_TYPES = ['å…¶ä»–'];

    const MORANDI_PALETTE = [
      '#90a4ae', '#a1887f', '#e57373', '#81c784', '#64b5f6',
      '#ffb74d', '#ba68c8', '#4db6ac', '#ffd54f', '#a1887f', '#7986cb'
    ];
    const USER_COLOR_MAP = {
      "hundun": { bg: '#fce4ec', text: '#c2185b' },
      "rourou622": { bg: '#e8f5e9', text: '#2e7d32' },
      "å…¶ä»–": { bg: '#f5f5f5', text: '#616161' }
    };
    let ExpenseClass = null;
    let currentUser = null;
    let allExpenses = [];
    let filteredExpenses = [];
    let monthlyBarChart = null;
    let echartsPieInstance = null;
    let activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let tempSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let currentPage = 1;
    let pageSize = 10;
    let currentBudget = 9000;
    let authMode = 'login';

    // ========== 1. å¯åŠ¨é€»è¾‘ ==========
    window.onload = () => { checkAppConfig(); };
    function getUserColor(username) { return USER_COLOR_MAP[username] || USER_COLOR_MAP["å…¶ä»–"]; }
    function checkAppConfig() {
      const id = localStorage.getItem('lc_app_id');
      const key = localStorage.getItem('lc_app_key');
      const url = localStorage.getItem('lc_server_url');
      const aiKey = localStorage.getItem('lc_ai_key');
      if (id && key && url && aiKey) {
        openRouterKey = aiKey; // èµ‹å€¼ç»™å…¨å±€å˜é‡
        initLeanCloud(id, key, url);
      } else {
        showConfigForm();
      }
    }
    function initLeanCloud(id, key, url) {
      document.getElementById('configSection').style.display = 'none';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';
      try {
        if (typeof AV === 'undefined') { alert('LeanCloud SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'); return; }
        // ç®€å•çš„ URL æ ¼å¼æ£€æŸ¥
        if (!url.startsWith('http')) {
          throw new Error('API Server URL å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
        }
        AV.init({ appId: id, appKey: key, serverURLs: url });
        ExpenseClass = AV.Object.extend(EXPENSE_CLASS_NAME);
        BudgetClass = AV.Object.extend(BUDGET_CLASS_NAME);  // åˆå§‹åŒ–é¢„ç®—ç±»
        checkLoginStatus();
      } catch (e) {
        console.error(e);
        alert('åˆå§‹åŒ–å¤±è´¥: ' + e.message);
        clearConfig();
      }
    }
    function checkLoginStatus() {
      currentUser = AV.User.current();
      document.getElementById('loadingSection').style.display = 'none';
      if (currentUser) { enterApp(); } else { showAuthForm(); }
    }
    async function enterApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('currentUserDisplay').textContent = `${currentUser.getUsername()}`;
      initCustomDropdown();
      await loadBudgetFromCloud();  // ä»äº‘ç«¯åŠ è½½é¢„ç®—
      renderExpenses();
      window.onresize = () => { if (echartsPieInstance) echartsPieInstance.resize(); };
    }
    function logout() { AV.User.logOut(); location.reload(); }

    // ========== 2. è®¤è¯ç•Œé¢é€»è¾‘ ==========
    function showConfigForm() { document.getElementById('configSection').style.display = 'block'; document.getElementById('authSection').style.display = 'none'; document.getElementById('loadingSection').style.display = 'none'; }
    function saveConfig() {
      const id = document.getElementById('configAppId').value.trim();
      const key = document.getElementById('configAppKey').value.trim();
      const url = document.getElementById('configServerUrl').value.trim();
      const aiKey = document.getElementById('configAiKey').value.trim(); // è·å–è¾“å…¥

      if (!id || !key || !url || !aiKey) return alert('è¯·å¡«å†™å®Œæ•´é…ç½®ï¼ˆåŒ…æ‹¬ AI Keyï¼‰');

      localStorage.setItem('lc_app_id', id);
      localStorage.setItem('lc_app_key', key);
      localStorage.setItem('lc_server_url', url);
      localStorage.setItem('lc_ai_key', aiKey); // ä¿å­˜åˆ°æœ¬åœ°

      openRouterKey = aiKey; // æ›´æ–°å…¨å±€å˜é‡
      initLeanCloud(id, key, url);
    }
    function clearConfig() {
      localStorage.removeItem('lc_app_id');
      localStorage.removeItem('lc_app_key');
      localStorage.removeItem('lc_server_url');
      localStorage.removeItem('lc_ai_key'); // æ¸…é™¤ Key
      location.reload();
    }
    function showAuthForm() { document.getElementById('authSection').style.display = 'block'; switchAuthMode('login'); }
    function switchAuthMode(mode) {
      authMode = mode;
      const btn = document.getElementById('authActionBtn');
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      if (mode === 'login') { tabLogin.classList.add('active'); tabSignup.classList.remove('active'); btn.textContent = 'ç«‹å³ç™»å½•'; btn.className = 'action-btn-large btn-brown'; } else { tabLogin.classList.remove('active'); tabSignup.classList.add('active'); btn.textContent = 'æ³¨å†Œå¹¶ç™»å½•'; btn.className = 'action-btn-large btn-accent'; }
    }
    async function handleAuthAction() {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      if (!u || !p) return alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
      try {
        if (authMode === 'login') { await AV.User.logIn(u, p); } else { const user = new AV.User(); user.setUsername(u); user.setPassword(p); await user.signUp(); }
        checkLoginStatus();
      } catch (error) { alert('æ“ä½œå¤±è´¥: ' + error.message); }
    }

    // ========== 3. ä¸‹æ‹‰æ¡†ä¸ç­›é€‰é€»è¾‘ ==========
    function initCustomDropdown() {
      const list = document.getElementById('typeOptionsList'); list.innerHTML = '';
      const allDiv = document.createElement('div'); allDiv.className = 'custom-option';
      allDiv.innerHTML = `<input type="checkbox" value="å…¨éƒ¨ç±»å‹" id="cb_all"><span>å…¨éƒ¨ç±»å‹</span>`;
      allDiv.onclick = (e) => toggleDropdownItem(e, 'å…¨éƒ¨ç±»å‹'); list.appendChild(allDiv);
      EXPENSE_TYPES.forEach(type => {
        const div = document.createElement('div'); div.className = 'custom-option';
        div.innerHTML = `<input type="checkbox" value="${type}" id="cb_${type}"><span>${type}</span>`;
        div.onclick = (e) => toggleDropdownItem(e, type); list.appendChild(div);
      });
      updateModalTypeOptions();
      const wrapper = document.getElementById('typeSelectWrapper');
      const trigger = document.getElementById('typeSelectTrigger');
      trigger.addEventListener('click', (e) => { e.stopPropagation(); wrapper.classList.toggle('open'); if (wrapper.classList.contains('open')) { tempSelectedTypes = [...activeSelectedTypes]; renderDropdownCheckboxes(); } });
      document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) wrapper.classList.remove('open'); });
    }
    function renderDropdownCheckboxes() {
      const isAll = tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹'); document.getElementById('cb_all').checked = isAll;
      EXPENSE_TYPES.forEach(type => { const cb = document.getElementById(`cb_${type}`); if (isAll) { cb.checked = true; } else { cb.checked = tempSelectedTypes.includes(type); } });
    }
    function toggleDropdownItem(e, value) {
      if (e.target.tagName !== 'INPUT') { const cb = e.currentTarget.querySelector('input'); cb.checked = !cb.checked; }
      if (value === 'å…¨éƒ¨ç±»å‹') { const isChecked = document.getElementById('cb_all').checked; tempSelectedTypes = isChecked ? ['å…¨éƒ¨ç±»å‹'] : []; } else { const isChecked = document.getElementById(`cb_${value}`).checked; if (tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { tempSelectedTypes = [...EXPENSE_TYPES]; if (!isChecked) tempSelectedTypes = tempSelectedTypes.filter(t => t !== value); } else { if (isChecked) tempSelectedTypes.push(value); else tempSelectedTypes = tempSelectedTypes.filter(t => t !== value); } const allSelected = EXPENSE_TYPES.every(t => tempSelectedTypes.includes(t)); if (allSelected) tempSelectedTypes = ['å…¨éƒ¨ç±»å‹']; }
      renderDropdownCheckboxes();
    }
    function confirmTypeFilter() { activeSelectedTypes = [...tempSelectedTypes]; if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; updateTriggerText(); document.getElementById('typeSelectWrapper').classList.remove('open'); renderExpenses(); }
    function cancelTypeFilter() { document.getElementById('typeSelectWrapper').classList.remove('open'); }
    function updateTriggerText() { const trigger = document.getElementById('typeSelectTrigger'); if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { trigger.textContent = 'å…¨éƒ¨ç±»å‹'; } else if (activeSelectedTypes.length === 1) { trigger.textContent = activeSelectedTypes[0]; } else { trigger.textContent = `${activeSelectedTypes[0]} ç­‰ ${activeSelectedTypes.length} é¡¹`; } }

    // ========== 4. æ•°æ®è·å–ä¸å¤„ç† ==========
    function computeStatMonth(dateStr) {
      const d = new Date(dateStr); let y = d.getFullYear(), m = d.getMonth() + 1;
      if (d.getDate() <= 4) { if (m === 1) { m = 12; y--; } else { m--; } }
      return `${y}-${String(m).padStart(2, '0')}`;
    }
    async function getExpenses() {
      if (!ExpenseClass || !currentUser) return [];
      const query = new AV.Query(ExpenseClass); query.equalTo('familyId', MY_FAMILY_ID); query.include('owner'); query.addDescending('date'); query.addDescending('createdAt'); query.limit(1000);
      try {
        const results = await query.find();
        return results.map(obj => {
          const ownerObj = obj.get('owner'); const username = ownerObj ? ownerObj.getUsername() : 'æœªçŸ¥';
          return {
            id: obj.id,
            date: String(obj.get('date')),
            type1: obj.get('type1'),
            type2: obj.get('type2') || '',
            amount: parseFloat(obj.get('amount')) || 0,
            statMonth: computeStatMonth(obj.get('date')),
            username: username,
            createdAt: obj.createdAt,
            category: 'expense',
            // æ–°å¢å¤ç›˜å­—æ®µ
            wasteAmount: parseFloat(obj.get('wasteAmount')) || 0,
            wasteNote: obj.get('wasteNote') || '',
            isReviewed: obj.get('isReviewed') || false
          };
        });
      } catch (err) { console.error(err); return []; }
    }

    function getTimeFilteredExpenses() {
      let temp = [...allExpenses];
      const memberFilter = document.getElementById('memberFilter').value; if (memberFilter) temp = temp.filter(e => e.username === memberFilter);
      const mFilter = document.getElementById('monthFilter').value; if (mFilter) temp = temp.filter(e => e.statMonth === mFilter);
      const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value;
      if (startDate) temp = temp.filter(e => e.date >= startDate); if (endDate) temp = temp.filter(e => e.date <= endDate);
      return temp;
    }

    // ========== 5. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ==========
    async function renderExpenses() {
      if (!currentUser) return;
      if (allExpenses.length === 0) {
        allExpenses = await getExpenses();
        const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
        const sel = document.getElementById('monthFilter'); let targetVal = sel.value; sel.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>'; months.forEach(m => sel.add(new Option(m, m)));
        const currentMonth = computeStatMonth(new Date().toISOString());
        if (!targetVal && months.includes(currentMonth)) targetVal = currentMonth;
        if (targetVal) sel.value = targetVal;
      }
      const memberSel = document.getElementById('memberFilter'); const currentMember = memberSel.value; const members = [...new Set(allExpenses.map(e => e.username))].filter(u => u && u !== 'æœªçŸ¥'); memberSel.innerHTML = '<option value="">å…¨éƒ¨æˆå‘˜</option>'; members.forEach(u => memberSel.add(new Option(u, u))); if (currentMember && members.includes(currentMember)) memberSel.value = currentMember;

      updateDashboardCards();

      let temp = getTimeFilteredExpenses();
      if (!activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { temp = temp.filter(e => activeSelectedTypes.includes(e.type1)); }
      const kw = document.getElementById('searchInput').value.trim(); if (kw) temp = temp.filter(e => e.type2.includes(kw));
      temp.sort((a, b) => { const dateA = String(a.date || "").substring(0, 10); const dateB = String(b.date || "").substring(0, 10); if (dateA > dateB) return -1; if (dateA < dateB) return 1; const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0; const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0; return timeB - timeA; });
      filteredExpenses = temp;
      const totalPages = Math.ceil(filteredExpenses.length / pageSize) || 1; if (currentPage > totalPages) currentPage = 1; document.getElementById('totalPagesDisplay').innerText = totalPages; document.getElementById('pageJumpInput').max = totalPages; document.getElementById('pageJumpInput').value = currentPage;
      renderTable(); renderCharts();
    }

    // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘Dashboard æ•°æ®è®¡ç®— ===
    function updateDashboardCards() {
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ—¶é—´æ„å»º YYYY-MM-DDï¼Œé¿å… toISOString() å¯¼è‡´çš„ UTC åç§»é—®é¢˜ (å¦‚å‡Œæ™¨æ—¶åˆ†æ—¥æœŸå›æ‹¨)
      const localNowStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
      const currentStatMonth = computeStatMonth(localNowStr);

      // Compute days passed in the current cycle (starts on the 5th)
      const [cYear, cMonth] = currentStatMonth.split('-').map(Number);
      const cycleStart = new Date(cYear, cMonth - 1, 5); // Month is 0-indexed
      // Normalize to midnight for accurate day diff
      const calcNow = new Date(now);
      calcNow.setHours(0, 0, 0, 0);
      cycleStart.setHours(0, 0, 0, 0);

      let daysPassed = Math.floor((calcNow - cycleStart) / (1000 * 60 * 60 * 24)) + 1;
      if (daysPassed < 1) daysPassed = 1;

      const thisMonthData = allExpenses.filter(e => e.statMonth === currentStatMonth);
      const monthTotalExpense = thisMonthData.reduce((sum, item) => sum + item.amount, 0);
      const thisMonthBudget = cloudBudget || 9000; // ä½¿ç”¨äº‘ç«¯åŒæ­¥çš„é¢„ç®—
      const monthBalance = thisMonthBudget - monthTotalExpense;
      const largeCount = thisMonthData.filter(e => e.amount > 500).length;
      const dailyAvg = monthTotalExpense / daysPassed;

      // ä¿®å¤è¿‘7å¤©è®¡ç®—é€»è¾‘
      const sevenDaysAgo = new Date(now); // Clone now
      sevenDaysAgo.setDate(now.getDate() - 6); // Past 6 days + Today = 7 days range
      const sevenDaysAgoStr = sevenDaysAgo.getFullYear() + '-' + String(sevenDaysAgo.getMonth() + 1).padStart(2, '0') + '-' + String(sevenDaysAgo.getDate()).padStart(2, '0');

      let weeklyExpense = 0;
      let monthlyEntShopping = 0;
      let lastMonthExpense = 0;

      // ä¿®æ­£ç¯æ¯”æœˆä»½è®¡ç®—é€»è¾‘
      let [currYearNum, currMonthNum] = currentStatMonth.split('-').map(Number);
      let lastMonthNum = currMonthNum - 1;
      let lastYearNum = currYearNum;
      if (lastMonthNum === 0) { lastMonthNum = 12; lastYearNum--; }
      const lastMonthStr = `${lastYearNum}-${String(lastMonthNum).padStart(2, '0')}`;

      const excludedTypes = ['åƒ', 'å–', 'äº¤é€š', 'ç”µæ°´è´¹', 'æˆ¿ç§Ÿ'];

      allExpenses.forEach(item => {
        const itemDateStr = item.date.substring(0, 10);
        if (itemDateStr >= sevenDaysAgoStr) { weeklyExpense += item.amount; }
        if (item.statMonth === currentStatMonth) {
          if (!excludedTypes.includes(item.type1)) { monthlyEntShopping += item.amount; }
        }
        if (item.statMonth === lastMonthStr) { lastMonthExpense += item.amount; }
      });

      const weeklyAvg = weeklyExpense / 7;
      let momGrowth = 0;
      let momText = "--";
      if (lastMonthExpense > 0) {
        momGrowth = ((monthTotalExpense - lastMonthExpense) / lastMonthExpense) * 100;
        const sign = momGrowth > 0 ? '+' : '';
        momText = `${sign} ${momGrowth.toFixed(1)}%`;
      } else if (monthTotalExpense > 0) { momText = "ä¸Šæœˆæ— æ•°æ®"; }

      document.getElementById('dashMonthExpense').innerText = `Â¥ ${formatMoney(monthTotalExpense)}`;
      document.getElementById('dashMonthBalance').innerText = `Â¥ ${formatMoney(monthBalance)}`;
      document.getElementById('dashMonthBalance').style.color = monthBalance >= 0 ? '#2e7d32' : '#c62828';
      document.getElementById('dashLargeCount').innerText = `${largeCount} ç¬”`;
      document.getElementById('dashMonthDailyAvg').innerText = `Â¥ ${formatMoney(dailyAvg)}`;
      document.getElementById('dashEntertainment').innerText = `Â¥ ${formatMoney(monthlyEntShopping)}`;
      document.getElementById('dashWeeklyAvg').innerText = `Â¥ ${formatMoney(weeklyAvg)}`;
      const momEl = document.getElementById('dashMomGrowth');
      momEl.innerText = momText;
      momEl.style.color = momGrowth > 0 ? '#c62828' : (momGrowth < 0 ? '#2e7d32' : '#374151');

      // --- æ–°å¢ï¼šæµªè´¹ç»Ÿè®¡é€»è¾‘ (ä¸Šæœˆ & ç¯æ¯”) ---
      // 1. è·å–ä¸Šæœˆæ•°æ®
      const lastMonthData = allExpenses.filter(e => e.statMonth === lastMonthStr);
      const lastMonthWasteTotal = lastMonthData.reduce((sum, item) => sum + (item.wasteAmount || 0), 0);
      const lastMonthWasteCount = lastMonthData.filter(e => (e.wasteAmount || 0) > 0).length;

      document.getElementById('dashWasteLabel').innerText = `ä¸Šæœˆæµªè´¹ (${lastMonthWasteCount}ç¬”)`;
      document.getElementById('dashWasteValue').innerText = `Â¥ ${formatMoney(lastMonthWasteTotal)}`;

      // 2. è·å–å‰æœˆ (ä¸Šä¸Šæœˆ) æ•°æ®
      let [lmYear, lmMonth] = lastMonthStr.split('-').map(Number);
      let pmMonth = lmMonth - 1;
      let pmYear = lmYear;
      if (pmMonth === 0) { pmMonth = 12; pmYear--; }
      const prevMonthStr = `${pmYear}-${String(pmMonth).padStart(2, '0')}`;
      const prevMonthData = allExpenses.filter(e => e.statMonth === prevMonthStr);
      const prevMonthWasteTotal = prevMonthData.reduce((sum, item) => sum + (item.wasteAmount || 0), 0);

      // 3. è®¡ç®—ç¯æ¯”
      let trendText = "æ— å˜åŒ–";
      let trendColor = "#37474f";

      if (prevMonthWasteTotal > 0) {
        const diff = lastMonthWasteTotal - prevMonthWasteTotal;
        const percent = (diff / prevMonthWasteTotal) * 100;
        const sign = diff > 0 ? 'å¢é•¿ ' : (diff < 0 ? 'å‡å°‘ ' : '');
        // æ˜¾ç¤ºæ ¼å¼: å¢é•¿ 150 (10%)
        trendText = `${sign}${formatMoney(Math.abs(diff))} (${Math.abs(percent).toFixed(0)}%)`;

        if (diff > 0) trendColor = "#c62828"; // å¢åŠ æ˜¯åäº‹ (çº¢)
        else if (diff < 0) trendColor = "#2e7d32"; // å‡å°‘æ˜¯å¥½äº‹ (ç»¿)
      } else if (lastMonthWasteTotal > 0) {
        trendText = `å¢é•¿ ${formatMoney(lastMonthWasteTotal)} (æ–°å¢)`;
        trendColor = "#c62828";
      } else {
        if (lastMonthWasteTotal === 0 && prevMonthWasteTotal === 0) {
          trendText = "æ— æµªè´¹è®°å½•";
          trendColor = "#2e7d32";
        }
      }

      const trendEl = document.getElementById('dashWasteTrendValue');
      if (trendEl) {
        trendEl.innerText = trendText;
        trendEl.style.color = trendColor;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('expenseList'); tbody.innerHTML = ''; const start = (currentPage - 1) * pageSize; const pageData = filteredExpenses.slice(start, start + pageSize);
      const targetTotal = filteredExpenses.reduce((a, b) => a + b.amount, 0); const targetCount = filteredExpenses.length;

      const filterResultText = document.getElementById('filterResultText'); if (filterResultText) { filterResultText.innerHTML = `å…± ${targetCount} ç¬”<br>æ€»é¢ Â¥ ${formatMoney(targetTotal)}`; }
      const groups = {}; pageData.forEach(e => { if (!groups[e.statMonth]) groups[e.statMonth] = []; groups[e.statMonth].push(e); });

      Object.keys(groups).sort().reverse().forEach(mon => {
        const list = groups[mon]; const subTotal = list.reduce((s, i) => s + i.amount, 0);
        const trTitle = document.createElement('tr'); trTitle.innerHTML = `<td colspan="8" class="month-group-title">${mon} å½“å‰é¡µå°è®¡: Â¥ ${formatMoney(subTotal)}</td>`; tbody.appendChild(trTitle);
        list.forEach(item => {
          const userColor = getUserColor(item.username);
          const tr = document.createElement('tr');

          // --- ä¸‰ç§çŠ¶æ€é€»è¾‘ ---
          const isWaste = item.wasteAmount > 0;
          const isReviewed = item.isReviewed === true; // ç¡®ä¿æ˜¯å¸ƒå°”å€¼

          let btnStyle = '';
          let btnIcon = '';
          let btnTitle = '';

          if (isWaste) {
            // 1. å·²å¤ç›˜ - æµªè´¹ (Waste)
            tr.classList.add('row-waste'); // ä¿æŒçº¢è‰²èƒŒæ™¯
            btnStyle = 'color:#c62828; border-color:#ffcdd2; background:#ffebee;';
            btnIcon = 'ğŸ—‘ï¸';
            btnTitle = 'å·²ç¡®è®¤ä¸ºæµªè´¹ (ç‚¹å‡»ä¿®æ”¹)';
          } else if (isReviewed) {
            // 2. å·²å¤ç›˜ - æ­£å¸¸ (Safe)
            // æ­£å¸¸è¡ŒèƒŒæ™¯ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç»™ä¸ªæ·¡æ·¡çš„ç»¿è‰²èƒŒæ™¯ï¼Ÿæš‚æ—¶ä¿æŒé»˜è®¤ç™½è‰²ï¼Œä»¥å…å¤ªèŠ±
            // ä½†æŒ‰é’®è¦å˜
            btnStyle = 'color:#2e7d32; border-color:#c8e6c9; background:#e8f5e9; opacity: 0.8;';
            btnIcon = 'âœ…';
            btnTitle = 'å·²ç¡®è®¤æ— è¯¯ (ç‚¹å‡»å¯åæ‚”)';
          } else {
            // 3. æœªå¤ç›˜ (Pending)
            btnStyle = 'color:#ff9800; border-color:#ffe0b2; background:#fff3e0;'; // æ©™è‰²é—®å·
            btnIcon = 'â“';
            btnTitle = 'å¾…å¤ç›˜ (ç‚¹å‡»ç¡®è®¤)';
          }

          tr.innerHTML = `<td><input type="checkbox" class="item-cb" value="${item.id}" onchange="checkBatchBtn()" style="height:auto;"></td><td>${item.statMonth}</td><td>${item.date.substring(0, 10)}</td><td><span style="background:#eceff1; padding:2px 8px; border-radius:10px; font-size:0.85em; color:#455a64;">${item.type1}</span></td><td><span class="user-badge" style="background:${userColor.bg}; color:${userColor.text};">${item.username}</span></td><td>${item.type2}</td><td style="font-weight:500;">Â¥ ${formatMoney(item.amount)}</td>
          <td>
            <div class="action-cell-content">
               <button class="action-btn" style="${btnStyle} padding:4px 8px; min-width:32px;" onclick="openEditNote('${item.id}')" title="${btnTitle}">${btnIcon}</button>
               <button class="action-btn btn-brown" onclick="editExp('${item.id}')">ç¼–è¾‘</button>
               <button class="action-btn btn-dark" onclick="delExp('${item.id}')">åˆ é™¤</button>
            </div>
          </td>`;
          tbody.appendChild(tr);
        });
      }); checkBatchBtn();
    }

    // ========== 7. å›¾è¡¨ä¸å…¶ä»–æ“ä½œ ==========
    function openEditNote(id) {
      currentEditNoteId = id;
      const item = allExpenses.find(e => e.id === id);

      document.getElementById('editWasteNoteInput').value = item.wasteNote || '';
      // å¦‚æœå·²æœ‰ wasteAmount ç”¨å®ƒï¼Œå¦åˆ™é»˜è®¤ç”¨ amount
      const defaultAmount = (item.wasteAmount > 0) ? item.wasteAmount : item.amount;
      document.getElementById('editWasteAmountInput').value = defaultAmount;

      // æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
      const btnRevoke = document.getElementById('btnRevokeWaste');
      const btnSafe = document.getElementById('btnMarkSafe');

      // å…ˆéšè—æ‰€æœ‰ä¸­é—´æŒ‰é’®
      btnRevoke.style.display = 'none';
      btnSafe.style.display = 'none';

      if (item.wasteAmount > 0) {
        // å¦‚æœæ˜¯æµªè´¹ -> æ˜¾ç¤ºæ’¤é”€
        btnRevoke.style.display = 'block';
      } else if (!item.isReviewed) {
        // å¦‚æœæœªå¤ç›˜ -> æ˜¾ç¤ºç¡®è®¤æ— è¯¯
        btnSafe.style.display = 'block';
      }
      // å¦‚æœå·²å¤ç›˜ä¸”æ­£å¸¸ (Safe) -> ä¸æ˜¾ç¤ºä¸­é—´æŒ‰é’® (åªæ˜¾ç¤ºå–æ¶ˆ/ä¿å­˜)

      document.getElementById('editNoteOverlay').classList.add('active');
    }

    function closeEditNote() {
      document.getElementById('editNoteOverlay').classList.remove('active');
      currentEditNoteId = null;
    }

    async function revokeWaste() {
      if (!confirm('ç¡®å®šæ’¤é”€æµªè´¹æ ‡è®°ï¼Ÿæ­¤è®°å½•å°†å˜æ›´ä¸ºâ€œå·²å¤ç›˜-æ­£å¸¸â€ã€‚')) return;
      await setItemStatus(0, '', true);
    }

    async function markAsSafe() {
      // æ ‡è®°ä¸ºæ­£å¸¸ï¼šæµªè´¹=0ï¼Œå·²å¤ç›˜=true
      await setItemStatus(0, '', true);
    }

    // é€šç”¨çŠ¶æ€æ›´æ–°å‡½æ•°
    async function setItemStatus(wasteAmt, note, reviewed) {
      if (!currentEditNoteId) return;

      const item = allExpenses.find(e => e.id === currentEditNoteId);
      if (item) {
        item.wasteAmount = wasteAmt;
        item.wasteNote = note;
        item.isReviewed = reviewed;
      }

      // æ›´æ–°äº‘ç«¯
      await updateExpenseStatus(currentEditNoteId, { wasteAmount: wasteAmt, wasteNote: note, isReviewed: reviewed });

      closeEditNote();
      refreshAllViews();
    }

    async function saveEditNote() {
      if (!currentEditNoteId) return;
      const newNote = document.getElementById('editWasteNoteInput').value.trim();
      const newAmount = parseFloat(document.getElementById('editWasteAmountInput').value);

      if (isNaN(newAmount) || newAmount < 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');

      // åªè¦ç‚¹äº†ä¿å­˜ï¼Œå°±ç®—å·²å¤ç›˜
      // å¦‚æœé‡‘é¢ > 0ï¼Œ naturally is waste

      const item = allExpenses.find(e => e.id === currentEditNoteId);
      if (item) {
        item.wasteNote = newNote;
        item.wasteAmount = newAmount;
        item.isReviewed = true;

        const uiNote = document.getElementById(`note-text-${currentEditNoteId}`);
        if (uiNote) uiNote.innerText = newNote || 'æš‚æ— å¤‡æ³¨';
        const uiAmount = document.getElementById(`amount-text-${currentEditNoteId}`);
        if (uiAmount) uiAmount.innerText = `Â¥ ${formatMoney(newAmount)}`;
      }

      await updateExpenseStatus(currentEditNoteId, { wasteNote: newNote, wasteAmount: newAmount, isReviewed: true });

      closeEditNote();
      refreshAllViews();
    }

    function refreshAllViews() {
      // ä¸ºäº†ç®€åŒ–ï¼Œåˆ·æ–°æ‰€æœ‰ç›¸å…³è§†å›¾

      // 1. å¦‚æœåçœæ¸…å•å¼€ç€ï¼Œåˆ·æ–°å®ƒ
      if (document.getElementById('wasteListModal').classList.contains('active')) {
        renderWasteList();
      }

      // 2. åˆ·æ–°ä¸»åˆ—è¡¨ (å› ä¸ºå¯èƒ½æœ‰é¢œè‰²å˜åŒ–æˆ–æ–°æ ‡è®°)
      renderExpenses();
    }

    // ========== 7. å›¾è¡¨ä¸å…¶ä»–æ“ä½œ ==========
    let selectedChartMonth = null;
    let chartEndMonth = null; // ç”¨äºæ§åˆ¶æŸ±çŠ¶å›¾æ˜¾ç¤ºçš„â€œç»“æŸæœˆä»½â€ (è§†å›¾çª—å£)

    // è·å–é¢„ç®— (ä½¿ç”¨äº‘ç«¯åŒæ­¥çš„é¢„ç®—å€¼)
    function getBudgetForMonth(month) {
      return cloudBudget || 9000;
    }

    // ä»äº‘ç«¯åŠ è½½é¢„ç®—
    async function loadBudgetFromCloud() {
      try {
        const query = new AV.Query(BUDGET_CLASS_NAME);
        query.equalTo('familyId', MY_FAMILY_ID);
        const result = await query.first();
        if (result) {
          cloudBudget = result.get('budgetAmount') || 9000;
        } else {
          cloudBudget = 9000; // é»˜è®¤é¢„ç®—
        }
        console.log('äº‘ç«¯é¢„ç®—å·²åŠ è½½:', cloudBudget);
      } catch (err) {
        // å¦‚æœ Class ä¸å­˜åœ¨ (404/101)ï¼Œä½¿ç”¨é»˜è®¤é¢„ç®—ï¼Œç¨åä¿å­˜æ—¶ä¼šè‡ªåŠ¨åˆ›å»º
        if (err.code === 101 || (err.message && err.message.includes("doesn't exist"))) {
          console.log('é¢„ç®—è¡¨å°šæœªåˆ›å»ºï¼Œä½¿ç”¨é»˜è®¤é¢„ç®—');
          cloudBudget = 9000;
        } else {
          console.error('åŠ è½½äº‘ç«¯é¢„ç®—å¤±è´¥:', err);
          cloudBudget = 9000;
        }
      }
    }

    // ä¿å­˜é¢„ç®—åˆ°äº‘ç«¯
    async function saveBudgetToCloud(newBudget) {
      try {
        // å…ˆå°è¯•æŸ¥è¯¢å·²æœ‰è®°å½•
        let budgetObj = null;
        try {
          const query = new AV.Query(BUDGET_CLASS_NAME);
          query.equalTo('familyId', MY_FAMILY_ID);
          budgetObj = await query.first();
        } catch (queryErr) {
          // Class ä¸å­˜åœ¨æ—¶æŸ¥è¯¢ä¼šæŠ¥é”™ï¼Œå¿½ç•¥å¹¶ç»§ç»­åˆ›å»ºæ–°è®°å½•
          console.log('é¢„ç®—è¡¨ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º');
        }

        if (budgetObj) {
          // æ›´æ–°å·²æœ‰è®°å½•
          budgetObj.set('budgetAmount', newBudget);
        } else {
          // åˆ›å»ºæ–°è®°å½•
          budgetObj = new BudgetClass();
          budgetObj.set('familyId', MY_FAMILY_ID);
          budgetObj.set('budgetAmount', newBudget);
          // è®¾ç½®å…¬å¼€è¯»å†™æƒé™ï¼ˆå®¶åº­æˆå‘˜å…±äº«ï¼‰
          const acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          budgetObj.setACL(acl);
        }

        await budgetObj.save();
        cloudBudget = newBudget;
        console.log('é¢„ç®—å·²ä¿å­˜åˆ°äº‘ç«¯:', newBudget);
        return true;
      } catch (err) {
        console.error('ä¿å­˜äº‘ç«¯é¢„ç®—å¤±è´¥:', err);
        alert('ä¿å­˜é¢„ç®—å¤±è´¥: ' + err.message);
        return false;
      }
    }

    function renderCharts() {
      // 1. å‡†å¤‡æ•°æ®
      const groups = {};
      allExpenses.forEach(e => {
        if (!groups[e.statMonth]) groups[e.statMonth] = 0;
        groups[e.statMonth] += e.amount;
      });

      // è·å–å½“å‰çœŸå®æœˆä»½ (ä½¿ç”¨æœ¬åœ°æ—¶é—´)
      const now = new Date();
      const localNowStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
      const currentRealMonth = computeStatMonth(localNowStr);

      // åˆå§‹åŒ–é€‰ä¸­æœˆä»½
      if (!selectedChartMonth) selectedChartMonth = currentRealMonth;

      // ç¡®å®šè§†å›¾çª—å£ï¼šä»¥é€‰ä¸­çš„æœˆä»½ä¸ºä¸­å¿ƒï¼Œå‰åå„2ä¸ªæœˆ (å…±5ä¸ªæœˆ)
      // Range: [Selected-2, Selected-1, Selected, Selected+1, Selected+2]
      const months = [];
      const [sYear, sMonth] = selectedChartMonth.split('-').map(Number);

      for (let i = -2; i <= 2; i++) {
        let m = sMonth + i;
        let y = sYear;
        while (m <= 0) { m += 12; y--; }
        while (m > 12) { m -= 12; y++; }
        months.push(`${y}-${String(m).padStart(2, '0')}`);
      }

      // æ›´æ–°è‡ªå®šä¹‰æ˜¾ç¤ºæ–‡æœ¬ (2026.01)
      const displaySpan = document.getElementById('chartDateDisplay');
      if (displaySpan) {
        displaySpan.textContent = selectedChartMonth.replace('-', '.');
      }

      const totals = months.map(m => groups[m] || 0);

      // 2. è·å–é€‰ä¸­æœˆä»½çš„é¢„ç®—ä¿¡æ¯
      currentBudget = getBudgetForMonth(selectedChartMonth);
      const selectedTotal = groups[selectedChartMonth] || 0;

      // æ›´æ–°æ ‡é¢˜ (åŒ…å«é¢„ç®—)
      const formattedMonth = selectedChartMonth.replace('-', '.');
      document.getElementById('budgetTitle').innerHTML = `
        ${formattedMonth} æ€»æ”¯å‡º 
        <span style="font-size:0.85em; font-weight:normal; color:#78909c; margin-left:8px;">
           (é¢„ç®— Â¥${currentBudget})
        </span>
      `;

      // 3. æ¸²æŸ“æŸ±çŠ¶å›¾
      const ctxBar = document.getElementById('monthlyBarChart').getContext('2d');
      if (monthlyBarChart) monthlyBarChart.destroy();

      // é¢œè‰²é€»è¾‘: 
      const barColors = months.map(m => {
        if (m === selectedChartMonth) {
          const mTotal = groups[m] || 0;
          const mBudget = currentBudget;
          return mTotal > mBudget ? '#e57373' : '#81c784';
        }
        return '#cfd8dc'; // é»˜è®¤ä¸ºæµ…ç°
      });

      monthlyBarChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'æ”¯å‡º',
            data: totals,
            backgroundColor: barColors,
            borderRadius: 6,
            barPercentage: 0.5,
            hoverBackgroundColor: '#90a4ae'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const clickedMonth = months[index];
              if (clickedMonth !== selectedChartMonth) {
                selectedChartMonth = clickedMonth;
                renderCharts();
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: context => context.parsed.y ? 'Â¥ ' + formatMoney(context.parsed.y) : ''
              }
            },
            annotation: {
              annotations: {
                line1: {
                  type: 'line',
                  yMin: currentBudget,
                  yMax: currentBudget,
                  borderColor: '#90a4ae',
                  borderDash: [4, 4],
                  borderWidth: 1.5,
                  label: {
                    display: true,
                    content: `é¢„ç®— Â¥ ${currentBudget}`,
                    position: 'end',
                    color: '#78909c',
                    font: { size: 10 },
                    backgroundColor: 'rgba(255,255,255,0.8)'
                  }
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#f1f5f9', drawBorder: false },
              ticks: { color: '#b0bec5', font: { size: 10 } },
              border: { display: false }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#64748b', font: { size: 11 } },
              border: { display: false }
            }
          }
        }
      });

      // 4. æ›´æ–°è¿›åº¦æ¡ (åŸºäº selectedChartMonth)
      const percent = Math.min(100, (selectedTotal / currentBudget) * 100);
      const remain = currentBudget - selectedTotal;

      const pGreen = document.getElementById('progressGreen');
      const pRed = document.getElementById('progressRed');
      const pText = document.getElementById('progressText');

      if (remain >= 0) {
        pGreen.style.width = ((remain / currentBudget) * 100) + '%';
        pRed.style.width = '0%';
        pText.textContent = `${selectedChartMonth} å‰©ä½™ Â¥ ${remain.toFixed(0)} (${(100 - percent).toFixed(0)}%)`;
        pText.style.color = "#2e7d32";
      } else {
        pGreen.style.width = '0%';
        const overPercent = Math.min(100, (Math.abs(remain) / currentBudget) * 100);
        const overRate = ((Math.abs(remain) / currentBudget) * 100).toFixed(0);

        pRed.style.width = overPercent + '%';
        pText.textContent = `${selectedChartMonth} è¶…æ”¯ Â¥ ${Math.abs(remain).toFixed(0)} (è¶… ${overRate}%)`;
        pText.style.color = "#c62828";
      }

      renderEChartsPie();
    }

    // ========== Custom Month Picker Logic ==========
    let pickerYear = new Date().getFullYear();

    function toggleMonthPicker(e) {
      const pop = document.getElementById('customMonthPopover');
      if (!pop) return;

      const isOpen = pop.classList.contains('active');
      if (isOpen) {
        pop.classList.remove('active');
      } else {
        // åŒæ­¥å½“å‰çš„å¹´ä»½åˆ° Picker
        if (selectedChartMonth) {
          pickerYear = parseInt(selectedChartMonth.split('-')[0]);
        }
        renderPickerGrid();
        pop.classList.add('active');
      }
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    document.addEventListener('click', function (e) {
      const wrapper = document.querySelector('.date-display-wrapper');
      const popover = document.getElementById('customMonthPopover');
      if (wrapper && popover && !wrapper.contains(e.target)) {
        popover.classList.remove('active');
      }
    });

    function changePickerYear(offset) {
      pickerYear += offset;
      renderPickerGrid();
    }

    function renderPickerGrid() {
      document.getElementById('pickerYearDisplay').innerText = pickerYear;
      const grid = document.getElementById('pickerMonthGrid');
      grid.innerHTML = '';

      // Get all unique statMonths from allExpenses for the current pickerYear
      const monthsWithData = new Set(allExpenses
        .filter(e => e.statMonth.startsWith(`${pickerYear}-`))
        .map(e => e.statMonth));

      for (let m = 1; m <= 12; m++) {
        const mStr = String(m).padStart(2, '0');
        const fullMonth = `${pickerYear}-${mStr}`;

        const div = document.createElement('div');
        div.className = 'month-cell';
        div.innerText = `${m}æœˆ`;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
        const hasData = monthsWithData.has(fullMonth);
        if (hasData) div.classList.add('has-data');

        // æ£€æŸ¥æ˜¯å¦å½“å‰é€‰ä¸­
        if (fullMonth === selectedChartMonth) div.classList.add('selected');

        div.onclick = function () {
          if (!hasData) {
            alert(`${fullMonth} æ— æ•°æ®`);
            return;
          }
          selectedChartMonth = fullMonth;
          renderCharts();
          document.getElementById('customMonthPopover').classList.remove('active');
        };

        grid.appendChild(div);
      }
    }

    function shiftChartMonth(offset) {
      if (!selectedChartMonth) return;
      let [y, m] = selectedChartMonth.split('-').map(Number);

      // è®¡ç®—ç›®æ ‡æœˆä»½
      m += offset;
      while (m <= 0) { m += 12; y--; }
      while (m > 12) { m -= 12; y++; }

      const targetMonth = `${y}-${String(m).padStart(2, '0')}`;

      // æ£€æŸ¥ç›®æ ‡æœˆä»½æ˜¯å¦æœ‰æ•°æ®
      const hasData = allExpenses.some(e => e.statMonth === targetMonth);
      if (!hasData) {
        alert(`æœˆä»½ ${targetMonth} æ— è´¦å•æ•°æ®`);
        return;
      }

      selectedChartMonth = targetMonth;
      renderCharts();
    }

    function renderEChartsPie() {
      const dom = document.getElementById('echartsPie'); if (!echartsPieInstance) { echartsPieInstance = echarts.init(dom); echartsPieInstance.on('click', function (params) { handleChartClick(params.name); }); echartsPieInstance.on('legendselectchanged', function (params) { handleChartClick(params.name); }); }
      let pieSourceData = getTimeFilteredExpenses(); const typeMap = {}; pieSourceData.forEach(e => { typeMap[e.type1] = (typeMap[e.type1] || 0) + e.amount; });
      const isAllSelected = activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹'); const dataForChart = Object.keys(typeMap).map(k => { const isSelected = isAllSelected || activeSelectedTypes.includes(k); return { value: typeMap[k], name: k, itemStyle: { opacity: isSelected ? 1 : 0.1, color: isSelected ? undefined : '#cfd8dc' }, label: { show: isSelected, color: '#546e7a' }, labelLine: { show: isSelected, lineStyle: { color: '#cfd8dc' } } }; });
      const legendSelectedState = {}; EXPENSE_TYPES.forEach(t => legendSelectedState[t] = true);
      const option = { color: MORANDI_PALETTE, tooltip: { trigger: 'item', backgroundColor: 'rgba(255,255,255,0.9)', formatter: function (params) { return `${params.name}<br/>Â¥ ${params.value.toFixed(2)} (${params.percent}%)`; } }, legend: { bottom: 0, left: 'center', padding: [5, 5], itemWidth: 15, itemHeight: 10, textStyle: { color: '#607d8b' }, width: '95%', selected: legendSelectedState }, series: [{ name: 'æ”¯å‡ºç±»å‹', type: 'pie', radius: ['35%', '55%'], center: ['50%', '40%'], avoidLabelOverlap: true, itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 }, data: dataForChart, selectedMode: 'multiple', selectedOffset: 10 }] }; echartsPieInstance.setOption(option, true);
    }
    function handleChartClick(typeName) { if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { activeSelectedTypes = [typeName]; } else { if (activeSelectedTypes.includes(typeName)) { activeSelectedTypes = activeSelectedTypes.filter(t => t !== typeName); if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; } else { activeSelectedTypes.push(typeName); } } tempSelectedTypes = [...activeSelectedTypes]; updateTriggerText(); renderDropdownCheckboxes(); renderExpenses(); }

    // ========== 8. è¾…åŠ©æ“ä½œä¸æ–°å¢åŠŸèƒ½ ==========
    function formatMoney(n) { return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }
    function applyMonthOrSearchFilter() { currentPage = 1; renderExpenses(); }
    function applyDateRangeFilter() { const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value; if (start && end && start > end) { alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´'); document.getElementById('startDate').value = ''; return; } currentPage = 1; renderExpenses(); }
    function resetFilters() { activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; tempSelectedTypes = ['å…¨éƒ¨ç±»å‹']; updateTriggerText(); renderDropdownCheckboxes(); document.getElementById('typeSelectWrapper').classList.remove('open'); document.getElementById('startDate').value = ''; document.getElementById('endDate').value = ''; const sel = document.getElementById('monthFilter'); const memSel = document.getElementById('memberFilter'); memSel.value = ""; const currentMonth = computeStatMonth(new Date().toISOString()); let found = false; for (let i = 0; i < sel.options.length; i++) { if (sel.options[i].value === currentMonth) { sel.value = currentMonth; found = true; break; } } if (!found) sel.value = ""; document.getElementById('searchInput').value = ''; currentPage = 1; renderExpenses(); }
    function changePageSize() { pageSize = parseInt(document.getElementById('pageSizeSelect').value); currentPage = 1; renderExpenses(); }
    function jumpToPage() { const inputVal = parseInt(document.getElementById('pageJumpInput').value); const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1; if (isNaN(inputVal) || inputVal < 1) currentPage = 1; else if (inputVal > maxPage) currentPage = maxPage; else currentPage = inputVal; renderTable(); document.getElementById('pageJumpInput').value = currentPage; }
    function changePageRelative(offset) { const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1; let newPage = currentPage + offset; if (newPage < 1) newPage = 1; if (newPage > maxPage) newPage = maxPage; if (newPage !== currentPage) { currentPage = newPage; renderTable(); document.getElementById('pageJumpInput').value = currentPage; } }
    function checkBatchBtn() { const n = document.querySelectorAll('.item-cb:checked').length; const btn = document.getElementById('batchDeleteBtn'); btn.disabled = (n === 0); btn.style.opacity = n === 0 ? '0.5' : '1'; }
    function toggleAllCheckboxes() { const v = document.getElementById('selectAll').checked; document.querySelectorAll('.item-cb').forEach(c => c.checked = v); checkBatchBtn(); }

    // --- AI æ™ºèƒ½è¯†åˆ« (ä½¿ç”¨æŒ‡å®šæ¨¡å‹) ---
    async function handleSmartIdentify() {
      const inputVal = document.getElementById('aiInput').value.trim();
      if (!inputVal) return alert('è¯·å…ˆè¾“å…¥æè¿°æ–‡å­—');

      // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„ Keyï¼Œæˆ–è€…å…¨å±€å˜é‡ openRouterKey
      // è¿™é‡Œçš„é€»è¾‘å·²ä¿®æ”¹ï¼Œä¸å†æ£€æŸ¥é¡¶éƒ¨çš„ç©º const
      let apiKey = localStorage.getItem('lc_ai_key');
      if (!apiKey && openRouterKey) apiKey = openRouterKey;

      if (!apiKey) {
        return alert('è¯·å…ˆç‚¹å‡»å³ä¸‹è§’çš„â€œé‡ç½® App é…ç½®â€ï¼Œå¡«å…¥ OpenRouter API Key');
      }

      const btn = document.getElementById('btnSmartIdentify');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = 'ğŸ¤– æ­£åœ¨åˆ†æä¸­...';

      try {
        const todayStr = new Date().toISOString().split('T')[0];
        const expenseTypesStr = EXPENSE_TYPES.join('ã€');

        // æç¤ºè¯åªåŒ…å«æ”¯å‡ºç±»å‹
        const systemPrompt = `
You are a smart expense tracker assistant.Â 
Today is ${todayStr}.
Existing Expense Types: [${expenseTypesStr}]

Your task is to extract information from the user's input and return a JSON object.
Rules:
1. "date": Format YYYY-MM-DD. Handle relative dates like "yesterday", "today".
2. "amount": Number.
3. "category": Always "expense".
4. "type1": Choose the most appropriate one from the Existing Expense Types list.
5. "type2": A short description of the item.

Output strictly valid JSON only.
Example: {"date":"2023-10-10", "amount": 25.5, "category": "expense", "type1": "åƒ", "type2": "å¥¶èŒ¶"}
Â  Â  Â  Â  Â  Â  `;

        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json",
            "HTTP-Referer": window.location.href,
            "X-Title": "Family Expense Tracker"
          },
          body: JSON.stringify({
            // === ä½¿ç”¨æŒ‡å®šçš„å°ç±³æ¨¡å‹ ID ===
            "model": "z-ai/glm-4.5-air:free",
            "messages": [
              { "role": "system", "content": systemPrompt },
              { "role": "user", "content": inputVal }
            ]
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`API Error: ${response.status} - ${errText}`);
        }

        const result = await response.json();
        if (!result.choices || result.choices.length === 0) throw new Error('API è¿”å›æ•°æ®ä¸ºç©º');

        let content = result.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
        let aiData = JSON.parse(content);
        console.log('AI è¯†åˆ«ç»“æœ:', aiData);

        if (aiData.date) document.getElementById('modalDate').value = aiData.date;
        if (aiData.amount) document.getElementById('modalAmount').value = aiData.amount;
        if (aiData.type2) document.getElementById('modalType2').value = aiData.type2;

        // å¼ºåˆ¶ä¸º expense
        document.querySelector('input[name="modalCategory"][value="expense"]').checked = true;
        updateModalTypeOptions();

        if (aiData.type1) {
          setTimeout(() => {
            const select = document.getElementById('modalType1');
            for (let i = 0; i < select.options.length; i++) {
              if (select.options[i].value === aiData.type1) {
                select.value = aiData.type1;
                break;
              }
            }
          }, 50);
        }

      } catch (error) {
        console.error(error);
        alert('âŒ è¯†åˆ«å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function updateModalTypeOptions() {
      // å§‹ç»ˆåªåŠ è½½æ”¯å‡ºç±»å‹
      const select = document.getElementById('modalType1');
      select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
      EXPENSE_TYPES.forEach(t => select.add(new Option(t, t)));
    }

    function openAddModal() {
      document.getElementById('modalExpenseForm').reset();
      document.getElementById('modalEditId').value = '';
      document.getElementById('modalTitle').innerText = 'æ–°å¢è®°å½•';
      document.getElementById('aiInput').value = '';
      document.querySelector('input[name="modalCategory"][value="expense"]').checked = true;
      updateModalTypeOptions();
      document.getElementById('modalDate').valueAsDate = new Date();
      document.getElementById('addModal').classList.add('active');
    }
    function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

    document.getElementById('modalExpenseForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('æœªç™»å½•');
      const id = document.getElementById('modalEditId').value;
      const cleanAmount = Math.round(parseFloat(document.getElementById('modalAmount').value) * 100) / 100;

      // å¼ºåˆ¶ category ä¸º expense
      const data = { date: document.getElementById('modalDate').value, type1: document.getElementById('modalType1').value, type2: document.getElementById('modalType2').value, amount: cleanAmount, familyId: MY_FAMILY_ID, category: 'expense' };
      try {
        if (id) { const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id); obj.set(data); await obj.save(); } else { const obj = new ExpenseClass(); obj.set(data); obj.set('owner', currentUser); const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); obj.setACL(acl); await obj.save(); }
        closeAddModal(); allExpenses = []; renderExpenses();
      } catch (err) { alert('ä¿å­˜å¤±è´¥: ' + err.message); }
    };
    async function delExp(id) { if (!confirm('ç¡®å®šåˆ é™¤?')) return; const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id); await obj.destroy(); allExpenses = allExpenses.filter(e => e.id !== id); renderExpenses(); }
    async function batchDeleteSelected() { const ids = Array.from(document.querySelectorAll('.item-cb:checked')).map(c => c.value); if (!confirm(`ç¡®å®šåˆ é™¤ ${ids.length} æ¡?`)) return; const objs = ids.map(id => AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id)); await AV.Object.destroyAll(objs); allExpenses = allExpenses.filter(e => !ids.includes(e.id)); renderExpenses(); document.getElementById('selectAll').checked = false; }
    function editExp(id) {
      const item = allExpenses.find(e => e.id === id); document.getElementById('modalEditId').value = id;
      // ç¼–è¾‘æ—¶å¼ºåˆ¶é€‰ä¸­ expense
      document.querySelector(`input[name="modalCategory"][value="expense"]`).checked = true;
      updateModalTypeOptions();
      document.getElementById('modalDate').value = item.date.substring(0, 10); document.getElementById('modalType1').value = item.type1; document.getElementById('modalType2').value = item.type2; document.getElementById('modalAmount').value = item.amount;
      document.getElementById('aiInput').value = '';
      document.getElementById('modalTitle').innerText = 'ç¼–è¾‘è®°å½•'; document.getElementById('addModal').classList.add('active');
    }
    document.getElementById('editBudgetBtn').onclick = async () => {
      const v = prompt(`ä¿®æ”¹æ¯æœˆé€šç”¨é¢„ç®—ï¼ˆæ‰€æœ‰è®¾å¤‡åŒæ­¥ï¼‰`, currentBudget);
      if (v && !isNaN(v)) {
        const newBudget = parseFloat(v);
        const success = await saveBudgetToCloud(newBudget);
        if (success) {
          renderCharts();
          updateDashboardCards();
        }
      }
    };
    function exportToCSV() { let csv = 'ç»Ÿè®¡æœˆä»½,æ—¥æœŸ,ä¸€çº§ç±»å‹,è®°è´¦äºº,äºŒçº§ç±»å‹,é‡‘é¢\n'; filteredExpenses.forEach(e => { csv += `${e.statMonth},${e.date.substring(0, 10)},${e.type1},${e.username},${e.type2},${e.amount}\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'æ”¯å‡ºæ˜ç»†.csv'; a.click(); }
    function printCurrentPage() { window.print(); }
    // ========== 9. å¤ç›˜æ¨¡å¼ (Retro Mode) ==========
    let retroList = [];
    let retroIndex = 0;
    let retroScope = 'unreviewed'; // unreviewed | all

    function openRetroSetup() {
      document.getElementById('retroOverlay').classList.add('active');
      document.getElementById('retroSetupPanel').style.display = 'block';
      document.getElementById('retroRunningArea').style.display = 'none';
      document.getElementById('retroSummary').style.display = 'none';

      // å¡«å……æœˆä»½é€‰æ‹©å™¨ (é»˜è®¤é€‰ä¸Šä¸ªæœˆ)
      const select = document.getElementById('retroMonthSelect');
      select.innerHTML = '';
      const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
      months.forEach(m => select.add(new Option(m, m)));

      // å°è¯•é€‰ä¸­ä¸Šä¸ªæœˆ
      const now = new Date();
      let lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const lastMonthStr = computeStatMonth(lastMonth.toISOString());
      if (months.includes(lastMonthStr)) {
        select.value = lastMonthStr;
      } else if (months.length > 0) {
        select.value = months[0];
      }

      // é‡ç½® Scope UI
      setRetroScope('unreviewed');
    }

    function backToSetup() {
      document.getElementById('retroRunningArea').style.display = 'none';
      document.getElementById('retroSetupPanel').style.display = 'block';
    }

    function setRetroScope(scope) {
      retroScope = scope;
      document.getElementById('scopeUnreviewed').className = `toggle-option ${scope === 'unreviewed' ? 'active' : ''}`;
      document.getElementById('scopeAll').className = `toggle-option ${scope === 'all' ? 'active' : ''}`;
    }

    function startRetroSession() {
      const selectedMonth = document.getElementById('retroMonthSelect').value;
      if (!selectedMonth) return alert('å½“å‰æ²¡æœ‰å¯å¤ç›˜çš„æ•°æ®æœˆä»½');

      // ç­›é€‰æ•°æ®
      retroList = allExpenses.filter(e => {
        if (e.statMonth !== selectedMonth) return false;
        if (retroScope === 'unreviewed') {
          // æœªå¤ç›˜å®šä¹‰: æ²¡æœ‰ wasteAmount è®°å½• (å³ 0) ä¸” isReviewed != true
          // ä½†ä¸ºäº†ç®€åŒ–ï¼Œåªè¦ isReviewed æ˜¯ true å°±ç®—å¤ç›˜è¿‡äº†
          return !e.isReviewed;
        }
        return true;
      });

      if (retroList.length === 0) {
        return alert(`å¤ªæ£’äº†ï¼${selectedMonth} æ²¡æœ‰${retroScope === 'unreviewed' ? 'æœªå¤ç›˜' : 'ç¬¦åˆæ¡ä»¶'}çš„è´¦å•ã€‚`);
      }

      retroIndex = 0;
      document.getElementById('retroSetupPanel').style.display = 'none';
      document.getElementById('retroRunningArea').style.display = 'flex';
      renderRetroCard();
    }

    function renderRetroCard() {
      if (retroIndex >= retroList.length) {
        showRetroSummary();
        return;
      }

      const item = retroList[retroIndex];
      // å¦‚æœå·²ç»æœ‰ wasteAmount (å¯èƒ½æ˜¯ 'all' æ¨¡å¼ä¸‹)ï¼Œå¯ä»¥æ˜¾ç¤ºåœ¨å¡ç‰‡ä¸Šæé†’ï¼Ÿ
      // æš‚æ—¶ä¿æŒç®€å•

      const card = document.getElementById('retroCard');
      // é‡ç½®åŠ¨ç”»ç±»
      card.classList.remove('swiped-left', 'swiped-right');

      // å¼ºåˆ¶é‡ç»˜ä»¥é‡ç½®åŠ¨ç”»çŠ¶æ€ (hack)
      void card.offsetWidth;

      document.getElementById('retroDate').innerText = `${item.date.substring(5, 10)}`;
      document.getElementById('retroCount').innerText = `${retroIndex + 1} / ${retroList.length}`;
      document.getElementById('retroType').innerText = item.type1;
      document.getElementById('retroAmount').innerText = `Â¥ ${formatMoney(item.amount)}`;
      document.getElementById('retroDesc').innerText = item.type2 || item.type1;

      const percent = ((retroIndex) / retroList.length) * 100;
      document.getElementById('retroProgressBar').style.width = `${percent}%`;

      // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
      document.getElementById('btnPrevCard').classList.toggle('disabled', retroIndex === 0);
    }

    function prevRetroCard() {
      if (retroIndex > 0) {
        retroIndex--;
        renderRetroCard();
      }
    }

    function nextRetroCard() {
      // ä¹Ÿå¯ä»¥è§†ä¸ºä¸€ç§â€œè·³è¿‡â€
      if (retroIndex < retroList.length) {
        retroIndex++;
        renderRetroCard();
      }
    }

    async function handleRetroSwipe(action) {
      const item = retroList[retroIndex];
      const card = document.getElementById('retroCard');

      if (action === 'pass') {
        // å¿…éœ€å“ï¼šå³æ»‘
        card.classList.add('swiped-right');

        // ä¿å­˜çŠ¶æ€ï¼šisReviewed = true
        await updateExpenseStatus(item.id, { isReviewed: true });

        setTimeout(() => {
          retroIndex++;
          renderRetroCard();
        }, 300);
      }
    }

    function triggerWasteAction() {
      const item = retroList[retroIndex];
      const defaultVal = item.wasteAmount > 0 ? item.wasteAmount : item.amount;
      document.getElementById('retroWasteInput').value = defaultVal;
      document.getElementById('retroWasteNote').value = item.wasteNote || '';
      document.getElementById('retroInputLayer').classList.add('active');
    }

    function closeRetroInput() {
      document.getElementById('retroInputLayer').classList.remove('active');
    }

    async function confirmWasteAction() {
      const val = parseFloat(document.getElementById('retroWasteInput').value);
      const note = document.getElementById('retroWasteNote').value.trim();
      if (isNaN(val) || val < 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');

      const item = retroList[retroIndex];
      // ä¿å­˜çŠ¶æ€ï¼šwasteAmount = val, isReviewed = true
      await updateExpenseStatus(item.id, { isReviewed: true, wasteAmount: val, wasteNote: note });

      closeRetroInput();
      const card = document.getElementById('retroCard');
      card.classList.add('swiped-left'); // å·¦æ»‘æ•ˆæœ

      setTimeout(() => {
        retroIndex++;
        renderRetroCard();
      }, 300);
    }

    async function updateExpenseStatus(id, updates) {
      // 1. æœ¬åœ°æ›´æ–° (allExpenses & filteredExpenses & retroList æŒ‡å‘åŒä¸€å¯¹è±¡å¼•ç”¨å—ï¼ŸallExpenses æ˜¯æºå¤´)
      const idx = allExpenses.findIndex(e => e.id === id);
      if (idx !== -1) {
        Object.assign(allExpenses[idx], updates);
      }

      // 2. äº‘ç«¯æ›´æ–°
      // ä¸ºäº†ä¸é˜»å¡ UIï¼Œæˆ‘ä»¬ä¸ await saveï¼Œä½† catch é”™è¯¯
      const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id);
      Object.keys(updates).forEach(key => obj.set(key, updates[key]));
      obj.save().catch(console.error);
    }

    // è®°å¾—åœ¨ getExpenses ä¸­è·å– wasteNote (å·²åœ¨ getExpenses ä¿®æ”¹äº†å—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦é¢å¤–å¤„ç†ï¼Œè¿™é‡Œå‡è®¾ getExpenses é‡ŒåŠ äº†æˆ–è€…åç»­ Lazy Load)
    // ä¸ºäº†ä¿é™©èµ·è§ï¼Œæˆ‘ä»¬åœ¨ getExpenses ä¸­æ·»åŠ å­—æ®µè¯»å–


    function showRetroSummary() {
      document.getElementById('retroRunningArea').style.display = 'none';
      document.getElementById('retroSummary').style.display = 'block';

      // ç®€å•è®¡ç®—æœ¬æ¬¡å¤ç›˜ç»“æœ
      // å®é™…ä¸Šåº”è¯¥åªç»Ÿè®¡æœ¬æ¬¡ Session æ“ä½œçš„ï¼Œä½†è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç»Ÿè®¡è¯¥æœˆæ‰€æœ‰æµªè´¹
      const selectedMonth = document.getElementById('retroMonthSelect').value;
      const totalWaste = retroList.reduce((acc, cur) => acc + (cur.wasteAmount || 0), 0);

      document.getElementById('retroSummaryWaste').innerText = `Â¥ ${formatMoney(totalWaste)}`;
    }

    function closeRetroMode() {
      document.getElementById('retroOverlay').classList.remove('active');
      // åˆ·æ–°æ•°æ®
      renderExpenses();
    }

    // ========== 10. åçœæ¸…å• (Waste List) ==========
    let currentEditNoteId = null;
    let wasteListCurrentPage = 1;
    let wasteListPageSize = 10;
    let wasteListFiltered = [];

    function openWasteListModal() {
      document.getElementById('wasteListModal').classList.add('active');

      // å¡«å……æœˆä»½ Filter
      const select = document.getElementById('wasteMonthSelect');
      select.innerHTML = '';
      const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
      months.forEach(m => select.add(new Option(m, m)));

      // é»˜è®¤é€‰ä¸­å½“å‰æœˆæˆ–ä¸Šä¸ªæœˆ
      const nowStr = computeStatMonth(new Date().toISOString());
      if (months.includes(nowStr)) select.value = nowStr;

      renderWasteList();
    }

    function closeWasteListModal() {
      document.getElementById('wasteListModal').classList.remove('active');
    }

    function renderWasteList() {
      const month = document.getElementById('wasteMonthSelect').value;
      const container = document.getElementById('wasteListContainer');
      container.innerHTML = '';

      if (!month) {
        container.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">æš‚æ— æ•°æ®</div>';
        updateWastePagination(0);
        return;
      }

      wasteListFiltered = allExpenses.filter(e => e.statMonth === month && e.wasteAmount > 0);

      if (wasteListFiltered.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">æœ¬æœˆè¡¨ç°ä¸é”™ï¼Œæ²¡æœ‰æ ‡è®°æµªè´¹ï¼ğŸ‰</div>';
        updateWastePagination(0);
        return;
      }

      // åˆ†é¡µé€»è¾‘
      const total = wasteListFiltered.length;
      const totalPages = Math.ceil(total / wasteListPageSize);
      if (wasteListCurrentPage > totalPages) wasteListCurrentPage = 1;
      if (wasteListCurrentPage < 1) wasteListCurrentPage = 1;

      updateWastePagination(total, totalPages);

      const start = (wasteListCurrentPage - 1) * wasteListPageSize;
      const pageData = wasteListFiltered.slice(start, start + wasteListPageSize);

      pageData.forEach(item => {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f9f9f9; border-radius:12px; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:flex-start;';

        div.innerHTML = `
             <div style="flex:1;">
                <div style="font-weight:bold; color:#37474f; font-size:1rem; margin-bottom:4px;">${item.type1} <span style="font-weight:normal; color:#90a4ae; font-size:0.9rem;">(${item.date.substring(5, 10)})</span></div>
                <div style="color:#78909c; font-size:0.9rem; margin-bottom:8px;">${item.type2 || 'æ— æè¿°'}</div>
                <div style="background:#fff3e0; color:#e65100; padding:8px; border-radius:8px; font-size:0.9rem; line-height:1.4;">
                   <span style="font-weight:bold;">ğŸ“ åçœ:</span> <span id="note-text-${item.id}">${item.wasteNote || 'æš‚æ— å¤‡æ³¨'}</span>
                </div>
             </div>
             <div style="text-align:right; margin-left:15px; display:flex; flex-direction:column; align-items:flex-end;">
                <div style="font-weight:bold; color:#c62828; font-size:1.1rem; margin-bottom:5px;" id="amount-text-${item.id}">Â¥ ${formatMoney(item.wasteAmount)}</div>
                <button class="action-btn-small" style="background:white; border:1px solid #ddd; color:#607d8b;" onclick="openEditNote('${item.id}')">âœï¸ ä¿®æ”¹</button>
             </div>
          `;
        container.appendChild(div);
      });
    }

    function updateWastePagination(total, totalPages = 1) {
      document.getElementById('wasteListSummaryText').innerText = `å…± ${total} æ¡`;
      document.getElementById('wasteTotalPages').innerText = totalPages;
      document.getElementById('wastePageInput').value = wasteListCurrentPage;
      document.getElementById('wastePageInput').max = totalPages;
    }

    function changeWastePageRelative(offset) {
      const totalPages = Math.ceil(wasteListFiltered.length / wasteListPageSize) || 1;
      let newPage = wasteListCurrentPage + offset;
      if (newPage < 1) newPage = 1;
      if (newPage > totalPages) newPage = totalPages;
      if (newPage !== wasteListCurrentPage) {
        wasteListCurrentPage = newPage;
        renderWasteList();
      }
    }

    function jumpToWastePage() {
      const totalPages = Math.ceil(wasteListFiltered.length / wasteListPageSize) || 1;
      let val = parseInt(document.getElementById('wastePageInput').value);
      if (isNaN(val) || val < 1) val = 1;
      if (val > totalPages) val = totalPages;
      wasteListCurrentPage = val;
      renderWasteList();
    }




  </script>
</body>

</html>