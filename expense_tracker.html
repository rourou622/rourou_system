<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å®¶åº­è´¹ç”¨æ¸…å•</title>

  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* --- è«å…°è¿ªé…è‰²å®šä¹‰ --- */
      --bg-body: #f2f4f6;
      --bg-card: #ffffff;

      --primary: #607d8b;
      --primary-hover: #455a64;
      --accent: #81a18b;
      --danger: #d4a5a5;
      --danger-hover: #c08b8b;

      --text-main: #374151;
      --text-sub: #6b7280;
      --border-color: #e5e7eb;

      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 8px 16px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.06);

      --radius-md: 12px;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', 'Noto Sans SC', sans-serif;
      background-color: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* === å¤´éƒ¨å¸ƒå±€ === */
    .app-header {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
      min-height: 40px;
      padding: 0 10px;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.6rem;
      color: var(--text-main);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .user-info-box {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
    }

    /* === Dashboard å¡ç‰‡æ ·å¼ === */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    @media (max-width: 900px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: #ffffff;
      border-radius: var(--radius-lg);
      padding: 20px;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.03);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      min-height: 100px;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 2;
      flex: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #90a4ae;
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      font-family: 'Roboto', sans-serif;
      line-height: 1.2;
      letter-spacing: -0.5px;
      word-break: break-all;
    }

    .stat-icon-box {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-left: 12px;
    }

    .stat-icon-box svg {
      width: 24px;
      height: 24px;
    }

    /* é…è‰²æ–¹æ¡ˆ */
    .theme-blue .stat-icon-box {
      background: #e3f2fd;
      color: #1976d2;
    }

    .theme-blue .stat-value {
      color: #37474f;
    }

    .theme-red .stat-icon-box {
      background: #ffebee;
      color: #e53935;
    }

    .theme-red .stat-value {
      color: #c62828;
    }

    .theme-green .stat-icon-box {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .theme-green .stat-value {
      color: #2e7d32;
    }

    /* ç´«è‰²æ™®é€š (ç”¨äºç¯æ¯”) */
    .theme-purple .stat-icon-box {
      background: #f3e5f5;
      color: #8e24aa;
    }

    .theme-purple .stat-value {
      color: #4a148c;
    }

    /* ç´«è‰²é«˜äº® (ä»…ç”¨äºç­›é€‰ç»“æœ) */
    .theme-purple-highlight {
      background: #f3e5f5;
      border: 1px solid #e1bee7;
    }

    .theme-purple-highlight .stat-icon-box {
      background: #fff;
      color: #8e24aa;
    }

    .theme-purple-highlight .stat-value {
      color: #6a1b9a;
      font-size: 1.1rem;
    }

    .theme-purple-highlight .stat-label {
      color: #8e24aa;
    }

    /* === ç»Ÿä¸€çš„å¤§å¡ç‰‡æ ·å¼ === */
    .details-card {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 25px;
      box-shadow: var(--shadow-md);
      margin-bottom: 30px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .details-header {
      margin-bottom: 25px;
      display: flex;
      align-items: center;
    }

    .details-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-main);
      padding-left: 12px;
      border-left: 4px solid var(--primary);
      line-height: 1.2;
    }

    /* === ä¼˜åŒ–åçš„æ¨¡æ€æ¡† & è¡¨å•æ ·å¼ === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: #fff;
      padding: 35px;
      border-radius: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      transform: scale(0.95);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
    }

    /* AI åŒºåŸŸä¼˜åŒ– */
    .ai-section {
      background: linear-gradient(145deg, #f0fdf4 0%, #e8f5e9 100%);
      padding: 18px;
      border-radius: 16px;
      border: 1px dashed #a5d6a7;
      margin-bottom: 25px;
    }

    .ai-textarea {
      width: 100%;
      height: 70px;
      padding: 12px;
      border: 1px solid #c8e6c9;
      border-radius: 12px;
      resize: none;
      font-family: inherit;
      font-size: 0.95rem;
      margin-bottom: 12px;
      background: #fff;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
      transition: all 0.3s ease;
    }

    .ai-textarea:focus {
      border-color: #66bb6a;
      box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.15);
    }

    .btn-ai {
      background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
      color: white;
      width: 100%;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      font-weight: 500;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.2);
    }

    .btn-ai:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
    }

    /* é€šç”¨è¾“å…¥æ¡†ç¾åŒ– */
    input,
    select {
      width: 100%;
      height: 46px;
      padding: 0 16px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.1);
    }

    /* === ä¿®å¤è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ (æ–‡å­—å‚ç›´å±…ä¸­) === */
    .custom-select-trigger {
      width: 100%;
      height: 46px;
      padding: 0 16px;
      /* ä¿æŒä¸ input ä¸€è‡´ */
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95rem;
      background-color: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      /* å‚ç›´å±…ä¸­ */
      justify-content: space-between;
      /* ç¡®ä¿æ–‡å­—åœ¨å·¦ï¼Œç®­å¤´åœ¨å³ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰ */
      line-height: normal;
      /* é‡ç½®è¡Œé«˜ï¼Œäº¤ç»™ flex æ§åˆ¶ */
    }

    .custom-select-wrapper.open .custom-select-trigger {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 125, 139, 0.1);
    }

    /* Radio æŒ‰é’®ç¾åŒ– */
    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 5px;
    }

    .radio-label {
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .radio-label:hover {
      background: #f5f5f5;
    }

    .radio-label input {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    /* æŒ‰é’®æ ·å¼å¾®è°ƒ */
    .modal-footer {
      margin-top: 35px;
      gap: 15px;
    }

    .modal-footer button {
      border-radius: 12px;
      height: 46px;
      font-size: 1rem;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    /* === FAB æ‚¬æµ®æŒ‰é’® === */
    .fab-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 999;
    }

    .fab-btn {
      width: 60px;
      height: 60px;
      border-radius: 24px;
      background-color: #263238;
      color: white;
      border: none;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .fab-btn:hover {
      transform: scale(1.1) rotate(90deg);
      background-color: #37474f;
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    /* === å…¶ä»–é€šç”¨æ ·å¼ (ä¿æŒä¸å˜) === */
    .auth-card {
      background: var(--bg-card);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 450px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #authContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 90vh;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 25px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-sub);
      transition: all 0.3s;
    }

    .auth-tab.active {
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      margin-bottom: -2px;
    }

    .auth-title {
      text-align: center;
      color: var(--primary);
      margin-bottom: 20px;
      font-weight: 700;
    }

    .helper-text {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-bottom: 15px;
      background: #f0f4f8;
      padding: 10px;
      border-radius: var(--radius-md);
    }

    #appContainer {
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    button {
      font-family: inherit;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .action-btn,
    .action-btn-large {
      border-radius: 8px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn {
      padding: 6px 12px;
      font-size: 0.85rem;
      margin: 0;
      white-space: nowrap;
    }

    .action-btn-large {
      padding: 12px 24px;
      font-size: 1rem;
      min-width: 100px;
      width: 100%;
    }

    @media(min-width: 768px) {
      .action-btn-large {
        width: auto;
      }

      .auth-card .action-btn-large {
        width: 100%;
      }
    }

    .btn-brown {
      background: var(--primary);
      color: white;
    }

    .btn-brown:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-dark {
      background: var(--danger);
      color: white;
    }

    .btn-dark:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }

    .btn-light {
      background: #fff;
      border: 1px solid var(--border-color);
      color: var(--text-main);
    }

    .btn-light:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .btn-accent {
      background: var(--accent);
      color: white;
    }

    .btn-accent:hover {
      background: #6b8c76;
      transform: translateY(-1px);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.95rem;
    }

    th {
      padding: 15px;
      text-align: left;
      background-color: #f8fafc;
      color: var(--text-sub);
      font-weight: 600;
      border-bottom: 2px solid var(--border-color);
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-main);
      vertical-align: middle;
    }

    tbody tr:hover {
      background-color: #f9fafb;
    }

    .action-cell-content {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .month-group-title {
      background: #e2e8f0;
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
      padding-left: 15px;
    }

    .user-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 500;
      letter-spacing: 0.3px;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .charts-section {
      margin: 30px 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    @media (max-width: 768px) {
      .charts-section {
        grid-template-columns: 1fr;
      }
    }

    .chart-container {
      background: #fff;
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .chart-title {
      text-align: center;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      font-size: 1.1rem;
    }

    #budgetProgressBar {
      margin-top: 15px;
      padding: 4px;
      background: #eceff1;
      border-radius: 20px;
      position: relative;
      height: 36px;
      overflow: hidden;
    }

    #budgetBase {
      border-radius: 18px !important;
    }

    .filter-bar {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filter-bar>div {
      flex: 1;
      min-width: 130px;
      width: auto;
    }

    .custom-select-wrapper {
      position: relative;
      user-select: none;
    }

    .custom-select-trigger {
      position: relative;
      cursor: pointer;
    }

    .custom-select-trigger::after {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-25%);
      border: 5px solid transparent;
      border-top-color: var(--text-sub);
    }

    .custom-options {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s ease;
      box-shadow: var(--shadow-lg);
    }

    .custom-select-wrapper.open .custom-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-options-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 5px 0;
    }

    .custom-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .custom-option:hover {
      background-color: #f1f5f9;
    }

    .custom-option input {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      accent-color: var(--primary);
    }

    .custom-footer {
      display: flex;
      border-top: 1px solid var(--border-color);
      padding: 10px;
      gap: 10px;
      background: #f8fafc;
    }

    .custom-footer button {
      padding: 8px;
      flex: 1;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .btn-cancel {
      background: #e5e7eb;
    }

    .btn-confirm {
      background: var(--primary);
      color: white;
    }

    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 30px 0;
      padding: 15px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      gap: 15px;
    }

    .pagination-jumper {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      color: var(--text-main);
      background: #f8fafc;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
    }

    .pagination-input {
      width: 50px !important;
      height: 28px !important;
      padding: 4px !important;
      text-align: center;
      margin: 0 5px;
      line-height: normal !important;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      background: #fff;
    }

    .btn-page-nav {
      background: transparent;
      border: none;
      color: var(--text-sub);
      font-size: 1.1rem;
      padding: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      height: 28px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .btn-page-nav:hover {
      color: var(--primary);
      background: #e2e8f0;
    }

    .btn-jump {
      margin-left: 10px;
      padding: 4px 12px;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      color: var(--text-main);
      font-size: 0.85rem;
    }

    .btn-jump:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .action-bar {
      text-align: center;
      margin-top: 30px;
    }
  </style>
</head>

<body>

  <div id="authContainer">
    <div class="auth-card">
      <h2 class="auth-title">å®¶åº­è´¹ç”¨æ¸…å•</h2>
      <p style="text-align: center; color: var(--text-sub); margin-bottom: 20px;">
        Family: Big Banana House
      </p>

      <div id="configSection" style="display: none;">
        <div class="helper-text">
          è¯·å‰å¾€ LeanCloud æ§åˆ¶å°è·å–åº”ç”¨çš„ App ID å’Œ App Keyã€‚<br>
          æ§åˆ¶å° > è®¾ç½® > åº”ç”¨å‡­è¯
        </div>
        <div class="form-group">
          <label>App ID</label>
          <input type="text" id="configAppId" placeholder="è¾“å…¥ App ID">
        </div>
        <div class="form-group">
          <label>App Key</label>
          <input type="password" id="configAppKey" placeholder="è¾“å…¥ App Key">
        </div>
        <div class="form-group">
          <label>REST API Server URL</label>
          <input type="text" id="configServerUrl" placeholder="https://..." value="https://api.leancloud.cn">
        </div>
        <div class="form-group">
          <label>OpenRouter API Key</label>
          <input type="password" id="configAiKey" placeholder="è¾“å…¥ sk-or-v1-...">
        </div>
        <button class="action-btn-large btn-brown" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
      </div>

      <div id="authSection" style="display: none;">
        <div class="auth-tabs">
          <div class="auth-tab active" id="tabLogin" onclick="switchAuthMode('login')">ç™»å½•</div>
          <div class="auth-tab" id="tabSignup" onclick="switchAuthMode('signup')">æ³¨å†Œ</div>
        </div>

        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="authUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="authPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
        </div>

        <button class="action-btn-large btn-brown" id="authActionBtn" onclick="handleAuthAction()">ç™»å½•</button>

        <div style="text-align: center; margin-top: 20px;">
          <button class="action-btn" style="color: var(--text-sub); text-decoration: underline;"
            onclick="clearConfig()">é‡ç½® App é…ç½®</button>
        </div>
      </div>

      <div id="loadingSection" style="display: none; text-align: center; color: var(--text-sub);">
        æ­£åœ¨åˆå§‹åŒ–...
      </div>

    </div>
  </div>


  <div class="container" id="appContainer">

    <div class="app-header">
      <h1>å®¶åº­è´¹ç”¨æ¸…å•</h1>
      <div class="user-info-box">
        <span id="currentUserDisplay" style="font-weight: 500; color: var(--primary);"></span>
        <button class="action-btn btn-light" onclick="logout()"
          style="padding: 4px 12px; font-size: 0.85rem; margin-left: 10px;">é€€å‡º</button>
      </div>
    </div>

    <div class="dashboard-grid">

      <div class="stat-card theme-red">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆæ¶ˆè´¹</div>
          <div class="stat-value" id="dashMonthExpense">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6" />
            <polyline points="17 18 23 18 23 12" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-green">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆç»“ä½™</div>
          <div class="stat-value" id="dashMonthBalance">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆå¤§é¢æ¶ˆè´¹ç¬”æ•°(>500)</div>
          <div class="stat-value" id="dashLargeCount">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M16 12l-4-4-4 4"></path>
            <line x1="12" y1="16" x2="12" y2="8"></line>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆæ—¥å‡æ¶ˆè´¹</div>
          <div class="stat-value" id="dashMonthDailyAvg">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2v-1a2 2 0 0 1 2-2h2"></path>
            <path d="M2 6h20v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6z"></path>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-red">
        <div class="stat-content">
          <div class="stat-label">æœ¬æœˆå¨±ä¹/è´­ç‰©</div>
          <div class="stat-value" id="dashEntertainment">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <path d="M16 10a4 4 0 0 1-8 0"></path>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-blue">
        <div class="stat-content">
          <div class="stat-label">è¿‘7å¤©æ—¥å‡æ¶ˆè´¹</div>
          <div class="stat-value" id="dashWeeklyAvg">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        </div>
      </div>

      <div class="stat-card theme-purple">
        <div class="stat-content">
          <div class="stat-label">æ”¯å‡ºç¯æ¯”å¢é•¿</div>
          <div class="stat-value" id="dashMomGrowth">--</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <polyline points="18 20 18 4 6 4 6 20"></polyline>
            <line x1="6" y1="16" x2="18" y2="16"></line>
          </svg>
        </div>
      </div>

      <div class="stat-card theme-purple-highlight">
        <div class="stat-content">
          <div class="stat-label">å½“å‰ç­›é€‰ç»“æœ</div>
          <div class="stat-value" id="filterResultText">åŠ è½½ä¸­...</div>
        </div>
        <div class="stat-icon-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
          </svg>
        </div>
      </div>
    </div>

    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-title">
          <span id="budgetTitle">å„æœˆæ€»æ”¯å‡º</span>
          <button id="editBudgetBtn" class="action-btn btn-light"
            style="margin-left:8px; font-size:0.75em;">ä¿®æ”¹é¢„ç®—</button>
        </div>
        <canvas id="monthlyBarChart" height="180"></canvas>
        <div id="budgetProgressBar">
          <div id="budgetBase" style="height:100%; width:100%; background:#cfd8dc; position:relative; overflow:hidden;">
            <div id="progressGreen"
              style="height:100%; width:0%; background:linear-gradient(to right, #a5d6a7, #81c784); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressRed"
              style="height:100%; width:0%; background:linear-gradient(to right, #ef9a9a, #e57373); position:absolute; left:0; top:0; transition: width 0.5s ease;">
            </div>
            <div id="progressText"
              style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:0.85em; z-index:2;">
            </div>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">ç±»å‹å æ¯” <span
            style="font-size:0.8em; color:var(--text-sub); font-weight:400;">(ç‚¹å‡»æ‰‡åŒºç­›é€‰)</span></div>
        <div id="echartsPie" style="width: 100%; height: 350px;"></div>
      </div>
    </div>

    <div class="details-card">
      <div class="details-header">
        <div class="details-title">æ”¯å‡ºæ˜ç»†</div>
      </div>

      <div class="filter-bar">
        <div>
          <label>ç±»å‹ç­›é€‰ (å¤šé€‰)</label>
          <div class="custom-select-wrapper" id="typeSelectWrapper">
            <div class="custom-select-trigger" id="typeSelectTrigger">å…¨éƒ¨ç±»å‹</div>
            <div class="custom-options">
              <div class="custom-options-list" id="typeOptionsList"></div>
              <div class="custom-footer">
                <button class="btn-cancel" onclick="cancelTypeFilter()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmTypeFilter()">ç¡®è®¤</button>
              </div>
            </div>
          </div>
        </div>
        <div style="flex: 2; display: flex; gap: 10px;">
          <div style="flex: 1;">
            <label for="startDate">æ˜ç»†å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="startDate" onchange="applyDateRangeFilter()" />
          </div>
          <div style="flex: 1;">
            <label for="endDate">æ˜ç»†ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="endDate" onchange="applyDateRangeFilter()" />
          </div>
        </div>
        <div>
          <label for="monthFilter">ç»Ÿè®¡æœˆä»½ç­›é€‰</label>
          <select id="monthFilter" onchange="applyMonthOrSearchFilter()">
            <option value="">å…¨éƒ¨æœˆä»½</option>
          </select>
        </div>
        <div>
          <label for="memberFilter">å®¶åº­æˆå‘˜ç­›é€‰</label>
          <select id="memberFilter" onchange="applyMonthOrSearchFilter()">
            <option value="">å…¨éƒ¨æˆå‘˜</option>
          </select>
        </div>
        <div>
          <label for="searchInput">æœç´¢ï¼ˆäºŒçº§ç±»å‹ï¼‰</label>
          <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯..." oninput="applyMonthOrSearchFilter()" />
        </div>
        <div style="flex: 0 0 auto;">
          <button class="action-btn btn-accent" onclick="resetFilters()" style="height: 46px;">æ¢å¤é»˜è®¤</button>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table id="expenseTable">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"
                  style="height:auto;"></th>
              <th>ç»Ÿè®¡æœˆä»½</th>
              <th>æ¶ˆè´¹æ—¥æœŸ</th>
              <th>ä¸€çº§ç±»å‹</th>
              <th>è®°è´¦äºº</th>
              <th>äºŒçº§ç±»å‹</th>
              <th>é‡‘é¢</th>
              <th style="width: 160px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="expenseList"></tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div style="display:flex; align-items:center;">
          <span style="color:var(--text-sub); font-size:0.9rem; margin-right:5px;">æ¯é¡µ:</span>
          <select id="pageSizeSelect" onchange="changePageSize()"
            style="width:auto; height:30px; line-height:30px; padding:0 25px 0 10px; font-size:0.9rem;">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>

        <div class="pagination-jumper">
          <button class="btn-page-nav" onclick="changePageRelative(-1)" title="ä¸Šä¸€é¡µ">â®</button>
          <span style="margin: 0 6px;">ç¬¬</span>
          <input type="number" id="pageJumpInput" class="pagination-input" value="1" min="1"
            onkeypress="if(event.keyCode==13) jumpToPage()">
          <span style="margin: 0 6px;">é¡µ / å…± <span id="totalPagesDisplay" style="font-weight:bold;">1</span> é¡µ</span>
          <button class="btn-page-nav" onclick="changePageRelative(1)" title="ä¸‹ä¸€é¡µ">â¯</button>
          <button class="btn-jump" onclick="jumpToPage()">è·³è½¬</button>
        </div>
      </div>

      <div style="text-align: right;">
        <button id="batchDeleteBtn" class="action-btn btn-dark" style="opacity:0.8; font-size:0.9rem; padding:8px 16px;"
          onclick="batchDeleteSelected()" disabled>æ‰¹é‡åˆ é™¤</button>
      </div>
    </div>

    <div class="action-bar">
      <button class="action-btn-large btn-light" onclick="exportToCSV()">å¯¼å‡º CSV</button>
      <button class="action-btn-large btn-light" onclick="printCurrentPage()">æ‰“å°</button>
    </div>

  </div>

  <div class="fab-container">
    <button class="fab-btn" onclick="openAddModal()" title="æ–°å¢æ•°æ®">+</button>
  </div>

  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">æ–°å¢è®°å½•</div>
        <button class="action-btn" style="background:none; color:#999; font-size:1.5em; padding:0;"
          onclick="closeAddModal()">&times;</button>
      </div>

      <form id="modalExpenseForm">
        <input type="hidden" id="modalEditId" />

        <div class="ai-section">
          <label
            style="color: #388e3c; display:flex; align-items:center; gap:6px; font-weight:600; font-size:0.95rem; margin-bottom:8px;">
            <span>ğŸ¤– AI æ™ºèƒ½è¯†åˆ«</span>
          </label>
          <textarea id="aiInput" class="ai-textarea" placeholder="è¾“å…¥å¦‚ï¼šæ˜¨å¤©ä¹°å¥¶èŒ¶èŠ±äº†18å…ƒ..."></textarea>
          <button type="button" class="btn-ai" onclick="handleSmartIdentify()" id="btnSmartIdentify">
            âœ¨ æ™ºèƒ½å¡«å……
          </button>
        </div>

        <div class="form-group" style="display:none;">
          <label>æ”¶æ”¯ç±»å‹</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="modalCategory" value="expense" checked onchange="updateModalTypeOptions()"> æ”¯å‡º
            </label>
          </div>
        </div>

        <div class="form-group">
          <label>æ¶ˆè´¹æ—¥æœŸ</label>
          <input type="date" id="modalDate" required />
        </div>
        <div class="form-group">
          <label>ä¸€çº§ç±»å‹</label>
          <select id="modalType1" required>
            <option value="">-- è¯·é€‰æ‹© --</option>
          </select>
        </div>
        <div class="form-group">
          <label>äºŒçº§ç±»å‹</label>
          <input type="text" id="modalType2" placeholder="å¦‚ï¼šå¥¶èŒ¶ã€å·¥èµ„æ˜ç»†" />
        </div>
        <div class="form-group">
          <label>é‡‘é¢</label>
          <div style="position:relative;">
            <span
              style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:#999; font-weight:bold;">Â¥</span>
            <input type="number" step="0.01" id="modalAmount" required min="0.01"
              style="padding-left:30px; font-weight:600; color:#374151;" />
          </div>
        </div>
        <div class="modal-footer" style="display:flex; justify-content:flex-end;">
          <button type="button" class="btn-light" style="width:100px;" onclick="closeAddModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn-brown"
            style="width:120px; box-shadow: 0 4px 10px rgba(96, 125, 139, 0.3);">ç¡®è®¤ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========== 0. å…¨å±€é…ç½®ä¸å˜é‡ ==========
    const OPENROUTER_API_KEY = "";

    const MY_FAMILY_ID = "big banana house";
    let BUDGET_STORAGE_KEY = 'expense_budget_' + MY_FAMILY_ID;
    const EXPENSE_CLASS_NAME = 'rourou_YellowChamberPot';

    // æ”¯å‡ºç±»å‹å®šä¹‰ (å·²ç§»é™¤æˆ¿ç§Ÿ)
    const EXPENSE_TYPES = ['åƒ', 'å–', 'äº¤é€š', 'è¯è´¹', 'è´­ç‰©', 'æ¸¸æˆ', 'å……å€¼', 'ç”µæ°´è´¹', 'å® ç‰©', 'å…¶ä»–'];

    // æ”¶å…¥ç±»å‹ (è™½ç„¶UIä¸æ˜¾ç¤ºï¼Œä¿ç•™å®šä¹‰ä»¥é˜²æŠ¥é”™)
    const INCOME_TYPES = ['å…¶ä»–'];

    const MORANDI_PALETTE = [
      '#90a4ae', '#a1887f', '#e57373', '#81c784', '#64b5f6',
      '#ffb74d', '#ba68c8', '#4db6ac', '#ffd54f', '#a1887f', '#7986cb'
    ];
    const USER_COLOR_MAP = {
      "hundun": { bg: '#fce4ec', text: '#c2185b' },
      "rourou622": { bg: '#e8f5e9', text: '#2e7d32' },
      "å…¶ä»–": { bg: '#f5f5f5', text: '#616161' }
    };
    let ExpenseClass = null;
    let currentUser = null;
    let allExpenses = [];
    let filteredExpenses = [];
    let monthlyBarChart = null;
    let echartsPieInstance = null;
    let activeSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let tempSelectedTypes = ['å…¨éƒ¨ç±»å‹'];
    let currentPage = 1;
    let pageSize = 10;
    let currentBudget = 9000;
    let authMode = 'login';

    // ========== 1. å¯åŠ¨é€»è¾‘ ==========
    window.onload = () => { checkAppConfig(); };
    function getUserColor(username) { return USER_COLOR_MAP[username] || USER_COLOR_MAP["å…¶ä»–"]; }
    function checkAppConfig() {
      const id = localStorage.getItem('lc_app_id');
      const key = localStorage.getItem('lc_app_key');
      const url = localStorage.getItem('lc_server_url');
      const aiKey = localStorage.getItem('lc_ai_key');
      if (id && key && url && aiKey) {
        openRouterKey = aiKey; // èµ‹å€¼ç»™å…¨å±€å˜é‡
        initLeanCloud(id, key, url);
      } else {
        showConfigForm();
      }
    }
    function initLeanCloud(id, key, url) {
      document.getElementById('configSection').style.display = 'none';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('loadingSection').style.display = 'block';
      try {
        if (typeof AV === 'undefined') { alert('LeanCloud SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'); return; }
        AV.init({ appId: id, appKey: key, serverURLs: url });
        ExpenseClass = AV.Object.extend(EXPENSE_CLASS_NAME);
        checkLoginStatus();
      } catch (e) { console.error(e); alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®'); clearConfig(); }
    }
    function checkLoginStatus() {
      currentUser = AV.User.current();
      document.getElementById('loadingSection').style.display = 'none';
      if (currentUser) { enterApp(); } else { showAuthForm(); }
    }
    function enterApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('currentUserDisplay').textContent = `${currentUser.getUsername()}`;
      initCustomDropdown();
      renderExpenses();
      window.onresize = () => { if (echartsPieInstance) echartsPieInstance.resize(); };
    }
    function logout() { AV.User.logOut(); location.reload(); }

    // ========== 2. è®¤è¯ç•Œé¢é€»è¾‘ ==========
    function showConfigForm() { document.getElementById('configSection').style.display = 'block'; document.getElementById('authSection').style.display = 'none'; document.getElementById('loadingSection').style.display = 'none'; }
    function saveConfig() {
      const id = document.getElementById('configAppId').value.trim();
      const key = document.getElementById('configAppKey').value.trim();
      const url = document.getElementById('configServerUrl').value.trim();
      const aiKey = document.getElementById('configAiKey').value.trim(); // è·å–è¾“å…¥

      if (!id || !key || !url || !aiKey) return alert('è¯·å¡«å†™å®Œæ•´é…ç½®ï¼ˆåŒ…æ‹¬ AI Keyï¼‰');

      localStorage.setItem('lc_app_id', id);
      localStorage.setItem('lc_app_key', key);
      localStorage.setItem('lc_server_url', url);
      localStorage.setItem('lc_ai_key', aiKey); // ä¿å­˜åˆ°æœ¬åœ°

      openRouterKey = aiKey; // æ›´æ–°å…¨å±€å˜é‡
      initLeanCloud(id, key, url);
    }
    function clearConfig() {
      localStorage.removeItem('lc_app_id');
      localStorage.removeItem('lc_app_key');
      localStorage.removeItem('lc_server_url');
      localStorage.removeItem('lc_ai_key'); // æ¸…é™¤ Key
      location.reload();
    }
    function showAuthForm() { document.getElementById('authSection').style.display = 'block'; switchAuthMode('login'); }
    function switchAuthMode(mode) {
      authMode = mode;
      const btn = document.getElementById('authActionBtn');
      const tabLogin = document.getElementById('tabLogin');
      const tabSignup = document.getElementById('tabSignup');
      if (mode === 'login') { tabLogin.classList.add('active'); tabSignup.classList.remove('active'); btn.textContent = 'ç«‹å³ç™»å½•'; btn.className = 'action-btn-large btn-brown'; } else { tabLogin.classList.remove('active'); tabSignup.classList.add('active'); btn.textContent = 'æ³¨å†Œå¹¶ç™»å½•'; btn.className = 'action-btn-large btn-accent'; }
    }
    async function handleAuthAction() {
      const u = document.getElementById('authUsername').value.trim();
      const p = document.getElementById('authPassword').value.trim();
      if (!u || !p) return alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
      try {
        if (authMode === 'login') { await AV.User.logIn(u, p); } else { const user = new AV.User(); user.setUsername(u); user.setPassword(p); await user.signUp(); }
        checkLoginStatus();
      } catch (error) { alert('æ“ä½œå¤±è´¥: ' + error.message); }
    }

    // ========== 3. ä¸‹æ‹‰æ¡†ä¸ç­›é€‰é€»è¾‘ ==========
    function initCustomDropdown() {
      const list = document.getElementById('typeOptionsList'); list.innerHTML = '';
      const allDiv = document.createElement('div'); allDiv.className = 'custom-option';
      allDiv.innerHTML = `<input type="checkbox" value="å…¨éƒ¨ç±»å‹" id="cb_all"><span>å…¨éƒ¨ç±»å‹</span>`;
      allDiv.onclick = (e) => toggleDropdownItem(e, 'å…¨éƒ¨ç±»å‹'); list.appendChild(allDiv);
      EXPENSE_TYPES.forEach(type => {
        const div = document.createElement('div'); div.className = 'custom-option';
        div.innerHTML = `<input type="checkbox" value="${type}" id="cb_${type}"><span>${type}</span>`;
        div.onclick = (e) => toggleDropdownItem(e, type); list.appendChild(div);
      });
      updateModalTypeOptions();
      const wrapper = document.getElementById('typeSelectWrapper');
      const trigger = document.getElementById('typeSelectTrigger');
      trigger.addEventListener('click', (e) => { e.stopPropagation(); wrapper.classList.toggle('open'); if (wrapper.classList.contains('open')) { tempSelectedTypes = [...activeSelectedTypes]; renderDropdownCheckboxes(); } });
      document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) wrapper.classList.remove('open'); });
    }
    function renderDropdownCheckboxes() {
      const isAll = tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹'); document.getElementById('cb_all').checked = isAll;
      EXPENSE_TYPES.forEach(type => { const cb = document.getElementById(`cb_${type}`); if (isAll) { cb.checked = true; } else { cb.checked = tempSelectedTypes.includes(type); } });
    }
    function toggleDropdownItem(e, value) {
      if (e.target.tagName !== 'INPUT') { const cb = e.currentTarget.querySelector('input'); cb.checked = !cb.checked; }
      if (value === 'å…¨éƒ¨ç±»å‹') { const isChecked = document.getElementById('cb_all').checked; tempSelectedTypes = isChecked ? ['å…¨éƒ¨ç±»å‹'] : []; } else { const isChecked = document.getElementById(`cb_${value}`).checked; if (tempSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { tempSelectedTypes = [...EXPENSE_TYPES]; if (!isChecked) tempSelectedTypes = tempSelectedTypes.filter(t => t !== value); } else { if (isChecked) tempSelectedTypes.push(value); else tempSelectedTypes = tempSelectedTypes.filter(t => t !== value); } const allSelected = EXPENSE_TYPES.every(t => tempSelectedTypes.includes(t)); if (allSelected) tempSelectedTypes = ['å…¨éƒ¨ç±»å‹']; }
      renderDropdownCheckboxes();
    }
    function confirmTypeFilter() { activeSelectedTypes = [...tempSelectedTypes]; if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; updateTriggerText(); document.getElementById('typeSelectWrapper').classList.remove('open'); renderExpenses(); }
    function cancelTypeFilter() { document.getElementById('typeSelectWrapper').classList.remove('open'); }
    function updateTriggerText() { const trigger = document.getElementById('typeSelectTrigger'); if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { trigger.textContent = 'å…¨éƒ¨ç±»å‹'; } else if (activeSelectedTypes.length === 1) { trigger.textContent = activeSelectedTypes[0]; } else { trigger.textContent = `${activeSelectedTypes[0]} ç­‰ ${activeSelectedTypes.length} é¡¹`; } }

    // ========== 4. æ•°æ®è·å–ä¸å¤„ç† ==========
    function computeStatMonth(dateStr) {
      const d = new Date(dateStr); let y = d.getFullYear(), m = d.getMonth() + 1;
      if (d.getDate() <= 4) { if (m === 1) { m = 12; y--; } else { m--; } }
      return `${y}-${String(m).padStart(2, '0')}`;
    }
    async function getExpenses() {
      if (!ExpenseClass || !currentUser) return [];
      const query = new AV.Query(ExpenseClass); query.equalTo('familyId', MY_FAMILY_ID); query.include('owner'); query.addDescending('date'); query.addDescending('createdAt'); query.limit(1000);
      try {
        const results = await query.find();
        return results.map(obj => {
          const ownerObj = obj.get('owner'); const username = ownerObj ? ownerObj.getUsername() : 'æœªçŸ¥';
          // å¼ºåˆ¶éƒ½è§†ä¸ºæ”¯å‡º (expense)ï¼Œä¸å†å¤„ç† income é€»è¾‘
          return { id: obj.id, date: String(obj.get('date')), type1: obj.get('type1'), type2: obj.get('type2') || '', amount: parseFloat(obj.get('amount')) || 0, statMonth: computeStatMonth(obj.get('date')), username: username, createdAt: obj.createdAt, category: 'expense' };
        });
      } catch (err) { console.error(err); return []; }
    }
    function getTimeFilteredExpenses() {
      let temp = [...allExpenses];
      // ç§»é™¤ income è¿‡æ»¤ï¼Œå› ä¸ºç°åœ¨å…¨éƒ½æ˜¯ expense
      const memberFilter = document.getElementById('memberFilter').value; if (memberFilter) temp = temp.filter(e => e.username === memberFilter);
      const mFilter = document.getElementById('monthFilter').value; if (mFilter) temp = temp.filter(e => e.statMonth === mFilter);
      const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value;
      if (startDate) temp = temp.filter(e => e.date >= startDate); if (endDate) temp = temp.filter(e => e.date <= endDate);
      return temp;
    }

    // ========== 5. æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ==========
    async function renderExpenses() {
      if (!currentUser) return;
      if (allExpenses.length === 0) {
        allExpenses = await getExpenses();
        // æ—¢ç„¶å…¨æ˜¯æ”¯å‡ºï¼Œå°±ç›´æ¥ç”¨å…¨éƒ¨æ•°æ®
        const months = [...new Set(allExpenses.map(e => e.statMonth))].sort().reverse();
        const sel = document.getElementById('monthFilter'); let targetVal = sel.value; sel.innerHTML = '<option value="">å…¨éƒ¨æœˆä»½</option>'; months.forEach(m => sel.add(new Option(m, m)));
        const currentMonth = computeStatMonth(new Date().toISOString());
        if (!targetVal && months.includes(currentMonth)) targetVal = currentMonth;
        if (targetVal) sel.value = targetVal;
      }
      const memberSel = document.getElementById('memberFilter'); const currentMember = memberSel.value; const members = [...new Set(allExpenses.map(e => e.username))].filter(u => u && u !== 'æœªçŸ¥'); memberSel.innerHTML = '<option value="">å…¨éƒ¨æˆå‘˜</option>'; members.forEach(u => memberSel.add(new Option(u, u))); if (currentMember && members.includes(currentMember)) memberSel.value = currentMember;

      // === (å·²ç§»é™¤) æ›´æ–°ç»¿è‰²çŠ¶æ€æ¡æ•°æ® ===

      // === æ›´æ–°é¡¶éƒ¨ Dashboard å¡ç‰‡æ•°æ® ===
      updateDashboardCards();

      let temp = getTimeFilteredExpenses();
      if (!activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { temp = temp.filter(e => activeSelectedTypes.includes(e.type1)); }
      const kw = document.getElementById('searchInput').value.trim(); if (kw) temp = temp.filter(e => e.type2.includes(kw));
      temp.sort((a, b) => { const dateA = String(a.date || "").substring(0, 10); const dateB = String(b.date || "").substring(0, 10); if (dateA > dateB) return -1; if (dateA < dateB) return 1; const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0; const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0; return timeB - timeA; });
      filteredExpenses = temp;
      const totalPages = Math.ceil(filteredExpenses.length / pageSize) || 1; if (currentPage > totalPages) currentPage = 1; document.getElementById('totalPagesDisplay').innerText = totalPages; document.getElementById('pageJumpInput').max = totalPages; document.getElementById('pageJumpInput').value = currentPage;
      renderTable(); renderCharts();
    }

    // === ã€æ ¸å¿ƒä¿®æ”¹ã€‘Dashboard æ•°æ®è®¡ç®— ===
    function updateDashboardCards() {
      const now = new Date();
      const currentStatMonth = computeStatMonth(now.toISOString());

      // è·å–å½“å‰æœˆä»½å¤©æ•°ï¼Œç”¨äºè®¡ç®—æ—¥å‡
      const currentDay = now.getDate(); // ç®€å•å¤„ç†ï¼šé™¤ä»¥å½“å‰å·²è¿‡å¤©æ•°

      // 1. è·å–æœ¬æœˆæ•°æ®
      const thisMonthData = allExpenses.filter(e => e.statMonth === currentStatMonth);

      // 2. æœ¬æœˆæ€»æ¶ˆè´¹
      const monthTotalExpense = thisMonthData.reduce((sum, item) => sum + item.amount, 0);

      // 3. è¯»å–æœ¬æœˆé¢„ç®—
      const budgets = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}');
      const thisMonthBudget = budgets[currentStatMonth] || 9000;

      // 4. æœ¬æœˆç»“ä½™ (é¢„ç®— - æ¶ˆè´¹)
      const monthBalance = thisMonthBudget - monthTotalExpense;

      // 5. æœ¬æœˆå¤§é¢æ¶ˆè´¹ç¬”æ•° (>500)
      const largeCount = thisMonthData.filter(e => e.amount > 500).length;

      // 6. æœ¬æœˆæ—¥å‡æ¶ˆè´¹
      const dailyAvg = monthTotalExpense / (currentDay || 1);

      // --- è¾…åŠ©æ•°æ® (æ—§é€»è¾‘ä¿ç•™éƒ¨åˆ†) ---
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(now.getDate() - 6);
      const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];

      let weeklyExpense = 0;
      let monthlyEntShopping = 0;
      let lastMonthExpense = 0;

      // è®¡ç®—ä¸Šä¸ªæœˆæ ‡è¯†
      let [currYearNum, currMonthNum] = currentStatMonth.split('-').map(Number);
      let lastMonthNum = currMonthNum - 1;
      let lastYearNum = currYearNum;
      if (lastMonthNum === 0) { lastMonthNum = 12; lastYearNum--; }
      const lastMonthStr = `${lastYearNum}-${String(lastMonthNum).padStart(2, '0')}`;

      const excludedTypes = ['åƒ', 'å–', 'äº¤é€š', 'ç”µæ°´è´¹', 'æˆ¿ç§Ÿ'];

      allExpenses.forEach(item => {
        const itemDateStr = item.date.substring(0, 10);

        // 7å¤©æ—¥å‡
        if (itemDateStr >= sevenDaysAgoStr) {
          weeklyExpense += item.amount;
        }

        // æœ¬æœˆå¨±ä¹
        if (item.statMonth === currentStatMonth) {
          if (!excludedTypes.includes(item.type1)) {
            monthlyEntShopping += item.amount;
          }
        }

        // ä¸Šæœˆæ”¯å‡º (ç”¨äºç¯æ¯”)
        if (item.statMonth === lastMonthStr) {
          lastMonthExpense += item.amount;
        }
      });

      const weeklyAvg = weeklyExpense / 7;

      // ç¯æ¯”å¢é•¿é€»è¾‘
      let momGrowth = 0;
      let momText = "--";
      if (lastMonthExpense > 0) {
        momGrowth = ((monthTotalExpense - lastMonthExpense) / lastMonthExpense) * 100;
        const sign = momGrowth > 0 ? '+' : '';
        momText = `${sign} ${momGrowth.toFixed(1)}%`;
      } else if (monthTotalExpense > 0) {
        momText = "ä¸Šæœˆæ— æ•°æ®";
      }

      // æ›´æ–° DOM
      // å¡ç‰‡1ï¼šæœ¬æœˆæ¶ˆè´¹
      document.getElementById('dashMonthExpense').innerText = `Â¥ ${formatMoney(monthTotalExpense)}`;
      // å¡ç‰‡2ï¼šæœ¬æœˆç»“ä½™
      document.getElementById('dashMonthBalance').innerText = `Â¥ ${formatMoney(monthBalance)}`;
      document.getElementById('dashMonthBalance').style.color = monthBalance >= 0 ? '#2e7d32' : '#c62828';

      // å¡ç‰‡3ï¼šæœ¬æœˆå¤§é¢ç¬”æ•°
      document.getElementById('dashLargeCount').innerText = `${largeCount} ç¬”`;

      // å¡ç‰‡4ï¼šæœ¬æœˆæ—¥å‡
      document.getElementById('dashMonthDailyAvg').innerText = `Â¥ ${formatMoney(dailyAvg)}`;

      // å…¶ä»–å¡ç‰‡
      document.getElementById('dashEntertainment').innerText = `Â¥ ${formatMoney(monthlyEntShopping)}`;
      document.getElementById('dashWeeklyAvg').innerText = `Â¥ ${formatMoney(weeklyAvg)}`;

      const momEl = document.getElementById('dashMomGrowth');
      momEl.innerText = momText;
      momEl.style.color = momGrowth > 0 ? '#c62828' : (momGrowth < 0 ? '#2e7d32' : '#374151');
    }

    // ========== 6. è¡¨æ ¼ä¸åˆ†æ ==========
    function renderTable() {
      const tbody = document.getElementById('expenseList'); tbody.innerHTML = ''; const start = (currentPage - 1) * pageSize; const pageData = filteredExpenses.slice(start, start + pageSize);
      const targetTotal = filteredExpenses.reduce((a, b) => a + b.amount, 0); const targetCount = filteredExpenses.length;
      // å¢åŠ ç©ºæ ¼
      const filterResultText = document.getElementById('filterResultText'); if (filterResultText) { filterResultText.innerHTML = `å…± ${targetCount} ç¬”<br>æ€»é¢ Â¥ ${formatMoney(targetTotal)}`; }
      const groups = {}; pageData.forEach(e => { if (!groups[e.statMonth]) groups[e.statMonth] = []; groups[e.statMonth].push(e); });
      Object.keys(groups).sort().reverse().forEach(mon => {
        const list = groups[mon]; const subTotal = list.reduce((s, i) => s + i.amount, 0);
        // å¢åŠ ç©ºæ ¼
        const trTitle = document.createElement('tr'); trTitle.innerHTML = `<td colspan="8" class="month-group-title">${mon} å½“å‰é¡µå°è®¡: Â¥ ${formatMoney(subTotal)}</td>`; tbody.appendChild(trTitle);
        list.forEach(item => {
          const userColor = getUserColor(item.username);
          const tr = document.createElement('tr');
          // å¢åŠ ç©ºæ ¼
          tr.innerHTML = `<td><input type="checkbox" class="item-cb" value="${item.id}" onchange="checkBatchBtn()" style="height:auto;"></td><td>${item.statMonth}</td><td>${item.date.substring(0, 10)}</td><td><span style="background:#eceff1; padding:2px 8px; border-radius:10px; font-size:0.85em; color:#455a64;">${item.type1}</span></td><td><span class="user-badge" style="background:${userColor.bg}; color:${userColor.text};">${item.username}</span></td><td>${item.type2}</td><td style="font-weight:500;">Â¥ ${formatMoney(item.amount)}</td><td><div class="action-cell-content"><button class="action-btn btn-brown" onclick="editExp('${item.id}')">ç¼–è¾‘</button><button class="action-btn btn-dark" onclick="delExp('${item.id}')">åˆ é™¤</button></div></td>`; tbody.appendChild(tr);
        });
      }); checkBatchBtn();
    }

    // ========== 7. å›¾è¡¨ä¸å…¶ä»–æ“ä½œ ==========
    function renderCharts() {
      // æ—¢ç„¶å…¨æ˜¯æ”¯å‡ºï¼Œä¸å†è¿‡æ»¤ category='income'
      const groups = {}; allExpenses.forEach(e => { if (!groups[e.statMonth]) groups[e.statMonth] = 0; groups[e.statMonth] += e.amount; });
      const now = new Date(); const currentStatMonth = computeStatMonth(now.toISOString());
      const months = []; for (let i = 5; i >= 0; i--) { let [y, m] = currentStatMonth.split('-').map(Number); m = m - i; while (m <= 0) { m += 12; y--; } while (m > 12) { m -= 12; y++; } months.push(`${y}-${String(m).padStart(2, '0')}`); }
      const totals = months.map(m => groups[m] || 0); currentBudget = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}')[currentStatMonth] || 9000; document.getElementById('budgetTitle').textContent = `å„æœˆæ€»æ”¯å‡º (é¢„ç®— Â¥ ${currentBudget})`;
      const ctxBar = document.getElementById('monthlyBarChart').getContext('2d'); if (monthlyBarChart) monthlyBarChart.destroy(); monthlyBarChart = new Chart(ctxBar, { type: 'bar', data: { labels: months, datasets: [{ label: 'æ”¯å‡º', data: totals, backgroundColor: months.map(m => (m === currentStatMonth && (groups[m] || 0) > currentBudget) ? '#e57373' : '#90a4ae'), borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: { display: false }, annotation: { annotations: { line1: { type: 'line', yMin: currentBudget, yMax: currentBudget, borderColor: '#b0bec5', borderDash: [5, 5], borderWidth: 2 } } } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } } });
      const curTotal = groups[currentStatMonth] || 0; const percent = Math.min(100, (curTotal / currentBudget) * 100); const remain = currentBudget - curTotal;
      // å¢åŠ ç©ºæ ¼
      if (remain >= 0) { document.getElementById('progressGreen').style.width = (remain / currentBudget * 100) + '%'; document.getElementById('progressRed').style.width = '0%'; document.getElementById('progressText').textContent = `å‰©ä½™ Â¥ ${remain.toFixed(0)} (${(100 - percent).toFixed(0)}%)`; document.getElementById('progressText').style.color = "#2c3e50"; } else { document.getElementById('progressGreen').style.width = '0%'; document.getElementById('progressRed').style.width = Math.min(100, (Math.abs(remain) / currentBudget * 100)) + '%'; document.getElementById('progressText').textContent = `è¶…æ”¯ Â¥ ${Math.abs(remain).toFixed(0)}`; document.getElementById('progressText').style.color = "#b71c1c"; }
      renderEChartsPie();
    }
    function renderEChartsPie() {
      const dom = document.getElementById('echartsPie'); if (!echartsPieInstance) { echartsPieInstance = echarts.init(dom); echartsPieInstance.on('click', function (params) { handleChartClick(params.name); }); echartsPieInstance.on('legendselectchanged', function (params) { handleChartClick(params.name); }); }
      let pieSourceData = getTimeFilteredExpenses(); const typeMap = {}; pieSourceData.forEach(e => { typeMap[e.type1] = (typeMap[e.type1] || 0) + e.amount; });
      const isAllSelected = activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹'); const dataForChart = Object.keys(typeMap).map(k => { const isSelected = isAllSelected || activeSelectedTypes.includes(k); return { value: typeMap[k], name: k, itemStyle: { opacity: isSelected ? 1 : 0.1, color: isSelected ? undefined : '#cfd8dc' }, label: { show: isSelected, color: '#546e7a' }, labelLine: { show: isSelected, lineStyle: { color: '#cfd8dc' } } }; });
      const legendSelectedState = {}; EXPENSE_TYPES.forEach(t => legendSelectedState[t] = true);
      const option = { color: MORANDI_PALETTE, tooltip: { trigger: 'item', backgroundColor: 'rgba(255,255,255,0.9)', formatter: function (params) { return `${params.name}<br/>Â¥ ${params.value.toFixed(2)} (${params.percent}%)`; } }, legend: { bottom: 0, left: 'center', padding: [5, 5], itemWidth: 15, itemHeight: 10, textStyle: { color: '#607d8b' }, width: '95%', selected: legendSelectedState }, series: [{ name: 'æ”¯å‡ºç±»å‹', type: 'pie', radius: ['35%', '55%'], center: ['50%', '40%'], avoidLabelOverlap: true, itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 }, data: dataForChart, selectedMode: 'multiple', selectedOffset: 10 }] }; echartsPieInstance.setOption(option, true);
    }
    function handleChartClick(typeName) { if (activeSelectedTypes.includes('å…¨éƒ¨ç±»å‹')) { activeSelectedTypes = [typeName]; } else { if (activeSelectedTypes.includes(typeName)) { activeSelectedTypes = activeSelectedTypes.filter(t => t !== typeName); if (activeSelectedTypes.length === 0) activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; } else { activeSelectedTypes.push(typeName); } } tempSelectedTypes = [...activeSelectedTypes]; updateTriggerText(); renderDropdownCheckboxes(); renderExpenses(); }

    // ========== 8. è¾…åŠ©æ“ä½œä¸æ–°å¢åŠŸèƒ½ ==========
    function formatMoney(n) { return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'); }
    function applyMonthOrSearchFilter() { currentPage = 1; renderExpenses(); }
    function applyDateRangeFilter() { const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value; if (start && end && start > end) { alert('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºç»“æŸæ—¶é—´'); document.getElementById('startDate').value = ''; return; } currentPage = 1; renderExpenses(); }
    function resetFilters() { activeSelectedTypes = ['å…¨éƒ¨ç±»å‹']; tempSelectedTypes = ['å…¨éƒ¨ç±»å‹']; updateTriggerText(); renderDropdownCheckboxes(); document.getElementById('typeSelectWrapper').classList.remove('open'); document.getElementById('startDate').value = ''; document.getElementById('endDate').value = ''; const sel = document.getElementById('monthFilter'); const memSel = document.getElementById('memberFilter'); memSel.value = ""; const currentMonth = computeStatMonth(new Date().toISOString()); let found = false; for (let i = 0; i < sel.options.length; i++) { if (sel.options[i].value === currentMonth) { sel.value = currentMonth; found = true; break; } } if (!found) sel.value = ""; document.getElementById('searchInput').value = ''; currentPage = 1; renderExpenses(); }
    function changePageSize() { pageSize = parseInt(document.getElementById('pageSizeSelect').value); currentPage = 1; renderExpenses(); }
    function jumpToPage() { const inputVal = parseInt(document.getElementById('pageJumpInput').value); const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1; if (isNaN(inputVal) || inputVal < 1) currentPage = 1; else if (inputVal > maxPage) currentPage = maxPage; else currentPage = inputVal; renderTable(); document.getElementById('pageJumpInput').value = currentPage; }
    function changePageRelative(offset) { const maxPage = Math.ceil(filteredExpenses.length / pageSize) || 1; let newPage = currentPage + offset; if (newPage < 1) newPage = 1; if (newPage > maxPage) newPage = maxPage; if (newPage !== currentPage) { currentPage = newPage; renderTable(); document.getElementById('pageJumpInput').value = currentPage; } }
    function checkBatchBtn() { const n = document.querySelectorAll('.item-cb:checked').length; const btn = document.getElementById('batchDeleteBtn'); btn.disabled = (n === 0); btn.style.opacity = n === 0 ? '0.5' : '1'; }
    function toggleAllCheckboxes() { const v = document.getElementById('selectAll').checked; document.querySelectorAll('.item-cb').forEach(c => c.checked = v); checkBatchBtn(); }

    // --- AI æ™ºèƒ½è¯†åˆ« (ä½¿ç”¨æŒ‡å®šæ¨¡å‹) ---
    async function handleSmartIdentify() {
      const inputVal = document.getElementById('aiInput').value.trim();
      if (!inputVal) return alert('è¯·å…ˆè¾“å…¥æè¿°æ–‡å­—');

      if (!OPENROUTER_API_KEY || OPENROUTER_API_KEY.includes('YOUR-KEY')) {
        return alert('è¯·åœ¨ä»£ç é¡¶éƒ¨ const OPENROUTER_API_KEY = "..." ä¸­å¡«å…¥æ­£ç¡®çš„ Key');
      }

      const btn = document.getElementById('btnSmartIdentify');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = 'ğŸ¤– æ­£åœ¨åˆ†æä¸­...';

      try {
        const todayStr = new Date().toISOString().split('T')[0];
        const expenseTypesStr = EXPENSE_TYPES.join('ã€');

        // æç¤ºè¯åªåŒ…å«æ”¯å‡ºç±»å‹
        const systemPrompt = `
You are a smart expense tracker assistant. 
Today is ${todayStr}.
Existing Expense Types: [${expenseTypesStr}]

Your task is to extract information from the user's input and return a JSON object.
Rules:
1. "date": Format YYYY-MM-DD. Handle relative dates like "yesterday", "today".
2. "amount": Number.
3. "category": Always "expense".
4. "type1": Choose the most appropriate one from the Existing Expense Types list.
5. "type2": A short description of the item.

Output strictly valid JSON only.
Example: {"date":"2023-10-10", "amount": 25.5, "category": "expense", "type1": "åƒ", "type2": "å¥¶èŒ¶"}
            `;

        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
            "Content-Type": "application/json",
            "HTTP-Referer": window.location.href,
            "X-Title": "Family Expense Tracker"
          },
          body: JSON.stringify({
            // === ä½¿ç”¨æŒ‡å®šçš„å°ç±³æ¨¡å‹ ID ===
            "model": "xiaomi/mimo-v2-flash:free",
            "messages": [
              { "role": "system", "content": systemPrompt },
              { "role": "user", "content": inputVal }
            ]
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`API Error: ${response.status} - ${errText}`);
        }

        const result = await response.json();
        if (!result.choices || result.choices.length === 0) throw new Error('API è¿”å›æ•°æ®ä¸ºç©º');

        let content = result.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
        let aiData = JSON.parse(content);
        console.log('AI è¯†åˆ«ç»“æœ:', aiData);

        if (aiData.date) document.getElementById('modalDate').value = aiData.date;
        if (aiData.amount) document.getElementById('modalAmount').value = aiData.amount;
        if (aiData.type2) document.getElementById('modalType2').value = aiData.type2;

        // å¼ºåˆ¶ä¸º expense
        document.querySelector('input[name="modalCategory"][value="expense"]').checked = true;
        updateModalTypeOptions();

        if (aiData.type1) {
          setTimeout(() => {
            const select = document.getElementById('modalType1');
            for (let i = 0; i < select.options.length; i++) {
              if (select.options[i].value === aiData.type1) {
                select.value = aiData.type1;
                break;
              }
            }
          }, 50);
        }

      } catch (error) {
        console.error(error);
        alert('âŒ è¯†åˆ«å¤±è´¥: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    function updateModalTypeOptions() {
      // å§‹ç»ˆåªåŠ è½½æ”¯å‡ºç±»å‹
      const select = document.getElementById('modalType1');
      select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
      EXPENSE_TYPES.forEach(t => select.add(new Option(t, t)));
    }

    function openAddModal() {
      document.getElementById('modalExpenseForm').reset();
      document.getElementById('modalEditId').value = '';
      document.getElementById('modalTitle').innerText = 'æ–°å¢è®°å½•';
      document.getElementById('aiInput').value = '';
      document.querySelector('input[name="modalCategory"][value="expense"]').checked = true;
      updateModalTypeOptions();
      document.getElementById('modalDate').valueAsDate = new Date();
      document.getElementById('addModal').classList.add('active');
    }
    function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

    document.getElementById('modalExpenseForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('æœªç™»å½•');
      const id = document.getElementById('modalEditId').value;
      const cleanAmount = Math.round(parseFloat(document.getElementById('modalAmount').value) * 100) / 100;

      // å¼ºåˆ¶ category ä¸º expense
      const data = { date: document.getElementById('modalDate').value, type1: document.getElementById('modalType1').value, type2: document.getElementById('modalType2').value, amount: cleanAmount, familyId: MY_FAMILY_ID, category: 'expense' };
      try {
        if (id) { const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id); obj.set(data); await obj.save(); } else { const obj = new ExpenseClass(); obj.set(data); obj.set('owner', currentUser); const acl = new AV.ACL(); acl.setPublicReadAccess(true); acl.setPublicWriteAccess(true); obj.setACL(acl); await obj.save(); }
        closeAddModal(); allExpenses = []; renderExpenses();
      } catch (err) { alert('ä¿å­˜å¤±è´¥: ' + err.message); }
    };
    async function delExp(id) { if (!confirm('ç¡®å®šåˆ é™¤?')) return; const obj = AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id); await obj.destroy(); allExpenses = allExpenses.filter(e => e.id !== id); renderExpenses(); }
    async function batchDeleteSelected() { const ids = Array.from(document.querySelectorAll('.item-cb:checked')).map(c => c.value); if (!confirm(`ç¡®å®šåˆ é™¤ ${ids.length} æ¡?`)) return; const objs = ids.map(id => AV.Object.createWithoutData(EXPENSE_CLASS_NAME, id)); await AV.Object.destroyAll(objs); allExpenses = allExpenses.filter(e => !ids.includes(e.id)); renderExpenses(); document.getElementById('selectAll').checked = false; }
    function editExp(id) {
      const item = allExpenses.find(e => e.id === id); document.getElementById('modalEditId').value = id;
      // ç¼–è¾‘æ—¶å¼ºåˆ¶é€‰ä¸­ expense
      document.querySelector(`input[name="modalCategory"][value="expense"]`).checked = true;
      updateModalTypeOptions();
      document.getElementById('modalDate').value = item.date.substring(0, 10); document.getElementById('modalType1').value = item.type1; document.getElementById('modalType2').value = item.type2; document.getElementById('modalAmount').value = item.amount;
      document.getElementById('aiInput').value = '';
      document.getElementById('modalTitle').innerText = 'ç¼–è¾‘è®°å½•'; document.getElementById('addModal').classList.add('active');
    }
    document.getElementById('editBudgetBtn').onclick = () => { const v = prompt('è¾“å…¥æœ¬æœˆé¢„ç®—', currentBudget); if (v && !isNaN(v)) { const nowStr = computeStatMonth(new Date().toISOString().slice(0, 10)); const budgets = JSON.parse(localStorage.getItem(BUDGET_STORAGE_KEY) || '{}'); budgets[nowStr] = parseFloat(v); localStorage.setItem(BUDGET_STORAGE_KEY, JSON.stringify(budgets)); renderCharts(); updateDashboardCards(); } };
    function exportToCSV() { let csv = 'ç»Ÿè®¡æœˆä»½,æ—¥æœŸ,ä¸€çº§ç±»å‹,è®°è´¦äºº,äºŒçº§ç±»å‹,é‡‘é¢\n'; filteredExpenses.forEach(e => { csv += `${e.statMonth},${e.date.substring(0, 10)},${e.type1},${e.username},${e.type2},${e.amount}\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'æ”¯å‡ºæ˜ç»†.csv'; a.click(); }
    function printCurrentPage() { window.print(); }
  </script>
</body>

</html>