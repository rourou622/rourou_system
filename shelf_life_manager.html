<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å®¶åº­å•†å“ä¿è´¨æœŸç®¡ç†</title>

  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.14.0/dist/av-min.js"></script>

  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Roboto:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* --- è«å…°è¿ªé…è‰² --- */
      --bg-body: #f2f4f6;
      --bg-card: #ffffff;

      --primary: #607d8b;
      --primary-hover: #546e7a;

      --accent: #81a18b;
      --accent-hover: #6b8c76;

      --danger: #d4a5a5;
      --danger-hover: #c08b8b;

      --text-main: #374151;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Roboto', 'Noto Sans SC', sans-serif;
      background: var(--bg-body);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      line-height: 1.6;
    }

    /* ============ è®¤è¯/å¼¹çª—é€šç”¨æ ·å¼ ============ */
    .overlay-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-body);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: 0.3s;
    }

    .modal-mask.active {
      opacity: 1;
      visibility: visible;
    }

    .auth-card,
    .modal-box {
      background: #fff;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      width: 90%;
      max-width: 420px;
      text-align: center;
    }

    .auth-card h2 {
      color: var(--primary);
      margin: 0 0 10px 0;
    }

    .auth-card p {
      color: var(--text-sub);
      font-size: 0.9em;
      margin-bottom: 25px;
    }

    .input-group {
      text-align: left;
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.85em;
      color: var(--text-sub);
    }

    .input-group input {
      width: 100%;
      height: 40px;
      padding: 0 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fafafa;
    }

    .input-group input:focus {
      border-color: var(--primary);
      background: #fff;
    }

    .btn-block {
      width: 100%;
      height: 42px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-block:hover {
      background: var(--primary-hover);
    }

    .link-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 0.9em;
      text-decoration: underline;
      margin-top: 15px;
    }

    .hidden {
      display: none !important;
    }

    /* ============ ä¸»åº”ç”¨ç•Œé¢æ ·å¼ ============ */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--bg-card);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      display: none;
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .top-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .app-logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #4a5a6a;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-badge {
      background: #f1f5f9;
      color: var(--text-sub);
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
    }

    .family-badge {
      background: #e0f2f1;
      color: #00695c;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .logout-btn {
      border: 1px solid var(--danger);
      color: var(--danger);
      background: #fff;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      cursor: pointer;
      transition: 0.2s;
    }

    .logout-btn:hover {
      background: var(--danger);
      color: white;
    }

    /* ============ é¡¶éƒ¨çœ‹æ¿æ ·å¼ ============ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    .stat-card::after {
      content: '';
      position: absolute;
      right: -10px;
      bottom: -10px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      opacity: 0.1;
      background: currentColor;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      flex-shrink: 0;
    }

    .stat-info {
      flex: 1;
    }

    .stat-label {
      color: var(--text-sub);
      font-size: 0.85em;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .stat-num {
      font-size: 1.8rem;
      font-weight: 700;
      line-height: 1;
      font-family: 'Roboto', sans-serif;
    }

    .card-total {
      color: var(--primary);
    }

    .card-total .stat-icon {
      background: #eff6ff;
    }

    .card-near {
      color: #f59e0b;
    }

    .card-near .stat-icon {
      background: #fffbeb;
    }

    .card-exp {
      color: var(--danger);
    }

    .card-exp .stat-icon {
      background: #fef2f2;
    }

    /* ç­›é€‰æ  */
    .filter-container {
      background: #fcfcfc;
      border: 1px solid #f0f0f0;
      padding: 20px;
      border-radius: 8px;
      display: flex;
      gap: 20px;
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .filter-item {
      flex: 1;
      min-width: 150px;
    }

    .filter-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-sub);
      font-size: 0.9rem;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      height: 40px;
      padding: 0 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
      color: var(--text-main);
    }

    .btn-search {
      background: var(--primary);
      color: white;
      height: 40px;
      padding: 0 25px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-search:hover {
      background: var(--primary-hover);
    }

    /* è¡¨æ ¼ */
    .table-wrapper {
      overflow-x: auto;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.95em;
      min-width: 1000px;
    }

    th {
      background: #f9fafb;
      padding: 14px 15px;
      text-align: left;
      color: #64748b;
      font-weight: 600;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }

    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      color: var(--text-main);
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    /* è¡¨æ ¼è¡Œé«˜äº®æ ·å¼ */
    /* ä¸´æœŸè¡ŒèƒŒæ™¯ - æµ…æ©™è‰² */
    tr.row-near {
      background-color: #fff7ed !important;
    }

    tr.row-near td {
      border-bottom-color: #fed7aa;
    }

    tr.row-near:hover {
      background-color: #ffedd5 !important;
    }

    /* è¿‡æœŸè¡ŒèƒŒæ™¯ - æµ…çº¢è‰² */
    tr.row-exp {
      background-color: #fef2f2 !important;
    }

    tr.row-exp td {
      border-bottom-color: #fecaca;
      color: #991b1b;
    }

    tr.row-exp:hover {
      background-color: #fee2e2 !important;
    }

    /* çŠ¶æ€ä¸è®°å½•äººæ ·å¼ */
    .status-normal {
      color: var(--accent);
      font-weight: 600;
    }

    .status-near {
      color: #e6a23c;
      font-weight: 600;
    }

    .status-exp {
      color: var(--danger);
      font-weight: 600;
    }

    /* è®°å½•äººå½©è‰²æ ‡ç­¾ */
    .recorder-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.85em;
      font-weight: 500;
      display: inline-block;
      letter-spacing: 0.5px;
    }

    .badge-green {
      background-color: #e6f4ea;
      color: #137333;
      border: 1px solid #ceead6;
    }

    .badge-pink {
      background-color: #fce4ec;
      color: #c2185b;
      border: 1px solid #f8bbd0;
    }

    .badge-blue {
      background-color: #e3f2fd;
      color: #1565c0;
      border: 1px solid #bbdefb;
    }

    .badge-orange {
      background-color: #fff3e0;
      color: #ef6c00;
      border: 1px solid #ffe0b2;
    }

    /* æ“ä½œæŒ‰é’® */
    .action-btn-group {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      color: white;
      border: none;
      cursor: pointer;
      opacity: 0.9;
    }

    .btn-sm:hover {
      opacity: 1;
    }

    .btn-edit {
      background: #eab308;
    }

    .btn-del {
      background: var(--danger);
    }

    /* åˆ†é¡µä¸åº•éƒ¨ */
    .pagination-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 10px 0;
      border: 1px solid #7d9cb3;
      border-radius: 6px;
      padding: 10px 15px;
      background: #fff;
    }

    .page-ctrl {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .page-btn {
      background: #fff;
      border: 1px solid #ddd;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      color: #666;
    }

    .page-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .page-btn:disabled {
      color: #ccc;
      cursor: not-allowed;
      border-color: #eee;
    }

    .batch-del-row {
      text-align: right;
      margin-top: 15px;
    }

    .btn-batch-del {
      background: #e2e8f0;
      color: #64748b;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-batch-del:hover:not(:disabled) {
      background: #cbd5e1;
      color: #334155;
    }

    .btn-batch-del:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .footer-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .footer-btn {
      flex: 1;
      min-width: 120px;
      height: 45px;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-export {
      background: var(--accent);
    }

    .btn-print {
      background: var(--primary);
    }

    .btn-import {
      background: #94a3b8;
    }

    .btn-claim {
      background: #ff9800;
    }

    /* æ¨¡æ€æ¡†å†…éƒ¨ */
    .modal-title {
      font-size: 1.5rem;
      color: #1e293b;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      margin-top: 30px;
    }

    /* === æ‚¬æµ®æŒ‰é’® (FAB) === */
    .fab-btn {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 64px;
      height: 64px;
      background: #2c3e50;
      color: white;
      border-radius: 50%;
      border: none;
      box-shadow: 0 8px 20px rgba(44, 62, 80, 0.4);
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1000;
    }

    .fab-btn:hover {
      transform: scale(1.1) rotate(90deg);
      box-shadow: 0 12px 25px rgba(44, 62, 80, 0.5);
      background: #34495e;
    }

    /* === æ™ºèƒ½è¯†åˆ«åŒºåŸŸ === */
    .smart-section {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px dashed #cbd5e1;
    }

    .smart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #475569;
    }

    .smart-input {
      width: 100%;
      height: 80px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      font-family: inherit;
      font-size: 0.9em;
      resize: none;
      margin-bottom: 10px;
      transition: 0.2s;
    }

    .smart-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-smart {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 8px 0;
      width: 100%;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: 0.3s;
      box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    }

    .btn-smart:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
    }

    .btn-smart:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .modal-box {
      padding: 30px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
    }

    .input-group input,
    .input-group select {
      height: 45px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      transition: 0.2s;
    }

    .input-group input:focus,
    .input-group select:focus {
      background: #fff;
      border-color: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.1);
    }
  </style>
</head>

<body>

  <div id="auth-layer" class="overlay-layer">
    <div id="config-card" class="auth-card hidden">
      <h2>ğŸ› ï¸ æœåŠ¡å™¨é…ç½®</h2>
      <p>åˆæ¬¡ä½¿ç”¨ï¼Œè¯·è¾“å…¥ LeanCloud App ID å’Œ Key</p>
      <div class="input-group">
        <label>App ID</label>
        <input type="text" id="conf-id" placeholder="ä¾‹å¦‚: dwracmq...">
      </div>
      <div class="input-group">
        <label>App Key</label>
        <input type="password" id="conf-key" placeholder="ä¾‹å¦‚: DngFcXZ...">
      </div>
      <div class="input-group">
        <label>REST API Server URL</label>
        <input type="text" id="conf-url" placeholder="ä¾‹å¦‚: https://api.leancloud.cn">
      </div>
      <div class="input-group">
        <label>OpenRouter API Key (ç”¨äºæ™ºèƒ½è¯†åˆ«)</label>
        <input type="password" id="conf-ai-key" placeholder="ä¾‹å¦‚: sk-or-v1-...">
      </div>
      <button class="btn-block" onclick="saveConfig()">ä¿å­˜é…ç½®å¹¶è¿æ¥</button>
      <div id="conf-msg" style="color:var(--danger); font-size:0.85em; margin-top:10px;"></div>
    </div>

    <div id="login-card" class="auth-card hidden">
      <h2>ğŸ‘¤ è´¦å·ç™»å½•</h2>
      <p>è¯·è¾“å…¥æ‚¨çš„ä¸ªäººè´¦å·</p>
      <div class="input-group">
        <label>ç”¨æˆ·å (å¦‚: user)</label>
        <input type="text" id="log-user">
      </div>
      <div class="input-group">
        <label>å¯†ç </label>
        <input type="password" id="log-pass">
      </div>
      <button class="btn-block" onclick="doLogin()">ç™» å½•</button>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button class="link-btn" onclick="showRegister()">æ³¨å†Œæ–°è´¦å·</button>
        <button class="link-btn" style="color:#999" onclick="clearConfig()">é‡ç½®æœåŠ¡å™¨</button>
      </div>
      <div id="log-msg" style="color:var(--danger); font-size:0.85em; margin-top:10px;"></div>
    </div>

    <div id="family-card" class="auth-card hidden">
      <h2>ğŸ  åŠ å…¥å®¶åº­</h2>
      <p>è¾“å…¥å®¶åº­åç§°ï¼Œåªæœ‰åŒåå®¶åº­æ‰èƒ½å…±äº«æ•°æ®</p>
      <div class="input-group">
        <label>å®¶åº­åç§° (å”¯ä¸€æ ‡è¯†)</label>
        <input type="text" id="family-name" placeholder="ä¾‹å¦‚: å¹¸ç¦ä¸€å®¶äºº">
      </div>
      <button class="btn-block" style="background:var(--accent);" onclick="joinFamily()">ç¡®è®¤åŠ å…¥</button>
      <div style="margin-top:15px; font-size:0.85em; color:#999;">
        æç¤ºï¼šå¦‚æœå®¶åº­ä¸å­˜åœ¨ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»º
      </div>
    </div>

    <div id="reg-card" class="auth-card hidden">
      <h2>ğŸ“ æ³¨å†Œæ–°è´¦å·</h2>
      <div class="input-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="reg-user">
      </div>
      <div class="input-group">
        <label>å¯†ç </label>
        <input type="password" id="reg-pass">
      </div>
      <div class="input-group">
        <label>ç¡®è®¤å¯†ç </label>
        <input type="password" id="reg-pass2">
      </div>
      <button class="btn-block" style="background:var(--accent);" onclick="doRegister()">æ³¨ å†Œ</button>
      <button class="link-btn" onclick="showLogin()">è¿”å›ç™»å½•</button>
      <div id="reg-msg" style="color:var(--danger); font-size:0.85em; margin-top:10px;"></div>
    </div>
  </div>

  <div class="container" id="app-layer">
    <div class="top-header">
      <div class="app-logo">ğŸ“¦ å•†å“ä¿è´¨æœŸç®¡ç†</div>
      <div class="user-area">
        <span class="family-badge" id="display-family">ğŸ  æœªåŠ å…¥å®¶åº­</span>
        <span class="user-badge" id="display-username">æœªç™»å½•</span>
        <button class="logout-btn" onclick="doLogout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="stat-card card-total" onclick="quickFilter('')">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-info">
          <div class="stat-label">å…¨éƒ¨å•†å“</div>
          <div class="stat-num" id="stat-total">0</div>
        </div>
      </div>
      <div class="stat-card card-near" onclick="quickFilter('near')">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-info">
          <div class="stat-label">å³å°†è¿‡æœŸ</div>
          <div class="stat-num" id="stat-near">0</div>
        </div>
      </div>
      <div class="stat-card card-exp" onclick="quickFilter('exp')">
        <div class="stat-icon">ğŸš«</div>
        <div class="stat-info">
          <div class="stat-label">å·²è¿‡æœŸ</div>
          <div class="stat-num" id="stat-exp">0</div>
        </div>
      </div>
    </div>

    <div class="filter-container">
      <div class="filter-item" style="flex: 2;">
        <label>ğŸ” æœç´¢</label>
        <input type="text" id="searchInput" class="filter-input" placeholder="åç§° / ç¼–å· / è®°å½•äºº..." />
      </div>
      <div class="filter-item">
        <label>ğŸ“Œ ç±»å‹</label>
        <select id="typeFilter" class="filter-select">
          <option value="">å…¨éƒ¨ç±»å‹</option>
          <option value="é£Ÿå“">é£Ÿå“</option>
          <option value="é¥®æ–™">é¥®æ–™</option>
          <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
          <option value="è¯å“">è¯å“</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
      <div class="filter-item">
        <label>ğŸš¦ çŠ¶æ€</label>
        <select id="statusFilter" class="filter-select">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="normal">æ­£å¸¸</option>
          <option value="near">ä¸´æœŸ</option>
          <option value="exp">è¿‡æœŸ</option>
        </select>
      </div>
      <div class="filter-item">
        <label>ğŸ”ƒ æ’åºæ–¹å¼</label>
        <select id="sortSelect" class="filter-select" onchange="renderProducts()">
          <option value="expiry_asc">â³ è¿‡æœŸæ—¶é—´ (ç”±è¿‘åˆ°è¿œ)</option>
          <option value="created_desc">ğŸ†• æ·»åŠ æ—¶é—´ (æœ€æ–°åœ¨å‰)</option>
          <option value="produce_desc">ğŸ“… ç”Ÿäº§æ—¥æœŸ (æœ€æ–°åœ¨å‰)</option>
        </select>
      </div>

      <div style="display: flex; gap: 10px;">
        <button class="btn-search" onclick="renderProducts()">æŸ¥è¯¢</button>
      </div>
    </div>

    <button class="fab-btn" onclick="openAddModal()" title="æ–°å¢å•†å“">+</button>

    <div class="table-wrapper">
      <table id="productTable">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()"></th>
            <th>ç¼–å·</th>
            <th>åç§°</th>
            <th>ä¸€çº§ç±»å‹</th>
            <th>ç”Ÿäº§æ—¥æœŸ</th>
            <th>ä¿è´¨æœŸ(å¤©)</th>
            <th>è¿‡æœŸæ—¥æœŸ</th>
            <th>å‰©ä½™å¤©æ•°</th>
            <th>çŠ¶æ€</th>
            <th>è®°å½•äºº</th>
            <th width="140">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <div id="totalItemsInfo" style="color:#64748b;">å…± 0 æ¡æ•°æ®</div>
      <div class="page-ctrl">
        <span style="color:#64748b;">æ¯é¡µ:</span>
        <select id="pageSizeSelect" onchange="changePageSize()" style="border:1px solid #ddd; border-radius:4px;">
          <option value="10">10</option>
          <option value="20">20</option>
        </select>
        <button class="page-btn" id="prevBtn" onclick="prevPage()">&lt;</button>
        <span id="pageNumberDisplay" style="color:#334155;">1 / 1</span>
        <button class="page-btn" id="nextBtn" onclick="nextPage()">&gt;</button>
        <span style="color:#64748b;">è·³è‡³</span>
        <input type="number" id="jumpInput" style="width:40px; text-align:center; border:1px solid #ddd;" min="1">
        <button class="page-btn" onclick="jumpToPage()">Go</button>
      </div>
    </div>

    <div class="batch-del-row">
      <button id="batchDeleteBtn" class="btn-batch-del" onclick="batchDeleteSelected()" disabled>æ‰¹é‡åˆ é™¤</button>
    </div>

    <div class="footer-actions">
      <button class="footer-btn btn-export" onclick="exportToCSV()">ğŸ“¥ å¯¼å‡º Excel</button>
      <button class="footer-btn btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°é¡µé¢</button>
      <button class="footer-btn btn-import" onclick="document.getElementById('importFile').click()">ğŸ“¤ æ‰¹é‡å¯¼å…¥</button>
      <button class="footer-btn btn-claim" onclick="claimLegacyData()" title="å°†æ‰€æœ‰æ— å®¶åº­å½’å±çš„æ•°æ®åŒæ­¥ä¸ºå½“å‰å®¶åº­å’Œå½“å‰è®°å½•äºº">âš¡
        ä¸€é”®è®¤é¢†æ—§æ•°æ®</button>
      <input type="file" id="importFile" accept=".csv" onchange="handleImportFile(this)" style="display:none;" />
    </div>
  </div>

  <div class="modal-mask" id="edit-modal">
    <div class="modal-box">
      <div class="modal-title">ğŸ“¦ å•†å“ä¿¡æ¯</div>

      <div class="smart-section">
        <div class="smart-header">
          <span>ğŸ¤– æ™ºèƒ½è¯†åˆ«</span>
          <span style="font-weight:400; color:#94a3b8; font-size:0.8rem">æ”¯æŒè‡ªç„¶è¯­è¨€æè¿°</span>
        </div>
        <textarea id="smart-input" class="smart-input"
          placeholder="ç²˜è´´æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼š'å•†å“ç¼–ç 2301 å«é¾™è¾£æ¡ 2024å¹´1æœˆ1æ—¥ç”Ÿäº§ ä¿è´¨æœŸ120å¤©'"></textarea>
        <button type="button" class="btn-smart" id="btn-smart-exec" onclick="smartRecognize()">
          âš¡ ä¸€é”®æå–ä¿¡æ¯
        </button>
      </div>

      <form id="modalForm">
        <input type="hidden" id="e-id">
        <div class="input-group">
          <label>å•†å“ç¼–å· (å”¯ä¸€)</label>
          <input type="text" id="e-code" required placeholder="å¦‚: 1001" />
        </div>
        <div class="input-group">
          <label>å•†å“åç§°</label>
          <input type="text" id="e-name" required placeholder="å¦‚: ç‰›å¥¶" />
        </div>
        <div class="input-group">
          <label>ä¸€çº§ç±»å‹</label>
          <select id="e-type" style="width:100%; height:40px; border:1px solid var(--border); border-radius:6px;">
            <option value="é£Ÿå“">é£Ÿå“</option>
            <option value="é¥®æ–™">é¥®æ–™</option>
            <option value="æ—¥ç”¨å“">æ—¥ç”¨å“</option>
            <option value="è¯å“">è¯å“</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="input-group">
          <label>ç”Ÿäº§æ—¥æœŸ</label>
          <input type="date" id="e-date" required />
        </div>
        <div class="input-group">
          <label>ä¿è´¨æœŸ (å¤©)</label>
          <input type="number" id="e-days" required min="1" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-block" style="background:#f1f5f9; color:#64748b; width:auto;"
            onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn-block" style="width:auto;">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ============================================
    // 1. è®¤è¯ã€å®¶åº­ä¸é…ç½®é€»è¾‘
    // ============================================
    const STORAGE_ID = 'lc_app_id';
    const STORAGE_KEY = 'lc_app_key';
    const STORAGE_URL = 'lc_server_url';
    const LS_AI_KEY_NAME = 'openrouter_api_key';
    const FAMILY_KEY = 'leancloud_family_name';

    let ProductClass = null;
    let currentUser = null;
    let currentFamily = null;

    window.onload = function () {
      checkInit();
    };

    function checkInit() {
      const id = localStorage.getItem(STORAGE_ID);
      const key = localStorage.getItem(STORAGE_KEY);
      const url = localStorage.getItem(STORAGE_URL);
      let aiKey = localStorage.getItem(LS_AI_KEY_NAME);

      if (id && key && url) {
        document.getElementById('conf-id').value = id;
        document.getElementById('conf-key').value = key;
        document.getElementById('conf-url').value = url;
        if (aiKey) document.getElementById('conf-ai-key').value = aiKey;

        initializeSystem(id, key, url).then(success => {
          if (success) {
            checkLoginStatus();
          } else {
            showCard('config-card');
            document.getElementById('conf-msg').innerText = "è‡ªåŠ¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®";
          }
        });
      } else {
        showCard('config-card');
      }
    }

    async function initializeSystem(appId, appKey, serverUrl) {
      try {
        if (typeof AV.applicationId === 'undefined') {
          AV.init({ appId, appKey, serverURLs: serverUrl });
        }
        ProductClass = AV.Object.extend('rourou_BananaNest');
        const q = new AV.Query(ProductClass);
        q.limit(1);
        await q.find();
        return true;
      } catch (e) {
        console.error("Init Error:", e);
        return false;
      }
    }

    function saveConfig() {
      const appId = document.getElementById('conf-id').value.trim();
      const appKey = document.getElementById('conf-key').value.trim();
      const serverUrl = document.getElementById('conf-url').value.trim();
      const aiKey = document.getElementById('conf-ai-key').value.trim();
      const msg = document.getElementById('conf-msg');

      if (!appId || !appKey || !serverUrl) return msg.innerText = "è¯·å¡«å†™å®Œæ•´";
      msg.innerText = "æ­£åœ¨è¿æ¥...";

      initializeSystem(appId, appKey, serverUrl).then(ok => {
        if (ok) {
          localStorage.setItem(STORAGE_ID, appId);
          localStorage.setItem(STORAGE_KEY, appKey);
          localStorage.setItem(STORAGE_URL, serverUrl);
          if (aiKey) localStorage.setItem(LS_AI_KEY_NAME, aiKey);
          else localStorage.removeItem(LS_AI_KEY_NAME);

          checkLoginStatus();
        } else {
          msg.innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‚æ•°";
        }
      });
    }

    function clearConfig() {
      if (confirm('ç¡®å®šé‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ(è¿™ä¹Ÿä¼šé‡ç½®è®°è´¦è½¯ä»¶çš„è¿æ¥)')) {
        localStorage.removeItem(STORAGE_ID);
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STORAGE_URL);
        localStorage.removeItem(FAMILY_KEY);
        AV.User.logOut();
        location.reload();
      }
    }

    function checkLoginStatus() {
      const user = AV.User.current();
      if (user) {
        currentUser = user;
        const savedFamily = localStorage.getItem(FAMILY_KEY);
        if (savedFamily) {
          joinFamily(savedFamily);
        } else {
          showCard('family-card');
        }
      } else {
        showCard('login-card');
      }
    }

    async function doLogin() {
      const u = document.getElementById('log-user').value.trim();
      const p = document.getElementById('log-pass').value.trim();
      if (!u || !p) return;
      try {
        const user = await AV.User.logIn(u, p);
        currentUser = user;
        const savedFamily = localStorage.getItem(FAMILY_KEY);
        if (savedFamily) {
          joinFamily(savedFamily);
        } else {
          showCard('family-card');
        }
      } catch (e) {
        document.getElementById('log-msg').innerText = "ç™»å½•å¤±è´¥: " + e.message;
      }
    }

    async function doRegister() {
      const u = document.getElementById('reg-user').value.trim();
      const p = document.getElementById('reg-pass').value.trim();
      const p2 = document.getElementById('reg-pass2').value.trim();
      if (!u || !p) return alert("è¯·è¾“å…¥å®Œæ•´");
      if (p !== p2) return alert("å¯†ç ä¸ä¸€è‡´");

      const user = new AV.User();
      user.setUsername(u);
      user.setPassword(p);
      try {
        await user.signUp();
        alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
        showCard('login-card');
      } catch (e) {
        document.getElementById('reg-msg').innerText = "æ³¨å†Œå¤±è´¥: " + e.message;
      }
    }

    function doLogout() {
      AV.User.logOut();
      location.reload();
    }

    function joinFamily(nameInput) {
      const fname = nameInput || document.getElementById('family-name').value.trim();
      if (!fname) return alert("è¯·è¾“å…¥å®¶åº­åç§°");

      currentFamily = fname;
      localStorage.setItem(FAMILY_KEY, fname);

      document.getElementById('auth-layer').style.display = 'none';
      document.getElementById('app-layer').style.display = 'block';
      document.getElementById('display-username').innerText = currentUser.getUsername();
      document.getElementById('display-family').innerText = `ğŸ  ${currentFamily}`;

      renderProducts();
    }

    function showCard(id) {
      document.querySelectorAll('.auth-card').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
    function showRegister() { showCard('reg-card'); }
    function showLogin() { showCard('login-card'); }


    // ============================================
    // 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
    // ============================================
    let currentProducts = [];
    let currentPage = 1;
    let itemsPerPage = 10;

    async function getProducts() {
      if (!ProductClass) return [];

      const query = new AV.Query(ProductClass);
      query.equalTo('familyName', currentFamily);
      query.limit(1000);
      query.descending('createdAt');

      try {
        const results = await query.find();
        return results.map(obj => ({
          id: obj.id,
          code: obj.get('code'),
          name: obj.get('name'),
          type1: obj.get('type1'),
          recorder: obj.get('recorder') || 'æœªçŸ¥',
          produceDate: obj.get('produceDate'),
          shelfLife: Number(obj.get('shelfLife')),
          createdAt: obj.createdAt // æ–°å¢ï¼šè·å–åˆ›å»ºæ—¶é—´ç”¨äºæ’åº
        }));
      } catch (error) {
        console.error(error);
        return [];
      }
    }

    async function claimLegacyData() {
      if (!confirm(`ç¡®å®šè¦å°†æ‰€æœ‰ã€æ— å®¶åº­å½’å±ã€‘çš„æ—§æ•°æ®ï¼Œå…¨éƒ¨åˆ’å…¥å®¶åº­ã€${currentFamily}ã€‘å¹¶æ ‡è®°è®°å½•äººä¸ºã€${currentUser.getUsername()}ã€‘å—ï¼Ÿ`)) return;

      const btn = document.querySelector('.btn-claim');
      const originalText = btn.innerText;
      btn.innerText = "å¤„ç†ä¸­...";
      btn.disabled = true;

      try {
        const query = new AV.Query(ProductClass);
        query.doesNotExist('familyName');
        query.limit(1000);
        const legacyItems = await query.find();

        if (legacyItems.length === 0) {
          alert("æ²¡æœ‰å‘ç°éœ€è¦è®¤é¢†çš„æ—§æ•°æ®ã€‚");
        } else {
          legacyItems.forEach(item => {
            item.set('familyName', currentFamily);
            item.set('recorder', currentUser.getUsername());
          });
          await AV.Object.saveAll(legacyItems);
          alert(`æˆåŠŸè®¤é¢†äº† ${legacyItems.length} æ¡æ•°æ®ï¼`);
          renderProducts();
        }
      } catch (error) {
        alert("è®¤é¢†å¤±è´¥ï¼š" + error.message);
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    function getProductStatus(p) {
      const now = new Date();
      const pDate = new Date(p.produceDate);
      const eDate = new Date(pDate);
      eDate.setDate(pDate.getDate() + p.shelfLife);

      const diff = eDate - now;
      const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));

      let ratio;
      if (p.shelfLife <= 30) ratio = 0.5;
      else if (p.shelfLife <= 540) ratio = 1 / 3;
      else ratio = 0.2;

      const criticalDate = new Date(eDate.getTime() - p.shelfLife * ratio * 24 * 60 * 60 * 1000);

      if (now > eDate) return { cls: 'status-exp', text: 'å·²è¿‡æœŸ', daysLeft };
      if (now >= criticalDate) return { cls: 'status-near', text: 'ä¸´æœŸ', daysLeft };
      return { cls: 'status-normal', text: 'æ­£å¸¸', daysLeft };
    }

    function calcExpireDate(pDateStr, shelfLife) {
      const d = new Date(pDateStr);
      d.setDate(d.getDate() + shelfLife);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function getRecorderStyle(name) {
      if (!name || name === 'æœªçŸ¥') return 'badge-blue';
      if (name.toLowerCase().includes('rourou')) return 'badge-green';
      if (name.toLowerCase().includes('hundun')) return 'badge-pink';
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      const colors = ['badge-blue', 'badge-orange', 'badge-green', 'badge-pink'];
      return colors[Math.abs(hash) % colors.length];
    }

    // === ç‚¹å‡»çœ‹æ¿å¡ç‰‡å¿«é€Ÿç­›é€‰ ===
    function quickFilter(statusVal) {
      const select = document.getElementById('statusFilter');
      select.value = statusVal;
      // è§¦å‘æŸ¥è¯¢
      renderProducts();
    }

    // === æ ¸å¿ƒæ¸²æŸ“å‡½æ•° (åŒ…å« ç»Ÿè®¡ + é«˜äº® + åŠ¨æ€æ’åº) ===
    async function renderProducts() {
      const key = document.getElementById('searchInput').value.toLowerCase();
      const typeF = document.getElementById('typeFilter').value;
      const statusF = document.getElementById('statusFilter').value;
      const sortType = document.getElementById('sortSelect').value; // è·å–æ’åºæ–¹å¼

      let list = await getProducts();

      // é¢„å¤„ç†ï¼šç»™æ¯ä¸ªå•†å“å¯¹è±¡æŒ‚è½½ status ä¿¡æ¯
      list.forEach(p => {
        p._statusInfo = getProductStatus(p);
      });

      // --- ç»Ÿè®¡é€»è¾‘ (Dashboard) ---
      // ç»Ÿè®¡åŸºäºâ€œæœç´¢è¯â€å’Œâ€œç±»å‹â€è¿‡æ»¤åçš„ç»“æœ
      let tempFilterList = list.filter(p => {
        const matchKey = !key || p.name.includes(key) || p.code.toLowerCase().includes(key) || p.recorder.includes(key);
        const matchType = !typeF || p.type1 === typeF;
        return matchKey && matchType;
      });

      let countTotal = tempFilterList.length;
      let countNear = 0;
      let countExp = 0;

      tempFilterList.forEach(p => {
        if (p._statusInfo.cls === 'status-near') countNear++;
        if (p._statusInfo.cls === 'status-exp') countExp++;
      });

      // æ›´æ–°çœ‹æ¿ DOM
      document.getElementById('stat-total').innerText = countTotal;
      document.getElementById('stat-near').innerText = countNear;
      document.getElementById('stat-exp').innerText = countExp;


      // --- æœ€ç»ˆåˆ—è¡¨è¿‡æ»¤ (åŠ å…¥çŠ¶æ€ç­›é€‰) ---
      let finalDisplayList = tempFilterList.filter(p => {
        let statusKey = '';
        if (p._statusInfo.cls === 'status-normal') statusKey = 'normal';
        if (p._statusInfo.cls === 'status-near') statusKey = 'near';
        if (p._statusInfo.cls === 'status-exp') statusKey = 'exp';

        return !statusF || statusKey === statusF;
      });

      // --- åŠ¨æ€æ’åºé€»è¾‘ ---
      finalDisplayList.sort((a, b) => {
        if (sortType === 'created_desc') {
          // æŒ‰æ·»åŠ æ—¶é—´ï¼šæ–°çš„åœ¨å‰
          return b.createdAt - a.createdAt;
        } else if (sortType === 'produce_desc') {
          // æŒ‰ç”Ÿäº§æ—¥æœŸï¼šæ–°çš„åœ¨å‰
          return new Date(b.produceDate) - new Date(a.produceDate);
        } else {
          // é»˜è®¤ï¼šæŒ‰è¿‡æœŸæ—¶é—´ï¼ˆç”±è¿‘åˆ°è¿œï¼‰
          const endA = new Date(a.produceDate).getTime() + a.shelfLife * 86400000;
          const endB = new Date(b.produceDate).getTime() + b.shelfLife * 86400000;
          return endA - endB;
        }
      });

      currentProducts = finalDisplayList;
      updatePagination();
    }

    function updatePagination() {
      const total = currentProducts.length;
      const maxPage = Math.ceil(total / itemsPerPage) || 1;
      if (currentPage > maxPage && maxPage > 0) currentPage = maxPage;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * itemsPerPage;
      const pageData = currentProducts.slice(start, start + itemsPerPage);

      const tbody = document.getElementById('productList');
      tbody.innerHTML = '';

      if (pageData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:30px; color:#999;">æš‚æ— æ•°æ®ï¼ˆå¦‚æœ‰æ—§æ•°æ®è¯·ç‚¹å‡»å³ä¸‹è§’è®¤é¢†ï¼‰</td></tr>`;
      } else {
        pageData.forEach(p => {
          // ä½¿ç”¨ä¹‹å‰æŒ‚è½½çš„ _statusInfo
          const statusInfo = p._statusInfo || getProductStatus(p);
          const { text, cls, daysLeft } = statusInfo;

          const expDate = calcExpireDate(p.produceDate, p.shelfLife);
          const recorderClass = getRecorderStyle(p.recorder);

          const tr = document.createElement('tr');

          // æ·»åŠ è¡Œé«˜äº® Class
          if (cls === 'status-near') tr.classList.add('row-near');
          if (cls === 'status-exp') tr.classList.add('row-exp');

          tr.innerHTML = `
            <td><input type="checkbox" class="item-cb" data-id="${p.id}" onchange="checkBatchBtn()"></td>
            <td>${p.code}</td>
            <td style="font-weight:500;">${p.name}</td>
            <td>${p.type1}</td>
            <td>${p.produceDate}</td>
            <td>${p.shelfLife}</td>
            <td>${expDate}</td>
            <td>${daysLeft}</td>
            <td class="${cls}">${text}</td>
            <td><span class="recorder-badge ${recorderClass}">${p.recorder}</span></td>
            <td>
              <div class="action-btn-group">
                <button class="btn-sm btn-edit" onclick="startEdit('${p.id}')">ç¼–è¾‘</button>
                <button class="btn-sm btn-del" onclick="deleteProduct('${p.id}')">åˆ é™¤</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('totalItemsInfo').innerText = `å…± ${total} æ¡æ•°æ®`;
      document.getElementById('pageNumberDisplay').innerText = `${currentPage} / ${maxPage}`;

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= maxPage;

      checkBatchBtn();
    }

    function changePageSize() {
      itemsPerPage = parseInt(document.getElementById('pageSizeSelect').value);
      currentPage = 1;
      updatePagination();
    }
    function prevPage() { if (currentPage > 1) { currentPage--; updatePagination(); } }
    function nextPage() { const max = Math.ceil(currentProducts.length / itemsPerPage); if (currentPage < max) { currentPage++; updatePagination(); } }
    function jumpToPage() {
      const val = parseInt(document.getElementById('jumpInput').value);
      if (val >= 1) { currentPage = val; updatePagination(); }
    }

    function toggleAllCheckboxes() {
      const v = document.getElementById('selectAll').checked;
      document.querySelectorAll('.item-cb').forEach(cb => cb.checked = v);
      checkBatchBtn();
    }
    function checkBatchBtn() {
      const n = document.querySelectorAll('.item-cb:checked').length;
      document.getElementById('batchDeleteBtn').disabled = (n === 0);
    }

    // å¢åˆ æ”¹
    function openAddModal() {
      document.getElementById('modalForm').reset();
      document.getElementById('e-id').value = '';
      document.getElementById('edit-modal').classList.add('active');
    }
    function closeModal() {
      document.getElementById('edit-modal').classList.remove('active');
    }

    async function startEdit(id) {
      const p = currentProducts.find(x => x.id === id);
      if (!p) return;
      document.getElementById('e-id').value = id;
      document.getElementById('e-code').value = p.code;
      document.getElementById('e-name').value = p.name;
      document.getElementById('e-type').value = p.type1;
      document.getElementById('e-date').value = p.produceDate;
      document.getElementById('e-days').value = p.shelfLife;
      document.getElementById('edit-modal').classList.add('active');
    }

    document.getElementById('modalForm').onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('e-id').value;
      const data = {
        code: document.getElementById('e-code').value,
        name: document.getElementById('e-name').value,
        type1: document.getElementById('e-type').value,
        produceDate: document.getElementById('e-date').value,
        shelfLife: parseInt(document.getElementById('e-days').value),
      };

      try {
        if (id) {
          const obj = AV.Object.createWithoutData('rourou_BananaNest', id);
          obj.set(data);
          await obj.save();
        } else {
          // æ–°å¢é€»è¾‘ï¼šå†™å…¥å®¶åº­ID å’Œ è®°å½•äºº
          const obj = new ProductClass();
          obj.set(data);
          if (currentUser) {
            obj.set('recorder', currentUser.getUsername());
            obj.set('familyName', currentFamily);
          }

          const acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          obj.setACL(acl);
          await obj.save();
        }
        closeModal();
        renderProducts();
      } catch (err) { alert(err.message); }
    };

    async function deleteProduct(id) {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      const obj = AV.Object.createWithoutData('rourou_BananaNest', id);
      await obj.destroy();
      renderProducts();
    }

    async function batchDeleteSelected() {
      if (!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­é¡¹?')) return;
      const ids = Array.from(document.querySelectorAll('.item-cb:checked')).map(c => c.dataset.id);
      const objs = ids.map(id => AV.Object.createWithoutData('rourou_BananaNest', id));
      await AV.Object.destroyAll(objs);
      renderProducts();
      document.getElementById('selectAll').checked = false;
    }

    function exportToCSV() {
      if (currentProducts.length === 0) return alert("æ— æ•°æ®");
      const header = "ç¼–å·,åç§°,ä¸€çº§ç±»å‹,è®°å½•äºº,ç”Ÿäº§æ—¥æœŸ,ä¿è´¨æœŸ,è¿‡æœŸæ—¥æœŸ,å‰©ä½™å¤©æ•°,çŠ¶æ€\n";
      const rows = currentProducts.map(p => {
        const { text, daysLeft } = getProductStatus(p);
        const exp = calcExpireDate(p.produceDate, p.shelfLife);
        return `${p.code},${p.name},${p.type1},${p.recorder},${p.produceDate},${p.shelfLife},${exp},${daysLeft},${text}`;
      }).join("\n");

      const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'products.csv'; a.click();
    }

    async function handleImportFile(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        let count = 0;
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const cols = line.split(',');
          if (cols.length < 5) continue;

          const p = new ProductClass();
          p.set('code', cols[0]);
          p.set('name', cols[1]);
          p.set('type1', cols[2]);
          if (currentUser) {
            p.set('recorder', currentUser.getUsername());
            p.set('familyName', currentFamily);
          }
          p.set('produceDate', cols[4]);
          p.set('shelfLife', parseInt(cols[5]));

          const acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          p.setACL(acl);

          try { await p.save(); count++; } catch (err) { console.error(err); }
        }
        alert(`æˆåŠŸå¯¼å…¥ ${count} æ¡ï¼Œè®°å½•äºº: ${currentUser.getUsername()}ï¼Œå®¶åº­: ${currentFamily}`);
        renderProducts();
        input.value = '';
      };
      reader.readAsText(file);
    }

    // ============================================
    // 3. æ™ºèƒ½è¯†åˆ« (OpenRouter)
    // ============================================
    async function smartRecognize() {
      const text = document.getElementById('smart-input').value.trim();
      if (!text) return alert("è¯·åœ¨ä¸Šæ–¹æ–‡æœ¬æ¡†æè¿°å•†å“ä¿¡æ¯");

      let apiKey = localStorage.getItem(LS_AI_KEY_NAME);
      if (!apiKey) return alert("è¯·å…ˆåœ¨æœåŠ¡å™¨é…ç½®é¡µé¢å¡«å†™ OpenRouter API Key");

      const btn = document.getElementById('btn-smart-exec');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'ğŸ¤– æ­£åœ¨åˆ†æ...';
      btn.disabled = true;

      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            "model": "xiaomi/mimo-v2-flash:free",
            "messages": [
              {
                "role": "user",
                "content": `ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å•†å“ä¿¡æ¯æå–åŠ©æ‰‹ã€‚è¯·ä»ç”¨æˆ·çš„æè¿°ä¸­æå–å•†å“ä¿¡æ¯ã€‚
å½“å‰æ—¥æœŸ: ${new Date().toISOString().split('T')[0]} (è¯·åŸºäºæ­¤æ—¥æœŸæ¨æ–­"ä»Šå¤©"ã€"æ˜¨å¤©"ã€"å»å¹´"ç­‰ç›¸å¯¹æ—¶é—´)

éœ€æå–å­—æ®µï¼š
- code (å•†å“ç¼–å·/æ¡ç , å­—ç¬¦ä¸²)
- name (å•†å“åç§°)
- type1 (å•†å“ç±»å‹, å¿…é¡»ä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„: "é£Ÿå“", "é¥®æ–™", "æ—¥ç”¨å“", "è¯å“", "å…¶ä»–")
- produceDate (ç”Ÿäº§æ—¥æœŸ, æ ¼å¼ YYYY-MM-DD. è¯·åŠ¡å¿…ä½¿ç”¨æ¨ªæ åˆ†éš”)
- shelfLife (ä¿è´¨æœŸ, å•ä½: å¤©. å¦‚æœæè¿°çš„æ˜¯"6ä¸ªæœˆ", è¯·è½¬æ¢ä¸º180)

è¯·ç›´æ¥è¿”å›çº¯ JSON æ ¼å¼æ•°æ®ï¼Œä¸è¦åŒ…å« Markdown æ ¼å¼ç¬¦ï¼ˆå¦‚ \`\`\`jsonï¼‰ã€‚
å¦‚æœæœ‰å­—æ®µæ— æ³•ä»æ–‡æœ¬ä¸­æå–ä¸”æ— æ³•åˆç†æ¨æ–­ï¼Œè¯·å¿½ç•¥è¯¥å­—æ®µã€‚

ç”¨æˆ·è¾“å…¥: ${text}`
              }
            ],
            "reasoning": { "enabled": true }
          })
        });

        if (!response.ok) {
          throw new Error(`API Error: ${response.status}`);
        }

        const result = await response.json();
        let content = result.choices[0].message.content;

        content = content.replace(/```json/g, '').replace(/```/g, '').trim();

        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          content = jsonMatch[0];
        }

        let data;
        try {
          data = JSON.parse(content);
        } catch (parseErr) {
          console.error("JSON Parse Error:", parseErr, "Content:", content);
          throw new Error("AI è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•");
        }

        if (data.code) document.getElementById('e-code').value = data.code;
        if (data.name) document.getElementById('e-name').value = data.name;
        if (data.type1) document.getElementById('e-type').value = data.type1;
        if (data.produceDate) {
          let fmtDate = data.produceDate.replace(/\//g, '-');
          document.getElementById('e-date').value = fmtDate;
        }
        if (data.shelfLife) document.getElementById('e-days').value = data.shelfLife;

      } catch (e) {
        console.error(e);
        alert("è¯†åˆ«å¤±è´¥: " + e.message);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>

</html>