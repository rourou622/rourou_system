<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯é”™é¢˜æœ¬ (ä¿®å¤ç‰ˆ)</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#64748b' }
                }
            }
        }
    </script>

    <!-- 2. Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- 3. LeanCloud Storage SDK -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>

    <!-- 4. Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>

    <style>
        @media print {
            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background-color: white;
            }

            .prose {
                max-width: 100% !important;
            }

            .question-item {
                break-inside: avoid;
                border-bottom: 1px solid #ddd;
                padding-bottom: 20px;
                margin-bottom: 20px;
            }
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [v-cloak] {
            display: none;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

    <div id="app" v-cloak class="h-full flex flex-col md:flex-row">

        <!-- ================= 0. åˆå§‹åŒ–/ç™»å½• ================= -->
        <div v-if="!isReady || !currentUser"
            class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                <h1 class="text-2xl font-bold text-center mb-6 text-primary">äº‘ç«¯é”™é¢˜æœ¬</h1>
                <div v-if="!hasConfig" class="space-y-4">
                    <div class="bg-blue-50 text-blue-700 p-3 rounded text-xs mb-4">LeanCloud æ§åˆ¶å° &gt; è®¾ç½® &gt; åº”ç”¨å‡­è¯</div>
                    <input v-model="configForm.appId" placeholder="App ID" class="w-full p-2 border rounded text-sm">
                    <input v-model="configForm.appKey" type="password" placeholder="App Key"
                        class="w-full p-2 border rounded text-sm">
                    <input v-model="configForm.serverURL" placeholder="REST API (https://...)"
                        class="w-full p-2 border rounded text-sm">
                    <button @click="saveConfig"
                        class="w-full bg-primary text-white py-2 rounded hover:bg-indigo-700 mt-2">ä¿å­˜é…ç½®</button>
                </div>
                <div v-else class="space-y-4">
                    <div class="flex border-b mb-4">
                        <button @click="authMode='login'" :class="{'border-primary text-primary': authMode==='login'}"
                            class="flex-1 pb-2 border-b-2 border-transparent">ç™»å½•</button>
                        <button @click="authMode='signup'" :class="{'border-primary text-primary': authMode==='signup'}"
                            class="flex-1 pb-2 border-b-2 border-transparent">æ³¨å†Œ</button>
                    </div>
                    <input v-model="authForm.username" placeholder="ç”¨æˆ·å" class="w-full p-2 border rounded">
                    <input v-model="authForm.password" type="password" placeholder="å¯†ç "
                        class="w-full p-2 border rounded">
                    <button @click="handleAuth" class="w-full bg-primary text-white py-2 rounded hover:bg-indigo-700">{{
                        authMode === 'login' ? 'è¿›å…¥ç³»ç»Ÿ' : 'ç«‹å³æ³¨å†Œ' }}</button>
                    <button @click="clearConfig"
                        class="text-xs text-slate-400 underline w-full text-center">é‡ç½®é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- ================= å¯¼èˆªæ  ================= -->
        <nav v-if="currentUser"
            class="no-print md:w-64 bg-white border-r border-slate-200 flex-shrink-0 flex md:flex-col justify-between fixed bottom-0 w-full md:relative md:h-full z-40 shadow-inner md:shadow-none">
            <div class="hidden md:flex items-center justify-center h-16 border-b border-slate-100">
                <span class="text-xl font-bold text-primary">Mistake Note</span>
            </div>
            <div class="flex md:flex-col justify-around w-full md:w-auto md:p-4 md:space-y-2">
                <button @click="switchView('list')" :class="navClass('list')"
                    class="p-3 md:px-4 md:py-3 rounded-lg flex flex-col md:flex-row items-center md:space-x-3 transition">
                    <span class="text-2xl md:text-lg">ğŸ“š</span><span class="text-xs md:text-base">é”™é¢˜æœ¬</span>
                </button>
                <button @click="switchView('quiz')" :class="navClass('quiz')"
                    class="p-3 md:px-4 md:py-3 rounded-lg flex flex-col md:flex-row items-center md:space-x-3 transition">
                    <span class="text-2xl md:text-lg">ğŸ§ </span><span class="text-xs md:text-base">åˆ·é¢˜</span>
                </button>
                <button @click="switchView('knowledge')" :class="navClass('knowledge')"
                    class="p-3 md:px-4 md:py-3 rounded-lg flex flex-col md:flex-row items-center md:space-x-3 transition">
                    <span class="text-2xl md:text-lg">ğŸ’¡</span><span class="text-xs md:text-base">çŸ¥è¯†åº“</span>
                </button>
                <button @click="switchView('settings')" :class="navClass('settings')"
                    class="p-3 md:px-4 md:py-3 rounded-lg flex flex-col md:flex-row items-center md:space-x-3 transition">
                    <span class="text-2xl md:text-lg">âš™ï¸</span><span class="text-xs md:text-base">è®¾ç½®</span>
                </button>
            </div>
            <div class="hidden md:block p-4 border-t border-slate-100">
                <div class="text-sm text-slate-600 mb-2">User: {{ currentUser.getUsername() }}</div>
            </div>
        </nav>

        <!-- ================= ä¸»å†…å®¹åŒº ================= -->
        <main v-if="currentUser" class="flex-1 h-full overflow-y-auto bg-slate-50 relative pb-20 md:pb-0 scroll-smooth">

            <!-- é¡¶éƒ¨é€šæ  -->
            <header
                class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-slate-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center no-print gap-3 shadow-sm">
                <h2 class="text-xl font-bold text-slate-800 self-start md:self-center">{{ viewTitle }}</h2>
                <div class="flex flex-wrap gap-2 self-start md:self-center">
                    <!-- åˆ·é¢˜æ¨¡å¼ç­›é€‰ -->
                    <div v-if="currentView === 'quiz'" class="flex items-center space-x-2 mr-2">
                        <span class="text-xs text-slate-500 font-bold">èŒƒå›´:</span>
                        <select v-model="quizCategory" @change="refreshQuiz"
                            class="text-sm border-slate-300 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary/20 bg-white py-1 pl-2 pr-8">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option v-for="cat in categoryList" :key="cat.id" :value="cat.get('name')">{{
                                cat.get('name') }}</option>
                        </select>
                    </div>

                    <button v-if="currentView === 'list'" @click="printMode"
                        class="px-3 py-1 text-sm bg-slate-200 rounded hover:bg-slate-300">å¯¼å‡º</button>
                    <button v-if="['list', 'knowledge'].includes(currentView)" @click="openAddModal"
                        class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-indigo-700 shadow-md flex items-center">
                        <span class="text-lg mr-1 leading-none">+</span> æ–°å¢
                    </button>
                    <button v-if="currentView === 'quiz'" @click="refreshQuiz"
                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 shadow-md">ğŸ”„
                        æ¢ä¸€æ‰¹</button>
                </div>
            </header>

            <!-- View: List (é”™é¢˜åˆ—è¡¨) -->
            <div v-if="currentView === 'list'" class="p-4 max-w-4xl mx-auto flex flex-col h-full">

                <!-- ç­›é€‰å·¥å…·æ  -->
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center pb-4 mb-2 no-print gap-4">
                    <div class="flex flex-wrap gap-2">
                        <button @click="toggleListFilter('')"
                            class="px-4 py-1.5 rounded-full text-sm font-medium transition-colors border"
                            :class="listFilter === '' ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">å…¨éƒ¨</button>
                        <button v-for="cat in categoryList" :key="cat.id" @click="toggleListFilter(cat.get('name'))"
                            class="px-4 py-1.5 rounded-full text-sm font-medium transition-colors border"
                            :class="listFilter === cat.get('name') ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">{{
                            cat.get('name') }}</button>
                        <button v-if="categoryList.length === 0" @click="currentView='settings'"
                            class="px-4 py-1.5 rounded-full text-sm font-medium border border-dashed border-slate-300 text-slate-400 hover:text-primary hover:border-primary">+
                            æ·»åŠ åˆ†ç±»</button>
                    </div>

                    <div class="flex items-center space-x-2">
                        <select v-model="masteryFilter" @change="resetPageAndFetch"
                            class="text-sm border-slate-200 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary/20 bg-white py-1.5 pl-3 pr-8 text-slate-600">
                            <option :value="-1">å…¨éƒ¨çŠ¶æ€</option>
                            <option :value="0">æœªæ–©æ€ (è¿›è¡Œä¸­)</option>
                            <option :value="1">å·²æ–©æ€ (å·²æŒæ¡)</option>
                        </select>
                    </div>
                </div>

                <div v-if="loading" class="text-center py-10 text-slate-400">åŠ è½½ä¸­...</div>
                <div v-else-if="questions.length === 0" class="text-center py-10 text-slate-400">
                    æš‚æ— æ•°æ®
                </div>

                <div class="space-y-4">
                    <div v-for="q in questions" :key="q.id"
                        class="question-item bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group/item">
                        <div
                            class="absolute top-0 right-0 bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-bl-lg font-bold">
                            {{ q.get('category') || 'æœªåˆ†ç±»' }}</div>
                        <div class="absolute top-8 right-4 hidden group-hover/item:flex space-x-2 no-print">
                            <button @click="openEditModal(q, 'question')"
                                class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100">ç¼–è¾‘</button>
                        </div>
                        <div class="flex justify-between items-start mb-2 pr-8">
                            <div class="flex space-x-2">
                                <span v-for="tag in q.get('tags')"
                                    class="px-2 py-0.5 bg-indigo-50 text-indigo-600 text-xs rounded-full">#{{ tag
                                    }}</span>
                            </div>
                            <span v-if="q.get('masteryLevel') === 1"
                                class="text-green-500 text-xs font-bold border border-green-500 px-2 rounded ml-2">å·²æ–©æ€</span>
                        </div>
                        <div class="prose prose-slate max-w-none mb-4" v-html="renderMarkdown(q.get('content'))"></div>
                        <details class="group bg-slate-50 rounded-lg p-3">
                            <summary class="cursor-pointer font-medium text-slate-700 select-none flex justify-between">
                                <span>æŸ¥çœ‹ç­”æ¡ˆ & è§£æ</span><span>â–¼</span></summary>
                            <div class="border-t border-slate-200 pt-2 mt-2">
                                <p class="font-bold text-sm text-slate-500">ç­”æ¡ˆï¼š</p>
                                <div class="prose prose-sm mb-2" v-html="renderMarkdown(q.get('answer'))"></div>
                                <p class="font-bold text-sm text-slate-500">è§£æï¼š</p>
                                <div class="prose prose-sm" v-html="renderMarkdown(q.get('analysis'))"></div>
                                <div v-if="q.get('linkedKnowledge')"
                                    class="mt-3 text-xs text-slate-500 flex items-center"><span
                                        class="mr-1">ğŸ”—</span>å…³è”çŸ¥è¯†ç‚¹: {{ q.get('linkedKnowledge').get('title') }}</div>
                            </div>
                        </details>
                        <div class="mt-4 flex justify-end space-x-3 no-print">
                            <button @click="toggleMastery(q)" class="text-xs text-slate-500 hover:text-green-600">{{
                                q.get('masteryLevel') === 1 ? 'æ¢å¤æœªæŒæ¡' : 'æ–©æ€ (Master)' }}</button>
                            <button @click="deleteQuestion(q)"
                                class="text-xs text-red-400 hover:text-red-600">åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <div v-if="!loading && questions.length > 0"
                    class="mt-8 mb-4 no-print bg-white p-3 rounded-lg border border-slate-200 flex flex-wrap justify-between items-center gap-4 text-sm text-slate-600">
                    <div class="flex items-center space-x-2">
                        <span>æ¯é¡µ:</span>
                        <select v-model="pagination.pageSize" @change="resetPageAndFetch" class="border rounded p-1">
                            <option :value="5">5</option>
                            <option :value="10">10</option>
                            <option :value="20">20</option>
                            <option :value="50">50</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button @click="changePage(pagination.current - 1)" :disabled="pagination.current <= 1"
                            class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&lt;</button>
                        <span>ç¬¬ {{ pagination.current }} é¡µ / å…± {{ pagination.total }} é¡µ</span>
                        <button @click="changePage(pagination.current + 1)"
                            :disabled="pagination.current >= pagination.total"
                            class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&gt;</button>
                        <div class="flex items-center space-x-1 ml-2">
                            <input type="number" v-model.number="jumpPageNum"
                                class="w-12 border rounded p-1 text-center" min="1" :max="pagination.total">
                            <button @click="changePage(jumpPageNum)"
                                class="px-2 py-1 border rounded bg-slate-50 hover:bg-slate-100 text-xs">è·³è½¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Quiz -->
            <div v-if="currentView === 'quiz'" class="p-4 max-w-2xl mx-auto h-full flex flex-col">
                <div class="text-center mb-4"><span
                        class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">å½“å‰åˆ†ç±»: {{
                        quizCategory || 'å…¨éƒ¨' }}</span></div>
                <div v-if="quizList.length > 0" class="flex-1 flex flex-col items-center justify-center">
                    <div class="w-full text-center mb-4 text-slate-500 text-sm">å‰©ä½™é¢˜ç›®: {{ quizList.length }}</div>
                    <div
                        class="w-full bg-white rounded-2xl shadow-xl p-8 border border-slate-100 min-h-[400px] flex flex-col relative">
                        <span
                            class="absolute top-4 right-4 text-xs text-slate-300 font-bold border border-slate-100 px-2 rounded">{{
                            quizList[0].get('category') || 'æœªåˆ†ç±»' }}</span>
                        <div class="flex-1">
                            <div class="prose prose-lg max-w-none" v-html="renderMarkdown(quizList[0].get('content'))">
                            </div>
                        </div>
                        <div v-if="showQuizAnswer"
                            class="mt-8 pt-6 border-t border-slate-100 bg-slate-50 p-4 rounded-lg">
                            <div class="font-bold text-green-700">ç­”æ¡ˆï¼š</div>
                            <div class="prose prose-sm" v-html="renderMarkdown(quizList[0].get('answer'))"></div>
                            <div class="mt-2 font-bold text-indigo-700">è§£æï¼š</div>
                            <div class="prose prose-sm" v-html="renderMarkdown(quizList[0].get('analysis'))"></div>
                        </div>
                    </div>
                    <div class="mt-6 flex space-x-4 w-full">
                        <button v-if="!showQuizAnswer" @click="showQuizAnswer = true"
                            class="flex-1 bg-white border border-slate-300 py-3 rounded-lg hover:bg-slate-50">æŸ¥çœ‹ç­”æ¡ˆ</button>
                        <template v-else>
                            <button @click="handleQuizResult(false)"
                                class="flex-1 bg-red-50 text-red-600 border border-red-200 py-3 rounded-lg hover:bg-red-100">è®°ä¸æ¸…</button>
                            <button @click="handleQuizResult(true)"
                                class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 shadow-lg">æ–©æ€!</button>
                        </template>
                    </div>
                </div>
                <div v-else class="flex flex-col items-center justify-center h-full text-slate-400">
                    <div class="text-6xl mb-4">ğŸ‰</div>
                    <p>æš‚æ— å¾…å¤ä¹ é¢˜ç›®</p><button @click="refreshQuiz" class="mt-4 text-primary underline">åˆ·æ–°</button>
                </div>
            </div>

            <!-- View: Knowledge -->
            <div v-if="currentView === 'knowledge'" class="p-4 max-w-4xl mx-auto flex flex-col h-full">
                <div class="flex flex-wrap gap-2 pb-4 mb-2 no-print">
                    <button @click="toggleKnowledgeFilter('')"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-colors border"
                        :class="knowledgeFilter === '' ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">å…¨éƒ¨</button>
                    <button v-for="cat in categoryList" :key="cat.id" @click="toggleKnowledgeFilter(cat.get('name'))"
                        class="px-4 py-2 rounded-full text-sm font-medium transition-colors border"
                        :class="knowledgeFilter === cat.get('name') ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">{{
                        cat.get('name') }}</button>
                </div>

                <div v-if="loading" class="text-center py-10 text-slate-400">åŠ è½½ä¸­...</div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-if="knowledgeList.length === 0" class="col-span-full text-center py-10 text-slate-400">{{
                        knowledgeFilter ? `â€œ${knowledgeFilter}â€ä¸‹æš‚æ— å†…å®¹` : 'æš‚æ— å†…å®¹' }}</div>
                    <div v-for="k in knowledgeList" :key="k.id"
                        class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition relative group/kitem">
                        <span class="absolute top-4 right-4 text-[10px] text-slate-400 border px-1.5 rounded">{{
                            k.get('category') || 'æœªåˆ†ç±»' }}</span>
                        <h3 class="font-bold text-lg text-slate-800 mb-2 mr-8">{{ k.get('title') }}</h3>
                        <div class="prose prose-sm line-clamp-3 text-slate-600"
                            v-html="renderMarkdown(k.get('content'))"></div>
                        <div class="mt-3 pt-2 border-t flex justify-end space-x-2">
                            <button @click="openEditModal(k, 'knowledge')"
                                class="text-xs text-blue-500 hover:text-blue-700">ç¼–è¾‘</button>
                            <button @click="deleteKnowledge(k)"
                                class="text-xs text-red-400 hover:text-red-600">åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <div v-if="!loading && knowledgeList.length > 0"
                    class="mt-8 mb-4 no-print bg-white p-3 rounded-lg border border-slate-200 flex flex-wrap justify-between items-center gap-4 text-sm text-slate-600">
                    <div class="flex items-center space-x-2">
                        <span>æ¯é¡µ:</span>
                        <select v-model="pagination.pageSize" @change="resetPageAndFetch" class="border rounded p-1">
                            <option :value="5">5</option>
                            <option :value="10">10</option>
                            <option :value="20">20</option>
                            <option :value="50">50</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button @click="changePage(pagination.current - 1)" :disabled="pagination.current <= 1"
                            class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&lt;</button>
                        <span>ç¬¬ {{ pagination.current }} é¡µ / å…± {{ pagination.total }} é¡µ</span>
                        <button @click="changePage(pagination.current + 1)"
                            :disabled="pagination.current >= pagination.total"
                            class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&gt;</button>
                        <div class="flex items-center space-x-1 ml-2">
                            <input type="number" v-model.number="jumpPageNum"
                                class="w-12 border rounded p-1 text-center" min="1" :max="pagination.total">
                            <button @click="changePage(jumpPageNum)"
                                class="px-2 py-1 border rounded bg-slate-50 hover:bg-slate-100 text-xs">è·³è½¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Settings (ä¿æŒä¸å˜) -->
            <div v-if="currentView === 'settings'" class="p-4 max-w-md mx-auto space-y-4">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold mb-4 border-b pb-2">è´¦å·ä¿¡æ¯</h3>
                    <p class="text-sm text-slate-600 mb-1">User: {{ currentUser.getUsername() }}</p>
                    <button @click="handleLogout"
                        class="text-xs text-red-500 border border-red-500 px-2 py-1 rounded hover:bg-red-50">é€€å‡ºç™»å½•</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold mb-4 border-b pb-2 flex justify-between">
                        <span>åˆ†ç±»ç®¡ç†</span>
                        <span class="text-xs text-slate-400 font-normal">{{ categoryList.length }}/20</span>
                    </h3>
                    <div class="bg-yellow-50 text-yellow-700 text-xs p-2 mb-4 rounded">åˆ†ç±»ç‹¬ç«‹å­˜å‚¨ï¼Œæ•°æ®æ›´å®‰å…¨ã€‚</div>
                    <div class="flex space-x-2 mb-4">
                        <input v-model="newCategoryName" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°"
                            class="flex-1 p-2 border rounded text-sm">
                        <button @click="addCategory"
                            class="bg-primary text-white px-3 py-2 rounded text-sm hover:bg-indigo-700"
                            :disabled="categoryList.length >= 20">æ·»åŠ </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="cat in categoryList" :key="cat.id"
                            class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm flex items-center">
                            {{ cat.get('name') }}
                            <button @click="removeCategory(cat)"
                                class="ml-2 text-slate-400 hover:text-red-500 font-bold leading-none">&times;</button>
                        </div>
                        <div v-if="categoryList.length === 0" class="text-slate-400 text-sm">æš‚æ— åˆ†ç±»ï¼Œè¯·æ·»åŠ ã€‚</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal (ä¿æŒä¸å˜) -->
        <div v-if="showModal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-lg">{{ isEditing ? 'ç¼–è¾‘' : 'æ–°å¢' }} {{ targetType === 'knowledge' ? 'çŸ¥è¯†ç‚¹' :
                        'é”™é¢˜' }}</h3>
                    <button @click="closeModal" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 block mb-1">æ‰€å±åˆ†ç±» <span
                                class="text-red-500">*</span></label>
                        <select v-model="form.category"
                            class="w-full p-2 border rounded bg-white focus:ring-2 ring-primary/50 outline-none">
                            <option value="" disabled>-- è¯·é€‰æ‹© --</option>
                            <option v-for="cat in categoryList" :key="cat.id" :value="cat.get('name')">{{
                                cat.get('name') }}</option>
                        </select>
                    </div>
                    <template v-if="targetType === 'knowledge'">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">çŸ¥è¯†ç‚¹æ ‡é¢˜</label>
                            <input v-model="form.k_title" placeholder="ä¾‹å¦‚ï¼šVue3 ç”Ÿå‘½å‘¨æœŸ"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">è¯¦ç»†å†…å®¹ (Markdown)</label>
                            <textarea v-model="form.k_content" placeholder="è¾“å…¥çŸ¥è¯†ç‚¹è¯¦æƒ…..." rows="8"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                    </template>
                    <template v-if="targetType === 'question'">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">é¢˜ç›®å†…å®¹ (æ”¯æŒ Markdown)</label>
                            <textarea v-model="form.q_content" placeholder="è¾“å…¥é¢˜å¹²..." rows="3"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">æ ‡å‡†ç­”æ¡ˆ</label>
                            <textarea v-model="form.q_answer" placeholder="è¾“å…¥ç­”æ¡ˆ" rows="2"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">è¯¦ç»†è§£æ</label>
                            <textarea v-model="form.q_analysis" placeholder="è¾“å…¥è§£æ" rows="3"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 block mb-1">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                                <input v-model="form.q_tags" placeholder="å¦‚: æ˜“é”™,é‡ç‚¹" class="w-full p-2 border rounded">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 block mb-1">å…³è”çŸ¥è¯†ç‚¹</label>
                                <select v-model="form.q_knowledgeId" class="w-full p-2 border rounded bg-white">
                                    <option value="">æ— å…³è”</option>
                                    <option v-for="k in knowledgeListAll" :key="k.id" :value="k.id">
                                        [{{ k.get('category') || '-' }}] {{ k.get('title') }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="p-4 border-t bg-slate-50 flex justify-end space-x-3">
                    <button @click="closeModal" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">å–æ¶ˆ</button>
                    <button @click="submitData"
                        class="px-6 py-2 bg-primary text-white rounded shadow hover:bg-indigo-700"
                        :disabled="categoryList.length === 0">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                const isReady = ref(false);
                const hasConfig = ref(false);
                const currentUser = ref(null);
                const currentView = ref('list');
                const loading = ref(false);

                const showModal = ref(false);
                const isEditing = ref(false);
                const editingObject = ref(null);
                const targetType = ref('question');
                const showQuizAnswer = ref(false);

                const questions = ref([]);
                const knowledgeList = ref([]);
                const knowledgeListAll = ref([]);
                const quizList = ref([]);
                const categoryList = ref([]);

                const quizCategory = ref('');
                const knowledgeFilter = ref('');
                const listFilter = ref('');
                const newCategoryName = ref('');
                const masteryFilter = ref(-1);

                const pagination = reactive({ current: 1, pageSize: 10, total: 0, count: 0 });
                const jumpPageNum = ref(1);

                const configForm = reactive({ appId: '', appKey: '', serverURL: '' });
                const authMode = ref('login');
                const authForm = reactive({ username: '', password: '' });
                const form = reactive({ category: '', q_content: '', q_answer: '', q_analysis: '', q_tags: '', q_knowledgeId: '', k_title: '', k_content: '' });

                onMounted(() => {
                    const storedId = localStorage.getItem('lc_app_id');
                    const storedKey = localStorage.getItem('lc_app_key');
                    const storedUrl = localStorage.getItem('lc_server_url');
                    if (storedId && storedKey && storedUrl) {
                        configForm.appId = storedId; configForm.appKey = storedKey; configForm.serverURL = storedUrl;
                        initLeanCloud(storedId, storedKey, storedUrl);
                    } else { isReady.value = true; }
                });

                const initLeanCloud = (id, key, url) => {
                    try {
                        AV.init({ appId: id, appKey: key, serverURLs: url });
                        hasConfig.value = true;
                        currentUser.value = AV.User.current();
                        isReady.value = true;
                        if (currentUser.value) {
                            loadCategories();
                            loadInitialData();
                            loadKnowledgeForSelect();
                        }
                    } catch (error) { console.error(error); alert('é…ç½®é”™è¯¯'); clearConfig(); }
                };

                const loadCategories = async () => {
                    const query = new AV.Query('Category');
                    query.equalTo('owner', currentUser.value);
                    query.limit(100);
                    try { categoryList.value = await query.find(); } catch (e) { console.error(e); }
                };

                const addCategory = async () => {
                    const val = newCategoryName.value.trim();
                    if (!val) return;
                    if (categoryList.value.some(c => c.get('name') === val)) return alert('åˆ†ç±»å·²å­˜åœ¨');
                    if (categoryList.value.length >= 20) return alert('æœ€å¤š20ä¸ªåˆ†ç±»');
                    const Category = AV.Object.extend('Category');
                    const cat = new Category();
                    cat.set('name', val); cat.set('owner', currentUser.value); cat.setACL(new AV.ACL(currentUser.value));
                    try { await cat.save(); newCategoryName.value = ''; loadCategories(); } catch (e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
                };

                const removeCategory = async (catObj) => {
                    if (!confirm(`ç¡®å®šåˆ é™¤â€œ${catObj.get('name')}â€å—ï¼Ÿ`)) return;
                    try { await catObj.destroy(); loadCategories(); } catch (e) { alert('åˆ é™¤å¤±è´¥: ' + e.message); }
                };

                const loadInitialData = () => {
                    pagination.current = 1;
                    if (currentView.value === 'list') fetchQuestions();
                    else if (currentView.value === 'knowledge') fetchKnowledge();
                };

                const loadKnowledgeForSelect = async () => {
                    const query = new AV.Query('Knowledge');
                    query.equalTo('owner', currentUser.value);
                    query.select(['title', 'category']);
                    query.limit(1000);
                    try { knowledgeListAll.value = await query.find(); } catch (e) { }
                };

                const buildQuestionQuery = () => {
                    const q = new AV.Query('Question');
                    q.equalTo('owner', currentUser.value);
                    if (listFilter.value) q.equalTo('category', listFilter.value);
                    if (masteryFilter.value !== -1) q.equalTo('masteryLevel', masteryFilter.value);
                    return q;
                };

                const fetchQuestions = async () => {
                    loading.value = true;
                    const query = buildQuestionQuery();
                    const countQuery = buildQuestionQuery(); // Separate query for count

                    query.skip((pagination.current - 1) * pagination.pageSize);
                    query.limit(pagination.pageSize);
                    query.include('linkedKnowledge');
                    query.descending('createdAt');

                    try {
                        const [results, count] = await Promise.all([query.find(), countQuery.count()]);
                        questions.value = results;
                        pagination.count = count;
                        pagination.total = Math.ceil(count / pagination.pageSize) || 1;
                    } catch (e) { console.error(e); }
                    loading.value = false;
                };

                const buildKnowledgeQuery = () => {
                    const q = new AV.Query('Knowledge');
                    q.equalTo('owner', currentUser.value);
                    if (knowledgeFilter.value) q.equalTo('category', knowledgeFilter.value);
                    return q;
                };

                const fetchKnowledge = async () => {
                    loading.value = true;
                    const query = buildKnowledgeQuery();
                    const countQuery = buildKnowledgeQuery();

                    query.skip((pagination.current - 1) * pagination.pageSize);
                    query.limit(pagination.pageSize);
                    query.descending('createdAt');

                    try {
                        const [results, count] = await Promise.all([query.find(), countQuery.count()]);
                        knowledgeList.value = results;
                        pagination.count = count;
                        pagination.total = Math.ceil(count / pagination.pageSize) || 1;
                    } catch (e) { console.error(e); }
                    loading.value = false;
                };

                const changePage = (page) => {
                    let p = parseInt(page);
                    if (isNaN(p)) p = 1;
                    if (p < 1) p = 1;
                    if (p > pagination.total) p = pagination.total;
                    pagination.current = p;
                    jumpPageNum.value = p;
                    if (currentView.value === 'list') fetchQuestions();
                    else if (currentView.value === 'knowledge') fetchKnowledge();
                };

                const resetPageAndFetch = () => {
                    pagination.current = 1; jumpPageNum.value = 1;
                    if (currentView.value === 'list') fetchQuestions();
                    else if (currentView.value === 'knowledge') fetchKnowledge();
                };

                const switchView = (view) => {
                    currentView.value = view;
                    if (view === 'list' || view === 'knowledge') resetPageAndFetch();
                    if (view === 'quiz' && quizList.value.length === 0) refreshQuiz();
                };

                const toggleListFilter = (catName) => { listFilter.value = (listFilter.value === catName) ? '' : catName; resetPageAndFetch(); };
                const toggleKnowledgeFilter = (catName) => { knowledgeFilter.value = (knowledgeFilter.value === catName) ? '' : catName; resetPageAndFetch(); };

                const openAddModal = () => {
                    isEditing.value = false; editingObject.value = null;
                    targetType.value = currentView.value === 'knowledge' ? 'knowledge' : 'question';
                    form.q_content = ''; form.q_answer = ''; form.q_analysis = ''; form.q_tags = '';
                    form.k_title = ''; form.k_content = ''; form.q_knowledgeId = '';
                    form.category = categoryList.value.length > 0 ? categoryList.value[0].get('name') : '';
                    showModal.value = true;
                };

                const openEditModal = (item, type) => {
                    isEditing.value = true; editingObject.value = item; targetType.value = type;
                    form.category = item.get('category');
                    if (type === 'knowledge') { form.k_title = item.get('title'); form.k_content = item.get('content'); }
                    else {
                        form.q_content = item.get('content'); form.q_answer = item.get('answer');
                        form.q_analysis = item.get('analysis'); form.q_tags = (item.get('tags') || []).join(',');
                        const link = item.get('linkedKnowledge'); form.q_knowledgeId = link ? link.id : '';
                    }
                    showModal.value = true;
                };

                const submitData = async () => {
                    if (!form.category) return alert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼');
                    try {
                        let obj;
                        if (targetType.value === 'knowledge') {
                            const Knowledge = AV.Object.extend('Knowledge');
                            obj = isEditing.value ? editingObject.value : new Knowledge();
                            obj.set('title', form.k_title); obj.set('content', form.k_content);
                        } else {
                            const Question = AV.Object.extend('Question');
                            obj = isEditing.value ? editingObject.value : new Question();
                            obj.set('content', form.q_content); obj.set('answer', form.q_answer);
                            obj.set('analysis', form.q_analysis);
                            obj.set('tags', form.q_tags.split(/,|ï¼Œ/).map(t => t.trim()).filter(t => t));
                            if (!isEditing.value) obj.set('masteryLevel', 0);
                            if (form.q_knowledgeId) obj.set('linkedKnowledge', AV.Object.createWithoutData('Knowledge', form.q_knowledgeId));
                            else obj.unset('linkedKnowledge');
                        }
                        obj.set('category', form.category);
                        if (!isEditing.value) { obj.set('owner', currentUser.value); obj.setACL(new AV.ACL(currentUser.value)); }
                        await obj.save();
                        if (targetType.value === 'knowledge') { loadKnowledgeForSelect(); fetchKnowledge(); }
                        else fetchQuestions();
                        closeModal();
                    } catch (error) { alert('ä¿å­˜å¤±è´¥: ' + error.message); }
                };

                const refreshQuiz = async () => {
                    showQuizAnswer.value = false;
                    const query = new AV.Query('Question');
                    query.equalTo('owner', currentUser.value);
                    query.notEqualTo('masteryLevel', 1);
                    if (quizCategory.value) query.equalTo('category', quizCategory.value);
                    query.include('linkedKnowledge');
                    query.limit(20);
                    try { const results = await query.find(); quizList.value = results.sort(() => Math.random() - 0.5); } catch (e) { console.error(e); }
                };
                const handleQuizResult = (killed) => {
                    if (killed) { quizList.value[0].set('masteryLevel', 1); quizList.value[0].save(); }
                    quizList.value.shift(); showQuizAnswer.value = false;
                };

                const saveConfig = () => { localStorage.setItem('lc_app_id', configForm.appId); localStorage.setItem('lc_app_key', configForm.appKey); localStorage.setItem('lc_server_url', configForm.serverURL); initLeanCloud(configForm.appId, configForm.appKey, configForm.serverURL); };
                const clearConfig = () => { localStorage.clear(); window.location.reload(); };
                const handleAuth = async () => { try { if (authMode.value === 'login') currentUser.value = await AV.User.logIn(authForm.username, authForm.password); else { const u = new AV.User(); u.setUsername(authForm.username); u.setPassword(authForm.password); currentUser.value = await u.signUp(); } loadCategories(); loadInitialData(); loadKnowledgeForSelect(); } catch (e) { alert(e.message); } };
                const handleLogout = async () => { await AV.User.logOut(); window.location.reload(); };
                const toggleMastery = async (item) => { item.set('masteryLevel', item.get('masteryLevel') === 1 ? 0 : 1); await item.save(); };
                const deleteQuestion = async (item) => { if (confirm('åˆ é™¤?')) { await item.destroy(); fetchQuestions(); } };
                const deleteKnowledge = async (item) => { if (confirm('åˆ é™¤?')) { await item.destroy(); fetchKnowledge(); } };
                const renderMarkdown = (text) => (text && typeof marked !== 'undefined') ? marked.parse(text) : (text || '');
                const closeModal = () => showModal.value = false;
                const printMode = () => window.print();
                const navClass = (v) => currentView.value === v ? 'bg-primary text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-100';
                const viewTitle = computed(() => ({ 'list': 'é”™é¢˜æœ¬', 'quiz': 'æ™ºèƒ½åˆ·é¢˜', 'knowledge': 'çŸ¥è¯†åº“', 'settings': 'è®¾ç½®' }[currentView.value]));
                const goToSettings = () => { closeModal(); currentView.value = 'settings'; };

                return {
                    isReady, hasConfig, currentUser, currentView, loading, configForm, authMode, authForm,
                    questions, knowledgeList, knowledgeListAll, quizList, showModal, form, showQuizAnswer, viewTitle,
                    categoryList, newCategoryName, quizCategory, knowledgeFilter, isEditing, targetType,
                    listFilter, masteryFilter, pagination, jumpPageNum,
                    saveConfig, clearConfig, handleAuth, handleLogout, renderMarkdown, navClass, switchView,
                    openAddModal, openEditModal, closeModal, submitData, toggleMastery, deleteQuestion, deleteKnowledge,
                    refreshQuiz, handleQuizResult, printMode, addCategory, removeCategory, goToSettings,
                    toggleListFilter, toggleKnowledgeFilter, resetPageAndFetch, changePage
                };
            }
        }).mount('#app');
    </script>
</body>

</html>