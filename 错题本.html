<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯é”™é¢˜æœ¬</title>
    <!-- å¼•å…¥åº“æ–‡ä»¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#64748b',
                        secondary: '#94a3b8',
                        accent: '#e2e8f0',
                        surface: '#ffffff',
                        background: '#f8fafc',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] {
            display: none;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Card Hover Effect */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* View Transitions */
        .view-enter-active,
        .view-leave-active {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .view-enter-from,
        .view-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }

        /* Markdown Styles Inside Prose */
        .prose pre {
            background-color: #f1f5f9;
            color: #334155;
            padding: 0.5rem;
            border-radius: 0.375rem;
            overflow-x: auto;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
            }

            .question-item {
                break-inside: avoid;
                border: 1px solid #eee;
                box-shadow: none;
                margin-bottom: 20px;
            }
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="h-full flex flex-col md:flex-row">

        <!-- ================= 0. åˆå§‹åŒ–/ç™»å½• ================= -->
        <div v-if="!isReady || !currentUser"
            class="fixed inset-0 z-[100] bg-slate-100 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
                <h1 class="text-2xl font-bold text-center mb-6 text-primary">äº‘ç«¯é”™é¢˜æœ¬</h1>
                <div v-if="!hasConfig" class="space-y-4">
                    <div class="bg-blue-50 text-blue-700 p-3 rounded text-xs mb-4">LeanCloud æ§åˆ¶å° &gt; è®¾ç½® &gt; åº”ç”¨å‡­è¯</div>
                    <input v-model="configForm.appId" placeholder="App ID" class="w-full p-2 border rounded text-sm">
                    <input v-model="configForm.appKey" type="password" placeholder="App Key"
                        class="w-full p-2 border rounded text-sm">
                    <input v-model="configForm.serverURL" placeholder="REST API (https://...)"
                        class="w-full p-2 border rounded text-sm">
                    <button @click="saveConfig"
                        class="w-full bg-primary text-white py-2 rounded hover:bg-slate-700 mt-2">ä¿å­˜é…ç½®</button>
                </div>
                <div v-else class="space-y-4">
                    <div class="flex border-b mb-4">
                        <button @click="authMode='login'" :class="{'border-primary text-primary': authMode==='login'}"
                            class="flex-1 pb-2 border-b-2 border-transparent">ç™»å½•</button>
                        <button @click="authMode='signup'" :class="{'border-primary text-primary': authMode==='signup'}"
                            class="flex-1 pb-2 border-b-2 border-transparent">æ³¨å†Œ</button>
                    </div>
                    <input v-model="authForm.username" placeholder="ç”¨æˆ·å" class="w-full p-2 border rounded">
                    <input v-model="authForm.password" type="password" placeholder="å¯†ç "
                        class="w-full p-2 border rounded">
                    <button @click="handleAuth" class="w-full bg-primary text-white py-2 rounded hover:bg-slate-700">{{
                        authMode === 'login' ? 'è¿›å…¥ç³»ç»Ÿ' : 'ç«‹å³æ³¨å†Œ' }}</button>
                    <button @click="clearConfig"
                        class="text-xs text-slate-400 underline w-full text-center">é‡ç½®é…ç½®</button>
                </div>
            </div>
        </div>


        <!-- ================= ä¸»å†…å®¹åŒº ================= -->
        <main v-if="currentUser" class="flex-1 h-full overflow-y-auto bg-slate-50 relative pb-20 md:pb-0 scroll-smooth">

            <!-- é¡¶éƒ¨é€šæ  -->
            <header
                class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-slate-200 px-6 py-4 flex flex-col md:flex-row justify-between items-center no-print gap-3 shadow-sm">
                <h2 class="text-xl font-bold text-slate-800 self-start md:self-center">{{ viewTitle }}</h2>
                <div class="flex flex-wrap gap-2 self-start md:self-center">
                    <!-- åˆ·é¢˜æ¨¡å¼ç­›é€‰ -->
                    <div v-if="currentView === 'quiz'" class="flex items-center space-x-2 mr-2">
                        <span class="text-xs text-slate-500 font-bold">èŒƒå›´:</span>
                        <select v-model="quizCategory" @change="refreshQuiz"
                            class="text-sm border-slate-300 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary/20 bg-white py-1 pl-2 pr-8">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            <option v-for="cat in categoryList" :key="cat.id" :value="cat.get('name')">{{
                                cat.get('name') }}</option>
                        </select>
                    </div>

                    <button v-if="currentView === 'list'" @click="printMode"
                        class="px-3 py-1 text-sm bg-slate-200 rounded hover:bg-slate-300">å¯¼å‡º</button>
                    <button v-if="['list', 'knowledge'].includes(currentView)" @click="openAddModal"
                        class="px-3 py-1 text-sm bg-primary text-white rounded hover:bg-slate-700 shadow-md flex items-center">
                        <span class="text-lg mr-1 leading-none">+</span> æ–°å¢
                    </button>
                    <button v-if="currentView === 'quiz'" @click="refreshQuiz"
                        class="px-3 py-1 text-sm bg-emerald-500 text-white rounded hover:bg-emerald-600 shadow-md">ğŸ”„
                        æ¢ä¸€æ‰¹</button>
                </div>
            </header>

            <transition name="view" mode="out-in">
                <!-- View: List (é”™é¢˜åˆ—è¡¨) -->
                <div v-if="currentView === 'list'" key="list" class="p-4 max-w-4xl mx-auto flex flex-col h-full">

                    <!-- ç­›é€‰å·¥å…·æ  -->
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center pb-4 mb-2 no-print gap-4">
                        <div class="flex flex-wrap gap-2">
                            <button @click="toggleListFilter('')"
                                class="px-4 py-1.5 rounded-full text-sm font-medium transition-colors border"
                                :class="listFilter === '' ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">å…¨éƒ¨</button>
                            <button v-for="cat in categoryList" :key="cat.id" @click="toggleListFilter(cat.get('name'))"
                                class="px-4 py-1.5 rounded-full text-sm font-medium transition-colors border"
                                :class="listFilter === cat.get('name') ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">{{
                                cat.get('name') }}</button>
                            <button v-if="categoryList.length === 0" @click="currentView='settings'"
                                class="px-4 py-1.5 rounded-full text-sm font-medium border border-dashed border-slate-300 text-slate-400 hover:text-primary hover:border-primary">+
                                æ·»åŠ åˆ†ç±»</button>
                        </div>

                        <div class="flex items-center space-x-2">
                            <select v-model="masteryFilter" @change="resetPageAndFetch"
                                class="text-sm border-slate-200 rounded-md shadow-sm focus:border-primary focus:ring focus:ring-primary/20 bg-white py-1.5 pl-3 pr-8 text-slate-600">
                                <option :value="-1">å…¨éƒ¨çŠ¶æ€</option>
                                <option :value="0">æœªæ–©æ€ (è¿›è¡Œä¸­)</option>
                                <option :value="1">å·²æ–©æ€ (å·²æŒæ¡)</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="loading" class="text-center py-10 text-slate-400">åŠ è½½ä¸­...</div>
                    <div v-else-if="questions.length === 0" class="text-center py-10 text-slate-400">
                        æš‚æ— æ•°æ®
                    </div>

                    <div class="space-y-4">
                        <!-- é”™é¢˜å¡ç‰‡ï¼šcontext ä¸º 'view' (æŸ¥çœ‹è¯¦æƒ…) -->
                        <div v-for="q in questions" :key="q.id" @click="openDetailModal(q, 'view')"
                            class="question-item bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group/item card-hover animate-fade-in-up cursor-pointer">
                            <div
                                class="absolute top-0 right-0 bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-bl-lg font-bold">
                                {{ q.get('category') || 'æœªåˆ†ç±»' }}</div>

                            <div class="flex justify-between items-start mb-2 pr-8">
                                <div class="flex space-x-2">
                                    <span v-for="tag in q.get('tags')"
                                        class="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded-full">#{{ tag
                                        }}</span>
                                </div>
                                <span v-if="q.get('masteryLevel') === 1"
                                    class="text-emerald-500 text-xs font-bold border border-emerald-500 px-2 rounded ml-2">å·²æ–©æ€</span>
                            </div>

                            <!-- é¢˜ç›®é¢„è§ˆï¼ˆé™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢åˆ—è¡¨è¿‡é•¿ï¼‰ -->
                            <div class="prose prose-slate max-w-none mb-4 line-clamp-4"
                                v-html="renderMarkdown(q.get('content'))">
                            </div>

                            <div class="flex items-center text-xs text-slate-400 mt-2">
                                <span>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ä¸è§£æ...</span>
                            </div>

                            <div class="mt-4 flex justify-end space-x-3 no-print border-t pt-3 border-slate-50">
                                <button @click.stop="toggleMastery(q)"
                                    class="text-xs text-slate-500 hover:text-emerald-600 px-2 py-1 rounded hover:bg-slate-50">{{
                                    q.get('masteryLevel') === 1 ? 'æ¢å¤æœªæŒæ¡' : 'æ–©æ€ (Master)' }}</button>
                                <button @click.stop="openEditModal(q, 'question')"
                                    class="text-xs text-blue-500 hover:text-blue-700 px-2 py-1 rounded hover:bg-blue-50">ç¼–è¾‘</button>
                                <button @click.stop="deleteQuestion(q)"
                                    class="text-xs text-rose-400 hover:text-rose-600 px-2 py-1 rounded hover:bg-rose-50">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div v-if="!loading && questions.length > 0"
                        class="mt-8 mb-4 no-print bg-white p-3 rounded-lg border border-slate-200 flex flex-wrap justify-between items-center gap-4 text-sm text-slate-600">
                        <div class="flex items-center space-x-2">
                            <span>æ¯é¡µ:</span>
                            <select v-model="pagination.pageSize" @change="resetPageAndFetch"
                                class="border rounded p-1">
                                <option :value="5">5</option>
                                <option :value="10">10</option>
                                <option :value="20">20</option>
                                <option :value="50">50</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="changePage(pagination.current - 1)" :disabled="pagination.current <= 1"
                                class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&lt;</button>
                            <span>ç¬¬ {{ pagination.current }} é¡µ / å…± {{ pagination.total }} é¡µ</span>
                            <button @click="changePage(pagination.current + 1)"
                                :disabled="pagination.current >= pagination.total"
                                class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&gt;</button>
                            <div class="flex items-center space-x-1 ml-2">
                                <input type="number" v-model.number="jumpPageNum"
                                    class="w-12 border rounded p-1 text-center" min="1" :max="pagination.total">
                                <button @click="changePage(jumpPageNum)"
                                    class="px-2 py-1 border rounded bg-slate-50 hover:bg-slate-100 text-xs">è·³è½¬</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Quiz -->
                <div v-if="currentView === 'quiz'" key="quiz" class="p-4 max-w-2xl mx-auto h-full flex flex-col">
                    <div class="text-center mb-4"><span
                            class="bg-slate-100 text-slate-800 text-xs font-medium px-2.5 py-0.5 rounded">å½“å‰åˆ†ç±»: {{
                            quizCategory || 'å…¨éƒ¨' }}</span></div>
                    <div v-if="quizList.length > 0" class="flex-1 flex flex-col items-center justify-center">
                        <div class="w-full text-center mb-4 text-slate-500 text-sm">å‰©ä½™é¢˜ç›®: {{ quizList.length }}</div>

                        <!-- åˆ·é¢˜å¡ç‰‡ï¼šç‚¹å‡» -> 'quiz_only' (åªçœ‹é¢˜ç›®) -->
                        <div @click="openDetailModal(quizList[0], 'quiz_only')"
                            class="w-full bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-8 border border-slate-100 min-h-[400px] flex flex-col relative animate-pop cursor-pointer hover:shadow-2xl transition-shadow">
                            <span
                                class="absolute top-4 right-4 text-xs text-slate-300 font-bold border border-slate-100 px-2 rounded">{{
                                quizList[0].get('category') || 'æœªåˆ†ç±»' }}</span>
                            <div class="flex-1 flex flex-col justify-center">
                                <div class="prose prose-lg max-w-none text-slate-700"
                                    v-html="renderMarkdown(quizList[0].get('content'))">
                                </div>
                            </div>
                            <div class="mt-4 text-center text-xs text-slate-300">
                                (ç‚¹å‡»å¡ç‰‡å±•å¼€é˜…è¯»å®Œæ•´é¢˜ç›®)
                            </div>
                        </div>

                        <!-- æŒ‰é’®åŒºï¼šç‚¹å‡» -> 'quiz' (æŸ¥çœ‹ç­”æ¡ˆ&åˆ¤é¢˜) -->
                        <div class="mt-8 w-full max-w-md">
                            <button @click="openDetailModal(quizList[0], 'quiz')"
                                class="w-full bg-white border-2 border-primary text-primary font-bold text-lg py-4 rounded-xl hover:bg-primary hover:text-white transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                ğŸ‘€ æŸ¥çœ‹ç­”æ¡ˆ & åˆ¤é¢˜
                            </button>
                        </div>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center h-full text-slate-400">
                        <div class="text-6xl mb-4">ğŸ‰</div>
                        <p>æš‚æ— å¾…å¤ä¹ é¢˜ç›®</p><button @click="refreshQuiz" class="mt-4 text-primary underline">åˆ·æ–°</button>
                    </div>
                </div>

                <!-- View: Knowledge -->
                <div v-if="currentView === 'knowledge'" key="knowledge"
                    class="p-4 max-w-4xl mx-auto flex flex-col h-full">
                    <div class="flex flex-wrap gap-2 pb-4 mb-2 no-print">
                        <button @click="toggleKnowledgeFilter('')"
                            class="px-4 py-2 rounded-full text-sm font-medium transition-colors border"
                            :class="knowledgeFilter === '' ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">å…¨éƒ¨</button>
                        <button v-for="cat in categoryList" :key="cat.id"
                            @click="toggleKnowledgeFilter(cat.get('name'))"
                            class="px-4 py-2 rounded-full text-sm font-medium transition-colors border"
                            :class="knowledgeFilter === cat.get('name') ? 'bg-primary text-white shadow-md border-transparent' : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200'">{{
                            cat.get('name') }}</button>
                    </div>

                    <div v-if="loading" class="text-center py-10 text-slate-400">åŠ è½½ä¸­...</div>
                    <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-if="knowledgeList.length === 0" class="col-span-full text-center py-10 text-slate-400">{{
                            knowledgeFilter ? `â€œ${knowledgeFilter}â€ä¸‹æš‚æ— å†…å®¹` : 'æš‚æ— å†…å®¹' }}</div>

                        <div v-for="k in knowledgeList" :key="k.id" @click="openDetailModal(k, 'view')"
                            class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md card-hover transition relative group/kitem animate-fade-in-up cursor-pointer">
                            <span class="absolute top-4 right-4 text-[10px] text-slate-400 border px-1.5 rounded">{{
                                k.get('category') || 'æœªåˆ†ç±»' }}</span>
                            <h3 class="font-bold text-lg text-slate-800 mb-2 mr-8">{{ k.get('title') }}</h3>
                            <div class="prose prose-sm line-clamp-3 text-slate-600"
                                v-html="renderMarkdown(k.get('content'))"></div>

                            <div class="mt-3 pt-2 border-t flex justify-end space-x-2">
                                <button @click.stop="openEditModal(k, 'knowledge')"
                                    class="text-xs text-blue-500 hover:text-blue-700 px-2 py-1 rounded hover:bg-blue-50">ç¼–è¾‘</button>
                                <button @click.stop="deleteKnowledge(k)"
                                    class="text-xs text-rose-400 hover:text-rose-600 px-2 py-1 rounded hover:bg-rose-50">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div v-if="!loading && knowledgeList.length > 0"
                        class="mt-8 mb-4 no-print bg-white p-3 rounded-lg border border-slate-200 flex flex-wrap justify-between items-center gap-4 text-sm text-slate-600">
                        <div class="flex items-center space-x-2">
                            <span>æ¯é¡µ:</span>
                            <select v-model="pagination.pageSize" @change="resetPageAndFetch"
                                class="border rounded p-1">
                                <option :value="5">5</option>
                                <option :value="10">10</option>
                                <option :value="20">20</option>
                                <option :value="50">50</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button @click="changePage(pagination.current - 1)" :disabled="pagination.current <= 1"
                                class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&lt;</button>
                            <span>ç¬¬ {{ pagination.current }} é¡µ / å…± {{ pagination.total }} é¡µ</span>
                            <button @click="changePage(pagination.current + 1)"
                                :disabled="pagination.current >= pagination.total"
                                class="px-2 py-1 border rounded hover:bg-slate-50 disabled:opacity-50">&gt;</button>
                            <div class="flex items-center space-x-1 ml-2">
                                <input type="number" v-model.number="jumpPageNum"
                                    class="w-12 border rounded p-1 text-center" min="1" :max="pagination.total">
                                <button @click="changePage(jumpPageNum)"
                                    class="px-2 py-1 border rounded bg-slate-50 hover:bg-slate-100 text-xs">è·³è½¬</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View: Settings -->
                <div v-if="currentView === 'settings'" key="settings" class="p-4 max-w-md mx-auto space-y-4">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4 border-b pb-2">è´¦å·ä¿¡æ¯</h3>
                        <p class="text-sm text-slate-600 mb-1">User: {{ currentUser.getUsername() }}</p>
                        <button @click="handleLogout"
                            class="text-xs text-rose-500 border border-rose-500 px-2 py-1 rounded hover:bg-rose-50">é€€å‡ºç™»å½•</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="font-bold mb-4 border-b pb-2 flex justify-between">
                            <span>åˆ†ç±»ç®¡ç†</span>
                            <span class="text-xs text-slate-400 font-normal">{{ categoryList.length }}/20</span>
                        </h3>
                        <div class="bg-yellow-50 text-yellow-700 text-xs p-2 mb-4 rounded">åˆ†ç±»ç‹¬ç«‹å­˜å‚¨ï¼Œæ•°æ®æ›´å®‰å…¨ã€‚</div>
                        <div class="flex space-x-2 mb-4">
                            <input v-model="newCategoryName" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°"
                                class="flex-1 p-2 border rounded text-sm">
                            <button @click="addCategory"
                                class="bg-primary text-white px-3 py-2 rounded text-sm hover:bg-slate-700"
                                :disabled="categoryList.length >= 20">æ·»åŠ </button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div v-for="cat in categoryList" :key="cat.id"
                                class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm flex items-center">
                                {{ cat.get('name') }}
                                <button @click="removeCategory(cat)"
                                    class="ml-2 text-slate-400 hover:text-rose-500 font-bold leading-none">&times;</button>
                            </div>
                            <div v-if="categoryList.length === 0" class="text-slate-400 text-sm">æš‚æ— åˆ†ç±»ï¼Œè¯·æ·»åŠ ã€‚</div>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <!-- Navigation Sidebar (Desktop) / Bottom Bar (Mobile) -->
        <nav
            class="bg-white border-r border-slate-200 flex flex-col justify-between w-full md:w-20 md:h-full fixed bottom-0 md:static z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-none">
            <div class="flex md:flex-col justify-around md:justify-start md:space-y-6 md:pt-8 p-2 md:p-0">
                <button @click="currentView='list'" :class="navClass('list')"
                    class="nav-card p-3 rounded-2xl transition-all duration-300 flex flex-col items-center group">
                    <span class="text-2xl mb-1 transition-transform group-hover:scale-110">ğŸ“š</span>
                    <span class="text-[10px] font-medium">é”™é¢˜æœ¬</span>
                </button>
                <button @click="currentView='quiz'" :class="navClass('quiz')"
                    class="nav-card p-3 rounded-2xl transition-all duration-300 flex flex-col items-center group">
                    <span class="text-2xl mb-1 transition-transform group-hover:scale-110">ğŸ¯</span>
                    <span class="text-[10px] font-medium">åˆ·é¢˜</span>
                </button>
                <button @click="currentView='knowledge'" :class="navClass('knowledge')"
                    class="nav-card p-3 rounded-2xl transition-all duration-300 flex flex-col items-center group">
                    <span class="text-2xl mb-1 transition-transform group-hover:scale-110">ğŸ§ </span>
                    <span class="text-[10px] font-medium">çŸ¥è¯†ç‚¹</span>
                </button>
                <button @click="currentView='settings'" :class="navClass('settings')"
                    class="nav-card p-3 rounded-2xl transition-all duration-300 flex flex-col items-center group">
                    <span class="text-2xl mb-1 transition-transform group-hover:scale-110">âš™ï¸</span>
                    <span class="text-[10px] font-medium">è®¾ç½®</span>
                </button>
            </div>
        </nav>

        <!-- ================= æ–°å¢/ç¼–è¾‘ å¼¹çª— ================= -->
        <div v-if="showModal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-lg">{{ isEditing ? 'ç¼–è¾‘' : 'æ–°å¢' }} {{ targetType === 'knowledge' ? 'çŸ¥è¯†ç‚¹' :
                        'é”™é¢˜' }}</h3>
                    <button @click="closeModal" class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto space-y-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-500 block mb-1">æ‰€å±åˆ†ç±» <span
                                class="text-rose-500">*</span></label>
                        <select v-model="form.category"
                            class="w-full p-2 border rounded bg-white focus:ring-2 ring-primary/50 outline-none">
                            <option value="" disabled>-- è¯·é€‰æ‹© --</option>
                            <option v-for="cat in categoryList" :key="cat.id" :value="cat.get('name')">{{
                                cat.get('name') }}</option>
                        </select>
                    </div>
                    <template v-if="targetType === 'knowledge'">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">çŸ¥è¯†ç‚¹æ ‡é¢˜</label>
                            <input v-model="form.k_title" placeholder="ä¾‹å¦‚ï¼šVue3 ç”Ÿå‘½å‘¨æœŸ"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">è¯¦ç»†å†…å®¹ (Markdown)</label>
                            <textarea v-model="form.k_content" placeholder="è¾“å…¥çŸ¥è¯†ç‚¹è¯¦æƒ…..." rows="8"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                    </template>
                    <template v-if="targetType === 'question'">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">é¢˜ç›®å†…å®¹ (æ”¯æŒ Markdown)</label>
                            <textarea v-model="form.q_content" placeholder="è¾“å…¥é¢˜å¹²..." rows="3"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">æ ‡å‡†ç­”æ¡ˆ</label>
                            <textarea v-model="form.q_answer" placeholder="è¾“å…¥ç­”æ¡ˆ" rows="2"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-slate-500 block mb-1">è¯¦ç»†è§£æ</label>
                            <textarea v-model="form.q_analysis" placeholder="è¾“å…¥è§£æ" rows="3"
                                class="w-full p-2 border rounded focus:ring-2 ring-primary/50 outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 block mb-1">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                                <input v-model="form.q_tags" placeholder="å¦‚: æ˜“é”™,é‡ç‚¹" class="w-full p-2 border rounded">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-bold text-slate-500 block mb-1">å…³è”çŸ¥è¯†ç‚¹</label>
                                <select v-model="form.q_knowledgeId" class="w-full p-2 border rounded bg-white">
                                    <option value="">æ— å…³è”</option>
                                    <option v-for="k in knowledgeListAll" :key="k.id" :value="k.id">
                                        [{{ k.get('category') || '-' }}] {{ k.get('title') }}
                                    </option>
                                </select>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="p-4 border-t bg-slate-50 flex justify-end space-x-3">
                    <button @click="closeModal" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">å–æ¶ˆ</button>
                    <button @click="submitData"
                        class="px-6 py-2 bg-primary text-white rounded shadow hover:bg-slate-700"
                        :disabled="categoryList.length === 0">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ================= ç»Ÿä¸€è¯¦æƒ…æµ®çª— ================= -->
        <div v-if="showDetailModal && currentDetail"
            class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4"
            @click.self="showDetailModal = false">

            <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] animate-pop">

                <!-- å¤´éƒ¨ -->
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center rounded-t-xl">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center">
                        <span class="mr-2">
                            {{ detailContext === 'quiz' ? 'åˆ¤é¢˜æ¨¡å¼' : (detailContext === 'quiz_only' ? 'é¢˜ç›®è¯¦æƒ…' : 'è¯¦æƒ…æŸ¥çœ‹') }}
                        </span>
                        <span class="text-xs font-normal text-slate-500 bg-white border px-1.5 py-0.5 rounded">
                            {{ currentDetail.get('category') }}
                        </span>
                    </h3>
                    <button @click="showDetailModal = false"
                        class="text-2xl text-slate-400 hover:text-slate-600">&times;</button>
                </div>

                <!-- å†…å®¹æ»šåŠ¨åŒº -->
                <div class="p-6 overflow-y-auto custom-scrollbar bg-white flex-1">

                    <!-- çŸ¥è¯†ç‚¹å±•ç¤ºæ¨¡å¼ -->
                    <template v-if="currentDetail.className === 'Knowledge'">
                        <h2 class="text-2xl font-bold mb-4">{{ currentDetail.get('title') }}</h2>
                        <div class="prose prose-slate max-w-none" v-html="renderMarkdown(currentDetail.get('content'))">
                        </div>
                    </template>

                    <!-- é”™é¢˜/åˆ·é¢˜å±•ç¤ºæ¨¡å¼ -->
                    <template v-else>
                        <div class="mb-6">
                            <div class="text-sm font-bold text-slate-400 mb-2">é¢˜ç›®</div>
                            <div class="prose prose-slate prose-lg max-w-none text-slate-800"
                                v-html="renderMarkdown(currentDetail.get('content'))">
                            </div>
                        </div>

                        <!-- ç­”æ¡ˆä¸è§£æ (åªæœ‰åœ¨ä¸æ˜¯ "åªçœ‹é¢˜ç›®" æ¨¡å¼ä¸‹æ‰æ˜¾ç¤º) -->
                        <div v-if="detailContext !== 'quiz_only'"
                            class="bg-emerald-50/50 p-5 rounded-xl border border-emerald-100/50 animate-fade-in-up">
                            <div class="mb-4">
                                <div class="text-sm font-bold text-emerald-600 mb-1">æ ‡å‡†ç­”æ¡ˆ</div>
                                <div class="prose prose-sm max-w-none text-emerald-900"
                                    v-html="renderMarkdown(currentDetail.get('answer'))"></div>
                            </div>

                            <div class="border-t border-emerald-100/50 pt-4">
                                <div class="text-sm font-bold text-slate-500 mb-1">è§£æ</div>
                                <div class="prose prose-sm max-w-none text-slate-700"
                                    v-html="renderMarkdown(currentDetail.get('analysis'))"></div>
                            </div>
                        </div>

                        <!-- å…³è”çŸ¥è¯†ç‚¹ (ä¹Ÿéšè—ï¼Œé˜²æ­¢å‰§é€) -->
                        <div v-if="detailContext !== 'quiz_only' && currentDetail.get('linkedKnowledge')"
                            class="mt-4 p-3 bg-blue-50/50 rounded-lg text-sm flex items-center text-blue-800 animate-fade-in-up">
                            <span class="mr-2">ğŸ”—</span>
                            <span>å…³è”çŸ¥è¯†ç‚¹ï¼š{{ currentDetail.get('linkedKnowledge').get('title') }}</span>
                        </div>
                    </template>
                </div>

                <!-- åº•éƒ¨æ“ä½œåŒºï¼šæ ¹æ®åœºæ™¯åŠ¨æ€å˜åŒ– -->
                <div class="p-4 border-t bg-slate-50 flex justify-end space-x-3 rounded-b-xl">

                    <!-- åœºæ™¯1: åˆ·é¢˜-åˆ¤åˆ†æ¨¡å¼ (æ˜¾ç¤ºåˆ¤åˆ†æŒ‰é’®) -->
                    <template v-if="detailContext === 'quiz'">
                        <button @click="handleQuizResultInModal(false)"
                            class="flex-1 md:flex-none px-6 py-2 bg-rose-50 text-rose-600 border border-rose-200 rounded hover:bg-rose-100 transition-colors">
                            è®°ä¸æ¸…
                        </button>
                        <button @click="handleQuizResultInModal(true)"
                            class="flex-1 md:flex-none px-6 py-2 bg-emerald-500 text-white rounded hover:bg-emerald-600 shadow-md hover:shadow-lg transition-all">
                            æ–©æ€ (ä¸‹ä¸€é¢˜)
                        </button>
                    </template>

                    <!-- åœºæ™¯2: åˆ·é¢˜-åªçœ‹é¢˜ç›®æ¨¡å¼ (åªæ˜¾ç¤ºå…³é—­) -->
                    <template v-else-if="detailContext === 'quiz_only'">
                        <button @click="showDetailModal = false"
                            class="px-6 py-2 bg-slate-800 text-white rounded shadow hover:bg-slate-700">
                            å…³é—­
                        </button>
                    </template>

                    <!-- åœºæ™¯3: æ™®é€šæŸ¥çœ‹æ¨¡å¼ (é”™é¢˜æœ¬/çŸ¥è¯†ç‚¹) -->
                    <template v-else>
                        <button
                            @click="showDetailModal = false; openEditModal(currentDetail, currentDetail.className === 'Knowledge' ? 'knowledge' : 'question')"
                            class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded">
                            ç¼–è¾‘æ­¤æ¡
                        </button>
                        <button @click="showDetailModal = false"
                            class="px-4 py-2 bg-slate-800 text-white rounded shadow hover:bg-slate-700">
                            å…³é—­
                        </button>
                    </template>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                // ================= çŠ¶æ€å˜é‡å®šä¹‰ =================
                const isReady = ref(false);
                const hasConfig = ref(false);
                const currentUser = ref(null);
                const currentView = ref('list');
                const loading = ref(false);

                // åˆ—è¡¨æ•°æ®
                const questions = ref([]);
                const knowledgeList = ref([]);
                const knowledgeListAll = ref([]);
                const quizList = ref([]);
                const categoryList = ref([]);

                // ç­›é€‰ä¸åˆ†é¡µ
                const quizCategory = ref('');
                const knowledgeFilter = ref('');
                const listFilter = ref('');
                const newCategoryName = ref('');
                const masteryFilter = ref(-1);
                const pagination = reactive({ current: 1, pageSize: 10, total: 0, count: 0 });
                const jumpPageNum = ref(1);

                // å¼¹çª—æ§åˆ¶
                const showModal = ref(false);
                const isEditing = ref(false);
                const editingObject = ref(null);
                const targetType = ref('question');
                const showQuizAnswer = ref(false);

                // ç»Ÿä¸€è¯¦æƒ…æµ®çª—æ§åˆ¶
                const showDetailModal = ref(false);
                const currentDetail = ref(null);
                const detailContext = ref('view'); // 'view' | 'quiz' | 'quiz_only'

                // è¡¨å•æ•°æ®
                const configForm = reactive({ appId: '', appKey: '', serverURL: '' });
                const authMode = ref('login');
                const authForm = reactive({ username: '', password: '' });
                const form = reactive({ category: '', q_content: '', q_answer: '', q_analysis: '', q_tags: '', q_knowledgeId: '', k_title: '', k_content: '' });

                // ================= åˆå§‹åŒ–ä¸é…ç½® =================
                onMounted(() => {
                    const storedId = localStorage.getItem('lc_app_id');
                    const storedKey = localStorage.getItem('lc_app_key');
                    const storedUrl = localStorage.getItem('lc_server_url');
                    if (storedId && storedKey && storedUrl) {
                        configForm.appId = storedId; configForm.appKey = storedKey; configForm.serverURL = storedUrl;
                        initLeanCloud(storedId, storedKey, storedUrl);
                    } else { isReady.value = true; }
                });

                const initLeanCloud = (id, key, url) => {
                    try {
                        AV.init({ appId: id, appKey: key, serverURLs: url });
                        hasConfig.value = true;
                        currentUser.value = AV.User.current();
                        isReady.value = true;
                        if (currentUser.value) {
                            loadCategories();
                            loadInitialData();
                            loadKnowledgeForSelect();
                        }
                    } catch (error) { console.error(error); alert('é…ç½®é”™è¯¯'); clearConfig(); }
                };

                const saveConfig = () => {
                    localStorage.setItem('lc_app_id', configForm.appId);
                    localStorage.setItem('lc_app_key', configForm.appKey);
                    localStorage.setItem('lc_server_url', configForm.serverURL);
                    initLeanCloud(configForm.appId, configForm.appKey, configForm.serverURL);
                };
                const clearConfig = () => {
                    localStorage.removeItem('lc_app_id');
                    localStorage.removeItem('lc_app_key');
                    localStorage.removeItem('lc_server_url');
                    hasConfig.value = false;
                    isReady.value = false;
                    location.reload();
                };

                // ================= è®¤è¯ =================
                const handleAuth = async () => {
                    try {
                        if (authMode.value === 'login') {
                            await AV.User.logIn(authForm.username, authForm.password);
                        } else {
                            const user = new AV.User();
                            user.setUsername(authForm.username);
                            user.setPassword(authForm.password);
                            await user.signUp();
                        }
                        currentUser.value = AV.User.current();
                        loadCategories();
                        loadInitialData();
                        loadKnowledgeForSelect();
                    } catch (e) { alert('è®¤è¯å¤±è´¥: ' + e.message); }
                };

                const handleLogout = () => {
                    AV.User.logOut();
                    currentUser.value = null;
                    questions.value = [];
                    knowledgeList.value = [];
                };

                // ================= æ•°æ®åŠ è½½ =================
                const loadCategories = async () => {
                    const query = new AV.Query('Category');
                    query.equalTo('owner', currentUser.value);
                    query.limit(100);
                    try { categoryList.value = await query.find(); } catch (e) { console.error(e); }
                };

                const loadInitialData = () => {
                    pagination.current = 1;
                    if (currentView.value === 'list') fetchQuestions();
                    else if (currentView.value === 'knowledge') fetchKnowledge();
                };

                const loadKnowledgeForSelect = async () => {
                    const query = new AV.Query('Knowledge');
                    query.equalTo('owner', currentUser.value);
                    query.select(['title', 'category']);
                    query.limit(1000);
                    try { knowledgeListAll.value = await query.find(); } catch (e) { }
                };

                // é”™é¢˜è·å–
                const fetchQuestions = async () => {
                    loading.value = true;
                    const query = new AV.Query('Question');
                    query.equalTo('owner', currentUser.value);
                    if (listFilter.value) query.equalTo('category', listFilter.value);
                    if (masteryFilter.value !== -1) query.equalTo('masteryLevel', masteryFilter.value);

                    const countQuery = new AV.Query('Question');
                    countQuery.equalTo('owner', currentUser.value);
                    if (listFilter.value) countQuery.equalTo('category', listFilter.value);
                    if (masteryFilter.value !== -1) countQuery.equalTo('masteryLevel', masteryFilter.value);

                    query.skip((pagination.current - 1) * pagination.pageSize);
                    query.limit(pagination.pageSize);
                    query.include('linkedKnowledge');
                    query.descending('createdAt');

                    try {
                        const [results, count] = await Promise.all([query.find(), countQuery.count()]);
                        questions.value = results;
                        pagination.count = count;
                        pagination.total = Math.ceil(count / pagination.pageSize) || 1;
                    } catch (e) { console.error(e); }
                    loading.value = false;
                };

                // çŸ¥è¯†ç‚¹è·å–
                const fetchKnowledge = async () => {
                    loading.value = true;
                    const query = new AV.Query('Knowledge');
                    query.equalTo('owner', currentUser.value);
                    if (knowledgeFilter.value) query.equalTo('category', knowledgeFilter.value);

                    const countQuery = new AV.Query('Knowledge');
                    countQuery.equalTo('owner', currentUser.value);
                    if (knowledgeFilter.value) countQuery.equalTo('category', knowledgeFilter.value);

                    query.skip((pagination.current - 1) * pagination.pageSize);
                    query.limit(pagination.pageSize);
                    query.descending('createdAt');

                    try {
                        const [results, count] = await Promise.all([query.find(), countQuery.count()]);
                        knowledgeList.value = results;
                        pagination.count = count;
                        pagination.total = Math.ceil(count / pagination.pageSize) || 1;
                    } catch (e) { console.error(e); }
                    loading.value = false;
                };

                // ================= äº¤äº’é€»è¾‘ =================
                const addCategory = async () => {
                    const val = newCategoryName.value.trim();
                    if (!val) return;
                    if (categoryList.value.some(c => c.get('name') === val)) return alert('åˆ†ç±»å·²å­˜åœ¨');
                    if (categoryList.value.length >= 20) return alert('æœ€å¤š20ä¸ªåˆ†ç±»');
                    const Category = AV.Object.extend('Category');
                    const cat = new Category();
                    cat.set('name', val); cat.set('owner', currentUser.value); cat.setACL(new AV.ACL(currentUser.value));
                    try { await cat.save(); newCategoryName.value = ''; loadCategories(); } catch (e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
                };

                const removeCategory = async (catObj) => {
                    if (!confirm(`ç¡®å®šåˆ é™¤â€œ${catObj.get('name')}â€å—ï¼Ÿ`)) return;
                    try { await catObj.destroy(); loadCategories(); } catch (e) { alert('åˆ é™¤å¤±è´¥: ' + e.message); }
                };

                const refreshQuiz = async () => {
                    const query = new AV.Query('Question');
                    query.equalTo('owner', currentUser.value);
                    query.notEqualTo('masteryLevel', 1);
                    if (quizCategory.value) query.equalTo('category', quizCategory.value);
                    query.limit(100);
                    try {
                        const results = await query.find();
                        if (results.length > 0) {
                            quizList.value = [results[Math.floor(Math.random() * results.length)]];
                            showQuizAnswer.value = false;
                        } else { quizList.value = []; }
                    } catch (e) { console.error(e); }
                };

                const handleQuizResult = async (success) => {
                    if (!quizList.value.length) return;
                    const q = quizList.value[0];
                    if (success) {
                        q.set('masteryLevel', 1);
                        try { await q.save(); } catch (e) { }
                    }
                    refreshQuiz();
                };

                // åœ¨æµ®çª—å†…åˆ¤é¢˜çš„åŒ…è£…å‡½æ•°
                const handleQuizResultInModal = async (success) => {
                    await handleQuizResult(success);
                    showDetailModal.value = false;
                };

                const toggleMastery = async (q) => {
                    const level = q.get('masteryLevel') === 1 ? 0 : 1;
                    q.set('masteryLevel', level);
                    try { await q.save(); } catch (e) { }
                };

                // ================= æ¨¡æ€æ¡†æ“ä½œ =================
                const openAddModal = () => {
                    isEditing.value = false;
                    editingObject.value = null;
                    targetType.value = currentView.value === 'knowledge' ? 'knowledge' : 'question';
                    Object.assign(form, { category: '', q_content: '', q_answer: '', q_analysis: '', q_tags: '', q_knowledgeId: '', k_title: '', k_content: '' });
                    showModal.value = true;
                };

                const openEditModal = (obj, type) => {
                    isEditing.value = true;
                    editingObject.value = obj;
                    targetType.value = type;
                    form.category = obj.get('category');
                    if (type === 'question') {
                        form.q_content = obj.get('content');
                        form.q_answer = obj.get('answer');
                        form.q_analysis = obj.get('analysis');
                        form.q_tags = (obj.get('tags') || []).join(',');
                        const linked = obj.get('linkedKnowledge');
                        form.q_knowledgeId = linked ? linked.id : '';
                    } else {
                        form.k_title = obj.get('title');
                        form.k_content = obj.get('content');
                    }
                    showModal.value = true;
                };

                // æ‰“å¼€è¯¦æƒ…æµ®çª—ï¼ˆæ”¯æŒé”™é¢˜å’Œåˆ·é¢˜æ¨¡å¼ï¼‰
                const openDetailModal = (item, context = 'view') => {
                    currentDetail.value = item;
                    detailContext.value = context;
                    showDetailModal.value = true;
                };

                const submitData = async () => {
                    if (!form.category) return alert('è¯·é€‰æ‹©åˆ†ç±»');
                    const ObjClass = AV.Object.extend(targetType.value === 'knowledge' ? 'Knowledge' : 'Question');
                    const obj = isEditing.value ? editingObject.value : new ObjClass();

                    if (!isEditing.value) {
                        obj.set('owner', currentUser.value);
                        obj.setACL(new AV.ACL(currentUser.value));
                    }
                    obj.set('category', form.category);

                    if (targetType.value === 'question') {
                        obj.set('content', form.q_content);
                        obj.set('answer', form.q_answer);
                        obj.set('analysis', form.q_analysis);
                        obj.set('tags', form.q_tags.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t));
                        if (form.q_knowledgeId) {
                            const k = AV.Object.createWithoutData('Knowledge', form.q_knowledgeId);
                            obj.set('linkedKnowledge', k);
                        } else { obj.unset('linkedKnowledge'); }
                        if (!isEditing.value) obj.set('masteryLevel', 0);
                    } else {
                        obj.set('title', form.k_title);
                        obj.set('content', form.k_content);
                    }

                    try {
                        await obj.save();
                        closeModal();
                        loadInitialData();
                    } catch (e) { alert('ä¿å­˜å¤±è´¥: ' + e.message); }
                };

                const deleteQuestion = async (q) => {
                    if (!confirm('ç¡®å®šåˆ é™¤?')) return;
                    try { await q.destroy(); fetchQuestions(); } catch (e) { }
                };
                const deleteKnowledge = async (k) => {
                    if (!confirm('ç¡®å®šåˆ é™¤?')) return;
                    try { await k.destroy(); fetchKnowledge(); } catch (e) { }
                };

                // ================= è¾…åŠ©å‡½æ•° =================
                const changePage = (p) => {
                    if (p < 1 || p > pagination.total) return;
                    pagination.current = p;
                    resetPageAndFetch();
                };
                const resetPageAndFetch = () => {
                    if (currentView.value === 'list') fetchQuestions();
                    else if (currentView.value === 'knowledge') fetchKnowledge();
                };
                const toggleListFilter = (cat) => { listFilter.value = cat; pagination.current = 1; fetchQuestions(); };
                const toggleKnowledgeFilter = (cat) => { knowledgeFilter.value = cat; pagination.current = 1; fetchKnowledge(); };

                const renderMarkdown = (text) => (text && typeof marked !== 'undefined') ? marked.parse(text) : (text || '');
                const closeModal = () => showModal.value = false;
                const printMode = () => window.print();
                const navClass = (v) => currentView.value === v ? 'bg-primary text-white shadow-lg shadow-slate-300 scale-105' : 'text-slate-500 hover:bg-slate-100 hover:shadow-md hover:-translate-y-0.5';
                const viewTitle = computed(() => ({ 'list': 'é”™é¢˜æœ¬', 'quiz': 'æ™ºèƒ½åˆ·é¢˜', 'knowledge': 'çŸ¥è¯†åº“', 'settings': 'è®¾ç½®' }[currentView.value]));
                const goToSettings = () => { closeModal(); currentView.value = 'settings'; };

                watch(currentView, (newVal) => {
                    if (newVal === 'list' || newVal === 'knowledge') {
                        pagination.current = 1;
                        loadInitialData();
                    }
                });

                // ================= è¿”å›ç»™æ¨¡æ¿ =================
                return {
                    isReady, hasConfig, currentUser, currentView, loading,
                    configForm, authMode, authForm, form,
                    questions, knowledgeList, knowledgeListAll, quizList, categoryList,
                    quizCategory, knowledgeFilter, listFilter, newCategoryName, masteryFilter,
                    pagination, jumpPageNum,
                    showModal, isEditing, targetType, showQuizAnswer,
                    showDetailModal, currentDetail, detailContext, // è¯¦æƒ…æµ®çª—ç›¸å…³
                    saveConfig, clearConfig, handleAuth, handleLogout,
                    addCategory, removeCategory,
                    refreshQuiz, handleQuizResult, handleQuizResultInModal, // æ–¹æ³•
                    openAddModal, openEditModal, openDetailModal, submitData,
                    deleteQuestion, deleteKnowledge, toggleMastery,
                    changePage, resetPageAndFetch, toggleListFilter, toggleKnowledgeFilter,
                    renderMarkdown, closeModal, printMode, navClass, viewTitle, goToSettings
                };
            }
        }).mount('#app');
    </script>
</body>

</html>